<link rel="import" href="../../web_components/polymer/polymer.html">

<dom-module id="x-comp-find-tipo-pago-option">
	<template is="dom-bind">
		<div style="display: flex">
			<div class="content_div_op_pago" id="_content_div_op_pago" 
			style="display: grid; max-width: 450px; grid-template-columns: repeat(6, auto); grid-auto-flow: row; grid-gap: 10px;" 
			disabled$="{{deshabilitado}}">
				<template is="dom-repeat" items="{{listOptionPago}}" as="categoria">
					<div class="xMiBoton_icon_option" style="margin-right: 0px;"
						data-id="{{categoria.idtipo_pago}}" 
						data-index="{{index}}" 	
						data-reqcliente="{{categoria.requiere_cliente}}"
						data-limite="{{categoria.limite}}"
						data-descripcion="{{categoria.descripcion}}"
						selected$="{{categoria.seleccionado}}"
						hidden$ = "{{categoria.hidden}}"
						onclick="selectOption(this)">
						<img src="{{categoria.logo}}">
						<p>{{categoria.descripcion}}</p>
					</div>					
				</template>
			</div>
			
			<!-- <select id="compFindListTipoPagoOptionOption" class="xTextRow2 xCursor" onchange="selectOptionTipoPagoOption()">
				<template is="dom-repeat" items="{{list}}" as="categoria">
					<option value="[[index]]">[[categoria.descripcion]] </option>
				</template>
			</select> -->
		</div>

	</template>
	<script>
		var xThisComTipoPagoOption, _ispagoappop = false;

		function getAllTipoPagoOption() {
			// const op = xThisComTipoPagoOption.ispagoappop ? 601 : 6;

			

			xThisComTipoPagoOption.listOptionPago = [];


			// _ispagoappop = isPedidoPagadoFromApp || false;
			_ispagoappop = xThisComTipoPagoOption.ispagoappop || false;

			var getListTppAll = localStorage.getItem('::app3_comp_tpp_all');
            getListTppAll = getListTppAll ? JSON.parse(getListTppAll) : null;
			
			if ( getListTppAll ) {
				cocinanarDataTppALL(getListTppAll);
				return;
			}
			
			// url: '../../bdphp/log_componentes.php?op='+op
			$.ajax({
					type: 'GET',
					url: '../../bdphp/log_componentes.php?op=602'
				})
				.done(function (dtValues) {
					dtValues = JSON.parse(dtValues);
					// console.log('dtValues pagos', dtValues);

					dtValues = dtValues.datos;
					localStorage.setItem('::app3_comp_tpp_all', JSON.stringify(dtValues));
					cocinanarDataTppALL(dtValues);
				});
		}

		function cocinanarDataTppALL(_dtValues) {
			let yaEncontroPrimero=false, index_primero=0, _listOption;

			let metodosPagosAceptados = xm_log_get('datos_org_sede')[0]?.metodo_pago_aceptados || null;
			metodosPagosAceptados = metodosPagosAceptados ? metodosPagosAceptados === '' ? null : metodosPagosAceptados: metodosPagosAceptados;
			// console.log('metodosPagosAceptados', metodosPagosAceptados);
			
			// metodosPagosAceptados += '4'; // agrega el pago app por defecto
			// metodosPagosAceptados = metodosPagosAceptados.split(',');


			xThisComTipoPagoOption.listOptionPago = [];

			// const op = _ispagoappop ? 601 : 6;
			// _ispagoappop = isPedidoPagadoFromApp || false;
			
			_ispagoappop = xThisComTipoPagoOption.ispagoappop || false;
			// console.log('=== _ispagoappop ', _ispagoappop);
			let dtValues = _dtValues.filter(x => {
				if (_ispagoappop) {
					return x.idtipo_pago.toString() === '4' ;
				} else {
					return x.idtipo_pago.toString() !== '4' ;
				}
			});
			
			
			_listOption = dtValues.map((x, index) => {	
					// no aceptado
					if ( metodosPagosAceptados ) {
						if ( metodosPagosAceptados.indexOf(x.idtipo_pago) < 0 ) { 
							x.visible = false; return x; } 							
					} else {
						// si no es visible marcamos como no visible
						if (x.visible == '1') {
							x.visible = false;
							return x;
						}
					}
						
						// x.clase = 'xMiBoton_icon_option';						
						x.logo='../../images/'+x.img;
						x.descripcion = xMayusculaPrimera(x.descripcion.toLowerCase());
						x.hidden = xThisComTipoPagoOption.novisibles.indexOf(x.idtipo_pago) > -1 ? true : false;
						// xThisComTipoPagoOption.hiddenIconBorrar = true;
						if (!x.hidden && !yaEncontroPrimero) {
							yaEncontroPrimero=true;
							x.seleccionado = true;
							index_primero = index;							
							
							// xThisComTipoPagoOption.hiddenIconBorrar = index === 0 ? true : false;
						} else {x.seleccionado = false;}

						x.visible = true;
						return x;
					});

			_listOption = _listOption.filter(x => x.visible);

			xThisComTipoPagoOption.listOptionPago = JSON.parse(JSON.stringify(_listOption));

			// console.log('xThisComTipoPagoOption.listOptionPago', xThisComTipoPagoOption.listOptionPago);
			xThisComTipoPagoOption.list_tipo_pago = xThisComTipoPagoOption.listOptionPago[index_primero];
			xThisComTipoPagoOption.list_tipo_pago.index = index_primero;
			
			xThisComTipoPagoOption.idselect = xThisComTipoPagoOption.list_tipo_pago.idtipo_pago;
			xThisComTipoPagoOption.reqcliente = xThisComTipoPagoOption.list_tipo_pago.requiere_cliente;
			xThisComTipoPagoOption.limite = xThisComTipoPagoOption.list_tipo_pago.limite;
			
			xThisComTipoPagoOption.valIdInt = xThisComTipoPagoOption.list_tipo_pago;
			xThisComTipoPagoOption.getValorIncial(xThisComTipoPagoOption.list_tipo_pago);
		}

		// function selectOptionTipoPagoOption() {
		// 	const index = xThisComTipoPagoOption.$.compFindListTipoPagoOption.value;
		// 	xThisComTipoPagoOption.list_tipo_pago = xThisComTipoPagoOption.list[index];
		// 	xThisComTipoPagoOption.list_tipo_pago.index = index
		// }

		function selectOption(obj) {
			const index=obj.dataIndex;	
			const idSelect = obj.dataId;
			xThisComTipoPagoOption.idselect = idSelect;
			xThisComTipoPagoOption.reqcliente = xThisComTipoPagoOption.listOptionPago[index].requiere_cliente;
			xThisComTipoPagoOption.limite = xThisComTipoPagoOption.listOptionPago[index].limite;
			

			$(obj).parent().find('.xMiBoton_icon_option').each((i,e) => {								
				e.dataIndex === index ? $(e).attr('selected', true) : $(e).removeAttr('selected');
			});

			xSelectViewOption(index);
		}

		function xSelectViewOption(_index) {
			xThisComTipoPagoOption.listOptionPago.map(x => {x.seleccionado=''; return x;});
			xThisComTipoPagoOption.listOptionPago[_index].seleccionado=true;
			xThisComTipoPagoOption.list_tipo_pago = xThisComTipoPagoOption.listOptionPago[_index];

			// xThisComTipoPagoOption.fire('onchange', xThisComTipoPagoOption.list_tipo_pago);			
			xThisComTipoPagoOption.getValorIncial(xThisComTipoPagoOption.list_tipo_pago);
		}

		Polymer({
			is: 'x-comp-find-tipo-pago-option',
			properties: {
				// idTipoIngreso: {type : Number, notify: true, reflectToAttribute: true},
				novisibles: {type: String, value:''},
				ispagoappop: Boolean,
				deshabilitado: {type: Boolean, value:false},
				hiddenIconBorrar: {type: Boolean, value:true},
				idselect: {type: Number, value:1},
				reqcliente: {type: Number, value:0},				
				limite: {type: Number, value:1},
				listOptionPago: {
					type: Object,
					reflectToAttribute: true,
					notify: true
				},
				// list_tipo_pago: {
				// 	type: Object,
				// 	// value : {},
				// 	reflectToAttribute: true,
				// 	notify: true,
				// 	value: function () {
				// 		return {};
				// 	},
				// 	observer: 'tipoPagoNameChanged'
				// },
				list_tipo_pago: [],
				valIdInt: {
					type: Object,
					notify: true,
					reflectToAttribute: true
				},
			},
			listeners: {
				'onchange': 'getTipoPagoOption',
				'onclick': 'getTipoPagoOption'
			},
			setResetOption: () => {
				getAllTipoPagoOption(); // vuelve a buscar
			}
			,
			tipoPagoNameChanged: function (categoria) {
				return categoria;
			},
			getTipoPagoOption() {
				return this.listOptionPago.filter(x => x.seleccionado)[0];
			},
			attached: function () {
				xThisComTipoPagoOption = this;
				xThisComTipoPagoOption.listOptionPago = [];
				getAllTipoPagoOption();
			},
			getValorIncial: function (val) {
				this.fire('getValorIncial', {
					values: val
				});
			},
			setResetFirstOption: ()=> {
				const index=0;
				if ( !xThisComTipoPagoOption.listOptionPago || xThisComTipoPagoOption.listOptionPago.length === 0) {return; }
				xThisComTipoPagoOption.listOptionPago.map(x => {x.seleccionado=''});
				xThisComTipoPagoOption.listOptionPago[index].seleccionado=true;
				$('#_content_div_op_pago div.xMiBoton_icon_option').each((i,e) => {
					e.dataIndex === index ? $(e).attr('selected', true) : $(e).removeAttr('selected');
				});
			},
			detached: function () {
				xThisComTipoPagoOption.listOptionPago = [];
			}
		})
	</script>

</dom-module>