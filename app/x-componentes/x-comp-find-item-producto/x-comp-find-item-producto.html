<dom-module id="x-comp-find-item-producto">
    <template is="dom-bind">
        <div>
            <input type="text" class$="[[clasecss]]" placeholder$="[[elplaceholder]]"
                onblur="removeChartSpecialCtrl(this)" onChange="conMayusculas(this)" id="des_item_pro_comp"
                on-keyup="xloadItemProductoComp">
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'x-comp-find-item-producto',
        properties: {
            dtProItem: [],
            idalmacenfiltro: Number,
            onlynomproducto: Boolean,
            onlynomalmacen: Boolean,
            onlynomfamilia: Boolean,
            valueInput: String,
            clasecss: String,
            elplaceholder: String,
            removespecialchart: Boolean,
        },
        attached: function () {
            this.removespecialchart = false;
        },
        xloadItemProductoComp: function (e) {
            this.clasecss = this.clasecss === '' ? 'xTextRow2 xCursor' : this.clasecss;

            const _val = e.target.value;
            const _idFiltro = this.idalmacenfiltro || 0;
            if (_val.length < 3) { return; }

            $.ajax({ type: 'POST', url: '../../bdphp/log_componentes.php?op=2001', data: { search: _val, idfiltro: _idFiltro } })
                .done((DtItems) => {
                    var xDtItems = JSON.parse(DtItems);
                    this.dtItemProductosComp = xDtItems.datos;
                    this.xCargarProductoItemCartaComp();
                })
        },
        xCargarProductoItemCartaComp: function () {
            var xPrecio_pro_calc = 0;
            var xObjTxtItemPro = this.$["des_item_pro_comp"];
            $(xObjTxtItemPro).autocomplete({
                autoFocus: true,
                source: this.dtItemProductosComp,
                select: (event, ui) => {
                    xObjTxtItemPro.value = ui.item.label;
                    xObjTxtItemPro.dataset.id = ui.item.value;
                    this.elementSeleted = ui.item;

                    this.valueInput = this.$.des_item_pro_comp.value;
                    this.fire('elementSeleted', this.elementSeleted);
                    this.fire('selected', this.elementSeleted);

                    return false;
                },
                focus: function (event, ui) { return false; },
                change: (event, ui) => {
                    if (ui.item === null) {
                        xObjTxtItemPro.dataset.value = "";
                        xObjTxtItemPro.dataset.id = "";

                        this.xNewItemPro = true;
                        this.elementSeleted = null;
                        this.valueInput = this.$.des_item_pro_comp.value;
                        this.fire('elementSeleted', this.elementSeleted);                        
                        this.fire('selected', this.elementSeleted);
                    } else { this.xNewItemPro = false; }
                    return false;
                }
            });
        },
        removeChartSpecialCtrl: function (obj) {
            console.log('this.removespecialchart', this.removespecialchart);
            if (this.removespecialchart === false) { return; }
            obj.value = removeSpecialChar(obj.value);
        },
        getelementSeletedAlmacen: function () {
            return this.elementSeleted;
        },
        resetText: function () {
            this.$.des_item_pro_comp.value = '';
            this.elementSeleted = null;
        },
        focusText: function () {
            this.$.des_item_pro_comp.focus();
        },
        getTextInput: function () {
            return this.$.des_item_pro_comp.value;
        }
    })
</script>

<!-- <dom-module id="x-comp-find-item-producto">
	<template is="dom-bind">
		<div>
            <input type="text" 
                class$="[[clasecss]]"
                placeholder$="[[elplaceholder]]"                
                onblur="removeChartSpecialCtrl(this)"
                onChange="conMayusculas(this)" id="des_item_pro_comp" onkeyup="xloadItemProductoComp(this)">						
		</div>
	</template>
</dom-module>
    <script>
		var xThisCompItemProducto, dtItemProductosComp, elementSeleted;

        function xloadItemProductoComp(obj){
            xThisCompItemProducto.clasecss = xThisCompItemProducto.clasecss === '' ? 'xTextRow2 xCursor' : xThisCompItemProducto.clasecss;

            const _val = obj.value;
            const _idFiltro = xThisCompItemProducto.idalmacenfiltro || 0;
            if ( _val.length < 3) {return; }

            $.ajax({ type: 'POST', url: '../../bdphp/log_componentes.php?op=2001', data: {search: _val, idfiltro: _idFiltro}})
            .done( function (DtItems) {
                var xDtItems=JSON.parse(DtItems);
                dtItemProductosComp=xDtItems.datos;                
                xCargarProductoItemCartaComp();
            })
        }

        function xCargarProductoItemCartaComp () {
            var xPrecio_pro_calc=0;
            // var xObjTxtItemPro=$("#des_item_pro_comp");
            var xObjTxtItemPro = this.$["des_item_pro_comp"];
                xObjTxtItemPro.autocomplete({
                    autoFocus:true,
                    source:dtItemProductosComp,
                    select: function( event, ui ) {
                        xObjTxtItemPro.val(ui.item.label);
                        xObjTxtItemPro.attr('data-id',ui.item.value);                        
                        elementSeleted=ui.item;

                        xThisCompItemProducto.valueInput = des_item_pro_comp.value;
                        xThisCompItemProducto.fire('elementSeleted', elementSeleted);
                        

                        // console.log(elementSeleted)

                        return false;
                    },
                    focus:function(event, ui){return false;},
                    change:function( event, ui ) {
                        if(ui.item===null){
                            xObjTxtItemPro.attr('data-value',"");
                            xObjTxtItemPro.attr('data-id',"");
                            
                            xNewItemPro=true;
                            elementSeleted = null;
                            xThisCompItemProducto.valueInput = des_item_pro_comp.value;
                            xThisCompItemProducto.fire('elementSeleted', elementSeleted);                            
                            xThisCompItemProducto.fire('selected', elementSeleted);
                        }else{xNewItemPro=false;}
                        return false;
                    }
                });
        }
        

        function removeChartSpecialCtrl(obj) {
            console.log('xThisCompItemProducto.removespecialchart', xThisCompItemProducto.removespecialchart);
            if ( xThisCompItemProducto.removespecialchart === false ) { return; }
            obj.value = removeSpecialChar(obj.value);
        }
        


		Polymer({
			is: 'x-comp-find-item-producto',
			properties: {				
                dtProItem: [],                
                idalmacenfiltro: Number,// idalmacen filtro 0 o null = all
                onlynomproducto: Boolean,
                onlynomalmacen: Boolean,
                onlynomfamilia: Boolean, //
                valueInput: String,
                clasecss: String,
                elplaceholder: String,
                removespecialchart: Boolean,
			},
			attached: function () {                
                // this.removespecialchart = false;
				xThisCompItemProducto = this;								
			},
            getelementSeletedAlmacen: () => {                
                return elementSeleted;
            },
            resetText: () => {
                des_item_pro_comp.value = '';
                elementSeleted = null;
            },
            focusText: () => {
                des_item_pro_comp.focus();
            },
            getTextInput: () => {
                return des_item_pro_comp.value;
            }
		})
	</script>
 -->
