<link rel="import" href="../../web_components/polymer/polymer.html">
<link rel="import" href="../../web_components/paper-input-autocomplete/paper-input-autocomplete.html">

<dom-module id="x-comp-find-input-cliente">
	<template>
		<paper-input-autocomplete 
			id="input_clie_nombres_auto" 
			label="{{label}}" value="{{inputValue}}"
			search-property="nombres"
			onkeyup="searchClienteInput(this)"	
			on-autocomplete-selected="xchangeCliente"			
			autocomplete-search-length="2" disable-show-clear="true"></paper-input-autocomplete>

			<p hidden$="[[!isErrorLength]]" class="fs-13 text-danger">MÃ­nimo 5 caracteres.</p>
	</template>
</dom-module>
<script>
	var xThisComInputCliente, _autocompleteComp;
		

		function getAllClientesInit() {
			
			// _autocompleteComp = document.getElementById('input_clie_nombres_auto');
			// _autocompleteComp.addEventListener('autocomplete-selected', (event) => {				
			// 	console.log('selected aaaaaaaaa', xThisComInputCliente.inputValue);
			// 	// const cliente = _autocompleteComp.getValue();
			// 	// xThisComInputCliente.fire('input-autocomplete-selected', cliente)
			// 	// xThisComInputCliente.getCliente(_autocompleteComp.getValue());
			// });

			getAllClientes();
		}

		function getAllClientes(val_input = '') {		
			if (val_input.length < 3  ) { return; }	
			$.ajax({ type: 'POST', url: '../../bdphp/log_componentes.php?op=70101', data: {val: val_input}})
			.done( function (DtProv) {
				var xDtProv=JSON.parse(DtProv);
				xThisComInputCliente.list_cliente=xDtProv.datos;
				
				// _autocompleteComp.source = ['Apple', 'Orange', 'Bananas'];
				const listElementInput = input_clie_nombres_auto;
				if ( listElementInput.length ) {
					for (let item of listElementInput) {
						item.source=xDtProv.datos;
					}
				} else {
					listElementInput.source=xDtProv.datos;
				}
				
				// input_clie_nombres_auto.map((x,i) => {
				// 	input_clie_nombres_auto[i].source=xDtProv.datos
				// });
				// $("#input_clie_nombres_auto").each((i,element) => {
				// 	element.source = xDtProv.datos;
				// });
				// _autocompleteComp.source = JSON.parse(JSON.stringify(xDtProv.datos));
				// _autocompleteComp.remoteSource = true;
			});
		}

		function resetSource() {
			input_clie_nombres_auto.source = xThisComInputCliente.list_cliente
		}

		function searchClienteInput() {
			if ( event.keyCode == 13 ) {return; }
			const valInput = event.target.value;
			// console.log('valInput', valInput);
			compRemoveSpecialCharObjClient(event);

			if (valInput.length < 3  ) { return; }
			getAllClientes(valInput);

		}

		function compRemoveSpecialCharObjClient(e) {					
			e.target.value = e.target.value.replace(/[&\/\\,~'"?]/g, '');
			// try {
			// 	e.target.value = e.target.value.split(' | ')[1]
			// } catch (error) {				
			// 	e.target.value = e.target.value;
			// }

			xThisComInputCliente.isErrorLength = e.target.value.length > 0 && e.target.value.length < 5;
			xThisComInputCliente.xchangeCliente();
		}

		Polymer({
			is: 'x-comp-find-input-cliente',
			properties: {
				_autocompleteComp: Object,
				label: String,
				inputValue: {
					type: String,
					notify: true
				},				
				cliente: {},
				list_cliente: {
					type: Object,
					// value : {},
					reflectToAttribute: true,
					notify: true,
					value: function () {
						return {};
					},
					observer: 'clienteNameChanged'
				},
				valIdInt: {type : Object, notify: true, reflectToAttribute: true},
				isErrorLength: Boolean
			},
			listeners: {
				'onchange': 'getCliente'
			},
			clienteNameChanged: function () {
				return this.list_cliente;
			},
			getCliente(e) {
				return e;
			},
			attached: function () {
				this.isErrorLength = false;
				xThisComInputCliente = this;
				getAllClientesInit();				
			},
			reloadllClientes: function() {
				getAllClientes();
			},
			xchangeCliente: ()=> {
				let cliente = event.target.value;				
				event.target.fire('input-autocomplete-selected', cliente);
				// console.log('aaaaaaaaaaaaaaa');
			}
			// getValorIncial: function (val) {
			// 	this.fire('getValorIncial', {
			// 		values: val
			// 	});
			// }
		})
</script>