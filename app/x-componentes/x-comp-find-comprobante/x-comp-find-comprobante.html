<link rel="import" href="../../web_components/polymer/polymer.html">
<link rel="import" href="../../web_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../web_components/iron-dropdown/iron-dropdown.html">


<dom-module id="x-comp-find-comprobante">
    <template>        

        <style>
            .cardTPC {
                display: inline-block;
                margin: 1px;
                padding: 3px;
                border: 1px solid #919191;
                color: #575757;
                border-radius: 5px;
                text-align: center;
                cursor: pointer;
                user-select: none;
                font-size: 10px;
                background: lightgray;
                opacity: 0.8;
            }
        
            .cardTPC.selected {
                border: solid 2px #777777;
                background-color: #b3e5fc;
                color: black;
                font-weight: 600;
                opacity: 1;
                /* Nuevo color de fondo */
            }

            .content-card-tpc {
                display: flex;
                flex-wrap: nowrap;
                flex-direction: column;
                transition: opacity 0.5s ease-in-out;
            }
        </style>

        <div>
            <select hidden$="[[showicons]]" id="compFindListComprobante" class$="[[applyClass]]" onchange="selectOptionComprobante()">
                <template is="dom-repeat" items="{{list}}" as="comprobante">
                    <option value="[[index]]">[[comprobante.descripcion]] </option>
                </template>
            </select>      

            <div hidden$="[[!showicons]]" style="background: #e6e4cb; padding: 10px; border-radius: 8px; display: inline-block;">
                <div class="content_div_op_pago" style="display: flex">
                    <template is="dom-repeat" items="{{list}}" as="comprobante">
                      <div class="xMiBoton_icon_option"
                        data-index="{{index}}"
                        selected$="{{comprobante.seleccionado}}"
                        onclick="selectOptionComprobanteTouch(this)"
                        >
                        <img src="{{comprobante.img}}" width="32px" class="mb-1">
                        <p>{{comprobante.descripcion}}</p>
                      </div>
                    </template>
                    
                    <!-- opcion de elegir si desea el comprobante, detallado o por consumo -->
                    <div hidden$="{{hideContentCardTpc}}">
                        <section class="content-card-tpc animated animate__headShake" hidden$="{{isSeletedFirtsOption}}">
                            <template is="dom-repeat" items="{{cardsTPC}}">
                                <div class$="{{getClass(index)}}" on-click="selectCard">
                                    {{item.descripcion}}
                                </div>
                            </template>                    
                        </section>
                    </div>
                </div>

                <!-- cuando se selecciona la opcion con el id=1 entonces se mostrar un input para colocar una descripcion -->
                <div hidden$="{{hideContentCardTpc}}">
                    <div hidden$="{{isSeletedFirtsOption}}">
                            <div class="animated fadeIn" hidden$="{{!isSelectedPorConsumo}}">
                                <paper-input label="DescripciÃ³n del comprobante" class="xPasarEnter2 w-100" id="txt_des_comprobante_por_consumo" value$={{modoComprobanteSelected.modo_title}} on-change="onChangeTxtDesComprobantePorConsumo">
                                </paper-input>
                            </div>                        
                    </div>
                </div>
                
            </div>


            
        </div>

    </template>
    <script>
        var xThisComComprobante;

        function getAllComprobantes() {            
            const _op = xThisComComprobante.op === 1 ? '2' : '201'; // 201=no enlasa con tipo_comprobante_seriie
            $.ajax({ type: 'POST', url: '../../bdphp/log_componentes.php?op='+_op})
	        .done( function (dtValues) {
                dtValues=$.parseJSON(dtValues);	                

                dtValues.datos.map((x, i) => {
                    x.seleccionado = i == 0;
                    x.img = '../../images/'+x.img;                    
                })

                xThisComComprobante.list=dtValues.datos;
                xThisComComprobante.comprobantes = xThisComComprobante.list[0];
                xThisComComprobante.isSeletedFirtsOption = true;
                xThisComComprobante.getValorIncial(xThisComComprobante.comprobantes);                

                var cards = document.getElementsByClassName('cardTPC');
                if (cards.length > 0) {
                    cards[0].classList.add('selected');
                    xThisComComprobante.modoComprobanteSelected = xThisComComprobante.cardsTPC[0];  
                    xThisComComprobante.modoComprobanteSelected.modo_title = '';

                    xThisComComprobante.cardsTPC[1].descripcion = 'POR CONSUMO';
                }
            });
        }

        function selectOptionComprobante(obj) {            
            const index = xThisComComprobante.$.compFindListComprobante.value;            
            xThisComComprobante.comprobantes = xThisComComprobante.list[index];            
        }

        function selectOptionComprobanteTouch(obj) {
            const index=obj.dataIndex;	
            // xThisComComprobante.selectedIndex = index;
            xThisComComprobante.isSeletedFirtsOption = index === 0; 
			// const idSelect = obj.dataId;

            // const index = xThisComComprobante.$.compFindListComprobante.value;
            
            xThisComComprobante.comprobantes = xThisComComprobante.list[index];

            $(obj).parent().find('.xMiBoton_icon_option').each((i,e) => {								
				e.dataIndex === index ? $(e).attr('selected', true) : $(e).removeAttr('selected');
			});

            xSelectViewOptionTC(index);
        }

        function xSelectViewOptionTC(_index) {
			xThisComComprobante.list.map(x => {x.seleccionado=false; return x;});			
			xThisComComprobante.comprobantes = xThisComComprobante.list[_index];
            xThisComComprobante.comprobantes.seleccionado=true;

            xThisComComprobante.modoComprobanteSelected.modo_title = txt_des_comprobante_por_consumo.value; 
            xThisComComprobante.comprobantes.modo = xThisComComprobante.modoComprobanteSelected; 

			xThisComComprobante.fire('_onchange', xThisComComprobante.comprobantes);
			// xThisComComprobante.getValorIncial(xThisComComprobante.list);
		}

        function resetListComprobante() {
            xThisComComprobante.$.compFindListComprobante.selectedIndex = 0;
            xThisComComprobante.comprobantes = xThisComComprobante.list[0];
            xSelectViewOptionTC(0);
        }
        

        Polymer({
        is: 'x-comp-find-comprobante',
        properties: {
            cardsTPC: {
                type: Array,
                value: [
                    {descripcion: 'DETALLADO', id: 1, selected: true, modo_title: ''},
                    {descripcion: 'POR CONSUMO', id: 2, selected: false, modo_title: 'POR CONSUMO' }                    
                ]
            },
            hideContentCardTpc: {
                type: Boolean,
                value: false,
            },
            selected: {
                type: Number,
                notify: true,
            },
            modoComprobanteSelected: {
                type: Object,
                notify: true,
            },  
            isSeletedFirtsOption: Boolean,
            isSelectedPorConsumo: Boolean,
            applyClass: { type: String, value:'xTextRow2 xCursor'},
            op:{
                type:Number,
                value:1
            },
            list: [],
            comprobantes: {
                type: Object,
                reflectToAttribute: true,
                notify: true,
                observer: 'comprobanteNameChanged'
            },
            showicons: {
                type: Boolean,
                value: true,
                reflectToAttribute: true,
                notify: true,
            }
        },
        comprobanteNameChanged: function(comprobante) {
            return comprobante;
        },    
        ready: function() {      
            // this.isSeletedFirtsOption = true;      
            console.log('0AAA INI');
            xThisComComprobante=this;	
            // this.class = this.class == '' ? 'xTextRow2 xCursor' : this.class;
            getAllComprobantes();                      
        },
        getValorIncial: function(comprobante) {
            this.fire('getValorIncialx', {values: comprobante});
        },
        getValorSelecionado: () => {     
            console.log('0getValorSelecionado');       
            if (!xThisComComprobante.modoComprobanteSelected) {
                xThisComComprobante.modoComprobanteSelected = xThisComComprobante.cardsTPC[0];  
            }

            xThisComComprobante.modoComprobanteSelected.modo_title = txt_des_comprobante_por_consumo.value;                

            // xThisComComprobante.comprobantes.modo = xThisComComprobante.modoComprobanteSelected;    

            return xThisComComprobante.comprobantes;
        },
        reloadAllComprobantes: ()=> {
            // recargar data, ej al cambiar correlativo api                        
            getAllComprobantes();
        },
        reset: () => {
            console.log('AAA reset');
            resetListComprobante()
        },
        getClass: function (index) {
                return 'cardTPC' + (index === this.selectedIndex ? ' selected' : '');
        },
        selectCard: function (e) {
                // Elimina la clase 'selected' de todas las tarjetas
                let _cardsTPC = Polymer.dom(this.root).querySelectorAll('.cardTPC');
                for (var i = 0; i < _cardsTPC.length; i++) {
                    Polymer.dom(_cardsTPC[i]).classList.remove('selected');
                }

                // Agrega la clase 'selected' a la tarjeta seleccionada y la enfoca
                this.selectedIndex = this.cardsTPC.indexOf(e.model.item);
                Polymer.dom(e.target).classList.add('selected');
                e.target.focus();

                this.isSelectedPorConsumo = this.selectedIndex === 1;    
                            
                this.modoComprobanteSelected = this.cardsTPC[this.selectedIndex];
                this.modoComprobanteSelected.modo_title = txt_des_comprobante_por_consumo.value;   
                this.comprobantes.modo = this.modoComprobanteSelected;

                
                xThisComComprobante.fire('_onchange', xThisComComprobante.comprobantes);
                // modificamos la propiedad selected de la tarjeta seleccionada 
                

                // this.fire('getCategoria', { categorias: e.model.item });
                // this.fire('onChange', { categorias: e.model.item });
        },
        resetModoComprobanteSelected: function () {
            console.log('reset modo comprobante selected');
            this.modoComprobanteSelected = this.cardsTPC[0];
            this.modoComprobanteSelected.modo_title = '';
            this.cardsTPC[1].modo_title = 'POR CONSUMO';
            this.selectFirstModoComprobante()
        },    
        // funcion que selecciona el primer medo de comprobante
        selectFirstModoComprobante: function () {
            let cards = document.getElementsByClassName('cardTPC');

            // remove class selected
            for (var i = 0; i < cards.length; i++) {
                cards[i].classList.remove('selected');
            }


            if (cards.length > 0) {
                cards[0].classList.add('selected');
                this.modoComprobanteSelected = this.cardsTPC[0];
                this.modoComprobanteSelected.modo_title = '';
                this.comprobantes.modo = this.modoComprobanteSelected;

                this.cardsTPC[1].descripcion = 'POR CONSUMO';
                this.isSelectedPorConsumo = false;

                xThisComComprobante.fire('_onchange', xThisComComprobante.comprobantes);
            }
        },   
        onChangeTxtDesComprobantePorConsumo: function (e) {
            // capturar el evento change del txt_des_comprobante_por_consumo para asignar el valor a la propiedad modo_title    
            this.modoComprobanteSelected.modo_title = e.target.value;
            this.comprobantes.modo = this.modoComprobanteSelected;            

            xThisComComprobante.fire('_onchange', xThisComComprobante.comprobantes);

        },                  
    })
    </script>

</dom-module>
