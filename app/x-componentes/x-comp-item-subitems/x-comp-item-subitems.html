<dom-module id="x-comp-item-subitems">
    <template>
        <paper-dialog id="dialog_item_comp" style="max-width: 400px;" class="xDlgItem_mipedido" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
            
            <div>
                <div class="contet-subitem">
                    <h4 hidden$ = "{{!isSubItemReq}}">Requiere que seleccione {{cantSubItemSelect}} opción.</h4>
                    <h4 hidden$ = "{{isSubItemReq}}">Si desea seleccione {{cantSubItemSelect}} opción.</h4>
                    <div class="subitem-content pl-3 pr-3 pt-2">                      
                            <template is="dom-repeat" items="[[listSubItems]]" as="subitem" observe="_updateHack">
                                <div class="xoption w-50 fs-13">
                                    <paper-checkbox                                     
                                        data-id = "{{index}}"
                                        checked$ = "[[subitem.selected]]"
                                        class = "check-subitem"
                                        disabled$ = "[[subitem.disabled]]"
                                        onchange = "addSubItem(this)"
                                    >
                                        <div>
                                            {{subitem.des}}
                                            <span class="xprecio" hidden$ = [[!subitem.precio_visible]]>
                                                (+ {{subitem.precio}})
                                            </span>
                                            <span class="xprecio" hidden$ = [[!subitem.cantidad_visible]]>
                                                | [[subitem.cantidad]]
                                            </span>
                                        </div>
                                    </paper-checkbox>
                            </div>                   
                        </template>
                    </div>
                </div>
            </div>

            <div class="xdlgBody" id="_xdlgBody">
			  <div class="spinner"><paper-spinner active></paper-spinner></div>
			</div>
			<br/>
			<div class="xBoton2 xPlomo xInvisible divLeft23" id="dlgBtn" onclick="xListoDlgVR_comp();">
			  Cerrar
			</div>
			<br/><br/>
		</paper-dialog>
    </template>
</dom-module>
<style>
    .subitem-content {
        display: inline-flex;
        width: 100%;
        padding-bottom: 20px;
        background: lightgoldenrodyellow;
        padding: 5px;
        flex-wrap: wrap;
        margin-top: 20px;
        margin-bottom: 20px;
        border-top: 1px solid #bdbdbd;
        border-bottom: 1px solid #bdbdbd;
    }

    .subitem-content .xoption {
        display: inline-flex;  
        padding-right: 8px;
        min-width: 150px;
        font-size: 12px;
    }

    .subitem-content .xoption .agotado {
        text-decoration: line-through;
        color: palevioletred;
    }

    .subitem-content .xoption .xprecio {
        font-size: 10px;
        color: #757575;
    }

    .xstock_item.xstock_item-redondo {
        border-radius: 50%;
        padding: 8px 10px 8px 10px;
    }

    .xhidden {
        display: none !important;
    }

</style>
<script>
	var xThisComSubItem, itemPedidos_objItemSelected, isExistSubitems = false;

    function xOpenDlgItemVR_comp(tpc, id) {
        
        // itemPedidos_objItemSelected = xThisComSubItem.item_select
        itemPedidos_objItemSelected = xArrayPedidoObj[tpc][id];        
        xThisComSubItem.cantSubItemSelect = itemPedidos_objItemSelected.subitem_cant_select;
        xThisComSubItem.isSubItemReq = itemPedidos_objItemSelected.subitem_cant_select === '1' ? true : false; 
        
        // itemPedidos_objItemSelected.subitems_selected = [];

        if (  itemPedidos_objItemSelected.subitems ) {
            if ( typeof itemPedidos_objItemSelected.subitems !== "object" ) {
                itemPedidos_objItemSelected.subitems = JSON.parse(itemPedidos_objItemSelected.subitems);
                
            }
            xThisComSubItem.listSubItems = [];
            xThisComSubItem.listSubItems = itemPedidos_objItemSelected.subitems;
            isExistSubitems = true;
            $('.contet-subitem').removeClass('xhidden');
        } else {
            xThisComSubItem.listSubItems = [];
            isExistSubitems = false;
            $('.contet-subitem').addClass('xhidden');
        }

        cocinarListSubItemsView();

        xidItem = id; // $(obj).attr("data-id");
        xTituloDet = itemPedidos_objItemSelected.des_seccion; // $(obj).attr("data-seccion");
        var xidsecc_item = itemPedidos_objItemSelected.idseccion // $(obj).attr("data-idseccion");
        , xidproc_item = itemPedidos_objItemSelected.procede //$(obj).attr("data-procede");
        , xCantArray
        , xindicaciones = ''
        , xidTipoConsumoItem;

        $("#_xdlgBody")
        .html(
            '<div class="xCentradoVerticalHorizontal spinner"><paper-spinner active></paper-spinner></div>'
        )
        .trigger("create");
        $("#dlgBtn").addClass("xInvisible");
        xLoadItemMiPedidoVR_comp(xidItem, xidsecc_item, xidproc_item);

        

        dialog_item_comp.open();
        // objOptionItemSelect.checked = false;
    }

    function xRefresSubItems_comp() {
        // var listUpdate = [];
        xThisComSubItem.listSubItems = [];
        xThisComSubItem.listSubItems = JSON.parse(JSON.stringify(itemPedidos_objItemSelected.subitems)); 
        // itemPedidos_objItemSelected.subitems.map((asub) => {
		// 	xThisComSubItem.listSubItems.filter((bsub) => asub.iditem_subitem === bsub.iditem_subitem)[0].cantidad = asub.cantidad;
		// });       
        // cocinarListSubItemsView();
        // xThisComSubItem.listSubItems = listUpdate;
    }

    function cocinarListSubItemsView() {
        if (xThisComSubItem.listSubItems.length > 0) {
            xThisComSubItem.listSubItems.map( x => {                
                x.iditem_subitem = x.id;                
                x.precio_visible = parseFloat(x.precio) === 0 ? false : true;
                x.cantidad_visible = isNaN(parseFloat(x.cantidad)) ? false : true;
                x.selected = false;
            });
        }

        $('.check-subitem').each((i, e) => {        
                e.checked = false;            
        });
    }

    function xListoDlgVR_comp() {
        xVerMipedidoVR();
        dialog_item_comp.close();
    }

    function addSubItem(obj) {
        const index = obj.dataId;
        var subitem = xThisComSubItem.listSubItems[index];
        subitem.selected = obj.checked;


    // subitem.selected = !subitem.selected;

    // if ( subitem.selected ) {
      const listSubItemChecked = xThisComSubItem.listSubItems.filter((x) => x.selected);
      let countSelectReq = listSubItemChecked.length;

      // adicional el importe al precio del item
      const precioSubIem = itemPedidos_objItemSelected.precio_unitario;
      itemPedidos_objItemSelected.precio = parseFloat(parseFloat(precioSubIem) + parseFloat(subitem.precio)).toFixed(2);

      // $('.xprecio_item').text(itemPedidos_objItemSelected.precio);
      // itemPedidos_objItemSelected.precio_total = parseFloat(itemPedidos_objItemSelected.precio);


      listSubItemChecked.map( (_subItem, i) =>  {
        if (countSelectReq > itemPedidos_objItemSelected.subitem_cant_select && _subItem !== subitem) {
          _subItem.selected = false;
          countSelectReq--;

            $('.check-subitem').each((i, e) => {
                var __subitem = xThisComSubItem.listSubItems[i];
                if ( __subitem === _subItem ) {
                    e.checked = false;
                }
            });
        }
      });

    //   $('.check-subitem').each((e, i) => {
    //     var _subitem = xThisComSubItem.listSubItems[i];        
    //   });
        itemPedidos_objItemSelected.subitems_selected = [];
        const listChecks = listSubItemChecked.filter((x) => x.selected);
        itemPedidos_objItemSelected.subitems_selected =  listChecks;

    // }
    }

    function xLoadItemMiPedidoVR_comp(xid, xidseccion, xprocede) {
    //$.ajax({ type: 'POST', url: '../../bdphp/log.php?op=303', data:{i:xid}})
    // $.ajax({
    //   type: "POST",
    //   url: "../../bdphp/log.php?op=303",
    //   data: { i: xid, p: xprocede }
    // }).done(function(dtItem) {	  
	  itemPedidos_objItemSelected.idcarta_lista = itemPedidos_objItemSelected.iditem;
	  itemPedidos_objItemSelected.des_item = itemPedidos_objItemSelected.des;

	  var xdtItem = itemPedidos_objItemSelected; //$.parseJSON(dtItem);
	  
	  
      // xdtItem = xdtItem.datos;

      var xClassEstadoStock = ''
      , xCadena_foto = ''
      , xCadena_des = ''
      , xCadenaItem_des_foto = ''
      , xCadenaItem_encabezado = ''
      , xCadenaItem_Detalle = ''
      , xCadenaItem = '', xClassStockRedondo = '';

      var xCantItem = xdtItem.stock_actual; //xdtItem.cantidad;
      xClassEstadoStock = xClassEstadoItem(xCantItem);
      xClassEstadoStock = xClassEstadoStock.split("|")[1];
      xClassStockRedondo = isExistSubitems ? 'xstock_item-redondo ' : '';


      xCadenaItem_encabezado =
        '<input class="xcheck_item" type="radio" name="option" value="other">' +
        '<p class="xprecio_item xEnLinea">' +
        xdtItem.precio +
        "</p>" +
        '<div class="xstock_item ' + xClassStockRedondo +
        xClassEstadoStock + 
        '"><span>stock</span><p>' +
        xCeroIzq(xCantItem, 2) +
        "</p></div>" +
        '<p class="xtitulo_item xEnLinea">' +
        xdtItem.des_item +
        "</p>";

      xCadenaItem_des_foto = "";
      if (xdtItem.img) {
        xCadena_foto = '<img src="../img/' + xdtItem.img + '">';
        xCadenaItem_des_foto = "1";
      }
      if (xdtItem.detalle) {
        xCadena_des =
          '<div class="xsub_titulo_item">' +
          xMayusculaPrimera(xdtItem.detalle || '') +
          "</div>";
        xCadenaItem_des_foto = "1";
      }
      if (xCadenaItem_des_foto == "1") {
        xCadenaItem_des_foto =
          '<div class="xdescripcion_foto">' +
          xCadena_des +
          xCadena_foto +
          "</div>";
      } else {
        xCadenaItem_des_foto = "";
      }

      xCadenaItem_Detalle =
        '<div id="subitems"></div>' +
        '<div class="xdetalle_item">' +
        xCadenaItem_des_foto +
        '<div class="xreferencia_item"><input type="text" autocomplete="on" placeholder="Escribe aqui las especificaciones..." class="xMiTextReferencia" id="txt_referencia"></div>' +
        xCadenaTC +
        "</div></div>";

      //xCadenaItem=String(xCadenaItem+'<div class="xmenu_item_2 xitem_seleccionado_pedido" data-id="'+xdtItem.idcarta_lista+'" data-item="'+xdtItem.iditem+'" data-idseccion="'+xdtItem.idseccion+'" '+

      // el idseccion_index viene '11.1' - esto hace que cree otra seccion al modificar
      const _idseccionIndex = xdtItem.idseccion_index.split(".")[0];

      xCadenaItem = String(
        xCadenaItem +
          '<div class="xmenu_item_2 xitem_seleccionado_pedido" ' +
          'data-id="' +
          xdtItem.idcarta_lista +
          '" ' +
          'data-item="' +
          xdtItem.iditem +
          '" ' +
          'data-idseccion="' + xdtItem.idseccion +'" ' +
          'data-desseccion="' + xdtItem.des_seccion +'" ' +
          'data-idseccionindex="' +
          _idseccionIndex +
          '" ' +
          'data-idbus="' +
          xdtItem.idseccion +
          '" ' +
          'data-idimpresora="' +
          xdtItem.idimpresora +
          '" ' +
          'data-idprocede="' +
          xdtItem.idprocede +
          '" ' +
          'data-procede="' +
          xdtItem.procede +
          '" ' +
          'data-procedeindex="' +
          xdtItem.procede_index +
          '" ' +
          'data-imprimircomanda="' +
          xdtItem.imprimir_comanda +
          '" ' +
          'data-iddescontar="' +
          xdtItem.idprocede +
          '" ' +
          'data-cant_descontar="' +
          xdtItem.cant_descontar +
          '" ' +
          'data-idalmacen_items="' +
          xdtItem.idalmacen_items +
          '">' +
          xCadenaItem_encabezado +
          xCadenaItem_Detalle
      );

      $("#_xdlgBody .spinner").remove();
      $("#_xdlgBody")
        .html(xCadenaItem)
        .trigger("create");
      $("#dlgBtn").removeClass("xInvisible");
      //dialog_item.sizingTarget();
      dialog_item_comp.center();

      $('#_xdlgBody')
        .find('div.xmenu_item_2 .xpedir_row')
        .each(function(a, element) {
          xidTipoConsumoItem = $(element).attr("data-id");
          if (xArrayPedidoObj[xidTipoConsumoItem][xidItem] != null) {
            xidTipoConsumo = xidTipoConsumoItem;
            xCantArray = xArrayPedidoObj[xidTipoConsumo][xidItem].cantidad;
            xindicaciones = xArrayPedidoObj[xidTipoConsumo][xidItem].indicaciones;
            $(element)
              .find(".xCant_item")
              .text(xCeroIzq(xCantArray, 2));
          }
        });
        dialog_item_comp.center();
      $(".xmenu_item_2")
        .find("#txt_referencia")
        .val(xindicaciones);
    // });
    }
		

	Polymer({
		is: 'x-comp-item-subitems',
		properties: {
            item_select: Object,
            listSubItems: {
                type: Object,
                notify: true,
                reflectToAttribute: true            
            },
            cantSubItemSelect: Number,
            isSubItemReq: Boolean,
            isExistSubItems: Boolean
		},
		attached: function () {
            xThisComSubItem = this;				
            xThisComSubItem.cantSubItemSelect = 0 ;
        },
        openDialog: function(tpc, id) {
            xOpenDlgItemVR_comp(tpc, id);
        },
        refreshSubItems: function () {
            xRefresSubItems_comp();
        }
	})
</script>
