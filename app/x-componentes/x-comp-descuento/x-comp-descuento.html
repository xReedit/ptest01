
<dom-module id="x-comp-descuento">
	<template>
        <!-- <x-pass id="pass_us_dsct" titulo="Usuario autorizado" valor="Pe5"></x-pass> -->
        <div>
            <!-- boton visible -->
            <div class="animate__animated animate__fadeIn animate__faster" hidden$="[[ showDetalle ]]">
                <div class="d-flexx btn-descuento" onclick="xVerificarPermisoDscUsuario()">
                    <div class="p-2 bg-warning">
                        <i class="fa fa-sort-numeric-desc"></i>
                    </div>
                    <p class="pl-2 fs-13">Aplicar Descuento</p>                
                </div>
            </div>
            <!-- boton visible -->

            <!-- accion -->
            <div class="animate__animated animate__fadeIn animate__faster" hidden$="[[ !showDetalle ]]">
                <div class="d-flexx align-content-center justify-content-end">
                    <div class="pr-1">
                        <select class$="[[classselect]]" onchange="selectedDsc(this)">
                            <template is="dom-repeat" items="{{listTipoConceptos}}" as="item">
                                <option value="{{ item.idtipo_descuento }}">{{ item.descripcion }}</option>
                            </template>                                                        
                        </select>
                    </div>

                    <div class="content-text-improte pr-1">
                        <input type="text" class="text_importe fs-16" id="txt_imp_dsc" autocomplete="off" onblur="xFocusInputDescuento(false)" onfocus="xFocusInputDescuento(true)" onkeyup="xCalcImporteDsc()" on-keypress="validarDsct">
                    </div>

                    <div class="pl-1">
                        <button class="btn btn-sm btn-danger" on-click="resetDsc" onclick="xShowDetalleDsc()">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>
                <p style="text-align: right;" hidden$="[[!msjCupon.visible]]" class$="[[msjCupon.color]]">{{msjCupon.label}}</p>
            </div>

        </div>
    </template>
</dom-module>
<style>
    .btn-descuento {
        border: 1px solid #bdbdbd;
        border-radius: 3px;
        align-items: center;
        width: 160px;
        display: flex;
        cursor: pointer;
    }

    .btn-descuento:hover {
        background: #eeeeee;
    }

    .content-text-improte {
        border: 1px solid #bdbdbd;
        border-radius: 3px;
        display: flex;
        align-items: center;
        max-width: 100px;
    }

    .content-text-improte:hover {
        background: #eeeeee;
    }

    .text_importe {
        border: 0px;       
        text-align: end !important; 
        max-width: 90px;
    }

    .text_importe:focus {
        outline:none;
    }

</style>
<script>
    var xThisCompDesc, datauSPerDsc, paseAccPer = false, keyDscStorage = '::app3_sys_tpdsc', tipoDscSelectedb, importeInicial = 0, lastValCalc = 0, xPermisoSupervisorDsc;

    function xShowDetalleDsc() {        
        xThisCompDesc.showDetalle = !xThisCompDesc.showDetalle;

        if ( xThisCompDesc.showDetalle ) {
            xThisCompDesc.$.txt_imp_dsc.value = '';
            xThisCompDesc.$.txt_imp_dsc.focus();
        } else {

            xThisCompDesc.fire('changeDescuento', {
                'value': 0,
                'descripcion': '',
                'isAgregar': false
            });
        }

        xThisCompDesc.msjCupon = {
            visible: false,
            label: '',
            color: ''
        }

        xThisCompDesc.$.txt_imp_dsc.disabled = false;        


        // console.log('importeventa', xThisCompDesc.importeventa);
    }

    function xVerificarPermisoDscUsuario() {
        paseAccPer = datauSPerDsc.per.indexOf('Pe5') > -1;
        if ( !paseAccPer ) {

            // xPSupervisorDesc=document.getElementById('pass_us_dsct');
            xPSupervisor.setVal('Pe5');
            xPSupervisor.addEventListener('xSendPe5', function (e) {
                var p=e.detail.xRpts[0].p;
                if(p===1){
                    xPermisoSupervisorDsc=e.detail.xRpts[0].us;                                        
                    xShowDetalleDsc();
                    return;
                    
                    // e.stopPropagation();
                    // e.stopImmediatePropagation()
                }
            });

            pass_us.open();
            return;
        }

        xShowDetalleDsc();
        
    }

    function xResetCompDsc() {
        xThisCompDesc.showDetalle = false;
        xThisCompDesc.$.txt_imp_dsc.value = '';
        lastValCalc = 0;
        // xCalcImporteDsc();
    }

    function xLoadTipoDsc() {
        var paseDsc = false;
        var _dtDscStorage = localStorage.getItem(keyDscStorage);

        xThisCompDesc.$.txt_imp_dsc.value === ''

        if ( _dtDscStorage ) {
            try {                
                xThisCompDesc.listTipoConceptos = JSON.parse(_dtDscStorage);
                paseDsc = true;
                tipoDscSelectedb = xThisCompDesc.listTipoConceptos[0];
                xThisCompDesc.tipoDscSelected = tipoDscSelectedb;
                // console.log('xThisCompDesc.listTipoConceptos desde el storage', xThisCompDesc.listTipoConceptos);
            } catch (error) {
                paseDsc = false
            }
        }

        if ( paseDsc ) { return; }


        $.ajax({
					type: 'GET',
					url: '../../bdphp/log_componentes.php?op=14'
				})
				.done(function (res) {
                    res = JSON.parse(res)
                    if ( !res.success ) { console.log('error', res); return; }
                    xThisCompDesc.listTipoConceptos = res.datos;

                    tipoDscSelectedb = xThisCompDesc.listTipoConceptos[0];

                    localStorage.setItem(keyDscStorage, JSON.stringify(res.datos));

                    // console.log('xThisCompDesc.listTipoConceptos ', xThisCompDesc.listTipoConceptos );
                });
    }

    function selectedDsc(obj) {        
        tipoDscSelectedb = xThisCompDesc.listTipoConceptos[obj.selectedIndex];
        // xThisCompDesc.$.txt_imp_dsc.value = '';
        xCalcImporteDsc();

        xThisCompDesc.$.txt_imp_dsc.focus();
        xThisCompDesc.tipoDscSelected = tipoDscSelectedb;

        try {
            xThisCompDesc.$.txt_imp_dsc.selected();            
        } catch (error) {            
        }
    }

    function xCalcImporteDsc() {
        // si es cupon de descuento
        if (tipoDscSelectedb.idtipo_descuento === '3') return;

        const isDestPorcentaje = tipoDscSelectedb.idtipo_descuento === '2';
        var rptCalc = 0, descripcionDesct = '';
        var importeTotalPedido = xThisCompDesc.importeventa;

        importeInicial = xThisCompDesc.$.txt_imp_dsc.value === '' ? 0 : importeInicial;
        if ( importeInicial === 0 ) { importeInicial = importeTotalPedido + lastValCalc; }
        var limiteCantidadDsc = isDestPorcentaje ? 100 : importeInicial;

        var valtxt = parseFloat(xThisCompDesc.$.txt_imp_dsc.value) || 0;
        if ( valtxt ===  lastValCalc) {return; }

        if ( valtxt  >  limiteCantidadDsc ) {
            valtxt = limiteCantidadDsc;
            xThisCompDesc.$.txt_imp_dsc.value = valtxt;
        }

        // if ( isDestPorcentaje ) {
        //     rptCalc = Math.round((importeInicial * (valtxt / 100)), 2);        
        //     rptCalc = rptCalc > importeInicial ? importeInicial : rptCalc;
        //     descripcionDesct = valtxt + '%'; 
        // } else {
        //     rptCalc = valtxt;
        // }

        if (isDestPorcentaje) {
            rptCalc = roundToNearestDecimal(importeInicial * (valtxt / 100));
            rptCalc = rptCalc > importeInicial ? importeInicial : rptCalc;
            descripcionDesct = valtxt + '%';
        } else {
            rptCalc = valtxt;
        }

        lastValCalc = rptCalc;

        xThisCompDesc.importeDsc = rptCalc;
        xThisCompDesc.fire('changeDescuento', {
			'value': rptCalc,
            'descripcion': descripcionDesct,
            'isAgregar': true
		});
    }

    function roundToNearestDecimal(value) {
        return Math.round(value * 10) / 10;
    }

    function xFocusInputDescuento(value) {
        xThisCompDesc.fire('focus-input', value)
    }

    Polymer({
		is: 'x-comp-descuento',
		properties: {
            showDetalle: Boolean,
            listTipoConceptos: [],
            importeDsc: {
                type: Number,
                notify: true,
                reflectToAttribute: true,
                value: 0
            },
            importeventa: {
                type: Number,
				notify: true,
				reflectToAttribute: true,
				value: 0
            },
            tipoDscSelected: {
                type: Object,
                notify: true,
                reflectToAttribute: true,
                value: {}
            },
            classselect: {
                type: String,
                value: 'selected-template-1 fs-15'
            },
            msjCupon: {
                type: Object,
                value: {
                    visible: false,
                    label: '',
                    color: ''
                }
            },
            cuponSeleted: {
                type: Object,
                value: {}
            },
            nomTablePedido: {
                type: String,
                value: 'tb_det_pedidos' // table de control pedidos
            }
		},
		attached: function () {
            this.showDetalle = false;
            xThisCompDesc = this;
            datauSPerDsc = xm_log_get('app3_us');

            xLoadTipoDsc();           
        },
        reset: () => {
            xResetCompDsc();
        },
        setVisible: (value)=> {
            xThisCompDesc.showDetalle = value;
        },
        validarDsct: async(e) => {
            if ( e.keyCode === 13 ) {
                // si es 
                if (tipoDscSelectedb.idtipo_descuento === '3') {
                    console.log('verificar cupon de descuento', e.target.value);
                    const rptCupon = await aplicarCuponDsct(e.target.value, xThisCompDesc.nomTablePedido);
                    console.log('¿Cupón válido?', rptCupon);


                    xThisCompDesc.msjCupon = {
                        visible: false,
                        label: '',
                        color: ''
                    }

                    setTimeout(() => {
                        xThisCompDesc.msjCupon = {
                            visible: true,
                            label: rptCupon.aplica ? 'Cupón válido' : 'Cupón no válido',
                            color: rptCupon.aplica ? 'fw-600 text-success animate__animated animate__flash' : 'fw-600 text-danger animate__animated animate__flash'
                        }
                    }, 200);
                

                    if ( !rptCupon.aplica ) { 
                        xThisCompDesc.cuponSeleted = null;
                        return;
                    } else {
                        // const importeDescuento = rptCupon.importeDsct;                          
                        xThisCompDesc.cuponSeleted = rptCupon;
                        xThisCompDesc.fire('changeDescuento', {
                            'value': rptCupon.importeDsct,
                            'descripcion': `por cupón ${e.target.value}`,
                            'isAgregar': true
                        });  
                        
                        xThisCompDesc.importeDsc = rptCupon.importeDsct;
                        // e.target disabled
                        e.target.disabled = true;
                    }
                } 
            }
        },
        resetDescuento: () => {
            xThisCompDesc.msjCupon = {
                visible: false,
                label: '',
                color: ''
            }

            xThisCompDesc.$.txt_imp_dsc.value = '';
            xThisCompDesc.$.txt_imp_dsc.disabled = false;
            xThisCompDesc.$.txt_imp_dsc.focus();

        },
        getCuponDescuento: () => {
            return xThisCompDesc.cuponSeleted || {};
        },
        get: () => {            
            if ( xThisCompDesc.tipoDscSelected ) {
                var valtxt = xThisCompDesc.$.txt_imp_dsc.value || 0;
                xThisCompDesc.tipoDscSelected.importe = xThisCompDesc.importeDsc || 0
                xThisCompDesc.tipoDscSelected.valor = valtxt;
            } else {
                xThisCompDesc.tipoDscSelected = {};
            }            
            return xThisCompDesc.tipoDscSelected;
        },
        resetDsc: () => {
            xThisCompDesc.importeDsc = 0;
            this.tipoDscSelectedb = null;
            xThisCompDesc.tipoDscSelected = null;
        }
	})
</script>