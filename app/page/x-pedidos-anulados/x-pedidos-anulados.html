<link rel="import" href="../../web_components/polymer/polymer.html">
<dom-module id="x-pedidos-anulados">

    <!-- <link rel="stylesheet" href="../../../css/picket-classic.css">
    <link rel="stylesheet" href="../../../css/picket-classic.date.css">
    <script src="../../../js/picket.legacy.js"></script>
    <script src="../../../js/picket.js"></script>
    <script src="../../../js/picket.date.js"></script> -->

    <template is="dom-bind">
    <div class="p-3" style="max-width: 1200px !important; margin: 0 auto;">
        <div class="pl-2 mb-2">            
            <h3>Pedidos Anulados</h3>
            <input type="text" class="selected-template-1 xCursor" id="pick-date"  placeholder="Elige fecha">
        </div>
        <div>
            <table class="w-100 content-table-delivery fs-12" style="min-width: 600px;">
                <thead>
                    <th align="center">#</th>
                    <th align="left">Fecha</th>
                    <th align="left" style="max-width: 200px;">Usuario</th>                    
                    <th align="left">Pedido</th>
                    <th align="left">Detalle</th>
                </thead>
                <tbody>
                    <template is="dom-repeat" items="{{listPedidosBorrados}}" as="item">
                        <tr>
                            <td align="center">                                                                
                                <p class="fw-600 fs-18">{{item.num}}</p>
                                <i hidden$="[[!item.isCerrado]]" class="fa fa-lock"></i>
                            </td>
                            <td>
                                <p class="fw-600">{{ item.fecha }}</p>
                                <p>{{ item.hora }}</p>
                            </td>
                            <td>
                                <p>{{ item.usuario}}</p>
                                <p title="Autorizo"> <i class="fa fa-key text-success fw-900"></i>  {{ item.usuario_autoriza }} </p>
                                <p><strong>Motivo:</strong> <span class="text-danger fw-600">{{ item.motivo_anular }}</span></p>
                            </td>                            
                            <td>
                                <p>{{ item.idpedido }}</p>
                                <p class="fw-900 ">{{ item.tp }}</p>
                                <p hidden$="[[!item.isShowMesa]]" class="badge badge-primary"><span class="fs-15">MESA {{item.nummesa}}</span></p>
                            </td>
                            <td>
                                <p hidden="[[ !item.isShowRecuperaStock ]]" class="badge badge-success">Stock Recuperado</p>
                                <p hidden="[[ item.isShowRecuperaStock ]]" class="badge badge-danger">Stock No Recuperado</p>
                                <template is="dom-repeat" items="{{item.items}}" as="row">
                                    <div class="d-flexx justify-content-between">
                                        <p>{{ row.cantidad }}  {{ row.descripcion }}</p>
                                        <p>{{ row.importe }}</p>
                                    </div>
                                </template>
                            </td>
                        </tr>
                    </template>
                    <tr>
                        <td colspan="4" align="right" class="fw-600"></td>
                        <td align="right" style="padding: 10px;"><span class="fw-600 fs-18">{{ convertRowFixed(importeTotal) }}</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    </template>

    <style>
        .content-table-delivery {
            padding: 15px 0px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .content-table-delivery tr>td {
            border-bottom: 8px solid #e5e5e7;
        }
    </style>

    <script>
        var xThisPB;

        function xPBLoad() {
            
            $("#Titulo_page").text("Pedidos Anulados");

            $('#pick-date').pickadate({
                format: 'dd mmmm, yyyy',
                today: 'Hoy',
                clear: 'Borrar',
                close: 'Cerrar',                
                onSet: function(context) {                     
                    const _fecha = context.select ? new Date(context.select).toLocaleDateString() : '';
                    xPBGetData(_fecha);
                }
            });

            xPBGetData('');

        }

        function xPBGetData(fecha) {
            const _fecha = fecha;
            var _importeTotal = 0;

            $.ajax({ type: 'POST', url: '../../bdphp/log_009.php?op=9', data: {f: _fecha}})
	        .done( function (res) { 
                res = JSON.parse(res);                
                console.log('res', res, _fecha);
                var _numrows = res.datos.length;                
                xThisPB.listPedidosBorrados = res.datos.map(x => {
                    
                    x.num = _numrows;
                    x.items = JSON.parse(x.items);
                    const _motivoAnuladoItems = x.items[0].motivo ? x.items[0].motivo : 'No indico';  

                    x.isCerrado = x.fecha_cierre !== '' ? true : false;
                    x.isShowMesa = x.nummesa != 0;
                    x.motivo_anular = x.motivo_anular ? x.motivo_anular : _motivoAnuladoItems;
                    x.isShowRecuperaStock = x.recupera_stock == '1' ? true : false;
                    _importeTotal += x.items.map(z => parseFloat(z.importe)).reduce((a, b) => a + b, 0);
                    _numrows--;
                    return x;
                });                


                xThisPB.importeTotal = _importeTotal;
            });
        }
        
        Polymer({
            is: 'x-pedidos-anulados',
            properties: {   
               listPedidosBorrados: [],
               importeTotal: Number
            },
            attached: function () {                                
                xThisPB = this;       
                xPBLoad();     
            },
            convertRowFixed: (obj) => {
                return obj.toFixed(2)
            }
        });
    </script>
</dom-module>