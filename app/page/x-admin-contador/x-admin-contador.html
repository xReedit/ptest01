<script src="../../view/xApiConsultaSunat.js"></script>
<script src="../../view/httpFech.js"></script>
<dom-module id="x-admin-contador">
	<template is="dom">

		<!-- Dialog que ofrece los formatos de descarga de los reportes -->
		<paper-dialog id="dialog_reporte_formato" class="dialog_redondo" style="max-width: 380px" entry-animation="scale-up-animation"
			exit-animation="fade-out-animation">
			<div class="p-3 text-center">
				<p class="fs-18">Selecciona el formato</p>
				<br>
				<div class="divBtnReporte">
					<button class="btn btn-sm btn-primary" onclick="downloadReporteCPE_f1()">Formato 1</button>
					<button class="btn btn-sm btn-success mt-2" onclick="downloadReporteCPE_f2()">Formato SIRE</button>
					<button class="btn btn-sm btn-success mt-2" onclick="downloadReporteCPE_f3()">Formato SIRE TXT</button>
				</div>
			</div>
		</paper-dialog>

		<paper-dialog id="dialog_match_sunat" class="dialog_redondo" modal style="min-width: 330px; max-width: 400px" modal entry-animation="scale-up-animation"
            exit-animation="fade-out-animation">
			<div class="p-2 text-center">
				<div>
					<img src="../../../images/scan_docs_sunat.gif" alt="img_match">
				</div>
				<div hidden$="[[ showProccessVerificationFinalize ]]">
					<paper-progress indeterminate></paper-progress>
				</div>
				<p class="fs-15 fw-600">Verificando el estado de los comprobantes con Sunat. <span class="text-success">{{numRowsVerificadoSuccess}}</span> de {{ numRowsList}}</p>
				<div hidden$="[[ !showRowsNoResponse ]]">
					<br>
					<div class="xLinea2"></div>
					<br>
					<p class="fs-15 fw-600">Sin respuesta: <span class="text-danger">{{numRowsVerificadoError}}</span></p>
					<div class="d-flexx justify-content-center" hidden$="[[ !showProccessVerificationFinalize ]]">
						<button class="btn btn-sm btn-info mr-2" onclick="downloadReporteCPE()">Verificar Nuevamente ({{numRowsVerificadoError}})</button>
						<button class="btn btn-sm btn-success" onclick="setDataListReporte()">Descargar</button>
					</div>
				</div>

				<div hidden$="[[ !showProccessVerificationError ]]">
					<br>
					<div class="xLinea2"></div>
					<br>
					<p class="fw-600 text-danger">Ocurrio un error al procesar</p>
					<button class="btn btn-sm btn-info mr-2" onclick="downloadReporteCPE()">Procesar Nuevamente</button>
				</div>
			</div>
        </paper-dialog>


		<br>
		<div class="xMiCard xradius" style="width:calc(100% - 10%); height: calc(100vh - 120px);">
			<div class="xEncanezadoCard xFondoRowAmarillo4">
				<strong>Reportes de facturacion electronica</strong><br>
				Para leer los reportes descargados debe contar con Microsof Excel instalado, o cualquier otro programa de calculo que lea archivos ".xml" <br>
				Para asignar mas Establecimientos o para soporte tecnico, comuniquese con nosotros a <a
					href="https://papaya.com.pe/" target="_blank">papaya.com.pe</a>
			</div>
			<div class="xContent">
				<div class="x_div_linea">					
					<div class="xitem1 xBordeDe" style="height: calc(100vh - 185px)">
						<br>
						<h4>Estableciminetos Asignados</h4>		
						<div class="xLinea2"></div>
						<br>
						<table width="100%">
							<thead>
								<th>#</th>
								<th>Razon social</th>
								<th>Ciudad</th>
							</thead>
							<tbody>
								<template is="dom-repeat" items="{{listAsignados}}" as="item">
									<tr id="{{index}}" class="animated fadeIn fast xCursor" onclick="selectEsablecimiento(this);">
										<td class="xfont11">{{displayIndex(index)}}</td>
										<td class="xfont11">{{item.razonsocial}} | {{item.nomsede}}</td>										
										<td class="xfont11">{{item.ciudad}}</td>										
									</tr>
								</template>
							</tbody>
						</table>
					</div>
					<div class="xitem2 xBordeIzqHover">
						<br>
						<h4>{{selEstablecimiento.nomsede}} | {{selEstablecimiento.ciudad}}</h4>
						<div class="xLinea2"></div>
						<br>
						<div style="width: 120px;">
							<label for="selYear" class="xColorRow_Plomo">Seleccione Año:</label>
							<select id="selYear" class="xTextRow2 xCursor" onchange="selectOptionYear()">
								<template is="dom-repeat" items="{{listYears}}" as="item">
									<option value="[[index]]">[[item.y]] </option>
								</template>
							</select>
						</div>
						<br>
						<table width="100%">
							<thead>
								<th width="15px">#</th>
								<th>Mes</th>
								<th>Estado</th>
								<th>Acción </th>
							</thead>
							<tbody>
								<template is="dom-repeat" items="{{listMonth}}" as="item">
									<tr id="{{index}}" class$="{{item.clase}}" onclick="selectedRowTR(this)">
										<td class="xfont11">{{displayIndex(index)}}</td>
										<td class="xfont11">{{item.mes}}</td>
										<td class="xfont11">{{item.desestado}}</td>										
										<td class="xfont11">
											<!-- <div>
												<a class="xCursor" onclick="downloadReporteCPE_open_dialog(this)">Descargar <i class="fa fa-download"></i></a>													
											</div> -->
											<div hidden$="{{!item.activo}}" onclick="downloadReporteCPE_open_dialog(this)">
												<a class="xCursor">Descargar <img src="../../../images/x_down2.png" alt=""></a>
											</div>
										</td>
									</tr>
								</template>
							</tbody>
						</table>
					</div>				
				</div>				
			</div>
		</div>	

		<!-- reporte comprobantes exportar -> excel -->
		<!-- <button onclick="xGenerarReporteExcel()">Exportar</button> -->
		<div id="reporte" class="xInvisible">

			<table id="testTable" width="100%">
				<caption>
					<h1>{{selEstablecimiento.nomsede}} | {{selEstablecimiento.ciudad}}</h1>					
					<h2>Reporte de comprobantes electronicos - {{selMes.mes}}</h2>
				</caption>
				<thead>
					<th width="45px">#</th>
					<th width="15%">f. Emision</th>					
					<th>Tipo</th>
					<th>Numero</th>
					<th width="35%">Cliente</th>
					<th width="15%">RUC/DNI</th>
					<th align="right">Sub total</th>
					<th align="right">I.G.V</th>
					<th align="right">Total</th>
					<th>Estado Sistema</th>
					<th>
						Estado Sunat						
					</th>
				</thead>
				<tbody>
					<template is="dom-repeat" items="{{ListReporte}}" as="row">
						<tr>
							<td>{{displayIndex(index)}}</td>
							<td style$="{{row.style_td}}">{{row.fecha}}</td>							
							<td style$="{{row.style_td}}">{{row.tipo_doc}}</td>
							<td style$="{{row.style_td}}">{{row.num_doc}}</td>
							<td style$="{{row.style_td}}">{{row.nom_cliente}}</td>							
							<td style='mso-number-format:"@"'>{{row.ruc}}</td>
							<td style$="{{row.style_td}}">{{row.subtotal}}</td>
							<td style$="{{row.style_td}}">{{row.igv}}</td>
							<td style$="{{row.style_td}}">{{row.total}}</td>
							<td style$="{{row.style_reporte}}">{{row.estado}}</td>
							<td style$="{{row.style_estado_sunat}}">{{row.estadoCp}}</td>							
						</tr>
					</template>
				</tbody>
			</table>

		</div>

		<div id="reporte-sire" class="xInvisible">
		
			<table id="testTableSire" width="100%">
				<caption>
					<h1>{{selEstablecimiento.nomsede}} | {{selEstablecimiento.ciudad}}</h1>
					<h2>Registro de Ventas - {{selMes.mes}}</h2>
				</caption>
				<thead>					
					<th width="45px">#</th>
					<th>Ruc</th>
					<th>Razon Social</th>
					<th>Periodo</th>
					<th>CAR SUNAT</th>
					<th width="15%">Fecha de emisión</th>
					<th width="15%">Fecha Vcto/Pago</th>
					<th>Tipo CP/Doc.</th>
					<th>Serie del CDP</th>
					<th>Nro CP o Doc</th>
					<th>Nro Final</th>
					<th width="15%">Tipo Doc Identidad</th>
					<th width="15%">Nro Doc Identidad</th>					
					<th width="35%">Apellidos Nombres/ Razón Social</th>					
					<th>Valor Facturado Exportación</th>
					<th>BI Gravada</th>
					<th>Dscto BI</th>
					<th>IGV / IPM</th>
					<th>Dscto IGV / IPM</th>
					<th>Mto Exonerado</th>
					<th>Mto Inafecto</th>
					<th>ISC</th>
					<th>BI Grav IVAP</th>
					<th>IVAP</th>
					<th>ICBPER</th>
					<th>Otros Tributos</th>
					<th>Total CP</th>
					<th>Moneda</th>
					<th>Tipo Cambio</th>
					<th>Fecha Emisión Doc Modificado</th>
					<th>Tipo CP Modificado</th>
					<th>Serie CP Modificado</th>
					<th>Nro CP Modificado</th>
					<th>ID Proyecto Operadores</th>
					<th>Atribución</th>
					<th>Tipo de Nota</th>
					<th>Est. Comp</th>
					<th>Desc. Comp</th>										
					<th>Valor FOB Embarcado</th>
					<th>Valor OP Gratuitas</th>
					<th>Tipo Operación</th>
					<th>DAM / CP</th>
					<th>CLU</th>					
					<th>Estado Sistema</th>
					<th>Estado Sunat</th>
				</thead>
				<tbody>
					<template is="dom-repeat" items="{{ListReporte}}" as="row">
						<tr>
							<td>{{displayIndex(index)}}</td>
							<td style$="{{row.style_td}}">{{selEstablecimiento.ruc}}</td>
							<td style$="{{row.style_td}}">{{selEstablecimiento.razonsocial}}</td>
							<td style$="{{row.style_td}}">{{periodoComprobantes}}</td>
							<td style$="{{row.style_td}}">{{row.cart_sunat}}</td>
							<td style='mso-number-format:"\@"'>{{row.fecha}}</td>
							<td style='mso-number-format:"\@"'>{{row.fecha}}</td>
							<td style='mso-number-format:"\@"'>{{row.tipo_doc_id}}</td>
							<td style$="{{row.style_td}}">{{row.serie_doc}}</td>
							<td style$="{{row.style_td}}">{{row.numero_doc}}</td>
							<td style$="{{row.style_td}}"></td>
							<td style='mso-number-format:"\@"'>{{row.tipo_doc_id_cliente}}</td>
							<td style='mso-number-format:"\@"'>{{row.num_doc_cliente}}</td>
							<td style$="{{row.style_td}}">{{row.nom_cliente}}</td>
							<td style='mso-number-format:"0.00"'>{{row.total_exportacion}}</td>
							<td style='mso-number-format:"0.00"'>{{row.total_gravado}}</td>
							<td style='mso-number-format:"0.00"'>0.00</td>
							<td style='mso-number-format:"0.00"'>{{row.igv}}</td>
							<td style='mso-number-format:"0.00"'>0.00</td>
							<td style='mso-number-format:"0.00"'>{{row.total_exonerado}}</td>
							<td style='mso-number-format:"0.00"'>{{row.total_inafecto}}</td>
							<td style='mso-number-format:"0.00"'>{{row.total_isc}}</td>
							<td style='mso-number-format:"0.00"'>0.00</td>
							<td style='mso-number-format:"0.00"'>0.00</td>
							<td style='mso-number-format:"0.00"'>0.00</td>
							<td style='mso-number-format:"0.00"'>0.00</td>
							<td style='mso-number-format:"0.00"'>{{row.total}}</td>
							<td style$="{{row.style_td}}">{{row.moneda_doc}}</td>
							<td style$="{{row.style_td}}">1</td>
							<td style$="{{row.style_td}}"></td>
							<td style$="{{row.style_td}}"></td>
							<td style$="{{row.style_td}}"></td>
							<td style$="{{row.style_td}}"></td>
							<td style$="{{row.style_td}}"></td>
							<td style$="{{row.style_td}}"></td>
							<td style$="{{row.style_td}}"></td>
							<td style$="{{row.style_td}}">{{row.estado_cpe}}</td>
							<td style$="{{row.style_td}}">{{row.estado_descricpion_cpe}}</td>
							<td style$="{{row.style_td}}">0.00</td>
							<td style$="{{row.style_td}}">{{row.total_gratuito}}</td>							
							<td style='mso-number-format:"\@"'>0101</td>
							<td style$="{{row.style_td}}"></td>
							<td style$="{{row.style_td}}"></td>
							<td style$="{{row.style_reporte}}">{{row.estado}}</td>
							<td style$="{{row.style_estado_sunat}}">{{row.estadoCp}}</td>
						</tr>
					</template>
					<!-- sumatoria de los totales -->
					<template is="dom-if" if="{{index === (ListReporte.length - 1)}}">
						<tr>
							<td colspan="13"></td>
							<td>TOTAL</td>
							<td style='mso-number-format:"0.00"; font-weight:bold;'>{{arrSumatoria.total_exportacion}}</td>
							<td style='mso-number-format:"0.00"; font-weight:bold;'>{{arrSumatoria.total_gravado}}</td>
							<td>0</td>
							<td style='mso-number-format:"0.00"; font-weight:bold;'>{{arrSumatoria.total_igv}}</td>
							<td>0</td>
							<td style='mso-number-format:"0.00"; font-weight:bold;'>{{arrSumatoria.total_exonerado}}</td>								
							<td style='mso-number-format:"0.00"; font-weight:bold;'>{{arrSumatoria.total_inafecto}}</td>
							<td style='mso-number-format:"0.00"; font-weight:bold;'>{{arrSumatoria.total_isc}}</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td style='mso-number-format:"0.00"; font-weight:bold;'>{{arrSumatoria.total}}</td>
						</tr>
					</template>
				</tbody>
			</table>
		
		</div>

		<style>
			tr:hover,
			tr.selected {
				background-color: #e3f2fd
			}		
			
			.divBtnReporte {
				display: flex;
				flex-direction: column;
				flex-wrap: nowrap;
				align-items: center;
			}
		</style>
	</template>	
</dom-module>
<script type="text/javascript" src="../../view/export.excel.js"></script>
<script>
var xThisAdmContador, xObjBorrar, _apiConsultaCpe, listCpeSuccess = [], dataListReporte, objProcesar;
const dateNow = new Date();
const _m_now = dateNow.getMonth()+1;
const _y_now = dateNow.getFullYear();

function xIniAdmContador() {
	xPopupLoad=document.getElementById('xLoad');

	setTimeout(() => {
		_apiConsultaCpe = new apiConsulaCpe();
	}, 1500);

	var _dtUs = xm_log_get('app3_us');
	xThisAdmContador.xt_org = _dtUs.ido;
	xThisAdmContador.xt_idsede = _dtUs.idsede;
	xThisAdmContador.xt_idus = _dtUs.idus;
	xThisAdmContador.ListReporte = [];
	$('body').addClass('loaded');

	$('.xPasarEnter2').on('keyup', function (e) {
			var code = e.which;
			if (code == 13 || code == 186) {
				var inputs = $('input'); // storage a array of Inputs
				var a = inputs.index(document.activeElement);
				if (inputs[a + 1] !== null) {
					var nextBox = inputs[a + 1];
					if (nextBox === undefined) {
						return
					}
					if (nextBox.disabled) {
						nextBox = inputs[a + 2]
					}

					if (nextBox == undefined) {
						return;
					}
					nextBox.focus();
					nextBox.select();
					//event.preventDefault();
				}
				return false;
			}
		});
		
		xLoadEstablecimientosAsignados();
}

function xLoadEstablecimientosAsignados() {
	$.ajax({
			type: 'GET',
			url: '../../bdphp/log_007.php?op=1'			
		})
		.done((res) => {
			const _res = JSON.parse(res);
			// console.log('_res', _res);
			xThisAdmContador.listAsignados = _res.datos;
		});
}

function selectEsablecimiento(obj) {
	const index = obj.id;	
	xThisAdmContador.selEstablecimiento = xThisAdmContador.listAsignados[index];
	// console.log('xThisAdmContador.selEstablecimiento', xThisAdmContador.selEstablecimiento);
	xThisAdmContador.showVerificacionSunat = xThisAdmContador.selEstablecimiento.habilita_verificacion_cpe == '1'
	listCpeSuccess = [];
	xDataYears();
	selectedRowTR(obj);
}

function selectedRowTR(obj){
	$(obj).addClass("selected").siblings().removeClass("selected");
} 

function xDataYears() {	
	const f_ini = xThisAdmContador.selEstablecimiento.mes_inicio.split('/');
	var _m = f_ini[0], _y = f_ini[1], count_year=0;

	// list years
	var _listYear=[];
	while(_y <=_y_now) {
		_listYear.push({y:_y});
		_y++;
		count_year++;
	}

	xThisAdmContador.listYears = _listYear;

	setTimeout(() => {
		// xThisAdmContador.$.selYear.selectedIndex = count_year;
		xThisAdmContador.$.selYear.selectedIndex = count_year - 1;
		xDataYearsMonth(_y_now);
	}, 100);
	// if( count_year === 1 ) {xDataYearsMonth(_y_now);}	
}

function selectOptionYear() {	
	const index = xThisAdmContador.$.selYear.selectedIndex;
	const yy = parseInt(xThisAdmContador.listYears[index].y);

	// _y_now = yy;
	xDataYearsMonth(yy);
}

function xDataYearsMonth(yy) {
	// list mes
	var _listMonth=[],count_m=1;
	const _my_ini = xThisAdmContador.selEstablecimiento.mes_inicio.split('/');
	const yy_ini = parseInt(_my_ini[1]);
	const _num_f_ini = _y_now === yy_ini ? parseInt(_my_ini[0]) + yy_ini : 1 + _y_now; // sumamos > 02+2019 = 2021 : 1 + 2020
	const isMismoYY = _y_now === yy;

	

	while(count_m <= 12) { 		
		const _num_f_now = isMismoYY ? _m_now+_y_now : 12 + yy;
		const _num_f = count_m+yy;
		const _activo = _num_f < _num_f_ini || _num_f > _num_f_now ? false : true;  // activa la descarga
		const _clase = _activo ? 'animated fadeIn fast xCursor' : 'animated fadeIn fast xColorRow_Plomo2';
		const _desestado = _activo ? 'DISPONIBLE' : 'SIN DATOS';
		// const _desbtn = _activo ? 'Descargar' : '';
		
		_listMonth.push({			
			mes:xDesMes(count_m-1)+' ' +yy,
			m: count_m,
			y: yy,
			activo: _activo,
			clase : _clase,
			desestado: _desestado,
			// desbtn: _desbtn
			}); 
		count_m++; 
	}
	// console.log(_listMonth);
	xThisAdmContador.listMonth = _listMonth;
}

async function downloadReporteCPE(obj) {

	xThisAdmContador.objProcesar = obj ? obj : xThisAdmContador.objProcesar;
	obj = xThisAdmContador.objProcesar;
	var countCpeSuccess = 0, countCpeError = 0;
	const index = obj.parentElement.parentElement.id;
	const _selMes = xThisAdmContador.listMonth[index];

	xThisAdmContador.selMes = _selMes;	
	xThisAdmContador.numRowsVerificadoSuccess = 0;
	xThisAdmContador.showRowsNoResponse = false;
	xThisAdmContador.showProccessVerificationFinalize = false;
	xThisAdmContador.showProccessVerificationError = false;

	xThisAdmContador.selEstablecimiento.ruc = xThisAdmContador.selEstablecimiento.ruc.trim();
	const _data = {
		establecimiento: xThisAdmContador.selEstablecimiento,
		m: _selMes.m,
		y: _selMes.y
	}

	xPopupLoad.titulo = 'Descargando...';
	xPopupLoad.xopen();

	// el perido es el año y el mes seleccionado yyyy-mm
	xThisAdmContador.periodoComprobantes = _selMes.y +''+ xCeroIzq(_selMes.m, 2);

	// obtner toke api consulta success_sunat
	let rptApiToken = await _apiConsultaCpe.getToken();
	let countNewToken = 0;
	// console.log('rptApiToken', rptApiToken);
	// return;
	const _apiToken = rptApiToken.access_token;
	// console.log('rpt token', _apiToken);

	

	xThisAdmContador.arrSumatoria = {
		total_exportacion: 0,
		total_gravado: 0,
		total_igv: 0,
		total_exonerado: 0,
		total_inafecto: 0,
		total_isc: 0,
		total: 0
	}

	dataListReporte = [];
	xThisAdmContador.ListReporte = [];
	$.ajax({
			type: 'POST',
			url: '../../bdphp/log_007.php?op=2',
			data: {item: _data}
		})
		.done(async (res) => {
			res = JSON.parse(res);
			if ( res.error ) {console.log(res.error); return;}
			// console.log(res.data);

			xPopupLoad.xclose();
			dialog_match_sunat.open();
			
			// console.log('xThisAdmContador.selEstablecimiento', xThisAdmContador.selEstablecimiento);

			const ruc_emisor = xThisAdmContador.selEstablecimiento.ruc;

			const _numRows = res.data.length;
			xThisAdmContador.numRowsList = _numRows;

			for (let index = 0; index < _numRows; index++) {
				var x = res.data[index];			

			// res.data.map(async (x) => {
				x.estado = x.tipo_doc === 'FACTURA' && parseInt(x.ruc) === 0 ? 'ANULADO' : x.estado;
				x.style_reporte = x.estado === 'ANULADO' ? 'color: red' : 'color: green';
				x.style_td = x.estado === 'ANULADO' ? 'color: red' : '';
				
				// CONSULTAR CON API SUNAT -- >>
				try {
					
					const cpeVerificado = listCpeSuccess.find(c => c.id === x.id);
					const codComp = x.series.indexOf('F') > -1 ? '01' : '03';
					const num_doc = parseInt(x.num_doc.split('-')[1]);

					if ( !cpeVerificado ) {
						const monto = x.total.replace(/,/g,''); // remplazamos las comas
						const payload = {
							header: {
								ruc_receptor: x.ruc,
								access_token: _apiToken
							},
							body: {"numRuc": ruc_emisor,"codComp": codComp,"numeroSerie": x.series,"numero": num_doc,"fechaEmision": x.fecha,"monto": monto}
						}

						// x.ruc = x.ruc.toString(); // para exportar cadena con 0 izquierda
						if ( x.estado.toLowerCase() == 'anulado' ) {
							x.total = '0'
							x.subtotal = '0'
						}

						
		
						// console.log('payload', payload);
						let estado_cpe;
						if ( xThisAdmContador.selEstablecimiento.habilita_verificacion_cpe == 1 ) {
							// verificacion api sunat
							if (x.rpt_sunat == '1') { // ya se consulto ya paso
								estado_cpe = xEstadoCpeApi('1');
								x.estado_cpe = '1';
								x.estado_descricpion_cpe = estado_cpe.titulo;
								x.success_sunat = 1;
								x.estadoCp = estado_cpe.titulo;
								x.style_estado_sunat = 'color: ' + estado_cpe.color;
								countCpeSuccess++;
								listCpeSuccess.push(x);

							} else { 
								
								// aun no se consulta // consultamos api sunat
								const rptApiConsulta = await _apiConsultaCpe.getConsulta(payload);
								

								

								if (rptApiConsulta?.success === true && rptApiConsulta?.data?.estadoCp) { 
									x.success_sunat = 1;									

									estado_cpe = xEstadoCpeApi(rptApiConsulta.data.estadoCp);
									x.estadoCp = estado_cpe.titulo;
									x.style_estado_sunat = 'color: ' + estado_cpe.color;

									x.estado_cpe = rptApiConsulta.data.estadoCp;
									x.estado_descricpion_cpe = x.estadoCp;
									

									// si no existe tambien marca en el estado sistema
									if ( rptApiConsulta.data.estadoCp === '0' ) {
										x.estado = estado_cpe.titulo;
										x.style_reporte = 'color: ' + estado_cpe.color;
										// no suma 
										x.total = '0'
										x.subtotal = '0'
										x.total_exonerado = '0'
									}

									countCpeSuccess++;
									listCpeSuccess.push(x);
								} else {
									countCpeError++;
									x.success_sunat = 0;
									x.estadoCp = 'Sin Respuesta';
									x.style_estado_sunat = 'color: black';
									xThisAdmContador.showRowsNoResponse = true;
								}

								// renovamos el token cada 500 registros consultados
								if ( countNewToken > 500 ) {
									rptApiToken = await _apiConsultaCpe.getToken();
									countNewToken = 0;
								}
								countNewToken++;

							}
						} else {
							// no consulta
							countCpeSuccess++;
							listCpeSuccess.push(x);
						}


						// console.log('rptApiConsulta', rptApiConsulta);
					} else {
						// dataListReporte.push(cpeVerificado);
						x = cpeVerificado;
						countCpeSuccess++;
					}
					xThisAdmContador.numRowsVerificadoSuccess = countCpeSuccess;
					xThisAdmContador.numRowsVerificadoError = countCpeError;
					// CONSULTAR CON API SUNAT -- >>
					

					// llenado de datos para el reporte

					// cart_sunat es el numero de ruc + tipo de comprobante + serie + numero	
					x.cart_sunat = xThisAdmContador.selEstablecimiento.ruc + x.tipo_doc_id + x.serie_doc + xCeroIzq(x.numero_doc, 10);					

					// si x.tipo_doc_id == '07' nota de credito, entonces los valores deben negativos
					if ( x.tipo_doc_id == '07' ) {
						x.subtotal = '-' + x.subtotal;
						x.igv = '-' + x.igv;
						x.total = '-' + x.total;
						x.total_exonerado = '-' + x.total_exonerado;
						x.total_inafecto = '-' + x.total_inafecto;						
					}
					
					// totales
					xThisAdmContador.arrSumatoria.total_exportacion += parseFloat(removeComas(x.total_exportacion));	
					xThisAdmContador.arrSumatoria.total_gravado += parseFloat(removeComas(x.total_gravado));
					xThisAdmContador.arrSumatoria.total_igv += parseFloat(removeComas(x.igv));
					xThisAdmContador.arrSumatoria.total_exonerado += parseFloat(removeComas(x.total_exonerado));
					xThisAdmContador.arrSumatoria.total_inafecto += parseFloat(removeComas(x.total_inafecto));
					xThisAdmContador.arrSumatoria.total_isc += parseFloat(removeComas(x.total_isc));
					xThisAdmContador.arrSumatoria.total += parseFloat(removeComas(x.total));
					
					
										

					
					dataListReporte.push(x);

				} catch (error) {
					xThisAdmContador.showProccessVerificationFinalize = true;
					xThisAdmContador.showProccessVerificationError = true;
					return;
				}
				//return x;
			// });
			}




			// return;
			// console.log('aaa res token', aaa);

			// verificar documentos con sunat

			xThisAdmContador.showProccessVerificationFinalize = true;
			if ( xThisAdmContador.showRowsNoResponse || xThisAdmContador.showProccessVerificationError ) {return; }

			console.log('xThisAdmContador.arrSumatoria', xThisAdmContador.arrSumatoria);


			xThisAdmContador.arrSumatoria = JSON.parse(JSON.stringify(xThisAdmContador.arrSumatoria));	

			setDataListReporte(dataListReporte);

			// xThisAdmContador.ListReporte = dataListReporte;

			// setTimeout(() => {
			// 	xExportarExcel();
			// }, 500);
		});

	// api2
	// $.ajax({
	// 		type: 'POST',
	// 		url: '../../bdphp/log_007.php?op=3',
	// 		data: {item: _data}
	// 	})
	// 	.done((res) => {
	// 		try {
	// 			res = JSON.parse(res);
	// 			if ( res.error ) {console.log(res.error); 
	// 				setDataListReporte(dataListReporte);
	// 				return;}	
	// 		} catch (error) {
	// 			setDataListReporte(dataListReporte);
	// 		}
			
	// 		console.log(res.data);
	// 		res.data.map(x => {
	// 			x.estado = x.tipo_doc === 'FACTURA' && parseInt(x.ruc) === 0 ? 'ANULADO' : x.estado;
	// 			x.style_reporte = x.estado === 'ANULADO' ? 'color: red' : 'color: green';
	// 			x.style_td = x.estado === 'ANULADO' ? 'color: red' : '';
	// 			dataListReporte.push(x);
	// 			//return x;
	// 		});

	// 		setDataListReporte(dataListReporte);	
	// 	});
}

function xEstadoCpeApi(estado) {
	var _estado = {
		titulo: '',
		color: ''
	};

	const _valEstado = estado.toString()
	switch (_valEstado) {
		case '0': _estado.titulo = "NO EXISTE"; _estado.color= "purple"; break;
		case '1': _estado.titulo = "ACEPTADO";  _estado.color= "green"; break;		
		case '2': _estado.titulo = "ANULADO";  _estado.color= "red"; break;		
		case '3': _estado.titulo = "AUTORIZADO";  _estado.color= "green"; break;		
		case '4': _estado.titulo = "NO AUTORIZADO"; _estado.color= "red"; break;		
	}

	return _estado;
}

function setDataListReporte(list) {
	// xThisAdmContador.ListReporte = list;
	xThisAdmContador.ListReporte = list ? list : dataListReporte
	setTimeout(() => {
		xExportarExcel();
	}, 500);
}

function xExportarExcel() {

	// TXT
	xPopupLoad.titulo='Exportando...';
	xPopupLoad.xopen();

	if ( xThisAdmContador.format_download == 3 ) {
		xGenerarReporteTXT()		
	} else {
		const _tableFormat = xThisAdmContador.format_download == 1 ? 'testTable' : 'testTableSire';
		tableToExcel(_tableFormat, 'Comprobantes');
	}

	setTimeout(() => {
		xPopupLoad.xclose();
		xPopupLoad.titulo = 'Cargando...';
		dialog_match_sunat.close();
	}, 500);
}

function downloadReporteCPE_f1() {
	xThisAdmContador.format_download = 1;
	runDownloadReporteCPE()
}


function downloadReporteCPE_f2() {
	xThisAdmContador.format_download = 2;
	runDownloadReporteCPE()
}

function downloadReporteCPE_f3() {
	xThisAdmContador.format_download = 3;
	runDownloadReporteCPE()
}

function downloadReporteCPE_open_dialog(obj) {
	xThisAdmContador.objProcesar = obj;
	dialog_reporte_formato.open();
}



function runDownloadReporteCPE() {	
	downloadReporteCPE();
	dialog_reporte_formato.close();
}

function xGenerarReporteTXT() {
	// Primero, crea la cadena de texto con el formato deseado
	let dataString = "Ruc|Razon Social|Periodo|CAR SUNAT|Fecha de emisión|Fecha Vcto/Pago|Tipo CP/Doc.|Serie del CDP|Nro CP o Doc. Nro Inicial (Rango)|Nro Final (Rango)|Tipo Doc Identidad|Nro Doc Identidad|Apellidos Nombres/ Razón Social|Valor Facturado Exportación|BI Gravada|Dscto BI|IGV / IPM|Dscto IGV / IPM|Mto Exonerado|Mto Inafecto|ISC|BI Grav IVAP|IVAP|ICBPER|Otros Tributos|Total CP|Moneda|Tipo Cambio|Fecha Emisión Doc Modificado|Tipo CP Modificado|Serie CP Modificado|Nro CP Modificado|ID Proyecto Operadores Atribución|Tipo de Nota|Est. Comp|Valor FOB Embarcado|Valor OP Gratuitas|Tipo Operación|DAM / CP|CLU\n";

	dataListReporte.forEach(row => {
		dataString += `${xThisAdmContador.selEstablecimiento.ruc}|${xThisAdmContador.selEstablecimiento.razonsocial}|${xThisAdmContador.periodoComprobantes}|${row.cart_sunat}|${row.fecha}|${row.fecha}|${row.tipo_doc_id}|${row.serie_doc}|${row.numero_doc}||${row.tipo_doc_id_cliente}|${row.num_doc_cliente}|${row.nom_cliente}|${parseFloat(removeComas(row.total_exportacion))}|${parseFloat(removeComas(row.total_gravado))}|0|${parseFloat(removeComas(row.igv))}|0|${parseFloat(removeComas(row.total_exonerado))}|${parseFloat(removeComas(row.total_inafecto))}|${parseFloat(removeComas(row.total_isc))}|0|0|0|0|${parseFloat(removeComas(row.total))}||||||||1|0|0|0|0101||\n`;
	});

	// Luego, crea un elemento de enlace invisible, establece el contenido del archivo y el nombre del archivo, y haz clic en él para iniciar la descarga
	let downloadLink = document.createElement('a');
	downloadLink.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(dataString);
	downloadLink.download = 'comprobantes.txt';

	document.body.appendChild(downloadLink);
	downloadLink.click();
	document.body.removeChild(downloadLink);
}


Polymer({
	is: 'x-admin-contador',
	properties: {
		xt_org: Number,
		xt_idsede: Number,	
		xt_idus: Number,
		listYears:[],
		listMonth:[],
		listAsignados: [],
		ListReporte: [],
		selEstablecimiento: [],
		selMes:[],
		numRowsVerificadoSuccess: Number,
		numRowsVerificadoError: Number,
		numRowsList: Number,
		showRowsNoResponse: Boolean,
		showProccessVerificationFinalize: Boolean,
		showProccessVerificationError: Boolean,
		showVerificacionSunat: Boolean,
		periodoComprobantes: String,
		format_download: Number,
		objProcesar: Object,
		arrSumatoria: Object
	},
	attached: function () {
		this.selected = 0,
		this.showRowsNoResponse = false;
		this.showProccessVerificationFinalize = false;
		this.showProccessVerificationError = false;
		this.showVerificacionSunat = false;
		this.arrSumatoria = {
			total_exportacion: 0,
			total_gravado: 0,
			total_igv: 0,
			total_exonerado: 0,
			total_inafecto: 0,
			total_isc: 0,
			total: 0
		}

		xThisAdmContador = this;
		xIniAdmContador();
	},
	displayIndex: function (index) {
		return xCeroIzq(index + 1, 1);
	},
	sumatoriaTotal: function (campo) {
		return xThisAdmContador.arrSumatoria[campo].toFixed(2);
	},
})
</script>