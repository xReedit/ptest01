<dom-module id="x-facturador">
    <template>
        <br>
        <div class="xMiCard xradius" style="width:85%">
            <div class="xEncanezadoCard xFondoRowAmarillo2">
                <p>Emite comprobantes electronicos personalizados. Es decir el concepto y los montos no tienen que ser previamente registrados.</p>
            </div>
            <div class="xContentCard" style="height: 100%;">                
                <p class="bold">Cliente</p>   
                <div class="container-cliente">             
                <form action="" id="form_pago_cliente" is="iron-form">
                    <input autofocus type="number" class="xMiInput xPasarEnter2" style="width:250px;" placeholder="RUC Cliente" pattern="[0-9]*" required id="txt_ruc" espaciar>
                    <input type="text" class="xMiInput xPasarEnter2" style="width:98%;" placeholder="Cliente" onChange="conMayusculas(this)" required id="txt_descripcion" espaciar>
                    <input type="text" class="xMiInput xPasarEnter2" style="width:98%;" placeholder="Direccion" onChange="conMayusculas(this)" required id="txt_direccion" espaciar>
                </form>
                <br>                
                </div>                
                <br>
                <table class="xtable4">
                    <thead>
                        <th class="xSinBorde" width="10px">Cant</th>
                        <th class="xSinBorde" width="60%">Descripcion</th>
                        <th class="xSinBorde" width="30px" align="right">P.Unitario</th>
                        <th class="xSinBorde" width="30px" align="right">P.Total</th>
                        <!-- <th class="xSinBorde" width="10px"></th> -->
                    </thead>
                    <tr class="xSinBorde" data-id="">                        
						<td><input type="number" class="xMiInput xPasarEnter2" style="width:100%;" placeholder="Cant" onChange="conMayusculas(this)" required id="cant_item" autofocus></td>
						<td><input type="text" class="xMiInput xPasarEnter2" style="width:100%;" placeholder="Descripcion" onChange="conMayusculas(this)" required id="des_item"></td>
                        <td><input type="number" class="xMiInput xAlinearDerecha punitario" onChange="conMayusculas(this)" onblur="xRetornaMoneda(this)"  placeholder="P. Unitario" id="punitario" name="precio" required></td>
                        <td><input type="number" class="xMiInput xAlinearDerecha xprecio" onChange="conMayusculas(this)" onblur="xRetornaMoneda(this)"   placeholder="P. Total" id="ptotal" name="total" required></td>
						<!-- <td><paper-fab icon="add" onclick="xAddItem()" title="Agregar item"></paper-fab></td> -->
                    </tr>        
                    <template is="dom-repeat" items="{{arrItems}}" as="item">
                        <tr data-value="[[index]]">
                            <td> <span class="xDeleteRowNeutro" title="Borrar" onclick="xBorrarItemLocalArr(this);"></span> {{item.cantidad}} </td>
                            <td>  {{item.descripcion}} </td>
                            <td align="right">  {{item.punitario}} </td>
                            <td align="right"> {{item.ptotal}}</td>
                        </tr>
                    </template>                    
                    <template is="dom-repeat" items="{{arrTotales}}" as="total">
                        <tr class="tt_row">
                            <td colspan="3" class="xSinBorde" align="right"> {{ total.des }} </td>
                            <td align="right"> {{ total.importe }} </td>
                        </tr>
                    </template>
                </table>
            </div>

            <div class="xPieCard">
                <br>
                <div class="xBoton2 xAzul" onclick="xOpenRegistrarPago();">Listo, emitir comprobante</div>
                <br><br>
            </div>
        </div>
    </template>
    <style type="text/css">
        :root {
            --font-size: 12px;
            --paper-input-container-input: {
                font-size: var(--font-size);
                }
            --paper-input-container-label: {
                font-size: 13px;
                };
            }

        .tt_row td {
            font-weight: 600;
            font-size: 15px;
        }
    </style>
</dom-module>
<script>
    var xThisFacturador, xPopupLoad, _arrItems = [];

    function xIniFacturador() {
        xThisFacturador.arrItems = [];
        xThisFacturador.arrTotales = [];
        xPopupLoad = document.getElementById('xLoad');

        $('.xPasarEnter2').on('keyup', function (e) {
            var code = e.which;
            if (code == 13 || code == 186) {
                var inputs = $('input'); // storage a array of Inputs
                var a = inputs.index(document.activeElement);
                if (inputs[a + 1] !== null) {
                    var nextBox = inputs[a + 1];
                    if (nextBox === undefined) { return }
                    if (nextBox.disabled) { nextBox = inputs[a + 2] }

                    if (nextBox == undefined) { return; }
                    nextBox.focus();
                    nextBox.select();
                }
                event.stopPropagation();
                e.stopPropagation();
                e.stopImmediatePropagation()
                return false;
            }
        });
        $(".punitario").on('keyup', function (e) {
            var code = e.which;
            xCalcTotal();
            if (code == 13 || code == 186) {
                $("#punitario").val(xMoneda(this.value));
                $("#ptotal").focus();
            }
        });
        $(".xprecio").on('keyup', function (e) {
            var code = e.which;
            if (code == 13 || code == 186) {
                xAddItem();
            }
        });
    }

    function xCalcTotal() {
        const xCan_item = $("#cant_item").val() === '' ? 0 : parseFloat($("#cant_item").val());    
        const xPUnitario = $("#punitario").val() === '' ? 0 : parseFloat($("#punitario").val());
        const ptotal = (parseFloat(parseFloat(xCan_item) * parseFloat(xPUnitario)).toFixed(2)) || 0; 
        
        // $("#punitario").val(xMoneda(xCan_item));
        $("#ptotal").val(ptotal);
        // $("#ptotal").focus();
    }

    function xAddItem() {
        const xCan_item = $("#cant_item").val();
        const xDes_item = $("#des_item").val();
        const xPUnitario = $("#punitario").val();
        const xPTotal = $("#ptotal").val();
        if (xCan_item === '' || xDes_item === '' && xPUnitario === '' && xPTotal === '') { return }



        const item = {'cantidad': xCan_item, 'descripcion': xDes_item, 'punitario': xPUnitario, 'ptotal': xPTotal};
        _arrItems.push(item);
        xThisFacturador.arrItems = JSON.parse(JSON.stringify(_arrItems));
        //arrItems = JSON.parse(JSON.stringify(arrItems));
        console.log(xThisFacturador.arrItems);
        xCalcularTotal();
        xNuevoItem();

    }

    function xBorrarItemLocalArr(obj) {
        const i = obj.parentElement.parentElement.dataValue;
        _arrItems.splice(i,1);
        xThisFacturador.arrItems = JSON.parse(JSON.stringify(_arrItems));
        xCalcularTotal();
    }

    function xNuevoItem() {
        $("#cant_item").val('');
        $("#des_item").val('');
        $("#punitario").val('');
        $("#ptotal").val('');
        $("#cant_item").focus();
    }

    function xCalcularTotal() {
        var xCartaSubtotales = xm_log_get('carta_subtotales');
        var _arrTotal = [];

        const SumaLista = this._arrItems.map( x => parseFloat(x.ptotal)).reduce((a,b) => a+b, 0);
        _arrTotal.push({ 'des': 'SUB TOTAL', 'importe': xMoneda(SumaLista) });

        xCartaSubtotales.map(x => {
            if (x.es_impuesto === '1') {
                const impuesto = parseFloat(x.monto);
                const importeCalc = x.activo === '0' ? parseFloat(SumaLista * (impuesto / 100)).toFixed(2) : '0.00';
                _arrTotal.push({'des': x.descripcion, 'importe': importeCalc});
            }
        });


        const total = _arrTotal.map(x => parseFloat(x.importe)).reduce((a, b) => a + b, 0);
        _arrTotal.push({ 'des': 'TOTAL', 'importe': xMoneda(total) });
        
        xThisFacturador.arrTotales = JSON.parse(JSON.stringify(_arrTotal));
        console.log(_arrTotal);
    }

    Polymer({
        is: 'x-facturador',
        properties: {    
            arrItems: [],
            arrTotales: [],            
        },
        attached: function () {
            xThisFacturador = this;
            xIniFacturador();
        }
    })
</script>