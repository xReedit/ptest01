<link rel="import" href="./x-repartidores.html">
<link rel="import" href="./x-admin-change-sys.html">
<dom-module id="x-admin">
	<link rel="import" href="../../x-componentes/x-comp-select-plan/x-comp-select-plan.html">
	<template>

		<paper-dialog id="dialogSedeUp"  entry-animation="scale-up-animation" exit-animation="fade-out-animation"
			class="dialog_redondo" with-backdrop>
			<div class="xContent">
				<p class="fs-20 fw-600">Restablecer Servicio</p>
				<br>
				<div>
					<!-- restable el servicio a la sede -->
					<p>Establecimiento: <span class="text-primary" id="p_razonsocial">{{sedeDown.razonsocial}}</span></p>
					<p>Sede: <span class="text-primary" id="p_nomsede">{{sedeDown.nomsede}}</span></p>
					<p>Ciudad: <span class="text-primary" id="p_ciudad">{{sedeDown.ciudad}}</span></p>
					<hr>
					<p class="fw-600 fs-18">¿Está seguro de restablecer el servicio a la sede?</p>
					<br>
					<div>
						<button class="btn btn-sm btn-success" on-click="upSede">Restablecer</button>
						<button class="btn btn-sm btn-secondary" onclick="dialogSedeUp.close()"> Cerrar</button>
					</div>
				</div>
			</div>									
		</paper-dialog>

		<paper-dialog id="dialogSedeDown" entry-animation="scale-up-animation" exit-animation="fade-out-animation"
			class="dialog_redondo" with-backdrop>
			<div class="xContent">
				<p class="fs-20 fw-600">Dar de baja</p>
				<br>
				<div>
					<div>
						<p>Establecimiento: <span class="text-primary" id="p_razonsocial">{{sedeDown.razonsocial}}</span></p>
						<p>Sede: <span class="text-primary" id="p_nomsede">{{sedeDown.nomsede}}</span></p>
						<p>Ciudad: <span class="text-primary" id="p_ciudad">{{sedeDown.ciudad}}</span></p>
						<br>
						<!-- motivo de baja -->
						<p>Motivo de baja:</p>
						<textarea class="selected-template-1 w-100" id="motivo_baja_sede"></textarea>
						<!-- fecha de baja -->
						<p>Fecha de baja:</p>
						<input type="date" class="selected-template-1" id="fecha_baja_sede">
					</div>
					<br>
					<hr>
					<p class="fw-600 fs-18">¿Está seguro de dar de baja a la sede?</p>
					<br>
					<div>
						<button class="btn btn-sm btn-danger" on-click="downSede">Dar de baja</button>
						<button class="btn btn-sm btn-secondary" onclick="dialogSedeDown.close()"> Cerrar</button>
					</div>
				</div>
			</div>
		</paper-dialog>

		<paper-dialog id="dialogPagarServicio" entry-animation="scale-up-animation" exit-animation="fade-out-animation"
			class="dialog_redondo" with-backdrop>
			<div class="xContent">
				<p class="fs-15 fw-600">Registrar pago del servicio</p>
				<br>
				<div>				
					<div class="d-flexx align-items-center" hidden$="[[isShowChagePlan]]">
						<p class="fw-600 text-primary" id="p_plancontrado">Plan contratado: </p>					
						<i class="fa fa-refresh text-dark ml-2 xCursor" onclick="showChangePlan()"></i>
					</div>	
					<div hidden$="[[!isShowChagePlan]]">
						<p>Seleccione Plan:</p>
						<x-comp-select-plan clasecss="selected-template-1" id="compPlanSelectChange"></x-comp-select-plan>
					</div>
				</div>
				<br>
				<div class="xLinea2"></div>
				<div class="d-flexx">
					<div class="pr-2">
						<p>Ultimo Mes Pagado:</p>
						<input type="month" class="selected-template-1 xPasarEnter2" id="sus_ultimo_mes_pago_re">
					</div>
	
					<div>
						<p>Periodo:</p>
						<select id="selPeriodoRe" class="selected-template-1 xCursor">
							<option value="MENSUAL">MENSUAL</option>
							<option value="SEMESTRAL">SEMESTRAL</option>
							<option value="ANUAL">ANUAL</option>
						</select>
					</div>
				</div>
				<br>
				<p>Importe pagado:</p>
				<input type="text" class="selected-template-1" id="importe_pago_suscripcion">
				<br><br>
				<div>
					<button class="btn btn-sm btn-success" onclick="registerPagoServicioSuscripcion()">Registrar</button>
					<button class="btn btn-sm btn-secondary" onclick="dialogPagarServicio.close()"> Cerrar</button>
				</div>

			</div>
		</paper-dialog>

		<paper-dialog id="dialog_add_us_cpc" entry-animation="scale-up-animation"
			exit-animation="fade-out-animation" class="dialog_redondo" with-backdrop>
			<div class="xContent">				
				<div class="x_div_linea">
					<div class="xitem1 xBordeDe">
						<h3>Datos del contador</h3>
						<hr>
						<br>
						<div>
							<form method="POST" id="frm_cpc">
								<input type="text" class="xMiInput xPasarEnter2" value$="{{UsarioCpc_sedes.nombre_cpc}}" placeholder="RAZON SOCIAL | NOMBRE" onChange="conMayusculas(this)" id="nombre_cpc" name="nombre_cpc" espaciar required>
								<input type="number" class="xMiInput xPasarEnter2" value$="{{UsarioCpc_sedes.ruc}}" placeholder="RUC | DNI" onChange="conMayusculas(this)" id="ruc" name="ruc" espaciar>
								<input type="text" class="xMiInput xPasarEnter2" value$="{{UsarioCpc_sedes.telefono}}" placeholder="TELEFONO" onChange="conMayusculas(this)" id="telefono" name="telefono" espaciar>
								<input type="text" class="xMiInput xPasarEnter2" value$="{{UsarioCpc_sedes.direccion}}" placeholder="DIRECCION" onChange="conMayusculas(this)" id="direccion" name="direccion" espaciar>
								<input type="text" class="xMiInput xPasarEnter2" value$="{{UsarioCpc_sedes.ciudad}}" placeholder="CIUDAD" onChange="conMayusculas(this)" id="ciudad" name="ciudad" espaciar required>
								<input type="text" class="xMiInput xPasarEnter2" value$="{{UsarioCpc_sedes.ubigeo}}" placeholder="UBIGEO" onChange="conMayusculas(this)" id="ubigeo" name="ubigeo" espaciar required>
								<input type="text" class="xMiInput xPasarEnter2" value$="{{UsarioCpc_sedes.f_registro}}" placeholder="F. REGISTRO" onChange="conMayusculas(this)" id="f_registro" name="f_registro" espaciar>
								<br><br>
								<p><strong>Usuario del sistema: <span class="xColorRow_Azul" id="usuario_cpc"></span></strong></p>
								<hr><br>
								<!-- <input type="text" class="xMiInput xPasarEnter2" placeholder="USUARIO" id="usuario_cpc" value$="{{UsarioCpc_sedes.usuario}}" espaciar readonly> -->
								<!-- <br><br> -->
								<a href="#" onclick="xResetearClave()"> Resetear clave</a>
								<br>
								<hr>	
								<div class="xInvisible">
									<input type="text" id="idus_cpc" name="idus_cpc" value$="{{UsarioCpc_sedes.idus_cpc}}">
									<input type="text" id="idusuario" name="idusuario" value$="{{UsarioCpc_sedes.idusuario}}">
								</div>													
							</form>
						</div>
						<br>
						<button class="xBoton2 xAzul" onclick="xCpeValidarFormSave();">Guardar</button>
						<button class="xBoton2 xPlomo" onclick="dialog_add_us_cpc.close();">Cerrar</button>
					</div>
					<div class="xitem2 xBordeIzqHover">
						<p><strong>Establecimientos Asignados</strong></p>						
						<hr>
						<br>						
						<table width="100%" id="tb_cpc_sede">
							<thead>
								<th align="left">#</th>
								<th align="left">Establecimiento</th>
								<th align="left">Sede</th>
								<th align="left">Serie</th>
								<th align="left">Ciudad</th>
								<th></th>
							</thead>
							<tbody>
								<tr>
									<td colspan="2">
										<select id="selConpanies" class="xTextRow2 xCursor" onchange="selectOptionCompanies()">
											<template is="dom-repeat" items="{{listCompanies}}" as="item">
												<option value="[[index]]">[[item.razonsocial]] </option>
											</template>
										</select>
									</td>									
									<td>
										<input type="text" class="xMiInput xPasarEnter2" onChange="conMayusculas(this)" id="txt_companies_sede" espaciar>
									</td>
									<td>
										<input type="number" class="xMiInput xPasarEnter2" onChange="conMayusculas(this)" id="txt_companies_serie" espaciar>
									</td>
									<td colspan="2">
										<input type="text" class="xMiInput xPasarEnter2" onChange="conMayusculas(this)" id="txt_companies_ciudad" onkeyup="addCompaniesContador()" espaciar>
									</td>
								</tr>
								<template is="dom-repeat" items="{{listCpc_sedes}}" as="item">
									<tr data-t="us_cpc_sedes" data-id="{{item.idus_cpc_sedes}}" id="{{index}}">
										<td class="xfont11">{{displayIndex(index)}}</td>
										<td class="xfont11">{{item.razonsocial}}</td>
										<td class="xfont11">{{item.nomsede}}</td>
										<td class="xfont11">{{item.serie}}</td>
										<td class="xfont11">{{item.ciudad}}</td>
										<td>
											<span class="xDeleteRow2 xCursor" title="Anular" onclick="xBorrarItem(this);"></span>
										</td>
									</tr>
								</template>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</paper-dialog>


		<!-- REPARDIROR -->
		<paper-dialog id="dialog_add_us_repartidor" style="max-width: 420px;" entry-animation="scale-up-animation"
			exit-animation="fade-out-animation" class="dialog_redondo" with-backdrop>
			<div class="xContent">													
				<h3>Datos del repartidor</h3>
				<hr>
				<br>
				<div>
					<x-repartidores usuarioReparido="UsarioRepartidorSelected"></x-repartidores>
				</div>
			</div>
		</paper-dialog>

		<br>
		<div class="xMiCard xradius" style="width:calc(100% - 10%)">
			<div class="xEncanezadoCard xFondoRowAmarillo4">				
				Listado de restaurantes.
			</div>
			<div class="xContentCard">
				<paper-tabs selected="{{selected}}" id="tab_admin">
					<paper-tab>Establecimientos</paper-tab>					
					<paper-tab>Registro de Contadores CPC</paper-tab>
					<paper-tab>Repartidores</paper-tab>
					<paper-tab>Actualizaciones Sistema</paper-tab>
				</paper-tabs>
				<div class="xLinea2"></div>
				<br><br>
				<iron-pages selected="{{selected}}">
					<div id="div_establecimientos">
						<div class="x_div_linea">
							<h3>Establecimientos suscritos</h3>							
							<button class="xBoton2 xAzul xDerecha" onclick="xAdmGoNew();">Nuevo</button>
						</div>						
						<hr>
						<br>
						<div>
							<input type="text" id="textBuscarSede" class="xMiInput w-100 fs-18" placeholder="Buscar..." onkeyup="xBuscarSedesSuscritos(this)">
						</div>
						<br>
						<table width="100%" id="tb_pedidos_borrados">
							<thead>
								<th>#</th>
								<th>Razon Social</th>
								<th>Sede</th>						
								<th>Ciudad</th>
								<th>Tipo</th>						
								<th>F. Inicio</th>						
								<th>Estado</th>
								<th>Pago</th>
								<th></th>
							</thead>
							<tbody>
								<template is="dom-repeat" items="{{ListSedes}}" as="item">
									<tr data-id="{{index}}">
										<td>{{displayIndex(index)}}</td>
										<td>{{item.razonsocial}}</td>
										<td>{{item.nomsede}}</td>
										<td>{{item.ciudad}}</td>
										<td>{{item.tipo}}</td>
										<td>{{item.finicio}}</td>
										<td>Activo</td>
										<td>
											<div class="text-center">
												<span class$="{{computeClass(item.is_bloqueado)}}">
													<span hidden$="{{_isEqual(item.is_bloqueado, '1')}}"><i class="fa fa-check"></i></span>
													<span data-id="{{item.idsede}}" onclick="openPagoServicioSuscripcion(this)" hidden$="{{!_isEqual(item.is_bloqueado, '1')}}"><i class="fa fa-circle xCursor"></i></span>
												</span>
											</div>
										</td>											
										<td>
											<div class="d-flexx" data-id="{{index}}">
												<span class$="{{computeClass(item.is_baja)}}" data-id="{{index}}">
													<i hidden$="{{!_isEqual(item.is_baja, '1')}}" title="Dado de baja" class="fa fa-arrow-down xCursor" on-click="openDialogDown"></i>
													<i hidden$="{{_isEqual(item.is_baja, '1')}}" title="Activo" class="fa fa-rocket mr-4 xCursor" on-click="openDialogDown"></i>
												</span>
												<span title="Modificar" onClick="xAdmModificarOrg(this)" class="xIconRow xCursor ml-2"><img src="../../../images/edit.png"></span>
											</div>
										</td>
									</tr>
								</template>
							</tbody>
						</table>
					</div>


					<!-- contadores -->
					<div id="div_contadores_cpc">
						<div class="x_div_linea">
							<h3>Listado de contadores</h3>							
							<button class="xBoton2 xAzul xDerecha" onclick="xCpcNewUs();">Nuevo</button>							
						</div>						
						<hr>
						<br>
						<table width="100%" id="tb_cpc">
							<thead>
								<th>#</th>
								<th>Razon Social / Nombres</th>
								<th>Usuario</th>
								<th>Ciudad</th>
								<th># Sedes</th>
								<th>F. registro</th>
								<th>Estado</th>
								<th></th>
							</thead>
							<tbody>
								<template is="dom-repeat" items="{{listCpc}}" as="item">
									<tr data-id="{{index}}">
										<td>{{displayIndex(index)}}</td>
										<td>{{item.nombre_cpc}}</td>
										<td>{{item.usuario}}</td>
										<td>{{item.ciudad}}</td>
										<td>{{item.num_sede}}</td>
										<td>{{item.f_registro}}</td>
										<td>Activo</td>
										<td title="Modificar" onClick="xCpcLoad_Uusario_Cpc(this)"><span class="xIconRow xCursor"><img
													src="../../../images/edit.png"></span></td>
									</tr>
								</template>
							</tbody>
						</table>
					</div>


					<!-- repartidores -->
					<div id="div_contadores_cpc">
						<div class="x_div_linea">
							<h3>Listado de repartidores</h3>							
							<button class="xBoton2 xAzul xDerecha" onclick="xCpcNewUsRepartidor();">Nuevo</button>
						</div>						
						<hr>
						<br>						
						<table width="100%" id="tb_cpc">
							<thead>
								<th>#</th>
								<th>Nombres</th>
								<th>DNI</th>								
								<th>Telefono</th>
								<th>Usuario</th>
								<th>Ciudad</th>								
								<th>F. registro</th>
								<th>Calificacion</th>
								<th>P. Atendidos</th>
								<th>P. Reasignados</th>
								<th>En</th>
								<th>Estado</th>
								<th></th>
							</thead>
							<tbody>
								<template is="dom-repeat" items="{{listRepartidores}}" as="item">
									<tr data-id="{{index}}">
										<td>{{displayIndex(index)}}</td>
										<td>{{item.nombre}}  {{item.apellido}}</td>
										<td>{{item.dni}}</td>
										<td>{{item.telefono}}</td>
										<td>{{item.usuario}}</td>
										<td>{{item.ciudad}}</td>
										<td>{{item.f_registro}}</td>
										<td>{{item.calificacion}}</td>
										<td>{{item.pedidos_atendidos}}</td>
										<td>{{item.pedidos_reasignados}}</td>
										<td>{{item.sede}}</td>
										<td>{{item.des_estado}}</td>
										<td title="Modificar" onClick="xCpcLoad_Uusario_Repartidor(this)"><span class="xIconRow xCursor"><img
													src="../../../images/edit.png"></span></td>
									</tr>
								</template>
							</tbody>
						</table>
					</div>

					<!-- cambios en el sistema -->
					<div id="div_change_sys">
						<x-admin-change-sys></x-admin-change-sys>
					</div>

				</iron-pages>
				<br><br>
			</div>
		</div>
	</template>
</dom-module>
<style>
	.red {
		color: red;
	}

	.green {
		color: green;
	}
</style>
<script type="text/javascript" src="./us_cpc.js"></script>
<script>
var xThisAdmin, xPopupLoad, arrSede=[];

    function xIniAdmin() {
		xLoadCpc();
		xLoadSedes();	
		getAllCompaniesFac();
		xLoadRepartidores();
		$('body').addClass('loaded');
	}

	function xLoadSedes(){
		$.ajax({ url: '../../bdphp/log_004.php?op=1' })
		.done((res) => {
			const _res = $.parseJSON(res);
			arrSede = _res.datos;
			xThisAdmin.ListSedes = _res.datos;			
		});
	}

	function xBuscarSedesSuscritos(obj) {
		let nom_sede = obj.value.toLowerCase();
		console.log('nom_sede', nom_sede);
		let arrSearch = arrSede.filter(s => s.nomsede).filter(s => s.nomsede.toLowerCase().includes(nom_sede));
		console.log('arrSearch', arrSearch);
		xThisAdmin.ListSedes = arrSearch;
	}

	function xLoadRepartidores(){
		$.ajax({ url: '../../bdphp/log_004.php?op=9' })
		.done((res) => {
			const _res = $.parseJSON(res);
			xThisAdmin.listRepartidores = _res.datos.map(r => {
				r.des_estado = r.estado === '0' ? 'Activo' : 'Baja';
				r.sede = r.idsede_suscrito === null ? 'RED' : r.nom_sede;
				return r; 
			});			
		});
	}

	function xAdmModificarOrg(obj) {
		const index =  obj.parentElement.dataId;
		localStorage.setItem('::app3_woOAdm', JSON.stringify(xThisAdmin.ListSedes[index]));
		
		router.go('/adm_dashboard-new');
	}

	function xAdmGoNew() {
		localStorage.removeItem('::app3_woOAdm');
		router.go('/adm_dashboard-new');
	}

	function xCpcNewUsRepartidor() {
		dialog_add_us_repartidor.open();
		// localStorage.removeItem('::app3_woOAdm');
		// router.go('/adm_dashboard-new-repartidor');
	}


	function xCpcLoad_Uusario_Repartidor(obj) {
		xPopupLoad.titulo = "Cargado..."		

		const index = obj.parentElement.dataId;
		xThisAdmin.UsarioRepartidorSelected = xThisAdmin.listRepartidores[index];		
		dialog_add_us_repartidor.open();
	}

	function openPagoServicioSuscripcion(obj) {
		console.log('obj.dataId', obj.dataId);
		xThisAdmin.idSedeSelectedPago = obj.dataId;
		const rowSede = xThisAdmin.ListSedes.filter(s => s.idsede === obj.dataId)[0];
		$('#importe_pago_suscripcion').val(rowSede.costo_restobar_fijo_mensual);
		$('#selPeriodoRe').val(rowSede.frecuencia);
		$('#p_plancontrado').text('Plan contratado: ' + rowSede.plan);	

		const xCompSelPlanChange = document.getElementById('compPlanSelectChange');
		xCompSelPlanChange.setPlan(rowSede.idsede_plan_contratado);

		dialogPagarServicio.open();
	}

	function registerPagoServicioSuscripcion() {
		xPopupLoad.xopen();
		const _importe_pago_suscripcion = $('#importe_pago_suscripcion').val();
		const _ultimo_mes_pago_re = $('#sus_ultimo_mes_pago_re').val();
		const _selPeriodoRe = $('#selPeriodoRe').val();
		const _idSedeSelectedPago = xThisAdmin.idSedeSelectedPago;

		const xCompSelPlanChange = document.getElementById('compPlanSelectChange');
		const _idsede_plan_contratado = xCompSelPlanChange.getPlanSeleted().idsede_plan_contratado;

		const dataSendPago = {
			data: {
				idsede: _idSedeSelectedPago,
				importe_pagado: _importe_pago_suscripcion,
				ultimo_pago: _ultimo_mes_pago_re,
				frecuencia: _selPeriodoRe,
				idsede_plan_contratado: _idsede_plan_contratado,				
			}
		}

		console.log('dataSendPago', dataSendPago);

		$.ajax({ type: 'POST', url: '../../bdphp/log_004.php?op=1804', data: dataSendPago })
			.done((res) => {
				console.log('res suscripcion', res);
				dialogPagarServicio.close()
				let rowSede = xThisAdmin.ListSedes.filter(s => s.idsede === xThisAdmin.idSedeSelectedPago)[0];
				rowSede.is_bloqueado = '0';

				xThisAdmin.ListSedes = JSON.parse(JSON.stringify(xThisAdmin.ListSedes));
				xPopupLoad.xclose();
			});
	}

	function showChangePlan() {
		xThisAdmin.isShowChagePlan = !xThisAdmin.isShowChagePlan;
	}


	Polymer({
			is: 'x-admin',
			properties: {
				ListSedes: [],
				listCpc: [],
				listCpc_sedes: [],
				listCompanies: [],
				listRepartidores: [],
				UsarioCpc_sedes: {},
				UsarioRepartidorSelected: {},
				idSedeSelectedPago: Number,
				isShowChagePlan: false,
				sedeDown: {},
				// hayDatosRestaurar: boolean = true,
			},
			attached: function () {		
				// this.UsarioRepartidorSelected = {};
				this.selected = 0,
				this.isShowChagePlan = false;
				xThisAdmin = this;
				xIniAdmin();
			},
			displayIndex: function (index) {
				return xCeroIzq(index + 1, 1);
			},
			computeClass: function (is_bloqueado) {
				return is_bloqueado === '1' ? 'red' : 'green';
			},
			_isEqual: function (value1, value2) {
				return value1 === value2;
			},
			openDialogDown: function (obj) {
				const index = obj.target.parentElement.dataId;
				this.sedeDown = this.ListSedes[index];

				console.log('index', this.sedeDown);
				if ( this.sedeDown.is_baja === '0' ) {
					dialogSedeDown.open();
				} else {
					dialogSedeUp.open();
				}
			},
			downSede: function () {
				const motivo_baja_sede = $('#motivo_baja_sede').val();
				const fecha_baja_sede = $('#fecha_baja_sede').val();
				const idsede = this.sedeDown.idsede;

				const dataSend = {
					idsede: idsede,
					motivo_baja_sede: motivo_baja_sede,
					fecha_baja_sede: fecha_baja_sede
				}

				$.ajax({ type: 'POST', url: '../../bdphp/log_004.php?op=19', data: dataSend })
					.done((res) => {
						console.log('res baja', res);
						this.sedeDown.is_bloqueado = '1';
						this.sedeDown.is_baja = '1';
						this.ListSedes = JSON.parse(JSON.stringify(this.ListSedes));
						dialogSedeDown.close();
					});
			},
			upSede: function () {
				const idsede = this.sedeDown.idsede;
				const dataSend = {
					idsede: idsede
				}

				$.ajax({ type: 'POST', url: '../../bdphp/log_004.php?op=1901', data: dataSend })
					.done((res) => {
						console.log('res baja', res);
						this.sedeDown.is_bloqueado = '0';
						this.sedeDown.is_baja = '0';
						this.ListSedes = JSON.parse(JSON.stringify(this.ListSedes));
						dialogSedeUp.close();
					});
			},
		})
</script>