<!-- <script src="../../js/isotope.pkgd.min.js"></script> -->
<link rel="import" href="../x-componentes/x-comp-find-categoria/x-comp-find-categoria.html">
<link rel="import" href="../x-componentes/x-comp-descuento/x-comp-descuento.html">
<link rel="import" href="./x-control-delivery/x-control-delivery.html">
<dom-module id="x-control-mesas">
	<link rel="import" href="../x-componentes/x-input-search-pedido-in-page/x-input-search-pedido-in-page.html">
	<link rel="import" href="../x-componentes/x-comp-btn-permiso/x-comp-btn-permiso.html">
	<link rel="import" href="../x-componentes/x-comp-btn-permiso/x-comp-dialog-permiso.html">

	<script src="../view/httpFech.js"></script>

	
	<!-- <script type="text/javascript" src="../../js/rxjs.umd.js"></script>
	<script rel="preload" type="text/javascript" src="../../js/socket.io.js"></script> -->
	
	<!-- <script rel="preload" type="text/javascript" src="../view/config.const-d4c9262c.js"></script> -->	
	<script type="text/javascript" src="../view/config.const.js"></script>
	
	<!-- <script type="text/javascript" src="../view/socket.master.service.js"></script> -->
	<script type="text/javascript" src="../view/socket.service.p.js"></script>

	<script type="text/javascript" src="../view/notifica.js"></script>

	<template>
		<div id="backdrop-dialog-detalle" class="backdrop-dialog-detalle"></div>

		<x-comp-dialog-permiso></x-comp-dialog-permiso>
		
		<x-pass id="pass_us" titulo="Usuario autorizado" valor="Pe1"></x-pass>
		<paper-dialog id="dialog_erro_print" modal style="min-width: 330px;" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation">
			<h4>Error en impresora</h4>
			<p id="print_error"></p>
			<br>
			<div class="xBoton2 xVerde divLeft23" onclick="xReImprimir();">Intentar Nuevamente</div>
			<div class="xBoton2 xPlomo divLeft23" dialog-dismiss onclick="xCPcloseDialogDetalle();">No imprimir</div>
			<br><br><br>
		</paper-dialog>
		<paper-dialog class="dialog_redondo" style="max-width:350px; background: #212121; color: #fff;" id="dialog_borrar_item" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
			<div class="xContent">
				<h3>BORRAR REGISTRO?</h3>
				<div class="content-check-borrar-item">
					<paper-checkbox class="xCursor" id="check_recuperar_stock">
						<p class="fw-600">Recuperar Stock</p>
					</paper-checkbox>
				</div>
				<br>
				<button class="btn btn-success mr-1" dialog-dismiss onclick="xGetPermisoEliminarItem();"> Si Borrar. </button>				
				<button class="btn btn-danger" dialog-dismiss>Cancelar</button>
				<br>
				<div class="mt-2">
					<x-comp-btn-permiso></x-comp-btn-permiso>
				</div>				
			</div>
		</paper-dialog>
		<paper-dialog style="min-width:290px; width:80%" id="dialog_add_item" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
			<div class="xContent">
				<br>
				<div>
					<input type="text" class="xMiInput" placeholder="buscar..." style="width:70%"  inline id="txt_bus_item">
					<input type="number" class="xMiInput" placeholder="cantidad" style="width:20%" value="1" pattern="[0-9]+([\.,][0-9]+)?" step="any" min="1" inline id="cant_item">
				</div>
				<br><br><br>
				<div class="xBoton2 xVerde" dialog-confirm  onclick="xBorrar_item();"> SI </div>
				<div class="xBoton2 xRojo" dialog-dismiss>Cancelar</div>
				<br><br>
			</div>
		</paper-dialog>
		<paper-dialog id="dialog_cambiar_mesa" style="max-width:350px;" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
			<div class="xContent">
				<br>
				<h4>CAMBIAR</h4>
				<h4 id="titulo_cambiar_mesa" class="txt_anular_cambiar_mesa">Cambiar de mesa todos los pedidos</h4>
				<div>
					<h4>Mesa:</h4>
					<input type="number" class="xMiInput xfont18" placeholder="Numero mesa" enlinea pattern="[0-9]+([\.,][0-9]+)?" step="any" min="1" inline id="txt_num_mesa_change" autofocus>
				</div>
				<br><br><br>
				<div class="xBoton2 xVerde" dialog-confirm onclick="xCambiarMesa();">Cambiar</div>
				<div class="xBoton2 xRojo" dialog-dismiss>Cancelar</div>
				<br><br>
			</div>
		</paper-dialog>

		<paper-dialog id="dialog_motivo_anular" class="dialog_redondo" style="min-width:320px; background: #212121; color: #fff;"  entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
			<div class="xContent">
				<h3>ANULAR</h3>
				<h4 class="txt_anular_cambiar_mesa"></h4>
				<br>
				<h4>Indique el motivo de anulacion</h4>
				<div>
					<!--textarea class="xMiInput" placeholder="Motivo..." id="txt_motivo_anular" autofocus espaciar></textarea-->
					<input type="text" class="xMiInput text-white" placeholder="Motivo..." id="txt_motivo_anular" autofocus>
				</div>
				<br>
				<div class="content-check-borrar-item">
					<paper-checkbox class="xCursor" id="check_recuperar_stock_all_pedido">
						<p class="fw-600">Recuperar Stock</p>
					</paper-checkbox>
				</div>
				<br>
				<div>
					<button class="btn btn-success mr-1" dialog-dismiss onclick="pass_us.open();">Listo</button>
					<button class="btn btn-danger" dialog-dismiss>Cancelar</button>

					<!-- <div class="xBoton2 xVerde" dialog-dismiss onclick="pass_us.open();">Listo</div> -->
					<!-- <div class="xBoton2 xRojo" dialog-dismiss>Cancelar</div> -->
					<br>
					<div class="mt-2">
						<x-comp-btn-permiso></x-comp-btn-permiso>
					</div>
				</div>				
			</div>
		</paper-dialog>

		<paper-dialog id="dialog_cambiar_item" style="border: 1px solid #bdbdbd;" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
			<h3>CAMBIAR POR</h3>
			<div>
				<input type="text" class="xMiInput xfont18 xPasarEnter2" placeholder="Buscar" id="list_bus_item" inline autofocus espaciar>
				<input type="number" min="1" max="2" onkeyup="xValidarCant_change(this)" onchange="xValidarCant_change(this)" class="xMiInput xfont18 xPasarEnter2 xtxtCentro" placeholder="Cantidad" id="txt_bus_cant" value="1" inline espaciar>
				<input type="text" class="xMiInput xPasarEnter2" placeholder="Especificaciones..." id="txt_espcificacion" inline autofocus espaciar>
				<form id="frm_change_item" method="post" class="xInvisible">
					<input type="text" id="idpedido_detalle" name="idpedido_detalle">
					<input type="text" id="idpedido" name="idpedido">
					<input type="text" id="idtipo_consumo" name="idtipo_consumo">
					<input type="text" id="idcategoria" name="idcategoria">
					<input type="text" id="idcarta_lista" name="idcarta_lista">
					<input type="text" id="iditem" name="iditem">
					<input type="text" id="idseccion" name="idseccion">
					<input type="text" id="cantidad" name="cantidad">
					<input type="text" id="punitario" name="punitario">
					<input type="text" id="ptotal" name="ptotal">
					<input type="text" id="descripcion" name="descripcion">
				</form>
				<br>
				<br>
				<div class="xBoton2 xVerde" dialog-confirm  onclick="xCambiar_item();"> Listo </div>
				<div class="xBoton2 xRojo" dialog-dismiss>Cancelar</div>
				<br>
			</div>
		</paper-dialog>


		<paper-dialog style="min-width:290px; max-width: 450px;" id="dialog_info_call_repartidor" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
			<div class="xContent">
				<p id="msj_dialo_call"></p>
				<br>
				<div class="xBoton2 xVerde" dialog-dismiss onclick="xCallRepartidorPapayaExec();" id="btnConfirmaCallReparto"> Si, Confirmo. </div>
				<div class="xBoton2 xPlomo" dialog-dismiss>Cancelar</div>
				<br><br>
			</div>
		</paper-dialog>


		<paper-dialog modal id="dialog_detalle" class="theme1 xNoScroll" entry-animation="scale-up-animation" exit-animation="fade-out-animation">
			<div>

				<iron-pages selected="0" id="content_page" class="xNoScroll">
					<div id="div_detalle_pedido" class="xNoScroll">
						<div class="lh-7">
							<div class="xDerecha d-flexx">
								<!-- <div>									
									<button>Llamar repartidor</button>
								</div> -->
								<div style="width: 50px;" class="mr-2 text-center" id="showRepartoAsignado">
									<i class="fa fa-check text-success fa-2x"></i>
									<span class="fs-9 fw-600">Repartidor Asignado</span>									
								</div>
								<div style="width: 50px;" class="mr-2 text-center" id="showLoadingReparto">
									<i class="fa fa-motorcycle fa-2x"></i>
									<span class="fs-9 fw-600">Buscando Repartidor</span>
									<paper-progress indeterminate class="w-100"></paper-progress>
								</div>
								<paper-fab mini icon="perm-phone-msg" onclick="xCallRepartidorPapaya()" title="Llamar a Repartidor de Papaya Express" tabindex="0" class="btnAddPapaya" id="btnLlamarRepartidorP"></paper-fab>
								<paper-fab icon="add" onclick="xOpenLULI()" title="[F8] Agregar item" tabindex="0" class="btnAdd2"></paper-fab>								
							</div>
							<h3 id="p_mesa">MESA 02</h3>
							<div class="xfont11 pb-3"><span id="p_correlativo"> CO: 00112</span><span id="p_referencia"> DR VALDES</span><span id="p_antendido"> | ATENDIDO POR: ORLANDO</span></div>													


							<div class="xdiv-info-delivery xInvisible lh-15" id="content-info-delivery">


								<!-- cuando tiene repartidor propio o no a llamado a papaya express -->
								<div id="divRepartidorPropio" class="pb-3">
									<div id="divRepartidorNom" class="xInvisible">
										<span class="xfont11">Repartidor: </span>
										<span class="xBold" id="a_nom_repartidor"></span>
										<hr>
									</div>
									<div id="divRepartidorSelect" class="xInvisible">																	
										<span class="xfont11">Repartidor: </span>
										<select name="" id="selectRepartidor" onchange="selectRepartidor()">
											<option value="-1">No Asignado</option>
											<template is="dom-repeat" items="{{listRepartidor}}" as="repartidor">
												<option value="[[index]]">[[repartidor.nombre]] </option>
											</template>
										</select>
										<hr>
									</div>	
								</div>


								<!-- <div class="xfont11"  style="padding: 5px 0px 5px 0px;" id="txt-info-delivery">DELIVERY: 42299556 | MARCELO RAMIREZ | JR. REYES GUERRA 7 | 745212 | PAGA CON: 420 : EFECTIVO</div> -->
								<div class="div-info-pedido">									
									<div class="w-50">
										<span class="xColorRow_Plomo3 fs-13">Datos del Cliente</span>
										<div id="info-pedido" class="fs-11">

										</div>
										
									</div>
									<div class="w-50">											
										<p class="xColorRow_Plomo3 fs-13">Comprobante</p>
										<div id="info-comprobante" class="fs-11">

										</div>
									</div>
								</div>
								<div id="div-info-delivery-from-app" class="xInvisible" style="padding: 5px 0px 5px 0px; border-top: 1px solid #bbbb; background: antiquewhite;">		
									<!-- <div class="xLinea"></div> -->
									<div class="xfont12" id="txt-info-delivery-from-app"></div>
								</div>
							</div>
							<!-- <br> -->
						</div>
						<div class="xLinea"></div>
						<br>
						<div class="content-pedido">
							<table width="100%" class="xtable4">
								<tr class="xSinBorde_tr" valign="top">
									 <!-- style="padding-right:10px;" -->
									<td width="40%" class="pd-r-10">
										<div class="xtd-derecha" id="xBodyPedidos">
										<table width="100%" id="tb_pedidos" class="xRowPading4">
											<thead><th colspan="5" align="left">PEDIDOS</th></thead>
											<tr class="row selected1 xCursor check_item_p" data-idpedido="1">
												<td><paper-checkbox checked class="check_item"></paper-checkbox>1</td>
												<td>Pedido 00102</td>
												<td>13:15:02</td>
												<td align="right" class="td_importe" id="td_importe">120.00</td>
											</tr>
											<tr class="row selected1 xCursor check_item_p" data-idpedido="2">
												<td><paper-checkbox checked class="check_item"></paper-checkbox>2</td>
												<td>Pedido 00102</td>
												<td>13:15:02</td>
												<td align="right" class="td_importe" id="td_importe">120.00</td>
											</tr>
											<tr class="row selected1 xCursor check_item_p" data-idpedido="3">
												<td><paper-checkbox checked class="check_item"></paper-checkbox>3</td>
												<td>Pedido 00102</td>
												<td>13:15:02</td>
												<td align="right" class="td_importe" id="td_importe">120.00</td>
											</tr>
										</table>
										<br>

										<!-- <button class="btn btn-sm btn-warning"><i class="fa fa-sort-amount-desc"></i> Aplicar Descuento</button> -->
										<x-comp-descuento id="component_descuento_pedido" importeventa$="[[ importeTotalPedido ]]"></x-comp-descuento>

										<br><br>
										</div>
									</td>
									<td class="xBordeIzq pd-l-10">		
										<div>
											<img src="../../images/_union.png" onclick="xJuntarFilasIguales();" class="xDerecha xAlinearce xCursor pos-union" title="Unir items">
											<img src="../../images/_juntar_row.png" onclick="xDesJuntarItem();" class="xDerecha xAlinearce xCursor pd-l-10-a" title="Separar items">
										</div>								
										<div class="xtd-derecha" id="xBody">
										<div>
										<table width="100%" id="tb_det_pedidos" class="xRowPading4">
											<!--thead><th colspan="6" align="left">Detalle del pedido | <div class="xBoton_flat xPlomo"> (2)</div><div class="xBoton_flat xPlomo">Para LLevar (3)</div></th></thead-->
											<tr>
												<td colspan="5" class="xFondoRowPlomo">CONSUMIR EN EL LOCAL</td>
											</tr>
											<tr>
												<td colspan="5"><h4>ENTRADAS</h4></td>
											</tr>
											<tr class="row xCursor" data-idpedidodetalle="1" data-idpedido="1" data-punitario="1.00" data-idtipoconsumo="1" data-idcategoria="1" data-idcartalista="117422605116">
												<td width="50px" class="click_row_dt_p" id="td_cant"><paper-checkbox  class="check_item"></paper-checkbox>03</td>
												<td class="click_row_dt_p">COCO RALLADO</td>
												<td class="click_row_dt_p" align="right" id="td_importe">0.00</td>
												<td align="center" class="td_op" data-op="cambiar"><img src="../../images/_change.png" title="Cambiar"></td>
												<td align="center" class="td_op" data-op="borrar"><img src="../../images/_delete3.png" title="Borrar"></td>
											</tr>
											<tr class="row xCursor" data-idpedidodetalle="2" data-idpedido="1" data-punitario="2.00" data-idtipoconsumo="1" data-idcategoria="1" data-idcartalista="11122605116">
												<td width="50px" class="click_row_dt_p" id="td_cant"><paper-checkbox  class="check_item"></paper-checkbox>02</td>
												<td class="click_row_dt_p">GELATINA</td>
												<td class="click_row_dt_p" align="right" id="td_importe">2.00</td>
												<td align="center" class="td_op" data-op="cambiar"><img src="../../images/_change.png" title="Cambiar"></td>
												<td align="center" class="td_op" data-op="borrar"><img src="../../images/_delete3.png" title="Borrar"></td>
											</tr>
										</table>
										</div>
										
										</div>
										<div class="d-flexx justify-content-end align-items-center" style="position: sticky; width: 100%;" hidden$="[[ !isAddItemRow ]]">
											<button class="btn btn-success" style="margin-top: -80px;" onclick="xArmarSqlAddLUlI()" ><i class="fa fa-check"></i> Confirmar</button>
										</div>
									</td>
								</tr>
							</table>
						</div>
						 <!-- style="overflow: hidden;" -->
						<div class="xAddItemPedido xNoScroll" id="SelAddLuLi">
								<div>
									<x-comp-find-categoria id="compFindCategoria" onchange="_getCategoria(categorias)"></x-comp-find-categoria>
									<select class="xTextRow2 xCursor w-100" id="select_ulTPC"></select>
									<input type="text" class="xMiInput w-100" placeholder="Buscar.." id="txt_bus_item_add">
								</div>
								<br>
								<ul id="accordion" class="list_add_item noselect">
									<!--li><li data-cat="gaseosas">
												<div>
													<div class="xicon3 xeditar xbtn_li_editar" title="editar"></div>
													<p class="xtitulo_li">LOMITO SALTADO CON VINO TINDO DEL ORIENTE NACIONAL EN SUDADO DE PAICHE</p>
													<input type="text" class="xMiInput" anchofull id="xinput_li">
												</div>
												<div class="xBtn_contet_li">
													<div class="xBtn_li">+</div>
													<span class="xcant_li">1</span>
													<div class="xBtn_li">-</div>
												</div>
											</li>
										</ul>
									</li-->
								</ul>
								<br>
								<div class="footer_dialog-more-item xFondoRowPlomo3">
									<div class="xLinea"></div>
									<br>
									<button class="btn btn-success" onclick="xArmarSqlAddLUlI();">F9 | Confirmar</button>
									<button class="btn btn-secondary" onclick="xCloseLULI();">Cerrar</button>
									<br>
								</div>

								<div class="xInvisible"><table data-TablaName="pedido_detalle" id="xli_tb_pedido_ad"></table></div>
						</div>
						<div class="footer_dialog xAlinearce xFondoRowBlanco2">
							<!-- <div class="xLinea"></div> -->
							<br>
							<!-- style="margin-top: 12px;display: inline-flex;" -->
							<div class="xDerecha pos-fotter-btn">
								<div class="xMiBoton_icon_lateral bgwhite mg-t-15" onclick="xImprimirPrecuenta();"><img src="../../images/_pre_cuenta.png"><p class="fs-10 m-0">Pre-cuenta</p></div>
								<div class="xMiBoton_icon_lateral bgwhite mg-t-15" onclick="xOpenCambiarMesa();" id="btn_cambiar_mesa"><img src="../../images/_cambiar_mesa.png"><p class="fs-10">Cambiar mesa</p></div>
								<div class="xMiBoton_icon_lateral bgwhite mg-t-15" onclick="xOpenAnularPedido();" id="btn_anular_pedido"><img src="../../images/_delete_pedido.png">
									<p class="fs-10">
										Anular
										<i id="btn_punto_verde_pedido" class="fa fa-unlock text-success punto-flotante-verde fs-12"></i>
									</p>
								</div>
							</div>
							<button class="btn btn-primary" id="btn_registrar_pago" onclick="xIrPage(1);">F10 | Listo, pagar</button>
							<button class="btn btn-dark" dialog-dismiss onclick="xCPcloseDialogDetalle()">Cerrar</button>

							<!-- <button class="xBoton2 xVerde" onclick="xImprimirComprobante()">Factura</button> -->
							<br>
						</div>
					</div>
					<div id="div_pago">
						<x-pago id="component_pago"></x-pago>
						<!-- <div class="xLinea"></div>
						<br>

						<div hidden="[[!hidden_container_registro_pago]]">
							<button class="xBoton2 xPlomo" onclick="xIrPage(0);" id="btn_regresar_cuenta">Regresar</button>
							<button class="xBoton2 xAzul" onclick="xValPagoMostrarContainerPago();" id="btn_pago_next" disabled="[[!valid_form_cliente_pago]]">[F10] Siguente</button>
						</div>

						<div hidden="[[hidden_container_registro_pago]]">
							<div class="xBoton2 xPlomo" onclick="xValPagoMostrarContainerPago();" id="btn_regresar_comprobante">Regresar</div>
							<button class="xBoton2 xAzul" onclick="xRegistrarClientePagoCP();" id="btn_pago" disabled="[[!valid_monto_pago]]">[F10]Listo, registrar pago</button>
						</div>						

						<br><br> -->
					</div>
					<br><br>
				</iron-pages>
			</div>
		</paper-dialog>
		<br>
		<div class="xContent d-flex">
			<!-- <button onclick="PlaySound('notificaNuevoPedido');">aaa</button> -->						
			<div class="grid grid-contente-pedidos" id="_gridCM" style="overflow:hidden !important;">
				<paper-spinner active class="xCentradoVerticalHorizontal"></paper-spinner>
				<!--div class="xMiCardPedido xNeutro" data-tpc="LOCAL">
					<p class="tipo">Mesa</p>
					<h3 class="numero xBold">01</h3>
					<p class="tiempo xfont11">disponible</p>
					<p class="importe xBold">-</p>
				</div-->
			</div>
			<div id="control-delivery-new-view" class="xInvisible">
				<x-control-delivery id="comp-control-delivery"></x-control-delivery>
			</div>

			<!-- div lateral notificacion cuentas pagadas por el cliente -->
			<!-- <div class="div-lateral-notifica-pago">
				<h1>aaaaa</h1>
			</div> -->
		</div>
	</template>
<style>
	.lh-7{line-height: 7px;}
	.lh-15{line-height: 15px;}
	.pd-r-10 { padding-right:10px; }
	.pd-l-10 { padding-left:10px; }
	.pd-l-10-a { padding-left:10px; position:absolute; right:40px; }
	.mg-t-15 { margin-top:-15px; }
	.pos-union { position:absolute; right:78px; }
	.pos-fotter-btn { margin-top: 12px;display: inline-flex; }

	.div-filtro-header-input { width:80px; margin-right:5px; }
	.subtotal-tr-row {padding-top:1px;padding-bottom:1px;}
	.xdiv-info-delivery {
		padding: 10px 0px 0px 0px;
		border-top: 1px solid lightgrey;
		margin-top: 10px;
		color: gray;
	}

	.content-info-delivery {
    	line-height: 15px;
	}

	.txt-info-delivery {
		line-height: 15px !important;
	}

	.txt-info-delivery-from-app {
		padding: 5px 5px !important;
	}

	.content-check-borrar-item {
		background: #e9e9e9;
    	padding: 5px;
    	border-radius: 3px;
		display: flex;		
	}

	/* content-pedido debe tener la altura de dialog_detalle - 120px*/	
	/* .content-pedido {
		height: calc(100% - 193px);
		overflow: auto;
	} */
	
</style>
</dom-module>
<style type="text/css">
	.grid:after {
		content: '';
		display: block;
		clear: both;
	}
	#dialog_detalle.tall{
		border-radius: 5px; width: 100%;min-width: 300px;
		position: fixed;
		top: 0;
		left: 2;
		bottom: 0;
		right: 2;
		margin: 2px;
		min-height: 50vh;
		width: -webkit-fill-available;
		height: -webkit-fill-available;
	}

	#dialog_detalle.tall-polys{
		width: -webkit-fill-available;
		height: -webkit-fill-available;
		border-radius: 5px;
	}

	#dialog_detalle.normal{border-radius: 5px; width: auto 0;min-width: 300px;}
	.xtd-derecha{height: calc(100vh - 193px); bottom: 0;  overflow-y:auto;}
	img.xdisabled{pointer-events:none;opacity:0.5; cursor:auto;}

	

</style>

<!-- <script  type="text/javascript" src="../view/config.const-d4c9262c.js"></script>
<script  type="text/javascript" src="../view/xJsonSunat.js"></script>
<script  type="text/javascript" src="../view/item_pedido_estructura.js"></script>
<script  type="text/javascript" src="../view/item_pedido_subtotales.js"></script>
<script  type="text/javascript" src="../view/item_pedido_print_comprobante.js"></script>
<script  type="text/javascript" src="../view/manager_storage.js"></script>
<script  type="text/javascript" src="../view/cliente.service.js"></script>
<script  type="text/javascript" src="../view/deNumALetras.js"></script> -->

<!-- <script type="text/javascript" src="../view/config.const-d4c9262c.js"></script> -->
<!-- <script src="../../js/isotope.pkgd.min.js"></script> -->
<!-- <script src="../../js/isotope.pkgd.min.js"></script> -->
<script type="text/javascript" src="../view/item_pedidos.js"></script>
<script type="text/javascript" src="../view/xJsonSunat.js"></script>
<script type="text/javascript" src="../view/xSOAPSunat.js"></script>
<script type="text/javascript" src="../view/cpe_interno.js"></script>
<script type="text/javascript" src="../view/cliente.service.js"></script>
<script type="text/javascript" src="../view/item_pedido_estructura.js"></script>
<script type="text/javascript" src="../view/item_pedido_subtotales.js"></script>
<script type="text/javascript" src="../view/item_pedido_print_comprobante.js"></script>
<script type="text/javascript" src="../view/deNumALetras.js"></script>
<script type="text/javascript" src="../view/manager_storage.js"></script>
<!-- <script type="text/javascript" src="../view/cliente.service.js"></script> -->


<script>
// import { xCargarDatosAEstructuraImpresion } from '../view/item_pedido_estructura.js';

var xThisCM,
	xsourceEvent,
	xRefreshPedidos,
	xRefreshHora,
	xIdFiltro1='',
	xCronometro_us=0,
	xPermisoSupervisor=0,
	xPermisoSupervisorNombre='',
	xRefreshPermiso,
	xpass_op,
	xid_pedido_detalle_item,
	xid_carta_lista_de,
	xid_carta_lista_a,
	xidprocede_item_lista,
	xdescontar_en_item_lista, //tabla descontar /carta_lista, porcion, almacen_items
	xIDdescontar_en_item_lista, //id segun tabla a desontar
	xid_pedido,
	xid_tpc_item,
	xid_cat_item,
	xcant_item,
	xobj_row_item,
	xObj_miPedido,
	xPopupLoad,
	xtt_pedidos=0,
	xDtPrint = [],
	xDtSede_cm= [],
	xArrayEnca=[],
	xArrayPrintEncaLi=[],
	xArrayPedido=[],
	xDtSubTotales=[],
	xRpt_pago=[],
	xitem_print,
	xidpedido_filtro=0, //filtro ordenacion agrupamiento
	xArraychek_pedido=[],//filtro ordenacion agrupamiento
	xAgrupar_item_activo=false,//filtro ordenacion agrupamiento // desabilita botnes cambiar o eliminar
	xArrayTpC=[], //ini en xLoadMipedidoBD tambien para formar array o estructura de  impresion en precuenta o factura, estructura de pedido={tipo consumo > seccion > items}
	xArraySeccion=[], //ini en xLoadMipedidoBD tambien  para formar array impresion  en precuenta o factura
	xArrayDtOrdenFiltro=[], // array resultado de orden y filtro
	xopen_add_item=false,//abrir add item con key
	xidpedid_txt_change='',//par cambiar mesa
	xSelAllPedidos=false,
	xbuscar_mesa=false,
	iIniIsotope=false,
	xkey_f10=true,
	xidCategoriaPD='',
	xArrayItemEliminar=[],
	xCountTotalPedidos=0, //cuenta la cantidad total de pedidos, si es diferente actualiza
	xValCountPedidos=0,
	enProcesoGuardarPago = false,
	guardandoPedido_cp = 0,
	checkItemsSeleccionados = [], // items seleccionados o todos // al sumar cantidades
	arrSumSubtTotales = [], // calcula y obtiene array de subtotales si los ubiera { igv, servio, taper etc..}
	ImporteDiferencia = 0, // la diferencia por pagar, para saber si es una seleccion total o parcial 
	xImporteTotalSeleccionados = 0,  // obtiene el total de los pedidos seleccionados
	datosDelivery = null, 
	isSocket = false, isPedidoOpenDeliveryCliente = false, arrTotalesDeliveryCliente, xid_pedido_selected, optionDeliveryCliente, xdtDpedido
	, pasoRedibujado = false, isPedidoPagadoFromApp = false, cuentaEventoLoadIni = 0, cuentaEventoLoadIniPrincipal = 0, xCompDescuentoPedido, arrSubtTotalesDescuento, xPSupervisor, lastIdPedidoPrint = 0;

var EstadoLoadMesas=false, firstLoad_mesas=true, lastIdPedidoCobrado = 0, lastDataPedidoInsert = null, xp_sel_idcategoria
	,isComercioServicioDeliveryPropio = false, isDeliveryCalculaCostoEntrega = false, isDeliveryCalculaCostoEntregaSoloApp = false,
	idUsuarioOperador = 0, isPedidoDelivery = false, isDeliverySolicitoReparto = false, isClienteDeliveryFromApp = false,
	countIntiCP = 0, isPassAddRowItemList = false;

const _fetchApi = new httpFecht();

function xIniControlMesa(){

	if ( cuentaEventoLoadIniPrincipal > 0 ) { return; }
	cuentaEventoLoadIniPrincipal++;

	// console.log('inicio control -> ', cuentaEventoLoadIniPrincipal)

	$( "#accordion" ).accordion({
		heightStyle: "content",
		animate: 50
	});

	$( "#spinner_li" ).spinner({
      min: 0,
      step: 1
    });

	$( "#tb_accordion" ).accordion({
		heightStyle: "content"
	});

	xPopupLoad=document.getElementById('xLoad');
	//xm_LogChequea(function(){ inicia en m_control_pedidos--9f5dcc9a.js		
		isSocket = parseInt(xm_log_get('datos_org_sede')[0].pwa) === 0 ? false : true;
		idUsuarioOperador =  xIdUsuario;


		firstLoad_mesas=true;
		
		xm_log_get('ini_us');

		xNuevoPedidoCM();
		xTraerDtTipoConsumo();
		xLoadDtPrintCM();
		xLoadLastIdPedidoCobrado();
		xLoadMesas();
		xRefreshHora=setInterval(function () {xCalcularTiempoPedido()},2000);

		xShowCantidadPedidosBorrados();

		var xDesFiltro1=getUrlParameter('df1','?');
		xDesFiltro1 = xDesFiltro1.replace(/%20/g, " ");
		xIdFiltro1=getUrlParameter('f1','?');
		$("#Titulo_page").text("PEDIDOS | "+xDesFiltro1);
		document.title ="Control de Pedidos";

		// $("#div_filtro_header").html('<input type="text" class="xMiInput" id="txt_bus_mesa" name="txt_bus_mesa" style="width:80px; margin-right:5px;" placeholder="mesa" letrablanco><div class="xBoton2 xVerde" onclick="xOrdenPedido(1);">Por Estado</div><div class="xBoton2 xPlomo" onclick="xOrdenPedido(0);">Por Numero</div>')
		$("#div_filtro_header").removeClass('xInvisilbe');
		// $("#div_filtro_header").html(`<div class="bg-white xBoton2"><input type="number" class="xMiInput" id="txt_bus_mesa" name="txt_bus_mesa" style="width:50px; margin-right:5px;" placeholder="# mesa" autocomplete="off"></div>
		// 							<div class="xBoton2 xVerde" onclick="xOrdenPedido(1);">Por Estado</div>
		// 							<div class="xBoton2 xPlomo" onclick="xOrdenPedido(0);">Por Numero</div>`).trigger('create');

		$("#div_filtro_header").html(`<x-input-search-pedido-in-page id="comp_input_search_pedido_in_page"></x-input-search-pedido-in-page>
									<div class="xBoton2 xVerde ml-1" onclick="xOrdenPedido(1);">Por Estado</div>
									<div class="xBoton2 xPlomo" onclick="xOrdenPedido(0);">Por Numero</div>`).trigger('create');

									
		


		xThisCM.xt_org=xIdOrg;
		xThisCM.xt_idsede=xIdSede;
		xThisCM.xt_idus=xIdUsuario;

		// xCargarCategoriaActual(function(xcat_id){
		// 	if(xcat_id.length==1){
		// 		xidCategoriaPD=xcat_id[0].idcategoria;
		// 		//$("#titulo_categoria").text(xcat_id[0].descripcion);
		// 	}
		// });

		
	//})
	//if(xIdOrg=='' || xIdOrg==undefined){xIdOrg=window.localStorage.getItem('::app3_wo');}
	//if(xIdUsuario=='' || xIdUsuario==undefined){xIdUsuario=window.localStorage.getItem('::app3_woU');}
	//xDtPrint=$.parseJSON(window.localStorage.getItem("::app3_sys_dta_prt"));



	//window.localStorage.removeItem("::app3_sys_dta_pe");
	//window.localStorage.removeItem("::app3_sys_dta_tct");
	///xNuevoPedidoCM();
	//xLoadArrayPedido(); //item_pedidos
	///xTraerDtTipoConsumo();
	//xLoadDataUlAdd();
	//xRefreshMesas=setInterval(function () {xLoadMesas()},6000);
	//xLoadDtPrintCM();
	///xLoadMesas();
	///xRefreshHora=setInterval(function () {xCalcularTiempoPedido()},2000);
	//xRefreshPedidos=setInterval(function () {xVerificarSiActualizaItems()},5000);
	//xLoadItems_cambio();

	//xLoadRegla();

	//para controlar las teclas f8-f10
	document.defaultAction = false;
	var eventHandler = true ? detectEvent : empty;
	document.body['onkeydown'] = eventHandler;

	$('.xPasarEnter2').on('keyup',function(e){
		var code=e.which;
		if ( code==13||code==186 ) {
			var inputs = $('input'); // storage a array of Inputs
		    var a = inputs.index(document.activeElement);
		    if (inputs[a + 1] !== null)
		    {
		      var nextBox = inputs[a + 1];
		      if(nextBox.disabled){nextBox = inputs[a + 2]}
		      nextBox.focus();
		      //event.preventDefault();
		    }
		    return false;
  		}
	});

	$('#txt_bus_item_add').keyup(function(e){
	   var filter = $(this).val();
	   if(filter==''){
	   		$('.list_add_item li').each(function(){
	   			$(this).show();
	        	//$(this).children().show();
	   		})
			//$( "#accordion" ).attr( "option", "collapsible", true );
			//$( "#accordion" ).accordion( "option", "active", 1 );
			return;

	   }
	   var xtext_data='';
	    $(".list_add_item li").each(function() {
	    	xtext_data=$(this).text()+$(this).attr('data-cat');
	      if (xtext_data.search(new RegExp(filter, "i")) < 0) {
	        //$(this).slideUp('easing');
	        $(this).hide();
	      } else {
	        $(this).show();
	        $(this).find('ul').show()
	        //$(this).children().show();
	        //$(this).find('.xBtn_contet_li').css('display','none');
	      }
	    });

	    //si se ingresp codigo de barras o si hay un solo elemento en la lista
	    if(e.keyCode==13){
	    	if($(".list_add_item li ul li:visible").length==1){
	    		xBtnSumarRestarKey($(".list_add_item li ul li:visible").find('.xBtn_li'),1);
	    		$(this).val('');
	    	}
	    }
	});


	//$(".list_add_item li ul li").on('focusout',function(){
	$(document).on('focusout', '.list_add_item li ul li', function(e) {
		var element_input=$(this).find("#xinput_li");
		if($(element_input).css('display') == 'inline-block'){
			if($(element_input)[0].value==''){
				$(element_input).css('display','none');
			}
		}
	})
	$(document).on('click', '.xbtn_li_editar', function(e) {
		$(this).parent().find('#xinput_li').css('display','inline-block');
		$(this).parent().find('#xinput_li').focus();
		// event.stopPropagation();
		e.stopPropagation();
		e.stopImmediatePropagation()
	});

	$(document).on('click', '.check_item_p', function(e) {
		//check pedidos
		xCheckPedidos();
		//var xcheck=this.classList.contains('selected1');//this.checked;//$(this).hasClass('selected1');
		if(xSelAllPedidos==true){//si todos los pedios estan seleccionados, selecciona solo uno
			$("#tb_pedidos .check_item").each(function(index,element){
				element.checked=false;
				//element.classList.remove("selected1")
				$(element).parent().parent().removeClass('selected1');
				$(element).parent().parent().find("#td_importe").removeClass('td_importe');
			})

			//xcheck=false;
		}

		var xcheck=this.classList.contains('selected1');//this.checked;//$(this).hasClass('selected1');
		var xidpedido_sel=$(this).attr('data-idpedido');

		if(xcheck==true){
			$(this).removeClass('selected1');
			$(this).find('.check_item').attr('checked',false);
			$(this).find("#td_importe").removeClass('td_importe');
			//xFiltrarRowAttr($("#tb_det_pedidos"),'data-idpedido',xidpedido_sel,false);
			//xidpedido_filtro=xidpedido_sel;
		}else{
			$(this).addClass('selected1');
			$(this).find('.check_item').attr('checked',true);
			$(this).find("#td_importe").addClass('td_importe');
			//xFiltrarRowAttr($("#tb_det_pedidos"),'data-idpedido',xidpedido_sel,true);
			//xidpedido_filtro=0;
		}
		xFiltrarRowArray();
		xSumarTotalPedidos();

		//check pedidos
		xCheckPedidos();

		// event.stopPropagation();
		e.stopPropagation();
		e.stopImmediatePropagation()
	})


	$(document).on('click', '.click_row_dt_p', function(e) {
		
	//$(".click_row_dt_p")('click',function(e){		
		var obj_row=$(this).parent();
		var xcheck=obj_row.hasClass('selected1');
		if(xcheck==true){
			obj_row.removeClass('selected1');
			obj_row.find('.check_item').attr('checked',false);
			obj_row.find("#td_importe").removeClass('td_importe');
		}else{
			obj_row.addClass('selected1');
			obj_row.find('.check_item').attr('checked',true);
			obj_row.find("#td_importe").addClass('td_importe');
		}

		xSumarTotalPedidos();

		// event.stopPropagation();
		e.stopPropagation();
		e.stopImmediatePropagation()
	})	

	$(document).on('click', '.btn-add-item', async function(e) {
		// agregar item al pedido desde item

			xobj_row_item=$(this).parents('tr')[0];

			const _tipoConsumo = xobj_row_item.dataset.idtipoconsumo;
			var _cantidad = parseInt(xobj_row_item.dataset.cantidad) + 1;
			var _punitario = parseFloat(xobj_row_item.dataset.punitario);
			var _importeTotal = parseFloat(_cantidad * _punitario).toFixed(2);

			// seteamos
			xobj_row_item.dataset.cantidad = _cantidad;
			xobj_row_item.dataset.cantidadr = _cantidad;
			xobj_row_item.dataset.total = _importeTotal;
			xobj_row_item.dataset.total_r = _importeTotal;
			xobj_row_item.dataset.ptotal = _importeTotal;

			$(xobj_row_item).find('#td_cant').text(xCeroIzq(_cantidad, 2));
			$(xobj_row_item).find('#td_importe').text(_importeTotal);
			
			// setear a select tipo consumo 
			$("#select_ulTPC").val(_tipoConsumo);

			xThisCM.isAddItemRow = true;

			// si no existe o no esta cargado la carta
			handlerFnMiPedidoControl(e);
			


			// xArmarSqlAddLUlI();

			// checkItemsSeleccionados = await getItemsSeleccionados();
			// console.log('checkItemsSeleccionados', checkItemsSeleccionados);
			

			e.stopPropagation();
			e.stopImmediatePropagation();
			return;	
	});

	//$(".td_op").on('click',function(e){
	$(document).on('click', '.td_op', function(e) {
		if($(this).attr('data-procede')!='0'){return;}

		// const opItem = $(this).attr('data-op');
		xpass_op=$(this).attr('data-op');
		xobj_row_item=$(this).parent();

		//agrega item
		// if ( xpass_op === 'itempedido' ) {

		// 	console.log('agrega item');
		// 	const _tipoConsumo = xobj_row_item.data().idtipoconsumo;
		// 	var _cantidad = xobj_row_item.data().cantidad + 1;
		// 	var _punitario = parseFloat(xobj_row_item.data().punitario);
		// 	var _importeTotal = parseFloat(_cantidad * _punitario).toFixed(2);

		// 	// seteamos
		// 	xobj_row_item.data().cantidad = _cantidad;
		// 	xobj_row_item.data().total = _importeTotal;
		// 	xobj_row_item.data().total_r = _importeTotal;

		// 	$(xobj_row_item).find('#td_cant').text(xCeroIzq(_cantidad, 2));
		// 	$(xobj_row_item).find('#td_importe').text(_importeTotal);
			
		// 	// setear a select tipo consumo 
		// 	$("#select_ulTPC").val(_tipoConsumo);
		// 	handlerFnMiPedidoControl(e);

		// 	console.log('xArrayPedidoObj', xArrayPedidoObj);

		// 	// xArmarSqlAddLUlI();
			

		// 	e.stopPropagation();
		// 	e.stopImmediatePropagation();
		// 	return;
		// }

		if(xAgrupar_item_activo==true){return;}
		xArrayItemEliminar=[];
		
		//var xcantEliminar=xobj_row_item.attr('data-cant_descontar');
		//if(isNaN(parseInt(xcantEliminar))){xcantEliminar=parseFloat(xobj_row_item.find('#td_cant').text());}

		xArrayItemEliminar={'procede':xobj_row_item.attr('data-descontar'),
							'cant_descontar':xobj_row_item.attr('data-cant_descontar'),
							'idprocede':xobj_row_item.attr('data-iddescontar'),
							'idalmacen_items':xobj_row_item.attr('data-idcartalista'),
							'idcarta_lista':xobj_row_item.attr('data-idcartalista'),
							'iditem':xobj_row_item.attr('data-iditem'),
							'idseccion': xobj_row_item.attr('data-idseccion'),
							'idimpresora_seccion': xobj_row_item.attr('data-idimpresora_seccion'),
							'idtipoconsumo': xobj_row_item.attr('data-idtipoconsumo'),
							'idpedido_detalle':xobj_row_item.attr('data-idpedidodetalle'),
							'idpedido':xobj_row_item.attr('data-idpedido'),
							'precio_total':parseFloat(xobj_row_item.find("#td_importe").text()),
							'precio_unitario':xobj_row_item.attr('data-punitario'),
							'des_tp': xobj_row_item.attr('data-des_tp'),
							'descripcion': xobj_row_item.attr('data-descripcion'),
							'is_cantidad_nd': xobj_row_item.attr('data-is_cantidad_nd'),
						};
		
		// console.log('xArrayItemEliminar', xArrayItemEliminar );

		const isBtnDeleteRowSuccess = $(this).find('.btn-delete-row').hasClass('text-success');
		
		xCompArraySolitaPermiso = {
			tipo_permiso: 1,
			obj: xArrayItemEliminar,
			mesa: xObj_miPedido.data().nummesa,
			numpedido: xObj_miPedido.data().numpedido,
			isBtnDeleteRowSuccess: isBtnDeleteRowSuccess			
		}
		
		// console.log('0xCompArraySolitaPermiso', xCompArraySolitaPermiso);

		// verificamos si el elemento con la clase 'btn-delete-row' tiene la clase text-success
		// si es asi, entonces no se puede eliminar el item

		

		
		
		

		//xid_tpc_item=xobj_row_item.attr('data-idtipoconsumo');

		

		/*xid_pedido_detalle_item=xobj_row_item.attr('data-idpedidodetalle');
		xid_pedido=xobj_row_item.attr('data-idpedido');
		xid_tpc_item=xobj_row_item.attr('data-idtipoconsumo');
		xid_cat_item=xobj_row_item.attr('data-idcategoria');
		xid_carta_lista_de=xobj_row_item.attr('data-idcartalista');
		xidprocede_item_lista=xobj_row_item.attr('data-procede');
		xdescontar_en_item_lista=xobj_row_item.attr('data-descontar');
		xIDdescontar_en_item_lista=xobj_row_item.attr('data-iddescontar');
		xcant_item=parseFloat(xobj_row_item.find('#td_cant').text());
		$("#txt_bus_cant").attr('max',xcant_item);*/
		
		xOp_permiso();
		// if(xCronometro_us==0){xPSupervisor.setVal('Pe1'); pass_us.open();}else{xOp_permiso();}

		// event.stopPropagation();
		e.stopPropagation();
		e.stopImmediatePropagation()
	});

	xPSupervisor=document.getElementById('pass_us');
	xPSupervisor.setVal('Pe1');
	xPSupervisor.addEventListener('xSend', function (e) {
		var p=e.detail.xRpts[0].p;
		if(p===1){
			xPermisoSupervisor=e.detail.xRpts[0].us;
			xPermisoSupervisorNombre = e.detail.xRpts[0].nomus;
			xCronometro_us=30;
			xRefreshPermiso=setInterval(function () {xcronometro_permiso()},1000);
			// xOp_permiso();
			xGoProcessBorrar();
			e.stopPropagation();
			e.stopImmediatePropagation()
		}
	});

	$("#dialog_cotent").on('iron-overlay-opened',function(){
		$("#dialog_cotent #us").focus()
	})

	
	
	


	xCompDescuentoPedido=document.getElementById('component_descuento_pedido');
	xCompDescuentoPedido.addEventListener('changeDescuento', function (e) {		
		const _rptDsc = e.detail;
		arrSubtTotalesDescuento = colocarDescuentoSubtotales(_rptDsc.value, arrSumSubtTotales, _rptDsc.descripcion, _rptDsc.isAgregar);
		
		xSumarTotalPedidos(null, true);

		e.stopPropagation();
		e.stopImmediatePropagation()
	});

	// xValPago.addEventListener('xContainerPagoVisible', function (e) {		
	// 	xThisCM.hidden_container_registro_pago = e.detail;
	// });

	// xValPago.addEventListener('xFormClienteValid', function (e) {		
	// 	xThisCM.valid_form_cliente_pago = e.detail;
	// });

	// xValPago.addEventListener('xFormPagoValid', function (e) {		
	// 	xThisCM.valid_monto_pago = e.detail;
	// });

	

	$("#dialog_detalle").on('iron-overlay-closed',function(){
		//xVerificarSiActualizaItems();		

		

		xbuscar_mesa=false;
		xdtDpedido = null;

		if ( xThisCM.isAddItemRow ) { // para resetear item no confirmados
			_cpSocketRestoreFromPedidoStorage();
		}

		xCPcloseDialogDetalle();
		//xRefreshPedidos=setInterval(function () {xActualizarItems()},4000);
	})


	$("#dialog_detalle").on('iron-overlay-opened',function(){		
		xbuscar_mesa=true;

		// dialog_detalle.center();

		const dialog_detalleHeight = $('#dialog_detalle').height();
		const footer_dialogHeight = $('#dialog_detalle .footer_dialog').height();	
		const contentHeight = (dialog_detalleHeight - footer_dialogHeight) - 135;
		$('.xtd-derecha').height(contentHeight);
		// // $('.xtd-derecha').height(contentHeight);


		// const backdropDiaglog = document.querySelector('iron-overlay-backdrop');
		// const backdrop = document.querySelector('#backdrop-dialog-detalle');
		// backdrop.style.display = 'block';
		// backdrop.classList.remove('fade-out');

		// dialog_detalle.classList.add('custom-backdrop');

		xValPago=document.getElementById('component_pago');
		xValPago.setObjConntet($("#dialog_detalle"));
		xValPago.addEventListener('xSend', function (e) {
			xRpt_pago=e.detail.xRpts;
			// console.log('xRpt_pago', xRpt_pago);
			var p=e.detail.xRpts[0].ok;
			// if(p==0){
			// 	// $("#btn_pago").attr('disabled', true);
			// 	// xThisCM.valid_monto_pago = false;
			// }else{
			// 	// btn_pago.removeAttribute("disabled")
			// 	// xThisCM.valid_monto_pago = true;
			// 	if(e.detail.xRpts[0].paseEnterTxt==1){xRegistrarClientePagoCP();}
			// }
			if(p!==0){
				if(e.detail.xRpts[0].paseEnterTxt==1){xRegistrarClientePagoCP();}
			}
		});

		xValPago.addEventListener('xCancelarCerrar', function (e) {		
			xIrPage(0);
		});

		xValPago.addEventListener('xListoRegistraPago', function (e) {		
			xRegistrarClientePagoCP();
		});
		// btn_pago.hidden=false;
	})
	$("#dialog_cambiar_mesa").on('iron-overlay-closed',function(){
	 	$("#txt_num_mesa_change").focus();
	})
	$("#dialog_motivo_anular").on('iron-overlay-closed',function(){
	 	$("#txt_motivo_anular").focus();
	})

	$("#dialog_motivo_anular #txt_motivo_anular").keyup(function(e){
		if(e.keyCode==13){dialog_motivo_anular.close(); xPSupervisor.setVal('Pe1'); pass_us.open();}
	})

	$("#dialog_cambiar_mesa #txt_num_mesa_change").keyup(function(e){
		if(e.keyCode==13){xCambiarMesa();}
	})


	$("#content_page").on('iron-select',function(a,e){
		if(a.target.selected==1){
			component_pago.setFocusTxt(); }
	});

	$(document).on('keyup', '.xMiTextReferencia', function(e) {
		const _itemIndex = e.target.parentElement.parentElement.dataset.index;
		xidTipoConsumo = $("#select_ulTPC option:selected").val();
		itemPedidos_objItemSelected = xGeneralDataCarta[_itemIndex];
		xidItem = itemPedidos_objItemSelected.idcarta_lista;
	})

	// aca el focus al txt busqueda
	// $(document).keydown(function(e) {
	// 	if (e.keyCode>=112 || e.keyCode<=123){
	// 		if(xbuscar_mesa==true){return;}
	// 		$("#txt_bus_mesa").focus();
	// 		if(xbuscar_mesa==true){$("#txt_bus_mesa").select();xbuscar_mesa=false;}
	// 	}
	// })
	$(document.body).on('keydown','#txt_bus_mesa',function(e){
		if (e.keyCode==13){
			var xval_bus_m=parseInt($(this).val());
			$(".xMiCardPedido.xOcupado").each(function(index,element){
				var xnum_obj=parseInt($(element).find(".numero").text());
				if(xnum_obj==xval_bus_m){
					lastDataPedidoInsert = null; // el utlimo pedido agregado desde control pedidos
					xLoadDetallesPedido($(element))
					$("#txt_bus_mesa").select();
					// event.stopPropagation();
					e.stopPropagation();
					e.stopImmediatePropagation();

					return;
				}
				$("#txt_bus_mesa").val('');
			})
		}
		// event.stopPropagation();
		e.stopPropagation();
		e.stopImmediatePropagation();
	})

	
	compFindCategoria=document.getElementById('compFindCategoria');
	compFindCategoria.addEventListener('getValorIncial', function (e) {
		// if ( cuentaEventoLoadIni > 0 ) { return; }
		setCatetgoriaCartaCP(e.detail.categorias);
		return;

		let valCategoriaLoalStorage;
		valCategoriaLoalStorage = e.detail.categorias		

		if ( getLocalStorage('::app3_cat_defualt') ) {
			const _valCategoriaLoalStorage = JSON.parse(getLocalStorage('::app3_cat_defualt'));			
			if (_valCategoriaLoalStorage.idcategoria != valCategoriaLoalStorage.idcategoria) {
				setLocalSotrage('::app3_cat_defualt', JSON.stringify(valCategoriaLoalStorage));				
			} else {
				valCategoriaLoalStorage = _valCategoriaLoalStorage;
			}

			xidCategoriaPD = valCategoriaLoalStorage.idcategoria; // toma el que esta en el storage si hubiera
			
			setTimeout(() => {// coloca la categoria antes seleccionada	
				compFindCategoria.$.compFindListCategoria.value = valCategoriaLoalStorage.index;
			}, 500);
		} else {
			xidCategoriaPD = e.detail.categorias.idcategoria; // toma el que esta en el storage si hubiera
		}
				
		
		setLocalSotrage('::app3_cat_defualt', JSON.stringify(valCategoriaLoalStorage));		
		// xLoadDataUlAdd();
		// $("#titulo_categoria").text(e.detail.categorias.descripcion);
	});

	const _getCateogriaCarta = compFindCategoria.getCategoria();
	if ( _getCateogriaCarta ) {
		setCatetgoriaCartaCP(_getCateogriaCarta);
	}

	xPopupLoad=document.getElementById('xLoad');


	$(document.body).on('change', '#select_ulTPC', function(e) {			
			// si hay item seleccionados entonces cambia el tipo de consumo
			xChangeTipoConsumoItems(e.target.value);
		});

	/// laad repartidores
	getAllRepartidor();
}

function xCPcloseDialogDetalle() {
	dialog_detalle.close();
	const backdrop = document.querySelector('#backdrop-dialog-detalle');
	// backdrop.style.display = 'none';
	backdrop.classList.add('fade-out');	
}

function xCPopenDialogDetalle() {
	
	// const backdrop = document.querySelector('#backdrop-dialog-detalle');
	// backdrop.style.display = 'none';
	// backdrop.classList.add('fade-out');

	// $('.xtd-derecha').height(contentHeight);
	const backdropDiaglog = document.querySelector('iron-overlay-backdrop');
	const backdrop = document.querySelector('#backdrop-dialog-detalle');
	backdrop.style.display = 'block';
	backdrop.classList.remove('fade-out');

	dialog_detalle.open();

	// const dialog_detalleHeight = $('#dialog_detalle').height();
	// const footer_dialogHeight = $('#dialog_detalle .footer_dialog').height();
	// const contentHeight = (dialog_detalleHeight - footer_dialogHeight) - 135;
	// $('.xtd-derecha').height(contentHeight);
}

// setear idcategoria
function setCatetgoriaCartaCP(e) {
	let valCategoriaLoalStorage;
		valCategoriaLoalStorage = e;		

		if ( getLocalStorage('::app3_cat_defualt') ) {
			const _valCategoriaLoalStorage = JSON.parse(getLocalStorage('::app3_cat_defualt'));			
			if (_valCategoriaLoalStorage.idcategoria != valCategoriaLoalStorage.idcategoria) {
				setLocalSotrage('::app3_cat_defualt', JSON.stringify(valCategoriaLoalStorage));				
			} else {
				valCategoriaLoalStorage = _valCategoriaLoalStorage;
			}

			xidCategoriaPD = valCategoriaLoalStorage.idcategoria; // toma el que esta en el storage si hubiera
			
			setTimeout(() => {// coloca la categoria antes seleccionada	
				compFindCategoria.$.compFindListCategoria.value = valCategoriaLoalStorage.index;
			}, 500);
		} else {
			xidCategoriaPD = e.idcategoria; // toma el que esta en el storage si hubiera
		}
				
		
		setLocalSotrage('::app3_cat_defualt', JSON.stringify(valCategoriaLoalStorage));	
}


//100521
// motivo: acelerar la consulta de pedido detalle
function xLoadLastIdPedidoCobrado() {
	_fetchApi.axiosExecute({ type: 'POST', url: '../../bdphp/log.php?op=50701' })
	.then((res) => {
	// $.ajax({ type: 'POST', url: '../../bdphp/log.php?op=50701'})
	// .done( function (res) {
		// console.log('id last pedido', res);
		localStorage.setItem('::app3_woLastIdP', res);
		lastIdPedidoCobrado = res;
	});
}

// 12118 // seleccionar idcarta al hacer pedido desde aca (control de mesas)
function _getCategoria(categoria) {

	xidCategoriaPD = categoria.idcategoria;
	setLocalSotrage('::app3_cat_defualt', JSON.stringify(categoria));
	xLoadDataUlAdd();
}

///092018

function xValPagoMostrarContainerPago() {
	xValPago.setVisibleContainerPago();
}

async function PreparComprobante() {
	var checkItemsSeleccionados = await getItemsSeleccionados();
	var xSubItmes = checkItemsSeleccionados.esSeleccionTotal ? [] : checkItemsSeleccionados.arrayPedidosSeleccionados;

	var xArrayEstructura = xCargarDatosAEstructuraImpresion(xSubItmes);
	// armamos los subtotales que retorma en xLocal_xDtSubTotales
	xArmarSubtotalesArray(xArrayEstructura,xDtPrint)
	
}


// obtener los pedidos seleccionados
async function getItemsSeleccionados() {
	var xidpedido_seleccionados = '', idRowClientePedido, xArrayIdClienteUsuarioPedido = [], countPedidosListaSelected = 0, _esSeleccionTodoPeidoLista = false;
	var ximporte_total_seleccionados=0;

	// // si es pago total o parcial
	// var xConsumo_tt_p=parseFloat($("#tb_pedidos #tt_consumo_t").text());
	var ximporte_pagar_tt_p=parseFloat($("#tb_pedidos #tt_importe_pagar_t").text());
	// var xCantidadSubItems =$("#tb_pedidos .check_item").length;

	
	
	$("#tb_pedidos .row.selected1").each(function(index,element){
		countPedidosListaSelected++;
		xidpedido_seleccionados=xidpedido_seleccionados+$(element).attr('data-idpedido')+',';
		idRowClientePedido=$(element).attr('data-idcliente'),
		ximporte_total_seleccionados += parseFloat(ximporte_total_seleccionados)+parseFloat($(element).find("#td_importe"));
		xid_tipo_consumo=$(element).attr('data-idtipoconsumo');

		if ( xArrayIdClienteUsuarioPedido.filter(x => x === idRowClientePedido).length ===0 ) {
			xArrayIdClienteUsuarioPedido.push(idRowClientePedido);
		}

	});

	xidpedido_seleccionados=xidpedido_seleccionados.slice(0,-1);

	_esSeleccionTodoPeidoLista = countPedidosListaSelected == xdtDpedido.length;

	//obtener subitems detalle pedido - idpedido_detalle
	var xArraySql_dt_p=[],
	tb_pedido_dt=$("#tb_det_pedidos"),
	cant_subitem_seleccionados=tb_pedido_dt.find('.row.selected1').length,
	cant_subitems_tb=tb_pedido_dt.find('.row').length,
	importe_total_por_pedido=0;

	var xCantRow=parseInt(tb_pedido_dt.find(".row").length);
	var xCantRowSel=parseInt(tb_pedido_dt.find(".row.selected1").length);
	// xCantRow=xCantRow-xCantRowSel;

	// var _esSeleccionTotal = ximporte_pagar_tt_p<xConsumo_tt_p ? false : true;
	var _esSeleccionTotal = (xCantRowSel < xCantRow && xCantRowSel > 0)  ? false : true;

	//obtner todos los subitems
	tb_pedido_dt.find('.row').each(function(i,e){
		var xid_pedido_dt_p=$(e).attr('data-idpedido'),
			xid_cliente_dt_p=$(e).attr('data-idcliente'),
			xid_iditem=$(e).attr('data-iditem'),
			xid_pedido_detalle_dt_p=$(e).attr('data-idpedidodetaller'),
			ximporte_dt_p=$(e).attr('data-totalr'),
			xpunitario_dt_p = $(e).attr('data-punitario'),
			xcantidad_dt_p = $(e).attr('data-cantidadr'),
			ximporte_dt_p_mostrar=$(e).attr('data-total'),
			xcantidad_dt_p_mostrar = $(e).attr('data-cantidad'),
			xdes_seccion = $(e).attr('data-des_seccion'),
			xid_seccion = $(e).attr('data-idseccion'),
			xsubtotales_tachados = $(e).attr('data-subtotales_tachados'), // para calcular los tachados o quitados - no cobrar
			xdescripcion = $(e).find("#descripcion_item").text(),
			xsub_i='';
			
			if(xid_pedido_detalle_dt_p.indexOf(',')!==-1){
					xid_pedido_detalle_dt_p = xid_pedido_detalle_dt_p.indexOf(',') > -1 ? xid_pedido_detalle_dt_p.slice(0,-1) : xid_pedido_detalle_dt_p;
					ximporte_dt_p = ximporte_dt_p.indexOf(',') > -1 ? ximporte_dt_p.slice(0,-1) : ximporte_dt_p;
					xcantidad_dt_p = xcantidad_dt_p.indexOf(',') > -1 ? xcantidad_dt_p.slice(0,-1) : xcantidad_dt_p;
			}
			/*xid_pedido_detalle_dt_p=$(e).attr('data-idpedidodetalle'),
			ximporte_dt_p=$(e).find("#td_importe").text(),
			xcantidad_dt_p=$(e).find("#td_cant").text(),*/


		xid_tipo_consumo=$(e).attr('data-idtipoconsumo');
		//if(xArraySql_dt_p[xid_pedido_dt_p]===undefined){xsub_i='';importe_total_por_pedido=0;}else{xsub_i=xArraySql_dt_p[xid_pedido_dt_p]["sub_items"];importe_total_por_pedido=xArraySql_dt_p[xid_pedido_dt_p]["tt_x_idpedido"];}

		if(cant_subitem_seleccionados===0){
			//importe_total_por_pedido=parseFloat(importe_total_por_pedido)+parseFloat(ximporte_dt_p);
			//xArraySql_dt_p[xid_pedido_dt_p]={'sub_items':xsub_i+xid_pedido_detalle_dt_p+',','tt_x_idpedido':importe_total_por_pedido};
			xArraySql_dt_p.push({'des_seccion':xdes_seccion, 'idseccion': xid_seccion, 
								'descripcion':xdescripcion,'idpedido':xid_pedido_dt_p,
								'idpedido_detalle':xid_pedido_detalle_dt_p, 
								'iditem': xid_iditem, 'cantidad':xcantidad_dt_p,
								'precio': xpunitario_dt_p, 'total':ximporte_dt_p,'ptotal':ximporte_dt_p_mostrar, 
								'idtipo_consumo': xid_tipo_consumo, 
								'subtotales_tachados': xsubtotales_tachados});
		}else{
			//obtener solo los seleccionados
			if($(e).hasClass('selected1')){
				//importe_total_por_pedido=parseFloat(importe_total_por_pedido)+parseFloat(ximporte_dt_p);
				//xArraySql_dt_p[xid_pedido_dt_p]={'sub_items':xsub_i+xid_pedido_detalle_dt_p+',','tt_x_idpedido':importe_total_por_pedido};
				xArraySql_dt_p.push({'des_seccion':xdes_seccion, 'idseccion': xid_seccion,
									'descripcion':xdescripcion,'idpedido':xid_pedido_dt_p,
									'idpedido_detalle':xid_pedido_detalle_dt_p, 
									'iditem': xid_iditem, 'cantidad':xcantidad_dt_p,
									'precio': xpunitario_dt_p, 'total':ximporte_dt_p,'ptotal':ximporte_dt_p_mostrar, 
									'idtipo_consumo': xid_tipo_consumo, 
									'subtotales_tachados': xsubtotales_tachados});				
			}
		}
	});

	
	return {esSeleccionTodoPeidoLista: _esSeleccionTodoPeidoLista, esSeleccionTotal: _esSeleccionTotal, arrayPedidosSeleccionados: xArraySql_dt_p, arrayIdClienteUsPedido: xArrayIdClienteUsuarioPedido, idPedidosSeleccionados: xidpedido_seleccionados, tipoConsumo : xid_tipo_consumo, importeTotalSeleccionado: ximporte_pagar_tt_p, importeTotalSubItemSeleccionados: ximporte_total_seleccionados };

}

// agrega a la lista los ids del o de los usuario que estan en esta mesa, para notificar si se pago la cuenta
function addListClienteUsuarioPedido(idcliente) {

}

//

function xCheckPedidos(){	
	var xcantidad_pedidos_sel=0;
		var xcantidad_total_pedidos=0;
		var xtitulo_cahnge_mesa='';
		xidpedid_txt_change='';
		xSelAllPedidos=false;

		$("#btn_cambiar_mesa").attr("disabled", false);
		$("#btn_anular_pedido").attr("disabled", false);
		$("#btn_registrar_pago").attr("disabled", false);
		xkey_f10=true;

		$("#tb_pedidos .check_item").each(function(index,element){
			if(element.checked==true){
				xidpedid_txt_change=xidpedid_txt_change+','+$(element).parent().parent().attr('data-idpedido');
				xnum_pedido_check=$(element).parent().parent().find('td:nth-child(2)').text();
				xtitulo_cahnge_mesa=xtitulo_cahnge_mesa+' '+xnum_pedido_check+',';
				xcantidad_pedidos_sel++;
				}
			xcantidad_total_pedidos++;
		})

		if(xcantidad_pedidos_sel==0){$("#btn_cambiar_mesa").attr("disabled", "disabled").off('click');$("#btn_registrar_pago").attr("disabled", "disabled").off('click'); $("#btn_anular_pedido").attr("disabled", "disabled").off('click');xkey_f10=false;}
		if(xcantidad_total_pedidos==xcantidad_pedidos_sel){xtitulo_cahnge_mesa='todos los pedidos: '; xSelAllPedidos=true;}
		if(xcantidad_total_pedidos>xcantidad_pedidos_sel){xtitulo_cahnge_mesa=xtitulo_cahnge_mesa.slice(0,-1);xtitulo_cahnge_mesa='los pedidos: '+xtitulo_cahnge_mesa+ '.';}
		$(".txt_anular_cambiar_mesa").text(xtitulo_cahnge_mesa);
		xidpedid_txt_change=xidpedid_txt_change.slice(1);
}

function empty() {
	// nothing

}
function detectEvent(e) {
	var evt = e || window.event;
	if(evt.keyCode==27){
		if(dialog_cambiar_mesa.opened){dialog_cambiar_mesa.close(); return;}
		if(xopen_add_item){xCloseLULI(); return;}
		if(content_page.selected==1){xIrPage(0);return;}
		if(dialog_detalle.opened){
			xCPcloseDialogDetalle();			
			return;
		}
	}

	// if (e.keyCode>=112 || e.keyCode<=123){
	if ((e.keyCode >= 48 && e.keyCode <= 90) || (e.keyCode >= 96 && e.keyCode <= 105)) { 
		if(xbuscar_mesa==true){return;}
		const _comp_inputsearchpedidoinpage = document.getElementById('comp_input_search_pedido_in_page');		
		_comp_inputsearchpedidoinpage.focus()
		if (xbuscar_mesa == true) { _comp_inputsearchpedidoinpage.select(); xbuscar_mesa = false; }
		// $("#txt_bus_mesa").focus();
		// if(xbuscar_mesa==true){$("#txt_bus_mesa").select();xbuscar_mesa=false;}
	}
	if (evt.keyCode>=119 && evt.keyCode<=121 && dialog_detalle.opened) {

		//alert('charCode is ' + evt.charCode);
		//return document.defaultAction;
		if(evt.keyCode==119){if(dialog_detalle.opened){xOpenLULI();}}//f8 abre add item menu lateral
		if(evt.keyCode==120){if(xopen_add_item){xArmarSqlAddLUlI();}}//f9//confirmar aumento
		if(evt.keyCode==121 && xkey_f10==true){
			if(xThisCM.$.content_page.selected !== 1 ){
				// if ( xThisCM.$.content_page.selected === 1 ) {
				// 	if (!xThisCM.hidden_container_registro_pago) {
				// 		if (xThisCM.valid_monto_pago) { xRegistrarClientePagoCP() }
				// 	} else {
				// 		xValPago.setVisibleContainerPago();
				// 	}
				// } else {			|		
				// 	xIrPage(1);
				// }

				xIrPage(1);
				

				// evt.stopPropagation();
				e.stopPropagation();
				e.stopImmediatePropagation();

				// xValPago.setFocusIinit();
				
			}
		}	
		
		

		return document.defaultAction;
	}

}

function xOpenAnularPedido(){
	if(xidpedid_txt_change==''){xCheckPedidos();}
	if(xidpedid_txt_change==''){return;}
	xpass_op='anular_pedido';
	xPSupervisor.setVal('Pe1');

	var _valRecuperarBorrarItem = localStorage.getItem('::app3_woRestoreStock');	
	check_recuperar_stock_all_pedido.checked = _valRecuperarBorrarItem ? _valRecuperarBorrarItem : false;


	var xArrayAnularItems = xCPGetItemPedidosAnular();	

	// chequeamos si los items seleccionados hay uno con is_cantidad_nd = 1
	const _isCheckIsCantidadNd = xArrayAnularItems.filter(x => x.is_cantidad_nd === '1').length > 0 ? true : false;
	const isBtnDeleteRowSuccess = !$('.xDerecha pos-fotter-btn').find('#btn_punto_verde_pedido').hasClass('xInvisble');



		
	


	xCompArraySolitaPermiso = {
		tipo_permiso: 2,
		obj: xArrayAnularItems,
		mesa: xObj_miPedido.data().nummesa,
		numpedido: xObj_miPedido.data().numpedido,
		importe_total: parseFloat($("#tb_pedidos #tt_importe_pagar_t").text()),
		is_cantidad_nd: _isCheckIsCantidadNd ? '1' : '0',
		isBtnDeleteRowSuccess: isBtnDeleteRowSuccess
	}

	console.log('xCompArraySolitaPermiso', xCompArraySolitaPermiso);

	if ( !isBtnDeleteRowSuccess ) {
		dialog_motivo_anular.open();
	} else {
		xCMCheckPermisoBorrar();
	}

	// xCMCheckPermisoBorrar();
	
	//pass_us.open();
}

function xCPGetItemPedidosAnular() {
	xCheckPedidos();
	var xArrayAnularItems = [];
	$("#tb_det_pedidos .row").each(function (index, element) {
		var xcantidad_remove_item = parseFloat($(element).find('#td_cant').text());
		var xidpeddido_item = $(element).attr('data-idpedido');
		var xid_descontar_item = $(element).attr('data-iddescontar');
		var xcant_descontar = $(element).attr('data-cant_descontar');
		var xitabla_item = $(element).attr('data-descontar');
		xArrayAnularItems.push({
			'idpedidos': xidpedid_txt_change,
			'm_a': $("#txt_motivo_anular").val(),
			'c': xcant_descontar,
			'cant_item': xcantidad_remove_item,
			'descripcion': $(element).attr('data-descripcion'),
			'des_tp': $(element).attr('data-des_tp'),
			'idimpresora_seccion': $(element).attr('data-idimpresora_seccion'),
			'idtipoconsumo': $(element).attr('data-idtipoconsumo'),
			'idseccion': $(element).attr('data-idseccion'),
			'iddescontar': xid_descontar_item,
			'tabladescontar': xitabla_item,
			'is_cantidad_nd': $(element).attr('data-is_cantidad_nd')
		})
	})
	//
	// xPopupLoad.xopen();

	console.log('xArrayAnularItems', xArrayAnularItems);
	return xArrayAnularItems;

}

function xAnularPedido(isRecuperarStock = false, motivoAnularEstablecido = ''){
	//armar sql devolucion de stock
	xCheckPedidos();
	var xArrayAnularItems=[];
	// $("#tb_det_pedidos .row").each(function(index,element){
	// 	var xcantidad_remove_item=parseFloat($(element).find('#td_cant').text());
	// 	var xidpeddido_item=$(element).attr('data-idpedido');
	// 	var xid_descontar_item=$(element).attr('data-iddescontar');
	// 	var xcant_descontar=$(element).attr('data-cant_descontar');
	// 	var xitabla_item=$(element).attr('data-descontar');
	// 	xArrayAnularItems.push({
	// 		'idpedidos':xidpedid_txt_change,
	// 		'm_a':$("#txt_motivo_anular").val(),
	// 		'c':xcant_descontar,
	// 		'cant_item':xcantidad_remove_item,
	// 		'descripcion': $(element).attr('data-descripcion'),
	// 		'des_tp': $(element).attr('data-des_tp'),
	// 		'idimpresora_seccion': $(element).attr('data-idimpresora_seccion'),
	// 		'idtipoconsumo': $(element).attr('data-idtipoconsumo'),
	// 		'idseccion': $(element).attr('data-idseccion'),
	// 		'iddescontar':xid_descontar_item,
	// 		'tabladescontar':xitabla_item})
	// })
	// //
	// xPopupLoad.xopen();

	xArrayAnularItems = xCPGetItemPedidosAnular()
	console.log('xArrayAnularItems', xArrayAnularItems);

	const _isCheckRecuperarStock = isRecuperarStock ? isRecuperarStock : check_recuperar_stock.checked;
	const _valRecuperarBorrarItem =  _isCheckRecuperarStock ? '1' : '0';	
	
	// impresion de anulacion
	const infoDataPedido = {
		nummesa: xObj_miPedido.data().nummesa,
		numpedido: xObj_miPedido.data().numpedido
	}
	
	const _motivoAnulacionPedidoCM = motivoAnularEstablecido ==='' ? txt_motivo_anular.value : motivoAnularEstablecido;
	// console.log('_motivoAnulacionPedidoCM', _motivoAnulacionPedidoCM);

	cocinarImpresionAnulacionList(xArrayAnularItems, xPermisoSupervisorNombre, xNomU, infoDataPedido, _motivoAnulacionPedidoCM)
	// return

	_fetchApi.axiosExecute({ type: 'POST', url: '../../bdphp/log.php?op=5011', data: { ArrayPeAnular: xArrayAnularItems, xPedidos: xidpedid_txt_change, xMotivo: _motivoAnulacionPedidoCM, 'u': xPermisoSupervisor, xisRecuperarStock: _valRecuperarBorrarItem } })
	.then((dt_xx) => {
	// $.ajax({ type: 'POST', url: '../../bdphp/log.php?op=5011', data:{ArrayPeAnular :xArrayAnularItems, xPedidos:xidpedid_txt_change, xMotivo: _motivoAnulacionPedidoCM,'u':xPermisoSupervisor, xisRecuperarStock: _valRecuperarBorrarItem}})
	// .done( function (dt_xx) {
		xPopupLoad.xclose();
		xActualizarItems();
		//xLoadMesas()
		if(xSelAllPedidos==true){
			$(xObj_miPedido).removeClass('xOcupado');
			$(xObj_miPedido).removeClass('xDespachado');
			$(xObj_miPedido).addClass('xNeutro');
			$(xObj_miPedido).find('.show-led-precuenta').addClass('xInvisible');
			$(xObj_miPedido).find('.show-led-print').addClass('xInvisible');
			$(xObj_miPedido).find('.show-ico-mozo').addClass('xInvisible');
			$(xObj_miPedido).find('.referencia-pedido').addClass('xInvisible');
			$(xObj_miPedido).find('.show-led-reserva').addClass('xInvisible');
			$(xObj_miPedido).find('.show-mozo-pedido').removeClass('pintar');
			$(xObj_miPedido).find("#nommozo").text('.');
			
			$(xObj_miPedido).find(".importe").text('.');
			$(xObj_miPedido).find(".tiempo").text('disponible');
			$(xObj_miPedido).attr('data-hora','');
			$(xObj_miPedido).attr('data-estado','b');
			$(xObj_miPedido).attr('data-abrir-detalle','0');
			$('.grid').isotope('updateSortData',$(xObj_miPedido)).isotope('layout');
		}
		
		xCPcloseDialogDetalle();		
	})

	// indica cantidad pedidos borrados
	xShowCantidadPedidosBorrados()
}

function xOpenCambiarMesa(){
	if(xidpedid_txt_change==''){xCheckPedidos();}
	if(xidpedid_txt_change==''){return;}
	dialog_cambiar_mesa.open();
}

function xCambiarMesa(){
	var xnum_txt_mesa=txt_num_mesa_change.value;
	if(xnum_txt_mesa==""){return;}

	xPopupLoad.xopen();
	_fetchApi.axiosExecute({ type: 'POST', url: '../../bdphp/log.php?op=5010', data: { n: xnum_txt_mesa, i: xidpedid_txt_change } })
	.then((dt_xx) => {
		// $.ajax({ type: 'POST', url: '../../bdphp/log.php?op=5010', data:{n:xnum_txt_mesa,i:xidpedid_txt_change}})
		// .done( function (dt_xx) {
		dialog_cambiar_mesa.close();
		txt_num_mesa_change.value='';
		xPopupLoad.xclose()
		
		xCPcloseDialogDetalle();		

		if($("#dialog_cambiar_mesa #titulo_cambiar_mesa").text().indexOf('todos')<0){xPintarEstadoPedido(); return;}
		$(xObj_miPedido).removeClass('xOcupado');
		$(xObj_miPedido).removeClass('xDespachado');
		$(xObj_miPedido).addClass('xNeutro');
		$(xObj_miPedido).find('.show-led-precuenta').addClass('xInvisible');
		$(xObj_miPedido).find('.show-led-reserva').addClass('xInvisible');
		$(xObj_miPedido).find('.show-led-print').addClass('xInvisible');
		$(xObj_miPedido).find('.show-ico-mozo').addClass('xInvisible');
		$(xObj_miPedido).find('.referencia-pedido').addClass('xInvisible');
		$(xObj_miPedido).find('.show-mozo-pedido').removeClass('pintar');
		$(xObj_miPedido).find("#nommozo").text('.');
		
		$(xObj_miPedido).find(".importe").text('.');
		$(xObj_miPedido).find(".tiempo").text('disponible');
		$(xObj_miPedido).attr('data-hora','');
		$(xObj_miPedido).attr('data-estado','b');
		$(xObj_miPedido).attr('data-abrir-detalle','0');
		$('.grid').isotope('updateSortData',$(xObj_miPedido)).isotope('layout');


		xPintarEstadoPedido(); // pinta nuevamente el cambio de mesa
	});
}

async function xImprimirPrecuenta(){
	//generar estructura de array impresion
	var xArrayItemPreCuenta=[];
	// var xDtBd=xArrayDtOrdenFiltro;
	var xSubItmes=[];
	//verificar items seleccionados
	checkItemsSeleccionados = await getItemsSeleccionados();
	// console.log('checkItemsSeleccionados', checkItemsSeleccionados);
	// xSubItmes = checkItemsSeleccionados.esSeleccionTotal ? xDtBd : checkItemsSeleccionados.arrayPedidosSeleccionados;

	// cargar a los items en la estructura de impresion
	xArrayItemPreCuenta = xCargarDatosAEstructuraImpresion(checkItemsSeleccionados.arrayPedidosSeleccionados, true);


	//saca el null
	var xmesa_pc=$("#p_mesa").text().split(' ');
	var xmunp_pc=$("#p_correlativo").text();
	xmunp_pc=xmunp_pc.replace('CO-','');
	xmunp_pc=xmunp_pc.replace('|','');
	xmunp_pc=xmunp_pc.replace(/\s/g,'');
	// xmesa_pc=xmesa_pc[1]; 
	// po si no sale el numero de mesa
	xmesa_pc=xdtDpedido[0].nummesa;

	// const isDelivery = datosDelivery ? 1 : 0;
	// const isDelivery = datosDelivery ? parseInt(datosDelivery?.p_header?.delivery) === 1 ? 1 : 0 : 0;
	const isDelivery = isPedidoDelivery ? 1 : 0;

	xArrayPrintEncaLi_pre_cuenta={'m':xmesa_pc, 'r':'', 'num_pedido':xmunp_pc,'reservar':0, 'solo_llevar':0,'correlativo_dia':xmunp_pc,'precuenta':true, 'delivery': isDelivery, 'arrDatosDelivery': datosDelivery};

	const _isFormatShortPrecuenta = xDtPrint[0].isprint_cpe_short == '1';
	xMandarImprimirOtroDoc(xArrayPrintEncaLi_pre_cuenta,xDtPrint,xArrayItemPreCuenta,arrSumSubtTotales,-1, _isFormatShortPrecuenta);

	// update bd print
	xUpdatePrintPrecuentaPedido(checkItemsSeleccionados.idPedidosSeleccionados);
	$(xObj_miPedido).find('.show-led-precuenta').removeClass('xInvisible');
	// _cpSocketEmitPrinterPrecuenta(null);
	// _cpSocketPintarPedido(null); // vuelve a pintar las mesas
}

function xImprimirComprobante() {
	//generar estructura de array impresion
	var xArrayItemComprobante=[];
	var xDtBd=xArrayDtOrdenFiltro;
	var xSubItmes=[];

	xArrayItemComprobante = xCargarDatosAEstructuraImpresion(checkItemsSeleccionados.arrayPedidosSeleccionados);
	xCocinarImprimirComprobante (xArrayItemComprobante, arrSumSubtTotales,-2);
}

//
function xTraerDtTipoConsumo(){
	//xDataLoadTipoConsumo(function(xDtTpC){
		var xCadenaSelectUlTPC='',xDtTpC=xm_log_get('estructura_pedido');
		for (var i = 0; i < xDtTpC.length; i++) {
			xCadenaSelectUlTPC=String(xCadenaSelectUlTPC+'<option value="'+xDtTpC[i].idtipo_consumo+'">'+xDtTpC[i].descripcion+'</option>');
		};
		$("#select_ulTPC").html(xCadenaSelectUlTPC).trigger('create');
	//});
}

function xOpenLULI(){
	xopen_add_item=true;
	$("#SelAddLuLi").css('display','inline-block');
	// $("#select_ulTPC").val(1);
	$("#select_ulTPC").val($("#select_ulTPC option:first").val());
	xLoadDataUlAdd();
}
function xCloseLULI(){
	_cpSocketRestoreFromPedidoStorage();
	$("#SelAddLuLi").css('display','none');
	xopen_add_item=false;
}

function xNuevoPedidoCM(){
	//vacear array pedido atenrior
	try {		
		if (isSocket) { _cpSocketClearStorage(); }
	} catch (error) {
		
	}

	window.localStorage.removeItem("::app3_sys_dta_pe");
	xArrayPedido=new Array();
	xDtSubTotales=new Array();
	guardandoPedido_cp = 0;


	xThisCM.isAddItemRow = false;
	xLoadArrayPedido();
}

function xLoadDataUlAdd(){
	$("#accordion").html('<div><paper-spinner active class="xCentradoVerticalHorizontal"></paper-spinner></div>').trigger('create');

	//vacear array pedido atenrior
	xNuevoPedidoCM();

	//$.ajax({ type: 'POST', url: '../../bdphp/log.php?op=205'})
	//.done( function (dtItem) {
	if (xidCategoriaPD === '') {
		const _getCateogriaCarta = compFindCategoria.getCategoria();
		if ( _getCateogriaCarta ) {
			setCatetgoriaCartaCP(_getCateogriaCarta);
		}
	}

	xGeneralLoadItems(xidCategoriaPD, function(){
		//var xdtItem=$.parseJSON(dtItem);
		var xArrayEncaUlLi=new Array();
		var xNom_seccion_ul='';
		//xdtItem=xdtItem.datos;

		//encabezados
		for (var i = 0; i < xGeneralDataCarta.length; i++) {
			if(xNom_seccion_ul==xGeneralDataCarta[i].des_seccion){continue;}
			xArrayEncaUlLi.push({'id':xGeneralDataCarta[i].idseccion_index,'des_seccion':xGeneralDataCarta[i].des_seccion});
			xNom_seccion_ul=xGeneralDataCarta[i].des_seccion;
		}

		var xCadenaBodyUlDt='';
		var xCadenaHeadUlDt='';
		var xCadenaAllUl='';
		var xIdUlIl;
		var xtachar_li='';
		var xCantidadMax;
		for (var z = 0; z < xArrayEncaUlLi.length; z++) {
			xIdUlIl=xArrayEncaUlLi[z].id;
			xCadenaHeadUlDt=String('<li class="li_tocuh"><div>'+xArrayEncaUlLi[z].des_seccion+'</div>');
			for (var p = 0; p < xGeneralDataCarta.length; p++) {
				if(xIdUlIl==xGeneralDataCarta[p].idseccion_index){
					xtachar_li='';
					xCantidadMax=xGeneralDataCarta[p].cantidad; //stock actual
					if(parseInt(xCantidadMax)<=0){xtachar_li='xTachar';}
					if(xCantidadMax=='ND'){xCantidadMax=1000}

					xGeneralDataCarta[p].stock_actual = xCantidadMax;
					xGeneralDataCarta[p].idcategoria = xidCategoriaPD;

					xCadenaBodyUlDt=String(xCadenaBodyUlDt+'<li class="row" id="li'+xGeneralDataCarta[p].idcarta_lista+'" data-index = "'+ p +'" data-signo="+"  data-idcategoria="'+xidCategoriaPD+
														'" data-cat="'+xArrayEncaUlLi[z].des_seccion+
														'" data-idcl="'+xGeneralDataCarta[p].idcarta_lista+
														'" data-idcartalista="'+xGeneralDataCarta[p].idcarta_lista+
														'" data-idseccion="'+xGeneralDataCarta[p].idseccion+
														'" data-idseccionindex="'+xGeneralDataCarta[p].idseccion_index+
														'" data-iditem="'+xGeneralDataCarta[p].iditem+
														'" data-punitario="'+xGeneralDataCarta[p].precio+
														'" data-idimpresora="'+xGeneralDataCarta[p].idimpresora+
														'" data-idprocede="'+xGeneralDataCarta[p].idprocede+
														'" data-procede="'+xGeneralDataCarta[p].procede+
														'" data-procedeindex="'+xGeneralDataCarta[p].procede_index+
														'" data-imprimircomanda="'+xGeneralDataCarta[p].imprimir_comanda+
														'" data-iddescontar="'+xGeneralDataCarta[p].idprocede+
														'" data-cant_descontar="'+xGeneralDataCarta[p].cant_descontar+
														'" data-stock_actual="'+xGeneralDataCarta[p].cantidad+
														'" data-idalmacen_items="'+xGeneralDataCarta[p].idalmacen_items+'">'+
															'<div>'+
																'<div class="xicon3 xeditar xbtn_li_editar" title="editar" style="width:15px;height:15px;"></div>'+
																'<p class="xtitulo_li '+xtachar_li+'">'+xGeneralDataCarta[p].des_item+'</p>'+
																'<p class="xInvisible">'+xGeneralDataCarta[p].codigo_barra+'</p>'+
																'<input type="text" class="xMiInput xMiTextReferencia" anchofull id="xinput_li">'+
															'</div>'+
															'<div class="xBtn_contet_li">'+
																'<div class="xBtn_li">-</div>'+
																'<span class="xcant_li" data-cantmax="'+xCantidadMax+'">0</span>'+
																'<div class="xBtn_li">+</div>'+
															'</div>'+
														'</li>');
					//xCadenaBodyUlDt=xCadenaBodyUlDt.replace(/\s/g, "");
				}
			}
			xCadenaBodyUlDt=xCadenaHeadUlDt+'<ul id="content_item_pedido">'+xCadenaBodyUlDt+'</ul></li>';
			xCadenaAllUl=String(xCadenaAllUl+xCadenaBodyUlDt);
			xCadenaBodyUlDt='';
			xCadenaBodyUlDt='';
		}

		$("#accordion").html(xCadenaAllUl).trigger('create');
		$("#accordion").accordion('refresh');
		$( "#accordion" ).accordion({
			collapsible: true,
			active: false			
		});
		
		// $('#accordion').accordion('option', {active: false});

		$("#txt_bus_item_add").focus();
	});
}

// listen sokect change items
function _cpStockItemModificado(item){
	if (!isSocket) {return; } // si no hay socket
	if ( !xopen_add_item ) {return; } // si el panel lateral no esta abierto

	const idFind = '#li' + item.idcarta_lista;	
	const xCantidadMax = item.cantidad;
	const index = $(idFind).attr('data-index');
	var xClassRow = '';

	xtachar_li='';	
	if(parseInt(xCantidadMax)<=0){xtachar_li='xTachar';}
	if(xCantidadMax=='ND'){xCantidadMax=1000}

	$(idFind).attr('data-stock_actual', xCantidadMax);
	// $(idFind)[0].dataset.stock_actual = xCantidadMax
	$(idFind + ' span.xcant_li').attr('data-cantmax', xCantidadMax);

	xGeneralDataCarta[index].stock_actual = xCantidadMax;
	xGeneralDataCarta[index].cantidad = xCantidadMax;
	itemPedidos_objItemSelected = xGeneralDataCarta[index];
	// $(idFind + ' span.xcant_li')[0].dataset.cantmax = xCantidadMax	
	if ( xtachar_li != '' ) {
		$(idFind).find('.xtitulo_li').addClass(xtachar_li);
	} else {
		$(idFind).find('.xtitulo_li').removeClass('xTachar');
	}
}

// agrega nuevo item desde el mismo pedido
async function xArmarSqlAddLUlI(){

	if ( guardandoPedido_cp === 1 ) {return;}
	guardandoPedido_cp = 1;


	var xRowLi='';
	var xli_id_pedido;
	var xli_id_categoria;
	var xli_tipoconsumo=$("#select_ulTPC option:selected").val();
	const tpCDes = $("#select_ulTPC option:selected").text().trim().toLowerCase();
	//var xli_importe_total_pedido=0;
	//var xli_importe_total_row=0;
	var xli_nummesa;
	var xli_numpedido;
	var xli_numcorelativo;
	var xli_ref;
	var xsub_sql_descontar='';
	var xsql_descontar='';
	var xpasar=false;

	//idpedido// idcategoria todos los checks // toma el ultimo check seleccionado
			$("#tb_pedidos .check_item").each(function(index,element){
				if(element.checked==true){
					xli_id_pedido=$(element).parent().parent().attr('data-idpedido');
					xli_id_categoria=$(element).parent().parent().attr('data-idcat');
					//xli_importe_total_pedido=parseFloat($(element).parent().parent().attr('data-total'));

					xli_nummesa=$(element).parent().parent().attr('data-m');
					xli_numpedido=$(element).parent().parent().attr('data-nump');
					xli_numcorelativo=$(element).parent().parent().attr('data-correlativo');
					xli_ref=$(element).parent().parent().attr('data-ref');
				}
			})
	
	//validar reglas
	//xValidarReglaCartaArray(xArrayPedido);
	xGeneralValidarRegalasCarta(xArrayPedidoObj,true);
	// xArmarSubtotalesArray();
	// xGeneralSumarTotales(); //genera y calcula los subtotales del pedido y los pone en xGeneralArraySubTotales
	// xImporteTotalRowArray=xGeneralArraySubTotales[0].importe; // el cero siempre sera subtotal el total;
	// xImporteTotalRowArray = xLocal_xDtSubTotales.length > 1 ? xLocal_xDtSubTotales[xLocal_xDtSubTotales.length -1].importe : xLocal_xDtSubTotales[0].importe;

	if(xArmarSubtotalesArray()==0){return}

	var xsolo_llevar="0", xdelivery="0";
	switch (tpCDes) {
		case 'para llevar': xsolo_llevar = "1"; break;
		case 'delivery': xdelivery="1"; break;
	}

	if (xsolo_llevar==="0" && xdelivery==="0" && (xli_nummesa==="" || xli_nummesa==="0") ) {
		alert("Indique numero de mesa. Coloque cero(0) si no corresponde");
		guardandoPedido_cp = 0;

		// xPopupLoad.xclose();
		return;
	}

	xArrayPrintEncaLi={'m':xCeroIzq(xli_nummesa,2), 'r':xMayusculaPrimera(xSoloMinuscula(xli_ref)), 'num_pedido':xCeroIzq(xli_numpedido,5),'reservar':0, 'solo_llevar': xsolo_llevar, 'delivery': xdelivery,'correlativo_dia':xli_numcorelativo};
	// xArrayGuardarPedido={'idcategoria':xidCategoriaPD ,'mesa':xCeroIzq(xli_nummesa,2),'referencia':'','reservar':0,'arrPedido':xArrayPedidoObj,'arrSubTotales':xGeneralArraySubTotales};


	// estado_p = 0 porque es un nuevo pedido y no va registrar pago
	// idclie porque no va registrar pago
	// p_from:'a' porque solo va registrar el pedido
	// xarr_header = {'idclie':0, 'ImporteTotal': xImporteTotalRowArray ,'referencia':'', 'idcategoria': xidCategoriaPD, 'mesa':xCeroIzq(xli_nummesa,2),'reservar':0, 'tipo_consumo': xli_tipoconsumo}
	xarr_header = {'idclie':0,'referencia':'', 'idcategoria': xidCategoriaPD, 'mesa':xCeroIzq(xli_nummesa,2), 'num_pedido': xli_numpedido,'reservar':0, 'tipo_consumo': xli_tipoconsumo, 'subtotales_tachados': ''}
	xarr_body = xArrayPedidoObj;
	xarr_subtotales = xLocal_xDtSubTotales;

	xVerificarSiSeImprimeComanda(xArrayPedidoObj);


	const dataSendPedido = {
		p_from:'1', 
		p_header: xarr_header, 
		p_body: xarr_body, 
		p_subtotales: xarr_subtotales, 
		estado_p:0
	};

	const idP = await goSendPedidoFecht(dataSendPedido);
	lastDataPedidoInsert = idP;

	// $.ajax({ type: 'POST', url: '../../bdphp/log.php?op=30401', data:{arr:xArrayGuardarPedido,idpedido:0}})

	xPopupLoad.xopen();
	
	// $.ajax({ type: 'POST', url: '../../bdphp/log_001.php', 
	// 	data:{
	// 		p_from:'a', 
	// 		p_header: JSON.stringify(xarr_header), 
	// 		p_body: JSON.stringify(xarr_body), 
	// 		p_subtotales: JSON.stringify(xarr_subtotales), 
	// 		estado_p:0
			// }})
	// 	.done( function (a) {
	// 		lastDataPedidoInsert = JSON.parse(a.replace('|', ''));

			if(xVerificarImprimirComanda==true){

				xLLamarPrintAddLUlI();
				// xMandarImprimir(xArrayPrintEncaLi,xDtPrint,xArrayPedidoObj,function(rpt){
				// 	if(rpt==true){
				// 		//actualizar y cerrar
				// 		xLoadDetallesPedido(xObj_miPedido);
				// 		xNuevoPedidoCM();
				// 		xCloseLULI();
				// 	}
				// })
			}else{
				//actualizar y cerrar
				xLoadDetallesPedido(xObj_miPedido, false);				
				xNuevoPedidoCM();
				xCloseLULI();
			}
			
			// repintar actaulizar mesa
			// if (isSocket) {_cpSocketPintarPedido(null);}	
			
			// sumar importe total al pintar pedido
			xSumarTotalPedidos(1);
			

		// }).fail(() => {
		// 	guardandoPedido_cp = 0;

		// });

		// regresa xocupado
		$(xObj_miPedido).removeClass('xDespachado');
		xThisCM.isAddItemRow = false;
		// xLoadMesas();// actualiza el estado
}


async function goSendPedidoFecht(_data) {
	const _fetchApi = new httpFecht();
	const rpt = await _fetchApi.postJson('../../bdphp/log_001.php', _data);
	return rpt;	
}

function xLLamarPrintAddLUlI() {
	xCocinarImprimirComanda(xArrayPrintEncaLi,xArrayPedidoObj,xLocal_xDtSubTotales, (res)=>{
		if(!res){ //si no hay error
			xPopupLoad.xclose();
			xLoadDetallesPedido(xObj_miPedido, false);
			
			xNuevoPedidoCM();
			xCloseLULI();
		} else {
			dialog_erro_print.open();
		}
	});
}



function xIrPage(op){
	//var pages = document.querySelector('iron-pages');
	switch(op){
		case 0:$("#dialog_detalle").removeClass('normal');$("#dialog_detalle").addClass('tall');break;
		case 1:
		//$("#dialog_detalle").removeClass('tall');$("#dialog_detalle").addClass('normal');
			 //$("#component_pago").focus(); component_pago.setFocusTxt();
			//  btn_pago.hidden=false;
			 
			// $("#btn_pago").attr('disabled',true); 
			xValPago.setVisiblePanel1(); // regresa al primer panel comprobante cliente
			component_pago.setVal(xMoneda(xtt_pedidos));
			component_pago.setModoSoloComprobante(false);
			component_pago.setIsPedidoPagadoFromAPP(isPedidoPagadoFromApp);
			xValPago.setIsPedidoPagadoFromAPP(isPedidoPagadoFromApp);
		break;
	}
	content_page.selected=op;
}
//
///guardar datos de pago
async function xRegistrarClientePagoCP(){
	//xCheckPedidos()
	//btn_pago.hidden=true;
	
	// $("#btn_pagoX").attr('disabled', true);
	// btn_pagoX.disabled = true;
	// btn_pago.hidden=true;
	if (enProcesoGuardarPago) {return;}
	enProcesoGuardarPago = true;
	
	xPopupLoad.titulo="Guardando...";
	xPopupLoad.xopen();

	var DatosCliente = xRpt_pago[0].cliente;
	const _idCLienteCompara = xRpt_pago[0].idcliente === '' ? 0 : xRpt_pago[0].idcliente;
	var ComprobanteSeleccionado = xRpt_pago[0].comprobante;
	// var xid_cliente_pago=DatosCliente.idcliente;
	

	// para que registr cliente
	// var xid_cliente_pago = DatosCliente.idcliente === "" ? await ClienteService_Guardar(DatosCliente) : DatosCliente.idcliente;
	// var xid_cliente_pago = xRpt_pago[0].is_update_cliente ? await ClienteService_Guardar(DatosCliente) : DatosCliente.idcliente;
	// 1801222 - guarda cliente en cliente sede
	var xid_cliente_pago = await ClienteService_Guardar(DatosCliente);
	
	var xidpedido_seleccionados='';
	
	DatosCliente.idcliente = xid_cliente_pago;

	// si es delivery compara y coloca datos del cliente
	if ( xdtDpedido[0].pwa_is_delivery.toString() === "1" ) {
		var dtDeliveryCliente = xdtDpedido[0].json_datos_delivery.p_header.arrDatosDelivery;
		DatosCliente.direccion = DatosCliente.direccion !== '' ? DatosCliente.direccion : dtDeliveryCliente.direccion;
		DatosCliente.nombres = DatosCliente.nombres !== '' ? DatosCliente.nombres : dtDeliveryCliente.nombre;
		DatosCliente.telefono = dtDeliveryCliente.telefono;
		DatosCliente.referencia = dtDeliveryCliente.referencia;		
	}

	//

	// si es nuevo cliente recarga el componente input cliente
	if (_idCLienteCompara != xid_cliente_pago) {
		xValPago.reloadInputDatalientes();
	}

	

	//si todos los pedidos estan seleccionados
	var xCantRow=parseInt($("#tb_pedidos .row").length);
	var xCantRowSel=parseInt($("#tb_pedidos .row.selected1").length);
	xCantRow=xCantRow-xCantRowSel;

	// si no esta seleccionado ninguno toma todos los pedidos
	var xcheckItemsSeleccionados = await getItemsSeleccionados();


	// xtt_pedidos = total a pagar
	xarr_cliente = {'cliente':DatosCliente, 'i': xcheckItemsSeleccionados.idPedidosSeleccionados };
	xarr_header = {'idclie':DatosCliente.idcliente, 'ImporteTotal': xMoneda(xtt_pedidos) , 'tipo_consumo': xcheckItemsSeleccionados.tipoConsumo, 'idPedidoSeleccionados': xcheckItemsSeleccionados.idPedidosSeleccionados, 'is_from_client_pwa': xdtDpedido[0].is_from_client_pwa};
	xarr_comprobante = ComprobanteSeleccionado;
	// xarr_items_seleccionados = xArraySql_dt_p; // items seleccionados
	xarr_items_seleccionados = xcheckItemsSeleccionados.arrayPedidosSeleccionados; // items seleccionados
	
	// lista usuarios clientes pedidos (cliente que hizo su pedido, para notificar pago)
	xarr_list_cliente_usuario_pedido = xcheckItemsSeleccionados.arrayIdClienteUsPedido;

	xarr_tipo_pago = xRpt_pago[0].xtipo_pagos;
	
	// cambio para sumar los costos negativos, si es que es delivery y el comercio paga
	xarr_subtotal = arrSumSubtTotales;
	// xarr_subtotal = darFormatoSubTotalesParaFacturacion(arrSumSubtTotales);
	
	
	if(!xcheckItemsSeleccionados.esSeleccionTotal || !xcheckItemsSeleccionados.esSeleccionTodoPeidoLista){ //si es pago parcial
		//registrar pago - ok
		const dataSendPedido = {
			p_from:'4', 
			p_items_seleccionados: xarr_items_seleccionados, 
			p_cliente: xarr_cliente, 
			p_header: xarr_header, 
			p_tipo_pago: xarr_tipo_pago, 
			p_subtotales: xarr_subtotal, 
			p_comprobante: xarr_comprobante
		}


		const idP = await goSendPedidoFecht(dataSendPedido);
		const _arrRpt = idP;

		// $.ajax({ type: 'POST', url: '../../bdphp/log_001.php', 
		// 	data:{
		// 		p_from:'c', 
		// 		p_items_seleccionados: JSON.stringify(xarr_items_seleccionados), 
		// 		p_cliente: JSON.stringify(xarr_cliente), 
		// 		p_header: JSON.stringify(xarr_header), 
		// 		p_tipo_pago: JSON.stringify(xarr_tipo_pago), 
		// 		p_subtotales: JSON.stringify(xarr_subtotal), 
		// 		p_comprobante: JSON.stringify(xarr_comprobante)
		// 	}})
		// .done( function (xrpt_correlativo) {
		// 	const _arrRpt = xm_all_SetResponseLog_001(xrpt_correlativo);


			const xIdRegistroPago = _arrRpt.idregistro_pago; // se necesita para guardar el id_externo_comprobante electronico
			xrpt_correlativo = _arrRpt.correlativo_comprobante;
			enProcesoGuardarPago = false;
			xLoadDetallesPedido(xObj_miPedido);
			// if (isSocket) {
				_cpSocketPintarPedido(null);
				// notificar al usuario de la cuenta
				_cpSocketEmitPedidoPagoCliente(xarr_list_cliente_usuario_pedido);
			// }

			xarr_subtotal = darFormatoSubTotalesParaFacturacion(arrSumSubtTotales);
			xMandarCocinarImpresionComprobante(xrpt_correlativo, xIdRegistroPago);	
			
			const _payloadPedidoPagado = {
				idusuario:  idUsuarioOperador,
				num_pedido: xObj_miPedido.data().numpedido,
				idpedido: xObj_miPedido.data().numpedido,
				num_mesa: xObj_miPedido.data().nummesa,
				importe_restante: xcheckItemsSeleccionados.importeTotalSeleccionado,
				p_tipo_pago: xarr_tipo_pago
			}

			_cpASocketNotifyPayPedido(_payloadPedidoPagado);

		// }).fail(enProcesoGuardarPago = false);

		xValPago.setResetFormaPago();
		return
	}else{
		//paga todo - listo
		//$.ajax({ type: 'POST', url: '../../bdphp/log.php?op=508', data:{idclie:xid_cliente_pago,nom:xnom_cliente_pago,i:xidpedido_seleccionados}})

		const dataSendPedido = {
			p_from:'3', 
			p_cliente: xarr_cliente, 
			p_header: xarr_header, 
			p_tipo_pago: xarr_tipo_pago, 
			p_subtotales: xarr_subtotal, 
			p_comprobante: xarr_comprobante
		}

		const idP = await goSendPedidoFecht(dataSendPedido);
		const _arrRpt = idP;
		

		// $.ajax({ type: 'POST', url: '../../bdphp/log_001.php', 
		// 	data:{
		// 		p_from:'b', 
		// 		p_cliente: JSON.stringify(xarr_cliente), 
		// 		p_header: JSON.stringify(xarr_header), 
		// 		p_tipo_pago: JSON.stringify(xarr_tipo_pago), 
		// 		p_subtotales: JSON.stringify(xarr_subtotal), 
		// 		p_comprobante: JSON.stringify(xarr_comprobante)
		// 	}})
		// .done( function (xrpt_correlativo) {
		// 	const _arrRpt = xm_all_SetResponseLog_001(xrpt_correlativo);

			const xIdRegistroPago = _arrRpt.idregistro_pago; // se necesita para guardar el id_externo_comprobante electronico
			xrpt_correlativo = _arrRpt.correlativo_comprobante;
			enProcesoGuardarPago = false;
			xRegistrarPagoCM(xCantRow);	

			// if (isSocket) {
				// notificar al usuario de la cuenta
				_cpSocketEmitPedidoPagoCliente(xarr_list_cliente_usuario_pedido);
			// }

			xarr_subtotal = darFormatoSubTotalesParaFacturacion(arrSumSubtTotales);
			xMandarCocinarImpresionComprobante(xrpt_correlativo, xIdRegistroPago);				
		
		// }).fail(enProcesoGuardarPago = false);

		const _payloadPedidoPagado = {
				idusuario:  idUsuarioOperador,
				num_pedido: xObj_miPedido.data().numpedido,
				num_mesa: xObj_miPedido.data().nummesa,
				importe_restante: 0,
				p_tipo_pago: xarr_tipo_pago
			}
		
		_cpASocketNotifyPayPedido(_payloadPedidoPagado);
		xValPago.setResetFormaPago();
	}
}

// function xRegistrarPagoCM(xidclie,xidp,arrayItems,xcant_rp,idtpc){
function xRegistrarPagoCM(xcant_rp){
	// $.ajax({ type: 'POST', url: '../../bdphp/log.php?op=509', data:{idclie:xidclie,tt:xMoneda(xtt_pedidos),idp:xidp,xArrayItems:arrayItems,ArrayPago:xRpt_pago[0].xtipo_pagos,idtipo_consumo:idtpc}})
	// .done( function (xidC) {
		var xnum_mesa_obj=parseInt($(xObj_miPedido).attr('data-nummesa'));
		var xsolo_confirmar_pago=parseInt($(xObj_miPedido).attr('data-isconfirmarpago'));
		
		if(xcant_rp==0){
			if(xnum_mesa_obj!=0 && xsolo_confirmar_pago.toString() === '0'){
				$(xObj_miPedido).removeClass('xOcupado');
				$(xObj_miPedido).removeClass('xDespachado');
				$(xObj_miPedido).addClass('xNeutro');
				$(xObj_miPedido).find('.show-led-precuenta').addClass('xInvisible');
				$(xObj_miPedido).find('.show-led-reserva').addClass('xInvisible');
				$(xObj_miPedido).find('.show-led-print').addClass('xInvisible');	
				$(xObj_miPedido).find('.show-ico-mozo').addClass('xInvisible');
				$(xObj_miPedido).find('.referencia-pedido').addClass('xInvisible');
				$(xObj_miPedido).find('.show-mozo-pedido').removeClass('pintar');
				$(xObj_miPedido).find("#nommozo").text('.');

				$(xObj_miPedido).find(".importe").text('.');
				$(xObj_miPedido).find(".tiempo").text('disponible');
				$(xObj_miPedido).attr('data-hora','');
				$(xObj_miPedido).attr('data-estado','b');
				$(xObj_miPedido).attr('data-abrir-detalle','0');
				$('.grid').isotope('updateSortData',$(xObj_miPedido)).isotope('layout');
			}else{
				//remove				
				$(".grid").isotope('remove',$(xObj_miPedido)).isotope('layout');
				$(xObj_miPedido).remove();
			}
		}
		xPopupLoad.xclose();

		xCPcloseDialogDetalle();		
	// });
}

async function xMandarCocinarImpresionComprobante(correlativo, _idregistro_pago) {	

	if (xRpt_pago.length > 0) {
		xPopupLoad.xclose();
		var arr_cliente = xRpt_pago[0].cliente;
		var arr_comprobante = xRpt_pago[0].comprobante;
		
		// correlativo comprobante
		// arr_comprobante.correlativo = xReturnCorrelativoComprobante(arr_comprobante);

		// if ( arr_comprobante ) {
			// arr_comprobante.correlativo = xCeroIzqNumComprobante(correlativo);
			// }

		try {
			arr_comprobante.correlativo = xCeroIzqNumComprobante(correlativo);
		} catch (error) {}
		
		xArrayItemComprobante = xCargarDatosAEstructuraImpresion(checkItemsSeleccionados.arrayPedidosSeleccionados);
		xCocinarImprimirComprobante(xArrayItemComprobante, arrSumSubtTotales, arr_comprobante, arr_cliente, _idregistro_pago,-2);
		
	}
	xRpt_pago=[];
}


// consultar si mesa tiene pedidos despues de haber registrado pago por app
function isPedidoInMesa(xObj_miPedido, nummesa) {
	// const _lastIdPedidoCobrado = localStorage.getItem('::app3_woLastIdP');
	_fetchApi.axiosExecute({ type: 'POST', url: '../../bdphp/log.php?op=507', data: { m: nummesa, p: '', confirmar_pago: 0, lastIdPedido: lastIdPedidoCobrado } })
	.then((dtDpedido) => {
	// $.ajax({ type: 'POST', url: '../../bdphp/log.php?op=507', data:{m:nummesa, p:'', confirmar_pago: 0, lastIdPedido: lastIdPedidoCobrado}})
	// .done( function (dtDpedido) {
		var xdtDpedido=$.parseJSON(dtDpedido);
		xdtDpedido=xdtDpedido.datos;

		// si no tiene mas pedidos lo quita
		if ( !xdtDpedido[0] ) {
			$(xObj_miPedido).removeClass('xOcupado');
			$(xObj_miPedido).removeClass('xDespachado');
			$(xObj_miPedido).addClass('xNeutro');
			$(xObj_miPedido).find('.show-led-precuenta').addClass('xInvisible');
			$(xObj_miPedido).find('.show-led-reserva').addClass('xInvisible');
			$(xObj_miPedido).find('.show-led-print').addClass('xInvisible');
			$(xObj_miPedido).find('.show-ico-mozo').addClass('xInvisible');
			$(xObj_miPedido).find('.referencia-pedido').addClass('xInvisible');
			$(xObj_miPedido).find('.show-mozo-pedido').removeClass('pintar');
			$(xObj_miPedido).find("#nommozo").text('.');

			$(xObj_miPedido).find(".importe").text('.');
			$(xObj_miPedido).find(".tiempo").text('disponible');
			$(xObj_miPedido).attr('data-hora','');
			$(xObj_miPedido).attr('data-estado','b');
			$(xObj_miPedido).attr('data-abrir-detalle','0');
			$('.grid').isotope('updateSortData',$(xObj_miPedido)).isotope('layout');
		}
	});
}


////////////////////
//////////////////////

//////load datos detalle pedido


//////load datos detalle pedido
function xLoadDetallesPedido (obj, clearDataLastPedidoInsert = true){
	if($(obj).attr('data-abrir-detalle')==0){return}

	lastDataPedidoInsert = clearDataLastPedidoInsert ? null : lastDataPedidoInsert;
	
	isPedidoOpenDeliveryCliente = false;
	isDeliverySolicitoReparto = false;
	xAgrupar_item_activo=false;
	xPopupLoad.titulo="Cargando...";
	xPopupLoad.xopen();
	xIrPage(0)
	xObj_miPedido=$(obj);


	// reset sub totales tachados
	xLocal_SubTotal_Quitados = "";

	arrTotalesDeliveryCliente = null;

	//clearInterval(xRefreshPedidos);

	var xp_sel_nummesa=$(obj).attr('data-nummesa');
	var xp_sel_numpedido=$(obj).attr('data-numpedido');
	var xp_sel_correlativo_dia=$(obj).attr('data-correlativo');
	xp_sel_idcategoria=$(obj).attr('data-idcat');
	var xp_sel_is_confirmar_pago=$(obj).attr('data-isconfirmarpago');
	var xtitulo='';

	if(xp_sel_nummesa=='0'){xtitulo='PEDIDO '+xCeroIzq(xp_sel_correlativo_dia,5)}else{xtitulo='MESA '+xCeroIzq(xp_sel_nummesa,2)}	
	
	// para sumar totales cuando se agrega de delivery
	var _isDeliveryObjPedido = xdtDpedido ? xdtDpedido[0]?.pwa_is_delivery === "1" ? true : false : false;
	isPedidoOpenDeliveryCliente = _isDeliveryObjPedido;

	if ( !clearDataLastPedidoInsert ) {
		xRefreshListaPedidosItems(obj);	
		xPopupLoad.xclose();	
		return;
	}
	

	
	_fetchApi.axiosExecute({ type: 'POST', url: '../../bdphp/log.php?op=507', data: { m: xp_sel_nummesa, p: xp_sel_numpedido, confirmar_pago: xp_sel_is_confirmar_pago, lastIdPedido: lastIdPedidoCobrado } })
	.then((dtDpedido) => {
		// console.log('dtDpedidoAxios === ', dtDpedido);
	// })

	//armar cantidad de pedidos
	// const _lastIdPedidoCobrado = localStorage.getItem('::app3_woLastIdP');
	// $.ajax({ type: 'POST', url: '../../bdphp/log.php?op=507', data:{m:xp_sel_nummesa, p:xp_sel_numpedido, confirmar_pago: xp_sel_is_confirmar_pago, lastIdPedido: lastIdPedidoCobrado}})
	// .done( function (dtDpedido) {

		

		// console.log('dtDpedido', dtDpedido);

		var isDelivery = false;
		var labelInfoPedido = '', labelInfoComprobante = '';
		isClienteDeliveryFromApp = false, pintarInfoDeliveryCliente = '', isLlamoRepartidorRed = false, infoFacturacion = ''; // si el pedido es delivery y viene de la app

		// si es solo para confirmar aunque no sea delivery
		// isPedidoPagadoFromApp se utliza en comp-find-tipo-pago-option
		// para saber si solo muestra tarjeta
		isPedidoPagadoFromApp = xp_sel_is_confirmar_pago.toString() === '1' ? true : false;
		localStorage.setItem('::app3_papp', xp_sel_is_confirmar_pago.toString());
		xdtDpedido=$.parseJSON(dtDpedido);

		// console.log('dtDpedido === ', xdtDpedido);

		xdtDpedido=xdtDpedido.datos;
		xid_pedido_selected = xdtDpedido[0].idpedido;

		
		
		var atendidoPor = xdtDpedido[0].nom_usuario ? xdtDpedido[0].nom_usuario : 'Cliente';
		atendidoPor = 'ATENDIDO POR: '+ atendidoPor  +' | ';

		_isDeliveryObjPedido = xdtDpedido ? xdtDpedido[0]?.pwa_is_delivery === "1" ? true : false : false;
		isPedidoOpenDeliveryCliente = _isDeliveryObjPedido;

		// combo repartdior
		isLlamoRepartidorRed = xdtDpedido ? xdtDpedido[0]?.flag_solicita_repartidor_papaya === '1' || false : false;
		isDeliverySolicitoReparto = isLlamoRepartidorRed;

		//encabezado
		$("#p_correlativo").text('CO-'+xCeroIzq(xdtDpedido[0].correlativo_dia,5)+' | ');
		$("#p_referencia").text(xdtDpedido[0].referencia +' | ');
		$("#p_antendido").text(atendidoPor);

		datosDelivery = xdtDpedido[0].json_datos_delivery;

		try {									
			datosDelivery = datosDelivery != '' && datosDelivery != '{}' && datosDelivery != '[]' ? JSON.parse(datosDelivery) : null;
		} catch (error) {
			// si el string tiene saltos de pagina /n 
			// itemList.json_datos_delivery = JSON.parse(datosDelivery.replace(/(\r\n|\n|\r)/g,""));
			try {
				datosDelivery = JSON.parse(datosDelivery.replace(/(\r\n|\n|\r)/g,""));				
			} catch (error) {
				datosDelivery = null;
			}
		}

		// datosDelivery = datosDelivery != '' && datosDelivery != '{}' && datosDelivery != '[]' ? JSON.parse(datosDelivery) : null;
		xdtDpedido[0].json_datos_delivery = datosDelivery;

		isDelivery = datosDelivery ? parseInt(datosDelivery.p_header.delivery) === 1 ? true : false : false;
		isPedidoDelivery = isDelivery; // marcador global
		// console.log('datosDelivery', datosDelivery);		

		$('#btnLlamarRepartidorP').addClass('xInvisible');
		$('#content-info-delivery').addClass('xInvisible');
		$('#showLoadingReparto').addClass('xInvisible');
		$('#showRepartoAsignado').addClass('xInvisible');
		$('#div-info-delivery-from-app').addClass('xInvisible');
		
		$("#btn_cambiar_mesa").removeClass('xInvisible');
		
		

		if (isDelivery) {			
			$("#btn_cambiar_mesa").addClass('xInvisible');

			// datos del delivery app cliente
			optionDeliveryCliente = datosDelivery;
			// isClienteDeliveryFromApp = optionDeliveryCliente ? optionDeliveryCliente.p_header ? optionDeliveryCliente.p_header.delivery === 1 : false : false;		
			isClienteDeliveryFromApp = optionDeliveryCliente ? optionDeliveryCliente.p_header ? optionDeliveryCliente.p_header.isCliente === 1 : false : false;		
		
			isComercioServicioDeliveryPropio =  xDtSede_cm[0].pwa_delivery_servicio_propio === '1'; // xDtSede_cm[0].pwa_delivery_hablitar_calc_costo_servicio === '1'
			isDeliveryCalculaCostoEntrega = xDtSede_cm[0].pwa_delivery_hablitar_calc_costo_servicio === '1';
			isDeliveryCalculaCostoEntregaSoloApp = xDtSede_cm[0].pwa_delivery_habilitar_calc_costo_servicio_solo_app === '1';
			isPuedeLLamarRepartdiroPapaya = xDtSede_cm[0].pwa_delivery_habilitar_llamar_repartidor_papaya === '1';

			// si esta en papaya express y la red de repartidores lleva los pedidos
			// si calcula el costo de entrega y no tiene repartidores propio entonces los lleva la red de papaya
			const isRedPapayaLLevaPedido = isDeliveryCalculaCostoEntrega && !isComercioServicioDeliveryPropio

			if ( isClienteDeliveryFromApp ) { // o delivery
				
				// 241121 le quitamos al agregar items no suma
				isPedidoOpenDeliveryCliente = isClienteDeliveryFromApp; // para el calculo de subtotales


				xtitulo = 'Pedido #' + xp_sel_numpedido; // para el titulo
				if ( optionDeliveryCliente.p_header.arrDatosDelivery.pasoRecoger ) {
					pintarInfoDeliveryCliente = 'El cliente pasa a recoger. ';
				} else {
					pintarInfoDeliveryCliente = !xdtDpedido[0].nom_repartidor ? '' :  'REPARTIDOR: ' + xdtDpedido[0].nom_repartidor + ' ' + xdtDpedido[0].ap_repartidor + '. Telefono: ' + xdtDpedido[0].tel_repartidor;
				}

				// facturacion
				const dtFacDelivery = optionDeliveryCliente.p_header.arrDatosDelivery.tipoComprobante;
				const dtMetodoPago = optionDeliveryCliente.p_header.arrDatosDelivery.metodoPago;
				const fac_razon_social = dtFacDelivery ? dtFacDelivery.dni ? dtFacDelivery.dni : 'Publico en general' + ' ' + (dtFacDelivery.otro_dato || ''): 'Publico en general';
				const desRepartidorPaga = dtMetodoPago.idtipo_pago === 2 ? 'El pedido YA ESTA pagado, solo recogen.' : 'El pedido DEBE ser pagado';
				isPedidoPagadoFromApp = dtMetodoPago.idtipo_pago === 2; // esto va al componente pago
				infoFacturacion = ' | Facturacion: ' + dtFacDelivery.descripcion + ' ' + fac_razon_social + '  |  ' + desRepartidorPaga;

				labelInfoComprobante = '<p>' + dtFacDelivery.descripcion + ' ' + fac_razon_social + '  </p><strong>' + desRepartidorPaga + '</strong></p>';

				// if ( pintarInfoDeliveryCliente !== '' ) {
				// 	$('#div-info-delivery-from-app').removeClass('xInvisible');
				// }

				// totales
				// si el servicio de delivery no es propio no muestra costo del servicio ni propinas
				// console.log('subtotales delivry');
				// arrTotalesDeliveryCliente = isComercioServicioDeliveryPropio ? optionDeliveryCliente.p_subtotales : isRedPapayaLLevaPedido ? optionDeliveryCliente.p_subtotales : darFormatoSubTotalesDelivery(optionDeliveryCliente.p_subtotales);
				arrTotalesDeliveryCliente = isComercioServicioDeliveryPropio ? optionDeliveryCliente.p_subtotales : darFormatoSubTotalesDelivery(optionDeliveryCliente.p_subtotales);
				// console.log('xLocal_xDtSubTotales', xLocal_xDtSubTotales);
			
				
				
				$('#btnLlamarRepartidorP').removeClass('xInvisible');
				
				
				
				// combo repartdior
				isLlamoRepartidorRed = xdtDpedido[0].flag_solicita_repartidor_papaya === '1';
				
				
				
				if ( isLlamoRepartidorRed && !isPuedeLLamarRepartdiroPapaya ) {
					$('#btnLlamarRepartidorP').addClass('xInvisible');
				}

				if ( isLlamoRepartidorRed ) {
					$('#showLoadingReparto').removeClass('xInvisible');
				}
	
				if ( xdtDpedido[0].idrepartidor ) {
					$('#divRepartidorNom #a_nom_repartidor').text(xdtDpedido[0].nom_repartidor + ' ' + xdtDpedido[0].ap_repartidor + '. Telefono: ' + xdtDpedido[0].tel_repartidor);
					$('#divRepartidorNom').removeClass('xInvisible');
					$('#divRepartidorSelect').addClass('xInvisible');
					$('#btnLlamarRepartidorP').addClass('xInvisible');

					$('#showRepartoAsignado').removeClass('xInvisible');
					$('#showLoadingReparto').addClass('xInvisible');
					
				} else {
					if ( isComercioServicioDeliveryPropio && !isLlamoRepartidorRed ) {
						$('select#selectRepartidor').val(-1);
						$('#divRepartidorSelect').removeClass('xInvisible');
						$('#divRepartidorNom').addClass('xInvisible');
					} else {					
						$('#divRepartidorNom').removeClass('xInvisible');
						$('#divRepartidorSelect').addClass('xInvisible');
						$('#btnLlamarRepartidorP').addClass('xInvisible');
						$('#divRepartidorNom #a_nom_repartidor').text('Repartidor no asignado..');

						if ( isLlamoRepartidorRed ) {
							$('#showLoadingReparto').removeClass('xInvisible');
						}
					}

					
	
	
				}
				///
				
			}
			
			

			datosDelivery = typeof datosDelivery === 'object' ? datosDelivery.p_header ? datosDelivery.p_header.delivery === 0 ? null : datosDelivery.p_header.arrDatosDelivery : datosDelivery : datosDelivery;
			
			if (datosDelivery) {				
				$('#content-info-delivery').removeClass('xInvisible');
				datosDelivery.paga_con = datosDelivery.paga_con.replace('undefined', '');
				const infoDelivery =  datosDelivery.num_doc || '' + ' | ' + datosDelivery.nombre + ' | '+  datosDelivery.direccion + ' | '+  datosDelivery.telefono + ' | '+  datosDelivery.paga_con;
				$('#txt-info-delivery').text('DELIVERY: ' + infoDelivery + infoFacturacion);				
								

				if ( datosDelivery.pasoRecoger ) {		
					pintarInfoDeliveryCliente = 'El cliente pasa a recoger. ';
					$('#divRepartidorPropio').addClass('xInvisible');
					$('#btnLlamarRepartidorP').addClass('xInvisible');
					labelInfoPedido = '<p><i class="fa fa-user"></i> '+ xdtDpedido[0].referencia +'</p>'								
								+'<p><i class="fa fa-phone"></i> '+ datosDelivery.telefono +'</p>';
					labelInfoComprobante = '<p class="badge badge-warning fs-14"><strong> <i class="fa fa-user"></i> El cliente pasa a recoger. <strong></p>';
				} else {
					$('#divRepartidorPropio').removeClass('xInvisible');
					// $('#btnLlamarRepartidorP').removeClass('xInvisible');
					const _nomClienteDelivery = xdtDpedido[0].referencia === '' ? datosDelivery.nombre : xdtDpedido[0].referencia;
					const _refDireccion = datosDelivery.referencia ? '<p><i class="fa fa-map-marker"></i> '+ datosDelivery.referencia +'</p>' : '';
					labelInfoPedido = '<p><i class="fa fa-user"></i> '+ _nomClienteDelivery +'</p>'
								+'<p><i class="fa fa-map-marker"></i> '+ datosDelivery.direccion +'</p>'
								+ _refDireccion
								+'<p><i class="fa fa-phone"></i> '+ datosDelivery.telefono +'</p>';

					
					pintarInfoDeliveryCliente = !xdtDpedido[0].nom_repartidor ? '' :  'REPARTIDOR: ' + xdtDpedido[0].nom_repartidor + ' ' + xdtDpedido[0].ap_repartidor + '. Telefono: ' + xdtDpedido[0].tel_repartidor;
				}

				
				const _stylepago = datosDelivery.metodoPago ? datosDelivery.metodoPago.idtipo_pago === 2 ? 'fs-14 badge-info' : 'badge-secondary' : 'badge-secondary';
				labelInfoComprobante += '<p><strong>Metodo de pago: </strong><span class="badge '+ _stylepago +'">' + datosDelivery.paga_con + '</span></p>';


				// if (pintarInfoDeliveryCliente !== '') {
				// 	$('#txt-info-delivery-from-app').text(pintarInfoDeliveryCliente);
				// 	$('#div-info-delivery-from-app').removeClass('xInvisible');
				// }

				$('#info-comprobante').html(labelInfoComprobante);
				$('#info-pedido').html(labelInfoPedido);

				if (  xDtSede_cm[0].pwa_delivery_servicio_propio === '0' || xdtDpedido[0].flag_solicita_repartidor_papaya === '0' ) {
					$('#div-info-delivery-from-app').addClass('xInvisible');					
					// xSumarTotalPedidos();
				}

				if ( xdtDpedido[0].flag_solicita_repartidor_papaya === '1' ) {		
					isDeliverySolicitoReparto = true;			
					arrTotalesDeliveryCliente = darFormatoSubTotalesComisionRepartidor(xDtSede_cm[0], optionDeliveryCliente.p_subtotales, optionDeliveryCliente.p_header.arrDatosDelivery.costoTotalDelivery, true);
				}

				if ( isPuedeLLamarRepartdiroPapaya ) {
					$('#btnLlamarRepartidorP').removeClass('xInvisible');
				}


				if ( xdtDpedido[0].idrepartidor ) {
					$('#divRepartidorNom #a_nom_repartidor').text(xdtDpedido[0].nom_repartidor + ' ' + xdtDpedido[0].ap_repartidor + '. Telefono: ' + xdtDpedido[0].tel_repartidor);
					$('#divRepartidorNom').removeClass('xInvisible');
					$('#divRepartidorSelect').addClass('xInvisible');
					$('#btnLlamarRepartidorP').addClass('xInvisible');

					$('#showRepartoAsignado').removeClass('xInvisible');
					$('#showLoadingReparto').addClass('xInvisible');
					
				} else {
					if ( isComercioServicioDeliveryPropio && !isLlamoRepartidorRed ) {
						$('select#selectRepartidor').val(-1);
						$('#divRepartidorSelect').removeClass('xInvisible');
						$('#divRepartidorNom').addClass('xInvisible');
					} else {					
						$('#divRepartidorNom').removeClass('xInvisible');
						$('#divRepartidorSelect').addClass('xInvisible');
						$('#btnLlamarRepartidorP').addClass('xInvisible');
						$('#divRepartidorNom #a_nom_repartidor').text('Repartidor no asignado..');

						if ( isLlamoRepartidorRed ) {
							$('#showLoadingReparto').removeClass('xInvisible');
						}
					}					
	
				}

			} 
			else {
				$('#content-info-delivery').addClass('xInvisible');
			}
		}

		//PEDIDOS
		var xcadena_pedido='';
		var xcount_p=1;
		let xcountPermissionAnular = 0;
		for (var i = 0; i < xdtDpedido.length; i++) {
			let xcolor_tiempo_despacho='';

			xcountPermissionAnular += parseFloat(xdtDpedido[i].permission_delete);

			// revisar si solicito permiso para anular pedido
			
			

			switch (xdtDpedido[i].val_color_despachado) {
				case '1':xcolor_tiempo_despacho='xColorRow_verde'; break;
				case '2':xcolor_tiempo_despacho='xColorRow_Ambar'; break;
				case '3':xcolor_tiempo_despacho='xColorRow_Rojo'; break;
			}
			
			const xClassColorMin = xcolor_tiempo_despacho === '' ? 'xColorRow_Plomo' : xcolor_tiempo_despacho;
			const td_tiempo_atencion = xdtDpedido[i].tiempo_atencion > 0 ? '<p class="'+ xcolor_tiempo_despacho +'">' + xdtDpedido[i].tiempo_atencion + ' <span class="xfont11 '+ xClassColorMin +'">min</span></p>' : '';
			let _nomUsMozo = xdtDpedido[i].nom_usuario;
			let _iconUs = 'fa-user';
			if ( !_nomUsMozo && xdtDpedido[i].flag_is_cliente === "1" ) {
				_iconUs = 'fa-mobile text-success fa-2x';
				_nomUsMozo = '';
			} else {
				_nomUsMozo = primeraConMayusculas(_nomUsMozo);
			}			

			xcadena_pedido=String(xcadena_pedido+'<tr class="row selected1 xCursor check_item_p" data-idcategoria="'+xidCategoriaPD+
								'" data-idpedido="'+xdtDpedido[i].idpedido+
								'" data-idcliente="'+xdtDpedido[i].idcliente+
								'" data-idcat="'+xp_sel_idcategoria+
								'" data-punitario="'+xdtDpedido[i].punitario+
								'" data-total="'+xdtDpedido[i].total+
								'" data-m="'+xdtDpedido[0].nummesa+
								'" data-idtipoconsumo="'+xdtDpedido[0].idtipo_consumo+
								'" data-nump="'+xdtDpedido[0].numpedido+
								'" data-correlativo="'+xdtDpedido[0].correlativo_dia+
								'" data-ref="'+xdtDpedido[0].referencia+'">'+
								'" data-subtotales_tachados="'+xdtDpedido[0].subtotales_tachados+'">'+
									'<td><paper-checkbox checked class="check_item"></paper-checkbox>'+xcount_p+'</td>'+
									'<td><span>'+xdtDpedido[i].des_pedido+'<span><p class="xfont10 xColorRow_Plomo">'+xdtDpedido[i].referencia+'</p></td>'+
									'<td><span class="fw-100 fs-12 text-secondary text_puntos" title="Usuario"><i class="fa '+ _iconUs +' pr-1"></i>'+ _nomUsMozo +'</span></td>'+
									'<td>'+xdtDpedido[i].min_transcurridos+' <span class="xfont11 xColorRow_Plomo">min</span>'+
									td_tiempo_atencion +'</td>'+
									// td_tiempo_atencion +
									'<td align="right" class="td_importe" id="td_importe">'+xMoneda(xdtDpedido[i].total)+'</td>'+
								'</tr>');
			xcount_p++;
		};


		const _classBtnRemoAddClassPermission = xcountPermissionAnular > 0;
		const _elementeBtnAnularPedido = $('.pos-fotter-btn').find('#btn_punto_verde_pedido');
		if ( !_classBtnRemoAddClassPermission ) {
			_elementeBtnAnularPedido.addClass('xInvisible');		
		} else {
			_elementeBtnAnularPedido.removeClass('xInvisible');
		}

		$('#tb_pedidos .row').remove();
		$('#tb_pedidos').append(xcadena_pedido).trigger('create');

		$("#xBody div").remove();
		$("#xBody").append('<div><paper-spinner active class="xCentradoVerticalHorizontal"></paper-spinner></div>').trigger('create');

		if (isDelivery) {
			$("#xBody").addClass('tall-delivery');
			$("#xBodyPedidos").addClass('tall-delivery');			
		} else {
			$("#xBody").removeClass('tall-delivery');
			$("#xBodyPedidos").removeClass('tall-delivery');
		}

		
		const idPedidoAdd = lastDataPedidoInsert ? lastDataPedidoInsert.idpedido : 0;
		const _numMesa = lastDataPedidoInsert ? 0 : xp_sel_nummesa;

		_fetchApi.axiosExecute({ type: 'POST', url: '../../bdphp/log.php?op=3051', data:{m:_numMesa, p:xp_sel_numpedido, confirmar_pago: xp_sel_is_confirmar_pago, lastIdPedido: lastIdPedidoCobrado, idpedido: idPedidoAdd}})	
		.then((dtPbdet) => {

		// $.ajax({ type: 'POST', url: '../../bdphp/log.php?op=3051', data:{m:_numMesa, p:xp_sel_numpedido, confirmar_pago: xp_sel_is_confirmar_pago, lastIdPedido: lastIdPedidoCobrado, idpedido: idPedidoAdd}})
		// .done( function (dtPbdet) {

			var xdtPbdet=$.parseJSON(dtPbdet);

			// si se agrego un nuevo pedido solo trae ese pedido
			if (lastDataPedidoInsert) {
				xdtPbdet.datos.map(i => {
					xArrayDtOrdenFiltro.push(i);
				})
			} else {
				xArrayDtOrdenFiltro=xdtPbdet.datos;
			}


			xThisCM.xdtPedDet=xArrayDtOrdenFiltro;
			// console.log('xThisCM.xdtPedDet', xThisCM.xdtPedDet);
			xLoadMipedidoBD(xArrayDtOrdenFiltro)

			// console.log('sub total pedidos');
			xSumarTotalPedidos();
			xCheckPedidos();
		})
		xPopupLoad.xclose();
		xCPopenDialogDetalle();

		xThisCM.isAddItemRow = false;
		xNuevoPedidoCM();
		
				

		event.stopPropagation();
		//e.stopPropagation();
		//e.stopImmediatePropagation();
	});

	// titulo
	$("#p_mesa").text(xtitulo);


	if ( !xGeneralDataCarta ) {
		xLoadDataUlAdd();											
	}
}

function xVerificarCheckPedidos(){
	xArraychek_pedido=[];
	$('.check_item_p .check_item').each(function(i,e){
		if(e.checked){
			xArraychek_pedido.push({'idp':$(e).parent().parent().attr('data-idpedido')});
		}
	})
}

//filtrar po pedidos
function xFiltrarRowArray(){
	//xArraychek_pedido=[];
	var objDt=xThisCM.xdtPedDet.slice();
	objDt=JSON.parse(JSON.stringify(objDt));
	xAgrupar_item_activo=false;
	xVerificarCheckPedidos();
	//filtrar check activos >>> xVerificarCheckPedidos();
	/*$('.check_item_p .check_item').each(function(i,e){
		if(e.checked){
			xArraychek_pedido.push({'idp':$(e).parent().parent().attr('data-idpedido')});
		}
	})*/

	for (var i = 0; i < objDt.length; i++) {
		for (var z = 0; z < xArraychek_pedido.length; z++) {
			if(objDt[i].idpedido!=xArraychek_pedido[z].idp){
				objDt[i].visible=1;
			}
			else{
				objDt[i].visible=0; 
				break;}
		};
	};

	xArrayDtOrdenFiltro=objDt;
	xLoadMipedidoBD(objDt)
}
function xDesJuntarItem(){
	var xcant,tr,punitario,idpd_r;
	$("#tb_det_pedidos .row").each(function(i,e){
		xcant=parseInt($(e).find('#td_cant').text());
		// punitario=parseFloat($(e).find('#td_importe').text())/xcant;
		// punitario = parseFloat($(e).attr('data-punitario'));
		p_total=parseFloat($(e).find('#td_importe').text()); // precio total
		punitario = p_total === 0 ? 0 : parseFloat($(e).attr('data-punitario'));
		idpd_r=$(e).attr('data-idpedidodetalle');

		var _tr_clone=$(e);
		var _count_cant = 0;
		while(xcant>0){
			if ( _count_cant > 0 ){
				_tr_clone=$(e).clone(true);
				$(_tr_clone).find("#checkboxLabel").empty();//duplica checkbox, remove
			}
			p_total = p_total - punitario;
			
			
			$(_tr_clone).attr('data-totalr',punitario);
			$(_tr_clone).attr('data-total',punitario);
			$(_tr_clone).attr('data-cantidadr',1);
			$(_tr_clone).attr('data-idpedidodetaller',idpd_r);
			$(_tr_clone).find('#td_cant').text('01').trigger('create');
			$(_tr_clone).find('#td_importe').text(xMoneda(punitario));
			// xhtml_strung=$(this).clone(true);
			// $(xhtml_strung).find("#checkboxLabel").empty();//duplica checkbox, remove
			if ( _count_cant > 0 ){				
				$(this).after(_tr_clone);
			}
			//$("#tb_det_pedidos").append(e.innerHTML).trigger('create');
			punitario = p_total <= 0 ? 0 : punitario;
			_count_cant++;
			xcant--;
		}
	});
}
//xjuntar=1 suma item iguales
function xJuntarFilasIguales(){
	var objDt=xThisCM.xdtPedDet.slice();
	objDt=JSON.parse(JSON.stringify(objDt));
	var xid_cl_order=0,xid_tpc_order,xcant_cl_order=0,xpre_cl_order=0,xultimo_i_add_order=1,ids_pd="",cant_pd="",xtt_pd="",xi_cant,xi_precio;
	xAgrupar_item_activo=true;

	//if(xArraychek_pedido.length===0){xFiltrarRowArray();}
	if(xArraychek_pedido.length===0){xVerificarCheckPedidos();}//verifica check de pedidos activos

	hist=objDt.map(x => {
		x.grupo = x.idtipo_consumo+x.idseccion_index+x.idcarta_lista;
		return x;
		}).filter(z => z.grupo ).reduce(function(rv, x) {
	    //(rv[x['idcarta_lista']] = rv[x['idcarta_lista']] || []).push(x);


		xi_grupo = x.grupo;
		if (!rv[xi_grupo]){			
			xcant_item=0;
			xptotal_item=0;
			ids_pd='';
			cant_pd='';
			xtt_pd='';
		} else {
			xcant_item = parseFloat(rv[xi_grupo].cantidad);
			xptotal_item = parseFloat(rv[xi_grupo].ptotal);
		}

		i_cantidad = parseFloat(x.cantidad);
		i_ptotal =  parseFloat(x.ptotal);

		xcant_item += i_cantidad;
		xptotal_item += i_ptotal;

	  	//xi_cant=parseFloat(x['cantidad']);
		//xi_precio=parseFloat(x['ptotal']);
		ids_pd=ids_pd + x['idpedido_detalle'] + '|' + x['idpedido'] + ',';
		cant_pd=cant_pd + i_cantidad + ',';
		xtt_pd=xtt_pd + i_ptotal + ',';
		//var xtipo_index_consumo=x['idtipo_consumo']+x['idcarta_lista'];
		var xtipo_index_consumo=x['idtipo_consumo']+x['idseccion_index']+x['idcarta_lista'];//mantener el orden de seccion
		//var xtipo_index_consumo=x['idseccion_index'];//para que ordene
		var xpasa_sel_pedido=false;
		for (z in xArraychek_pedido) {//si el pedido esta seleccionado
			if(x['idpedido']!=xArraychek_pedido[z].idp){xpasa_sel_pedido=false;}
			else{
				xpasa_sel_pedido=true; break;}
		};
		if(xpasa_sel_pedido==true){

			// if(rv[xtipo_index_consumo] == rv[xtipo_index_consumo] && rv[xtipo_index_consumo]!=undefined){
			// 	rv[xtipo_index_consumo].cantidad=xCeroIzq(parseFloat(rv[xtipo_index_consumo].cantidad)+xi_cant,2);
			// 	rv[xtipo_index_consumo].ptotal=xMoneda(parseFloat(rv[xtipo_index_consumo].ptotal)+xi_precio);
		  	// }else{
		  	// 	rv[xtipo_index_consumo]=x
			// 		rv[xtipo_index_consumo].cantidad_r="";
			// 		rv[xtipo_index_consumo].total_r="";
		  	// }
			// if (rv[xi_grupo]['idcarta_lista'] === undefined) { rv[xi_grupo]=x};
			if(!rv[xi_grupo]) { rv[xi_grupo]=x; }
			rv[xi_grupo].cantidad = xCeroIzq(xcant_item,2);
			rv[xi_grupo].ptotal = xMoneda(xptotal_item);

		}
		//cant_pd=cant_pd.slice(0,-1);
		//xtt_pd=xtt_pd.slice(0,-1);
		rv[xtipo_index_consumo].idpedido_detalle_r=ids_pd; //al pagar, se detalla por idp_d
		rv[xtipo_index_consumo].cantidad_r=cant_pd;//al pagar, se detalla por idp_d
		rv[xtipo_index_consumo].total_r=xtt_pd;//al pagar, se detalla por idp_d
		return rv;
	  }, {});


	xArrayDtOrdenFiltro=hist;
	xLoadMipedidoBD(hist)
}

function xLoadMipedidoBD(dt){
	var xTpConsumo='';
	var xCadenaItemArray;
	var xEncabezadoCollapse='';
	var xCadenaCollapse='';
	xArrayTpC=[]; //ini en xLoadMipedidoBD tambien para formar array o estructura de  impresion en precuenta o factura, estructura de pedido={tipo consumo > seccion > items}
	xArraySeccion=[]; //ini en xLoadMipedidoBD tambien  para formar array impresion  en precuenta o factura
	var xIdColapse='';
	var xCadenaGrupo='';
	//var xCantItems;
	var xIndicacionItem='';
	var xNom_seccion;
	var xDtBd=dt;
	
	var xdisabled_btn_cambiar='';
	var xdisabled_procede='';

	//tipo de consumo // estructura de impresion
	for(a in xDtBd) {
		if(xArrayTpC[xDtBd[a].idtipo_consumo]==null){xArrayTpC[xDtBd[a].idtipo_consumo]={'id':xDtBd[a].idtipo_consumo, 'des':xDtBd[a].des_tp}}

		// desglosar subitems y agregarlos como items unicos
		// const itemSubitems = xDtBd[a].subitems.length > 0 && xDtBd[a].subitems !==null ? JSON.parse(xDtBd[a].subitems) : null;
		// if ( itemSubitems ) {

		// 	const item = JSON.parse(JSON.stringify(xDtBd[a]));
		// 	// borramos el item para ya no mostrar
		// 	xDtBd = xDtBd.filter(i => i.idcarta_lista !== item.idcarta_lista);

		// 	itemSubitems.map(sub => {
			
		// 		const itemAdd = JSON.parse(JSON.stringify(item));
		// 		const pUnitario = sub.precio.toString() === '0' ? item.punitario :  parseFloat((parseFloat(sub.precio) / sub.cantidad_seleccionada)  + parseFloat(item.punitario) ).toFixed(2);
		// 		const pTotal = sub.precio.toString() === '0' ? (parseFloat(pUnitario) * parseFloat(sub.cantidad_seleccionada)).toFixed(2) :  (parseFloat(parseFloat(pUnitario) *  sub.cantidad_seleccionada)).toFixed(2);

			
		// 		itemAdd.cant_descontar = sub.cantidad_seleccionada;
		// 		itemAdd.cantidad = sub.cantidad_seleccionada;
		// 		itemAdd.cantidad_r = sub.cantidad_seleccionada;
		// 		itemAdd.descripcion = itemAdd.descripcion + '( '+ sub.des +' )';
		// 		itemAdd.precio_default = pUnitario;	
		// 		itemAdd.ptotal = pTotal;
		// 		itemAdd.punitario = pUnitario;
			
		// 		// agregamos el item nuevo
		// 		xDtBd.push(itemAdd);
		// 	});
		// }
	}
	//inicia check
	xArraychek_pedido=[];

	//body pedido

	var xNom_seccion_b='';
	for(b in xArrayTpC){
		xCadenaItemArray='';
		xEncabezadoCollapse='';
		xCadenaCollapse='';
		xIndicacionItem='';
		xArraySeccion=[];

		//xCantItems=0;
		for (i in xDtBd) {			
			if(xArrayTpC[b].id==xDtBd[i].idtipo_consumo){
					//fue juntado
					if(xDtBd[i].visible==1){continue; }
					if(xDtBd[i].procede!=0){xdisabled_procede="xdisabled";}else{xdisabled_procede='';}
					if(xAgrupar_item_activo==true){xdisabled_btn_cambiar="xdisabled";}else{xAgrupar_item_activo='';}

					xNom_seccion=xDtBd[i].des_seccion;

					const isShowItemRemove = xDtBd[i].item_permiso_borrar == '1';
					const classShowItemRemove = isShowItemRemove ? 'text-success' : '';
					const isVisiblePuntoFlotanteVerde = isShowItemRemove ? '' : 'xInvisible';
					

					const isShowBtnAddItem = xDtBd[i].precio_default ? 
									'<div class="btn-add-item btn-sm-add-row" data-op="itempedido" title="Agregar Uno"><i class="fa fa-plus" data-op="itempedido"></i></div>' : 
									'<div class="text-danger"><i class="fa fa-eye-slash" aria-hidden="true" title="Item borrado de la carta"></i></div>';

					//seccion
					if(xArraySeccion[xDtBd[i].idseccion_index]==null){xArraySeccion[xDtBd[i].idseccion_index]='<tr><td colspan="5" class="xBold">'+xNom_seccion+'</td></tr>'; }
					xCadenaItemArray=String('<tr class="row xCursor" data-idpedidodetalle="'+xDtBd[i].idpedido_detalle+
							'" data-i="'+ i +
							'" data-idpedido="'+xDtBd[i].idpedido+
							'" data-idcliente="'+xDtBd[i].idcliente+
							'" data-punitario="'+xDtBd[i].punitario+
							'" data-idtipoconsumo="'+xDtBd[i].idtipo_consumo+
							'" data-idcategoria="'+xDtBd[i].idcategoria+
							'" data-iditem="'+xDtBd[i].iditem + 
							'" data-idcartalista="'+xDtBd[i].idcarta_lista+
							'" data-procede="'+xDtBd[i].procede+
							'" data-descontar="'+xDtBd[i].descontar_en+
							'" data-iddescontar="'+xDtBd[i].iddescontar+
							'" data-cant_descontar="'+xDtBd[i].cant_descontar+
							'" data-idpedidodetaller="'+xDtBd[i].idpedido_detalle_r+
							'" data-cantidadr="'+xDtBd[i].cantidad_r+
							'" data-totalr="'+xDtBd[i].total_r+
							'" data-cantidad="'+xDtBd[i].cantidad+
							'" data-total="'+xDtBd[i].ptotal+
							'" data-des_seccion="'+ xNom_seccion +
							'" data-subtotales_tachados="'+ xDtBd[i].subtotales_tachados +
							'" data-idbus = "' + xDtBd[i].idseccion +
							'" data-des_tp = "' + xDtBd[i].des_tp + // add 260721
							'" data-descripcion = "' + xDtBd[i].descripcion +
							'" data-idseccion_index = "' + xDtBd[i].idseccion_index +
							'" data-isalmacen = "' + xDtBd[i].isalmacen +
							'" data-precio_default = "' + xDtBd[i].precio_default +
							'" data-procede_index = "' + xDtBd[i].procede_index +
							'" data-ptotal = "' + xDtBd[i].ptotal +
							'" data-total = "' + xDtBd[i].total +
							'" data-total_r = "' + xDtBd[i].total_r +
							'" data-totalr = "' + xDtBd[i].totalr +
							'" data-is_cantidad_nd = "' + xDtBd[i].is_cantidad_nd +
							'" data-idimpresora_seccion="' + xDtBd[i].idimpresora_seccion +
							'" data-idseccion="'+ xDtBd[i].idseccion +'" >'+
									'<td width="50px" class="click_row_dt_p" id="cant_descontar"><paper-checkbox class="check_item"></paper-checkbox><span id="td_cant">'+xCeroIzq(xDtBd[i].cantidad,2)+'</span></td>'+
									'<td class="click_row_dt_p" width="50%" id="descripcion_item">'+ xDtBd[i].descripcion +																			
									'</td>'+									
									'<td class="click_row_dt_p" align="right" id="td_importe">'+xDtBd[i].ptotal+'</td>'+
									'<td align="center" style="width: 35px" class="rowadditem" data-op="itempedido" data-procede=0>' +										
										isShowBtnAddItem +
									'</td>'+
									'<td align="center" style="width: 20px" class="td_op" data-op="borrar" data-procede=0>'+
										'<i style="font-size: 18px !important" title="Borrar" class="btn-delete-row fa fa-trash-o '+ xdisabled_btn_cambiar +' '+ classShowItemRemove +'">  <i class="fa fa-unlock text-success punto-flotante-verde '+ isVisiblePuntoFlotanteVerde +'"></i> </i>'+										
										// '<img src="../../images/_delete3.png" title="Borrar" class="'+xdisabled_btn_cambiar+'">'+										
									'</td>'+									
								'</tr>');

					//xCantItems=parseInt(xCantItems)+parseInt(xDtBd[i].cantidad);
					xArraySeccion[xDtBd[i].idseccion_index]=xArraySeccion[xDtBd[i].idseccion_index]+xCadenaItemArray;

			}
		}

		xEncabezadoCollapse='<tr><td colspan="5" class="xFondoRowBlanco xBold">'+xArrayTpC[b].des+'</td></tr>';
		for (a in xArraySeccion) {
			xCadenaCollapse=String(xCadenaCollapse+xArraySeccion[a]);
		};

		xCadenaGrupo=String(xCadenaGrupo+xEncabezadoCollapse+xCadenaCollapse);
	}
	xCadenaGrupo='<div><table width="100%" id="tb_det_pedidos" class="xRowPading4">'+xCadenaGrupo+'</table></div>';
	$("#xBody div").remove();
	$("#xBody").html(xCadenaGrupo).trigger('create');

	// setTimeout(() => {		
	// 	xGeneralValidarRegalasCarta('#tb_det_pedidos', false);
	// }, 200);
}


// buscar dentro de la tabla el item con el idpedido_detalle y el elemento btn-delete-row agregar la clase text-success	
function xCPAddClassItemPermissionDelete(idpedido_detalle) {
	console.log('idpedido_detalle', idpedido_detalle);
	$('#tb_det_pedidos .row').each(function(i,e){
		if($(e).attr('data-idpedidodetalle') == idpedido_detalle){
			const _elementeBtnDelete = $(e).find('.btn-delete-row');				
			_elementeBtnDelete.addClass('text-success');
			_elementeBtnDelete.attr('data-item_permiso_borrar', idpedido_detalle);

			// buscar en _elementeBtnDelete el punto-flotante-verde
			const _elementePuntoFlotante = $(_elementeBtnDelete).find('.punto-flotante-verde');	
			_elementePuntoFlotante.removeClass('xInvisible');			
			
		}
	});
}

// buscar dentro de la talba tb_pedidos el tr con la propiedad data-idpedido y agregar la clase text-success al elemento btn_anular_pedido que esta en el div pos-fotter-btn
function xCPAddClassItemPermissionAnularPedido(idpedido) {
	$('#tb_pedidos .row').each(function(i,e){
		const _idpedidoRow = $(e).attr('data-idpedido');
		const _arridpedidos = idpedido.split(',');
		if( _arridpedidos.indexOf(_idpedidoRow) > -1 ){
			const _elementeBtnAnularPedido = $('.pos-fotter-btn').find('#btn_punto_verde_pedido');				
			_elementeBtnAnularPedido.removeClass('xInvisible');
			// _elementeBtnAnularPedido.attr('data-item_permiso_borrar', idpedido);
		}
	});
}


function xLoadDtPrintCM(){
	
	xDtPrint=xm_log_get('sede_generales'); //$.parseJSON(window.localStorage.getItem("::app3_sys_dta_prt"));
	xDtSede_cm = xm_log_get('datos_org_all_sede');	
	// console.log('xDtSede', xDtSede_cm);
}

function xcronometro_permiso(){
	xCronometro_us--;
	if(xCronometro_us==0){clearInterval(xRefreshPermiso);}
}
function xOp_permiso(){
	var _valRecuperarBorrarItem = localStorage.getItem('::app3_woRestoreStock');
	check_recuperar_stock.checked = _valRecuperarBorrarItem ? _valRecuperarBorrarItem : false;
	check_recuperar_stock_all_pedido.checked = _valRecuperarBorrarItem ? _valRecuperarBorrarItem : false;



	switch(xpass_op){
		case 'borrar': 

			// // buscamos si existe idpedido_detalle en el storage de solicitud de permiso
			// const _dataSolicitudPermiso = findStorageSolicudPermisoRemota(xCompArraySolitaPermiso.obj.idpedido_detalle, xCompArraySolitaPermiso.tipo_permiso);
			// if (_dataSolicitudPermiso) {
			// 	// si existe solicitud entonces enviamos directamente a borrar
			// 	xGetPermisoEliminarItem();

			// }


			// let isStockProductoRemoveND = false;
			// try {				
			// 	isStockProductoRemoveND = xCompArraySolitaPermiso?.obj?.is_cantidad_nd ? xCompArraySolitaPermiso.obj.is_cantidad_nd === '1' : false;			
			// } catch (error) {			
			// 	isStockProductoRemoveND = false;	
			// }

			// if ( !isStockProductoRemoveND ){
			// 	dialog_borrar_item.open(); 
			// } else {
			// 	xGetPermisoEliminarItem();
			// }
			xCMCheckPermisoBorrar();
			break; //if(xCronometro_us>0 && xCronometro_us!=30){dialog_borrar_item.open();}else{xEliminarItemPedido()};break; //solo dialog ya no confirmacion de usuario
		case 'borrar':dialog_borrar_item.open(); break; // xPermisoSupervisor=xIdUsuario; dialog_borrar_item.open();break;
		case 'cambiar':$('#txt_bus_cant').val(1);$("#txt_espcificacion").val('');$("#list_bus_item").val(''); dialog_cambiar_item.open();break;
		case 'anular_pedido':xAnularPedido(); break;
	}
}

async function xCMCheckPermisoBorrar() {
	// evaluamos si el stock es diferente a ND para adicionar un check si recupera stock
	let isStockProductoND = false;
	let idFindSolicitud = 0;
	try {
		if ( xCompArraySolitaPermiso.tipo_permiso === 1 ) {
			idFindSolicitud = xCompArraySolitaPermiso.obj.idpedido_detalle;
			isStockProductoND =  xCompArraySolitaPermiso?.obj?.is_cantidad_nd ? xCompArraySolitaPermiso.obj.is_cantidad_nd === '1' : false;
		}

		if (xCompArraySolitaPermiso.tipo_permiso === 2) {
			idFindSolicitud = xCompArraySolitaPermiso.obj.map(x => x.idpedidos).join(',');
			isStockProductoND = xCompArraySolitaPermiso?.is_cantidad_nd ? xCompArraySolitaPermiso.is_cantidad_nd === '1' : false;
		}
	} catch (error) {
		isStockProductoND = false;
	}

	// sino tiene el permiso borrar
	if ( !xCompArraySolitaPermiso.isBtnDeleteRowSuccess ) {
		if (!isStockProductoND) {			
			dialog_borrar_item.open();
		} else {
			xGetPermisoEliminarItem();
		}

		return;
	}


	const _dataSolicitudPermiso = await findStorageSolicudPermisoRemota(idFindSolicitud, xCompArraySolitaPermiso.tipo_permiso);
	if ( _dataSolicitudPermiso !== false ) {
		const _swalAlertValues = paramsSwalAlert;				

		const _checkRecuperarStock = isStockProductoND ? '' : `<div class="bg-white" style="display: inline; padding: 2px 10px 5px 10px; border-radius: 5px; font-size: 15px;">
																		<paper-checkbox id="check_recuperar_stock_dialog_borrar" checked>Recuperar stock</paper-checkbox>
																	</div>`;

		_swalAlertValues.html = `<div class="p-1" style="overflow: hidden;"><i class="fa fa-trash-o fa-2x text-danger" aria-hidden="true"></i>
                                <p class="mt-1 fs-18">Esta seguro de borrar este registro?</p>
                                ${_checkRecuperarStock}</div>`;


		_swalAlertValues.confirmButtonText = "Si, borrar";
		_swalAlertValues.cancelButtonText = "Cancelar";
		_swalAlertValues.showCancelButton = true;

		const rptDialogBorrar = await showAlertSwalHtmlDecision(_swalAlertValues);

		if (rptDialogBorrar.isConfirmed) {
			// eliminar item del pedido

			xPermisoSupervisor = _dataSolicitudPermiso.idusuario_admin

			// evaluamos si selecciono el check check_recuperar_stock_dialog_borrar
			const _valRecuperarBorrarItem = _checkRecuperarStock !== '' ? check_recuperar_stock_dialog_borrar.checked : false;	

			if ( xCompArraySolitaPermiso.tipo_permiso === 1 )  {
				xEliminarItemPedido(_valRecuperarBorrarItem, _dataSolicitudPermiso.motivo);
			}

			// anula pedidos
			if ( xCompArraySolitaPermiso.tipo_permiso === 2 )  {
				xAnularPedido(_valRecuperarBorrarItem, _dataSolicitudPermiso.motivo);
			}
		}
	} else {
		if (xCompArraySolitaPermiso.tipo_permiso === 1)  {
			if ( !isStockProductoND ){
				dialog_borrar_item.open(); 
			} else {
				xGetPermisoEliminarItem();
			}
		}

		if (xCompArraySolitaPermiso.tipo_permiso === 2) {
			dialog_motivo_anular.open();
		}
	}
}

function xGetPermisoEliminarItem() {
	// console.log(check_recuperar_stock.checked);
	const _valRecuperarBorrarItem = check_recuperar_stock.checked ? '1' : '0';
	localStorage.setItem('::app3_woRestoreStock', _valRecuperarBorrarItem);

	if(xCronometro_us>0 && xCronometro_us!=30) {
		xPermisoSupervisor=xIdUsuario;
		xEliminarItemPedido();
	} else {
		xPSupervisor.solicitarPermisoRemoto(true);
		xPSupervisor.setVal('Pe1'); pass_us.open();
	}
}

function xGoProcessBorrar() {
	switch(xpass_op){
		case 'borrar': xEliminarItemPedido(); break;
		case 'anular_pedido': xAnularPedido(); break;
	}
}

function xEliminarItemPedido(isRecuperarStock = null, motivoAnularEstablecido = ''){
	//xArrayItemEliminar
	// enviar condicion de aumentar stock
	const _isCheckRecuperarStock = isRecuperarStock !== null ? isRecuperarStock : check_recuperar_stock.checked;
	const _valRecuperarBorrarItem = _isCheckRecuperarStock ? '1' : '0';
	xPopupLoad.xopen();
	
	_fetchApi.axiosExecute({ type: 'POST', url: '../../bdphp/log.php?op=3042', data: { xarr: xArrayItemEliminar, u: xPermisoSupervisor, xisRecuperarStock: _valRecuperarBorrarItem, xMotivo: motivoAnularEstablecido } })
	.then((e_rpt) => {
		// $.ajax({ type: 'POST', url: '../../bdphp/log.php?op=3042', data:{xarr:xArrayItemEliminar,u:xPermisoSupervisor, xisRecuperarStock: _valRecuperarBorrarItem}})
		// .done( function (e_rpt) {
		//e_rpt=$.parseJSON(e_rpt):
		xe_rpt=$.parseJSON(e_rpt);
		if(!xe_rpt.success){alert(e_rpt.error); return;}
		var xcantidad_remove=parseFloat(xobj_row_item.find('#td_cant').text());
		var obj_row_mod=xBuscarAttrTbData($('#tb_pedidos'),'data-idpedido',xArrayItemEliminar.idpedido);//importe item
		var xtd_importe_row=obj_row_mod.find('#td_importe').text();//importe pedido		
		var indexRowIem=xobj_row_item.attr('data-i');

		xcantidad_remove--;
		var xprecio_descontar=parseFloat(xArrayItemEliminar.precio_total);
		if(xcantidad_remove===0){
			obj_row_mod.find('#td_importe').text('0');
			$(xobj_row_item).fadeTo(500, 0, function () {$(this).remove();});
			xThisCM.xdtPedDet[indexRowIem].visible=1;
		}

		if(xprecio_descontar>0){
			const importeTotalRow = parseFloat(xArrayItemEliminar.precio_total-xArrayItemEliminar.precio_unitario);
			xobj_row_item.find('#td_importe').text(xMoneda(importeTotalRow));
			$(xobj_row_item).attr('data-totalr', importeTotalRow);
			$(xobj_row_item).attr('data-total', importeTotalRow);

			$(xobj_row_item).attr('data-cantidad', xcantidad_remove);
			$(xobj_row_item).attr('data-cantidadr', xcantidad_remove);
			// xobj_row_item.data.total = importeTotalRow;
			xtd_importe_row=parseFloat(xtd_importe_row-xArrayItemEliminar.precio_unitario)
			obj_row_mod.find('#td_importe').text(xMoneda(parseFloat(xMoneda(xtd_importe_row))));
			if(xtd_importe_row<=0){$(obj_row_mod).fadeTo(500, 0, function () {$(this).remove();})}
		}
		//xobj_row_item.find('#td_cant').html('<paper-checkbox  class="check_item"></paper-checkbox>'+xCeroIzq(xcantidad_remove,2))
		xobj_row_item.find('#td_cant').text(xCeroIzq(xcantidad_remove,2))
		setTimeout(() => {			
			xSumarTotalPedidos(1);
		}, 550);
		// xCheckPedidos();		
		xPopupLoad.xclose();

		const infoDataPedido = {
			nummesa: xObj_miPedido.data().nummesa,
			numpedido: xObj_miPedido.data().numpedido,
		}		
		cocinarImpresionAnulacionOne(xArrayItemEliminar, xPermisoSupervisorNombre, xNomU, infoDataPedido, true)

		// indica cantidad pedidos borrados
		// console.log('aaaaaaaaaaaaaaaaaaa');
		xShowCantidadPedidosBorrados()
	})
}

// function sumarRestarPedidoPintado(newImporte, sumar = true) {
// 	var indexRowIem=xobj_row_item.attr('data-i');
// 	var _imorteObj = parseFloat(xobj_row_item.find('#td_importe').val());
// 	_imorteObj = sumar ? _imorteObj + newImporte : _imorteObj - newImporte;
// 	xobj_row_item.find('#td_importe').text(xMoneda(_imorteObj));
// 	$(xobj_row_item).attr('data-totalr', importeTotalRow);
// 	$(xobj_row_item).attr('data-total', importeTotalRow);
// }

// 060622 se borra, no se utiliza
// function xModifcar_item_cant_importe(op){
// 	xPopupLoad.xopen();
// 	$.ajax({ type: 'POST', url: '../../bdphp/log.php?op='+op, data:{i:xid_pedido_detalle_item,u:xPermisoSupervisor}})
// 	.done( function (a) {
// 		var obj_row_mod=xBuscarAttrTbData($('#tb_pedidos'),'data-idpedido',xid_pedido);
// 		var xtd_importe_row=obj_row_mod.find('#td_importe').text();
// 		var xtd_importe_item=xobj_row_item.find('#td_importe').text();
// 		var xtd_importe_item_2=xtd_importe_item;
// 		var xcantidad_remove=parseFloat(xobj_row_item.find('#td_cant').text());
// 		var xtd_cant=1;//descontar
// 		var xcant_item_change;
// 		var xSumarImporteCambiar=1;


// 		var xsql_=xArmarArrayDescontarStock(xobj_row_item,'+');
// 		var xsql_update=xsql_[0].stock+' '+xsql_[0].importe;

// 		$.ajax({ type: 'POST', url: '../../bdphp/log.php?op=100', data:{xsql:xsql_update}})
// 		.done( function () {xLoadDetallesPedido(xObj_miPedido);})
// 		//xLoadDetallesPedido(xObj_miPedido);



// 		if(parseInt(xtd_importe_item_2)>0){
// 			xtd_importe_item=xobj_row_item.attr('data-punitario');
// 			xSumarImporteCambiar=0; //sumar importe al cambiar
// 		}
// 		xtd_importe_item_2=xMoneda(parseFloat(xtd_importe_item_2)-parseFloat(xtd_importe_item));
// 		xtd_importe_row=xMoneda(parseFloat(xtd_importe_row)-parseFloat(xtd_importe_item));

// 		if(op==503){
// 			xtd_cant=1;
// 			xcantidad_remove--;
// 			xcant_item_change=xtd_cant;
// 			xid_carta_lista_a='';
// 		}

// 		obj_row_mod.find('#td_importe').text(xtd_importe_row);
// 		xobj_row_item.find('#td_importe').text(xtd_importe_item_2);
// 		//xobj_row_item.find('#td_cant').html('<paper-checkbox  class="check_item"></paper-checkbox>'+xCeroIzq(xcantidad_remove,2))
// 		xobj_row_item.find('#td_cant').text(xCeroIzq(xcantidad_remove,2))

// 		if(xcantidad_remove==0){$(xobj_row_item).fadeTo(550, 0, function () {$(this).remove();});}
// 		xtd_cant=xcant_item_change;

// 		//xModificarTotalBD(xid_pedido,xid_pedido_detalle_item,xtd_importe_row,xtd_cant,xtd_importe_item_2);
// 		xSumarTotalPedidos();
// 		xPopupLoad.xclose();
// 	});
// }


function xReImprimir(){
	dialog_erro_print.close();
	xPopupLoad.titulo="Enviando...";
	xPopupLoad.xopen();
	if(xDtSubTotales.length>0){xLLamarPrintAddLi();}else{xLLamarPrint();}
}
function xLLamarPrint(){
	//para cambio
	xPopupLoad.xopen();
	xPopupLoad.titulo="Enviando...";
	var xmesa=$("#p_mesa").text();
	var xCorrelativo_dia=$("#p_correlativo").text();

	xArrayEnca={'m':xmesa,'correlativo_dia':xCorrelativo_dia, 'item':xitem_print};

	_fetchApi.axiosExecute({ type: 'POST', url: '../../print/print3_1.php', data: { Array_enca: xArrayEnca, Array_print: xDtPrint } })
	.then((dtPrint) => {

		// $.ajax({type: 'POST', url: '../../print/print3_1.php', data:{Array_enca:xArrayEnca, Array_print:xDtPrint}})
		// .done( function (dtPrint) {

		xPopupLoad.xclose();
		if(dtPrint.indexOf('Error')!=-1){
			$("#print_error").text(dtPrint);
			dialog_erro_print.open();
		}else{
			xPopupLoad.titulo='Exito!';
			setTimeout( function(){ xCPcloseDialogDetalle();  }, 1000);
			}
	});
}

function xLLamarPrintAddLi(){
	//cuando se agrega item
	xArrayPrintEncaLi.solo_llevar=0;
	xArrayPrintEncaLi.reservar=0;
	xPopupLoad.titulo="Enviando...";

	_fetchApi.axiosExecute({ type: 'POST', url: '../../print/print3.php', data: { Array_enca: xArrayPrintEncaLi, Array_print: xDtPrint, ArrayItem: xArrayPedidoObj, ArraySubTotales: xDtSubTotales } })
	.then((dtPbd) => {
	// $.ajax({type: 'POST', url: '../../print/print3.php', data:{Array_enca:xArrayPrintEncaLi, Array_print:xDtPrint, ArrayItem:xArrayPedidoObj, ArraySubTotales:xDtSubTotales}})
	// .done( function (dtPbd) {
		xPopupLoad.xclose();
		if(dtPbd.indexOf('Error')!=-1){
			$("#print_error").text(dtPbd);
			dialog_erro_print.open();
		}else{
			xPopupLoad.titulo='Exito!';
			
			xNuevoPedidoCM()
			//setTimeout( function(){ xNuevoPedido(); }, 1500);

		}
	});
}

// 060622 se borra no se utilizaz
// function xCambiar_item(){
// 	//modificar anterior en bd cantidad, precio, secambio ++ , si cantidad=0 estado=1

// 	//actualizar en comnada grid
// 	var xid_item_bus=$('#list_bus_item').attr('data-id');
// 	if(xid_item_bus==null){$('#list_bus_item').val('');$('#list_bus_item').focus(); return;}
// 	xModifcar_item_cant_importe(504);
// }

function xValidarCant_change(obj){
	if(parseInt($(obj).val())>parseInt($(obj).attr('max'))){$(obj).val($(obj).attr('max'))}
}

async function xSumarTotalPedidos(viene_borrar, viene_dsct ){
	var xcadena_pe='';
	xtt_pedidos=0;
	var xtt_pedidos_det=0;
	var xtt_dif=0;
	var xtb_pedidos=$("#tb_pedidos");
	// var xImporteTotalSeleccionados;  // obtiene el total de los pedidos seleccionados

	$("#tb_pedidos .total").remove();
	xtt_pedidos=xSumaCantRow(xtb_pedidos,'.td_importe');

	//
	xtb_pedidos=$("#tb_det_pedidos");
	xtt_pedidos_det=xSumaCantRow(xtb_pedidos,'.td_importe');
	
	// verifica los subitems seleccionados o todos
	checkItemsSeleccionados = await getItemsSeleccionados();
	var xSumSubItmes = checkItemsSeleccionados.arrayPedidosSeleccionados;

	var xarrSumEstructura = xCargarDatosAEstructuraImpresion(xSumSubItmes);
	var _importeTotalSeleccionados = xArmarSubtotalesArray(xarrSumEstructura,xSumSubItmes.importeTotalSubItemSeleccionados);

	// si hay algun subitem seleccionado no cambia por que esto es el total de pedidos
	xImporteTotalSeleccionados = checkItemsSeleccionados.esSeleccionTotal ?  _importeTotalSeleccionados : xImporteTotalSeleccionados;
	// si es pedido delivery cliente
	// xImporteTotalSeleccionados = isPedidoOpenDeliveryCliente ? getImporteTotalSubTotalesDelivery(arrTotalesDeliveryCliente) : xImporteTotalSeleccionados;
	
	// armamos los subtotales que retorma en xLocal_xDtSubTotales
	// arrSumSubtTotales = isPedidoOpenDeliveryCliente ? addCostoDeliveryArrTotal(xLocal_xDtSubTotales, arrTotalesDeliveryCliente) : xLocal_xDtSubTotales;
	if ( isPedidoOpenDeliveryCliente && arrTotalesDeliveryCliente ) {
		arrSumSubtTotales = addCostoDeliveryArrTotal(xLocal_xDtSubTotales, arrTotalesDeliveryCliente, isComercioServicioDeliveryPropio, isDeliveryCalculaCostoEntrega, isDeliveryCalculaCostoEntregaSoloApp, isDeliverySolicitoReparto, isClienteDeliveryFromApp);
		xImporteTotalSeleccionados = getImporteTotalSubTotalesDelivery(arrSumSubtTotales);
	} else {
		arrSumSubtTotales = xLocal_xDtSubTotales; 		
	}

	arrSumSubtTotales = viene_dsct ? arrSubtTotalesDescuento : arrSumSubtTotales;
	xLocal_xDtSubTotales = arrSumSubtTotales;

	var htmlSubtotales='';	
	xLocal_xDtSubTotales.forEach((element, index) => {
		var _fontSize,_fontSizeTitulo, titulo, _style='', _id='';
		
		var classTachado = element.tachado ? 'xTachar' : '';
		var textBnQuitar = element.tachado ? 'Add' : 'Quitar';
		var importeRow = element.tachado ? element.importe_tachado : parseFloat(element.importe).toFixed(2);
		var xBtnQuitar = element.quitar ? '<span data-tachado="'+ element.tachado +'" class="xCursor xBold xColorRow_Azul xfont11" title="no cobrar" onclick="quitarSubTotal(this, '+index+')"> '+textBnQuitar+' </span>' : '';

		if ( element.descripcion.toUpperCase() === "TOTAL" ) {
			_id='tt_importe_pagar_t';
			_fontSizeTitulo='';
			_fontSize='xfont18 xBold';
			titulo='IMPORTE A PAGAR';
			xtt_pedidos_det = parseFloat(element.importe).toFixed(2);
		} else {
			_fontSize='xfont15';
			_fontSizeTitulo=='xfont15';
			titulo=element.descripcion.toUpperCase();
			// _style='style="padding-top:1px;padding-bottom:1px;"';
			_style = 'subtotal-tr-row';
		}
		
		htmlSubtotales = htmlSubtotales + '<tr class="total '+classTachado+'">'+
							'<td colspan="4" class="'+_style+'"><p class="'+_fontSizeTitulo+'">'+titulo+' '+ xBtnQuitar +'</p></td>'+
							'<td align="right" class="'+_style+'"><p class="'+_fontSize+' xColorRow_Azul" id="'+_id+'">'+importeRow+'</p></td>'+
						'</tr>';
	});


	xcadena_pe=String(xcadena_pe+'<tr class="total"><td colspan="4">CONSUMO TOTAL</><td align="right"><P class="xfont18" id="tt_consumo_t"><b>'+xMoneda(xtt_pedidos)+'</b></p></td></tr>');

	xtt_dif=parseFloat(xImporteTotalSeleccionados)-parseFloat(xtt_pedidos_det);
	ImporteDiferencia = viene_dsct ? 0 : xtt_dif;

	
	xcadena_pe=String(xcadena_pe+htmlSubtotales+'<tr class="total"><td colspan="4">DIFERENCIA</><td align="right"><P class="xfont18 xColorRow_Rojo"><b>'+xMoneda(ImporteDiferencia)+'</b></p></td></tr>');

	$("#tb_pedidos").append(xcadena_pe).trigger('create');
	xtt_pedidos=xtt_pedidos_det;

	xThisCM.importeTotalPedido = xtt_pedidos;
	



	// if(viene_borrar==1){//si viene de borrar items y ya no queda mas items = mesa disponible
	// y si no viene de descuento
		// if(parseFloat(xtt_pedidos)==0 && !viene_dsct){//cierra pedido
		// 151221 comparamos el importe de diferencia para no cerrar si seleccionan un item de costo 0.00
		if((parseFloat(xtt_pedidos)==0 && xtt_dif == 0 ) && !viene_dsct){//cierra pedido
			// console.log('sumar pedidos neutro');
			$(xObj_miPedido).removeClass('xOcupado');
			$(xObj_miPedido).removeClass('xDespachado');
			$(xObj_miPedido).addClass('xNeutro');
			$(xObj_miPedido).find('.show-led-precuenta').addClass('xInvisible');
			$(xObj_miPedido).find('.show-led-reserva').addClass('xInvisible');
			$(xObj_miPedido).find('.show-led-print').addClass('xInvisible');
			$(xObj_miPedido).find('.show-ico-mozo').addClass('xInvisible');
			$(xObj_miPedido).find('.referencia-pedido').addClass('xInvisible');
			$(xObj_miPedido).find('.show-mozo-pedido').removeClass('pintar');
			$(xObj_miPedido).find("#nommozo").text('.');
			
			$(xObj_miPedido).find(".importe").text('.');
			$(xObj_miPedido).find(".tiempo").text('disponible');
			$(xObj_miPedido).attr('data-hora','');
			$(xObj_miPedido).attr('data-estado','b');
			$(xObj_miPedido).attr('data-abrir-detalle','0');
			$('.grid').isotope('updateSortData',$(xObj_miPedido)).isotope('layout');

			// cerramos
			xCPcloseDialogDetalle();
			
		}else{
			$(xObj_miPedido).find(".importe").text(xMoneda(xtt_pedidos));
		}

	// si mofica el importe y que no venga de descuento resetea componente
	if ( !viene_dsct ) {  xCompDescuentoPedido.reset(); }
	// }
	//actualizar importe en grid;
	//xtt_pedidos

}

function quitarSubTotal(obj, index) {
	const tachado = obj.dataset.tachado;
	var idQuitar = xLocal_xDtSubTotales[index].id || "";
	
	if ( tachado === "true") {
		idQuitar = idQuitar + ",";
		xLocal_SubTotal_Quitados = xLocal_SubTotal_Quitados.replace(idQuitar,''); 
		xLocal_xDtSubTotales[index].tachado = false;		
		obj.dataset.tachado = false;
		xLocal_xDtSubTotales[index].importe_tachado = parseFloat();
	} else {
		xLocal_SubTotal_Quitados += idQuitar + ',';	
		xLocal_xDtSubTotales[index].tachado = true;
		xLocal_xDtSubTotales[index].importe_tachado = xLocal_xDtSubTotales[index].importe;
		obj.dataset.tachado = true;
	}

	// recorremos los items seleccionados o visibles y asignamos el valor del tachado
	$("#tb_det_pedidos .row").each(function(i,e){
		const index = $(e).attr('data-i'); // index del array de items
		var xsubtotales_tachados = $(e).attr('data-subtotales_tachados');
		xsubtotales_tachados = tachado === "true" ? xsubtotales_tachados.replace(idQuitar,'') : xsubtotales_tachados + idQuitar + ',';
		$(e).attr('data-subtotales_tachados', xsubtotales_tachados);

		xThisCM.xdtPedDet[index].subtotales_tachados = xsubtotales_tachados;
	});

	xSumarTotalPedidos();
}


function xOrdenPedido(op){
	switch(op){
		case 0:
			$('.grid').isotope({
  				sortBy: [ 'tpc','numero', 'estado' ]
			});

			break;
		case 1:
			$('.grid').isotope({
			  sortBy: [ 'tpc','estado', 'numero' ]
			});
			break;
	}
}

function xFiltroPedidos(obj){
	xbuscar_mesa=false;
	$('#div_filtro_header').removeClass('xInvisible');
	$('#control-delivery-new-view').addClass('xInvisible');
	$('#btn_vista_delivery').addClass('xInvisible');
	$('#_gridCM').removeClass('xInvisible');
	$('#div_filtro_header').removeClass('xInvisible');
	
	var xurl_actual = window.location.href;
	xDesFiltro1=$(obj).find('.titulo').text();
	xIdFiltro1=$(obj).attr('data-id');

	$("#Titulo_page").text("PEDIDOS | "+xDesFiltro1);	

	// desarrollo nueva vista
	if ( xDesFiltro1.toLowerCase() === 'delivery' ) {
		xbuscar_mesa=true;
		$('#btn_vista_delivery').removeClass('xInvisible');
		$('#_gridCM').addClass('xInvisible');
		$('#control-delivery-new-view').removeClass('xInvisible');
		$('#div_filtro_header').addClass('xInvisible');
		try {		
			const _copNewViewDelivery = document.getElementById('comp-control-delivery');
			_copNewViewDelivery.ini();
		} catch (error) {
			// no esta cargada la pagina de pedidos
		}
		// return;
		// xOpenPage(11);
	}

	if(xurl_actual.indexOf('c_pedido')==-1){
		xOpenPage(2,'?f1='+xIdFiltro1+'?df1='+xDesFiltro1)
	}
	xIdFiltro1='.tpc'+xIdFiltro1;	
	

	if (iIniIsotope) {
		$('.grid').isotope({ filter: xIdFiltro1 });
	} else {		
		iIniIsotope = true;
	}			
	
}

function xVistaAnteriorDelivery() {
	$('#btn_vista_delivery').addClass('xInvisible');
	$('#_gridCM').removeClass('xInvisible');
	$('#control-delivery-new-view').addClass('xInvisible');	
	$('.grid').isotope();
}


async function xLoadMesas(){		

	$('.grid').html('<paper-spinner active class="xCentradoVerticalHorizontal"></paper-spinner>').trigger('create');	
	$('.grid').isotope('destroy');
		
	xPintarMesas();
	xLogRun_CuentaNumeroPedidos();
	xVerificarCajaAbiertaOtroUsuario();
}

function xPintarMesas() {
	// console.log('pintar mesa');
	
	var selector_tpc_local_id = xm_log_get('estructura_pedido').filter(x => x.titulo === 'LOCAL').map(x =>	x.idtipo_consumo)[0];
	if ( !selector_tpc_local_id ) {
		selector_tpc_local_id = xm_log_get('estructura_pedido')[0];
		selector_tpc_local_id = selector_tpc_local_id.idtipo_consumo
	}	
	const selector_tpc_local = 'tpc' + selector_tpc_local_id;
	xIdFiltro1 = selector_tpc_local_id;	

	// limpiar grid
	// $('.grid .xMiCardPedido').remove();

	const NumMesa = parseInt(xm_log_get('datos_org_all_sede')[0].mesas);
	var xcont_mesa=1, xCadenaNumMesa = '';
	for (var i = 0; i < NumMesa; i++) {
		xtxtEstado = 'xNeutro';
		xCadenaNumMesa = String(xCadenaNumMesa + '<div class="xMiCardPedido xNeutro ' + selector_tpc_local + '" data-estado="b" data-tpc="' + selector_tpc_local + '" data-abrir-detalle=0>' +
			'<div class="show-led-print xInvisible" title="Impreso"> <i class="fa fa-print"></i> </div>' +
			'<div>'+
				'<div class="show-led-precuenta xInvisible" title="Precuenta"><i class="fa fa-pencil-square-o"></i></div>' +			
				'<p class="show-mozo-pedido" title="Atendido por"><span class="fs-8 pr-1 show-ico-mozo xInvisible"><i class="fa fa-user-circle"></i></span> <span id="nommozo">-</span></p>' +
				'<div class="show-led-reserva xInvisible" title="Reserva"><i class="fa fa-tag"></i></div>' +			
			'</div>'+
			'<p class="tipo text-secondary">Mesa</p>' +
			'<p class="numero fs-28 p-2">' + xCeroIzq(xcont_mesa, 2) + '</p>' +
			'<div class="xInvisible referencia-pedido"></div>' +
			'<p class="tiempo xfont11">disponible</p>' +
			'<p class="importe xBold">-</p>' +
			'</div>'
		);
		xcont_mesa++;
	}

	xIdFiltro1 = xIdFiltro1.indexOf('tpc')>-1 ? xIdFiltro1 : '.tpc' + xIdFiltro1;
	$('.grid').html(xCadenaNumMesa).trigger('create');

	// console.log('create isoto');
	// if ($('.grid').length) {
		$('.grid').isotope({
		  itemSelector: '.xMiCardPedido',
		  layoutMode: 'masonry',
		  percentPosition: true,
		  getSortData: {
			tpc: '[data-tpc]',
			numero: '.numero parseInt',
			estado: '[data-estado]'
		  },
		  sortBy: [ 'tpc','numero','estado' ],
		  filter: xIdFiltro1,
		  masonry: {				
				horizontalOrder: true // manterner el order horizontal
			}		  
		});
	// }
	
	// $('.grid').isotope('layout');

	iIniIsotope = true;

	
	// setTimeout(() => {		
		xPintarEstadoPedido();
	// }, 500);
}

function xPintarEstadoPedido(_objPedido = 0) {
	const selector_tpc_local_id = xm_log_get('estructura_pedido').filter(x => x.titulo === 'LOCAL').map(x => x.idtipo_consumo)[0];
	const selector_tpc_local = 'tpc' + selector_tpc_local_id;
	xIdFiltro1 = selector_tpc_local_id;

	const NumMesa = parseInt(xm_log_get('datos_org_all_sede')[0].mesas);
	var xCadenaNumMesa=''
	, xCadenaPedidoOtros=''
	, xidtipo_c='tpc1';				

	// isShowResizePedidoByReferencia para redimensionar si hay referencias

	// console.log('vuelve a pintar bd');
	if (typeof _objPedido === 'object') {
		_objPedido.lastIdPedido = lastIdPedidoCobrado
	} 

	console.log('run axiosExecute');
	_fetchApi.axiosExecute({ type: 'POST', url: '../../bdphp/log.php?op=501', isShowPreload:false, data: {objPedido: _objPedido}})
	.then((dtPe) => {
		// $.ajax({ type: 'POST', url: '../../bdphp/log.php?op=501', data: {objPedido: _objPedido}})
		// .done( function (dtPe) {			
			// if($(".grid .xMiCardPedido").length>0){return;}			
			var xdtPe=JSON.parse(dtPe);
			console.log('xdtPe');
			// console.log('xdtPe', xdtPe);

			var xCadenaTPC=''
			, xcont_mesa=1
			, xindex
			, xtxtEstado='', xtxtEstadoDespachado='', itemList
			, xtxtHora='', xtxt_subtota_total=0;

			xCadenaNewItem='';

			xdtPe=xdtPe.datos.map( x => {x.actualizado = false; return x;});			

			if ( pasoRedibujado ) { return; }
			// xdtPe=xdtPe.datos;




			// for (var i = 0; i < NumMesa; i++) {
			$(".xMiCardPedido .numero").each(function(index,element){
				xindex=-1;
				xtxtEstado='';
				xtxtEstadoDespachado = ''
				xtxtHora='';

				const _eparent = $(element).parent();
				xcont_mesa = element.textContent; //numero mesa
				
				// itemList = xdtPe.filter(x => parseInt(x.nummesa) === parseInt(xcont_mesa))[0];
				itemList = xdtPe.filter(x => xCeroIzq(x.nummesa, 2) === element.textContent || xCeroIzq(x.correlativo_dia, 4) === element.textContent)[0];
				if ( itemList ) {
					if (itemList.confirmar_pago === '1'  && itemList.nummesa !== '0' ) { 
						// chequeamos si la mesa tiene pedido despues de haber pagado por app
						isPedidoInMesa(_eparent, itemList.nummesa);
						return;
					}

					xindex = 0;
					xtxtEstado = 'xOcupado';
					xtxtEstadoDespachado = parseInt(itemList.despachado) === 0 ? '' : 'xDespachado';
					xtxtHora = itemList.hora;

					// retorna el total + subtotales
					// xtxt_subtota_total = xArmarSubtotalesFromTotal(itemList);
					
					// xCadenaNumMesa = String(xCadenaNumMesa + '<div class="xMiCardPedido xOcupado ' + xtxtEstadoDespachado + ' ' + selector_tpc_local + ' xCursor'
					// 	+' data-estado="a" data-tpc="' + selector_tpc_local + '" data-hora="' + itemList.hora + '"' 
					// 	+' data-p="' + itemList.idpedido + '" data-nummesa="' + itemList.nummesa + '"'
					// 	+' data-correlativo="' + itemList.correlativo_dia + '"  data-numpedido="' + itemList.numpedido + '"'
					// 	+' data-idcat="' + itemList.idcategoria + '" onclick="xLoadDetallesPedido(this)" data-abrir-detalle="1">' +
					// 	'<p class="tipo">Mesa</p>' +
					// 	'<h3 class="numero xBold">' + xCeroIzq(xcont_mesa, 2) + '</h3>' +
					// 	'<p class="tiempo xfont11">-</p>' +
					// 	'<p class="importe xBold">S/. ' + xMoneda(xtxt_subtota_total) + '</p>' +
					// 	'</div>');

					_eparent.removeClass('xNeutro');
					_eparent.removeClass('xDespachado');
					_eparent.addClass('xOcupado');
					_eparent.addClass('xCursor');
					_eparent.addClass(xtxtEstadoDespachado);
					_eparent.find('.show-ico-mozo').removeClass('xInvisible');
					_eparent.find('.show-led-print').removeClass('xInvisible');
					_eparent.find('.show-mozo-pedido').addClass('pintar');

					// si ya se imprimio precuenta de la mesa
					if ( itemList.is_precuenta.toString() === '1' ) {
						_eparent.find('.show-led-precuenta').removeClass('xInvisible');
					} else {
						_eparent.find('.show-led-precuenta').addClass('xInvisible');
					}


					// si ya se imprimio comanda
					if ( itemList.is_printer.toString() === '1' ) {
						_eparent.find('.show-led-print').removeClass('xInvisible');
					}

					// evalua si hay referencia si hay referencia
					// console.log('itemList', itemList);
					const isShowReferenciaPedido = itemList.referencia && itemList.referencia !== '';	
					
					if ( isShowReferenciaPedido ) {
						// remplazar la primera coma por un espacio vacio
						const _cadenaReferenciaPedido = primeraConMayusculas(itemList.referencia.replace(/^,/, ''));
						const _listReferenciaPedido = _cadenaReferenciaPedido.split(',')
						let _itemHtmlReferenciaPedido = ''

						_listReferenciaPedido.forEach((element, index) => {
							_itemHtmlReferenciaPedido = _itemHtmlReferenciaPedido + '<p class="show-referencia-pedido">' + element + '</span>';
						});
						
						// console.log('_cadenaReferenciaPedido', _cadenaReferenciaPedido);
						_eparent.find('.referencia-pedido').removeClass('xInvisible');
						_eparent.find('.referencia-pedido').html(_itemHtmlReferenciaPedido);
						_eparent.find('.referencia-pedido').trigger('create');
					} else {
						_eparent.find('.referencia-pedido').addClass('xInvisible');
					}

					// _eparent.addClass(xidtpc_item_up);
					// retorna el total + subtotales
					xtxt_subtota_total = itemList.des_tipo_consumo.toUpperCase() === 'DELIVERY' ? '-'  :  'S/. ' + xMoneda(xArmarSubtotalesFromTotal(itemList));
					_eparent.find(".importe").text(xtxt_subtota_total);
					_eparent.attr('data-hora',itemList.hora);
					_eparent.attr('data-p',itemList.idpedido);
					_eparent.attr('data-nummesa',itemList.nummesa);
					_eparent.attr('data-isconfirmarpago',itemList.confirmar_pago);					
					_eparent.attr('data-numpedido',itemList.numpedido);
					_eparent.attr('data-correlativo',itemList.correlativo_dia);
					_eparent.attr('data-estado','a');
					// _eparent.attr('data-tpc', xidtpc_item_up);
					_eparent.attr('data-abrir-detalle','1');
					_eparent.click(function(e){
						lastDataPedidoInsert = null; // el utlimo pedido agregado desde control pedidos
						xLoadDetallesPedido(_eparent)						
							e.stopPropagation();
							e.stopImmediatePropagation()
						});
					
					_eparent.find('#nommozo').text(itemList.nommozo);
					
					if ( itemList.reserva === '1' ) {
						_eparent.find('.show-led-reserva').removeClass('xInvisible');
					} 

					itemList.actualizado=true;
					// xactualiza = true;
				// } else {
				// 	xtxtEstado = 'xNeutro';
				// 	xCadenaNumMesa = String(xCadenaNumMesa + '<div class="xMiCardPedido xNeutro ' + selector_tpc_local + '" data-estado="b" data-tpc="' + selector_tpc_local + '" data-abrir-detalle=0>' +
				// 		'<p class="tipo">Mesa</p>' +
				// 		'<h3 class="numero xBold">' + xCeroIzq(xcont_mesa, 2) + '</h3>' +
				// 		'<p class="tiempo xfont11">disponible</p>' +
				// 		'<p class="importe xBold">-</p>' +
				// 		'</div>'
				// 	);
				}

				// xcont_mesa++;
			});

			// para llevar / delivery / reserva / otros
			var xref_reserva='';
			if ( pasoRedibujado ) { return; }
			// xdtPe.filter(x => parseInt(x.nummesa) === 0 || parseInt(x.reserva) === 1).map(itemList => {

			try {
				// actualizamos pedidos pagados desde el app
				xdtPe.filter(x => x.confirmar_pago == "1").map(x => {

					// const element = $('.xMiCardPedido#'+x.idpedido);					
					var element = document.getElementById(x.idpedido);					
					if ( element ) {
						element = $(element);
						if ( x.nummesa == "0"  ) {
							element.addClass('xInfo');
							element.find('.iconPedido').addClass('fa fa-credit-card fa-2x');
							element.find('.tipo').text('Pago App');
						} else {
							// si es pago en mesa
							x.actualizado = true;
							x.dibujado = true;
						}
					}
				});				
			} catch (error) {
				console.log(error);
			}
			

			xdtPe.filter(x => !x.actualizado).map(itemList => {
				// if (itemList) {

					if ( itemList.dibujado ) { return; }

					// 291220
					// buscamos si este numpedioo ya esta pintado, si ya esta pintado lo removemos para actualizarlo, para que no se duplique vista de pedido					
					$(".xMiCardPedido .tipo").each(function(index,element){
						if (element.textContent.toLowerCase() !== 'mesa' ) {
							const _elementDivMiCardPedido = element.parentElement.parentElement; 
							const _numPedidoMiCardPedido = _elementDivMiCardPedido.dataset.numpedido; // $(element).parents('.xMiCardPedido')[0].dataset.numpedido;
							if (_numPedidoMiCardPedido === itemList.numpedido) {

								$(".grid").isotope('remove',$(_elementDivMiCardPedido)).isotope('layout');
							}
							// element.parentElement.remove();
						}
					});


					const  datosDelivery = itemList.json_datos_delivery;
					
					try {						
						itemList.json_datos_delivery = datosDelivery != '' && datosDelivery != '{}' && datosDelivery != '[]' ? JSON.parse(datosDelivery) : null;
					} catch (error) {
						// si el string tiene saltos de pagina /n
						itemList.json_datos_delivery = JSON.parse(datosDelivery.replace(/(\r\n|\n|\r)/g,""));
					}
					
					
					xref_reserva = '';
					xidtipo_c = itemList.idtipo_consumo;
					if (parseInt(itemList.reserva) === 1) {
						xidtipo_c = '99';
						// xref_reserva = '<p class="ref_reserva xfont12">' + itemList.referencia + '</p>';
					}

					xidtipo_c='tpc'+xidtipo_c;
					var _stylePedido = 'xOcupado ', 
					xEstadoMiPedido = 'a', 
					xIconPedido = '<i class="iconPedido"></i>', 
					xnomCliente = '', 
					_labelIdpedido = '<p class="fs-15 pb-8"> #' + itemList.idpedido + '</p>',
					labelTitle = 'Pedido';					

					if ( itemList.json_datos_delivery ) {

						if ( itemList.json_datos_delivery.p_header &&  itemList.json_datos_delivery.p_header.arrDatosDelivery.metodoPago) {

							_stylePedido = itemList.json_datos_delivery.p_header.arrDatosDelivery.metodoPago.idtipo_pago === 2 ? 'xWarning ' : 'xOcupado ';
							if ( itemList.json_datos_delivery.p_header.arrDatosDelivery.pasoRecoger ) {
								_stylePedido = 'xWarning ';
								xnomCliente = itemList.json_datos_delivery.p_header.arrDatosDelivery.nombre;
								_labelIdpedido = '<p class="xfont10">' + xnomCliente + '</p>';
								xIconPedido = '<i class="iconPedido fa fa-user fa-2x"></i>';
								labelTitle = 'Cliente Pasa Recoger';
								xEstadoMiPedido = 'r';
							}
	
							// si es un pedido programado
							if ( itemList.json_datos_delivery.p_header.arrDatosDelivery.tiempoEntregaProgamado ) {
								if ( itemList.json_datos_delivery.p_header.arrDatosDelivery.tiempoEntregaProgamado.modificado ) {
									_stylePedido = 'xWarning ';
									xnomCliente = itemList.json_datos_delivery.p_header.arrDatosDelivery.nombre;
									_labelIdpedido = '<p class="fs-15 pb-8"> #' + itemList.idpedido + '</p>';
									xIconPedido = '<i class="iconPedido fa fa-clock-o fa-2x"></i>';
									labelTitle = 'Pedido Programado  '  + itemList.json_datos_delivery.p_header.arrDatosDelivery.tiempoEntregaProgamado.dia + ' ' + itemList.json_datos_delivery.p_header.arrDatosDelivery.tiempoEntregaProgamado.hora;
									xEstadoMiPedido = 'p';
								}
							}
	
							// si ha sido pagado con tarjeta
							if ( itemList.json_datos_delivery.p_header.arrDatosDelivery.metodoPago.idtipo_pago === 2 ) {
								_stylePedido = 'xOcupado ';
								xnomCliente = itemList.json_datos_delivery.p_header.arrDatosDelivery.nombre;
								_labelIdpedido = '<p class="fs-15 pb-8"> #' + itemList.idpedido + '</p>';
								// xIconPedido = '<i class="iconPedido fa fa-credit-card fa-2x"></i>';
								labelTitle = 'Pedido Pagado';
								xEstadoMiPedido = 't';
							}

						}
						


					}

					// si ya pago desde el app y solo falta confirmar pago para registrar
					var _isOtroCardClass = 'otroCard ';
					itemList.reserva = itemList.reserva ? itemList.reserva : '0';
					var numBold = itemList.reserva.toString() === '0' && itemList.tipo_consumo_titulo.toUpperCase() === 'LOCAL' ? '' : xCeroIzq(itemList.correlativo_dia,4);
					var NumidPedido = itemList.idpedido;
					var fechaHoraPedido = itemList.fecha +' '+ itemList.hora;
					var _labelNumIdFecha =  '<p class="tiposubt fs-11 fw-100">ID:'+ NumidPedido +' F: '+ fechaHoraPedido +'</p>';
					var _tituloMesa = numBold === '' ?  'Mesa ' : 'Pedido';
					var _itemReferencia = itemList.referencia === '' ? '.' : xMayusculaPrimera(itemList.referencia.toLowerCase());
					var _referencia =  `<p class="refTitulo fs-17 pb-2 pt-2">${ _itemReferencia }</p>`; // si es en mesa no pone referencia
					var _nomMozo = itemList.nommozo ? xMayusculaPrimera(itemList.nommozo.toLowerCase()) : 'Cliente';
					_nomMozo = 'Atendido por: ' + _nomMozo;

					var isClientePedidoFromApp = itemList.json_datos_delivery ? itemList.json_datos_delivery.p_header ? itemList.json_datos_delivery.p_header.isCliente === 1 : false : false;		
					var _isDeliveryPedido = itemList?.json_datos_delivery?.p_header?.delivery === 1;
					var _iconApp = isClientePedidoFromApp ? '<span class="badge badge-success mr-1">APP</span>' : '-'

					var _iconTopTpc = '<i class="fa fa-shopping-bag ml-2 text-secondary" aria-hidden="true"></i>';					

					var isClientePedidoFromAppPagoTarjeta = itemList?.json_datos_delivery?.p_header?.arrDatosDelivery?.metodoPago?.idtipo_pago === 2 ? true : false;		
					var _iconAppTarjeta = isClientePedidoFromAppPagoTarjeta ? '<span class="badge badge-info">Tarjeta</span>' : '-'

					if ( isClientePedidoFromApp && !isClientePedidoFromAppPagoTarjeta ) {
						const _desTipoPagoAPP = itemList?.json_datos_delivery?.p_header?.arrDatosDelivery?.metodoPago ? itemList?.json_datos_delivery?.p_header?.arrDatosDelivery?.metodoPago.descripcion : '';
						if ( _desTipoPagoAPP  !== '') {
							switch (_desTipoPagoAPP.toLowerCase()) {
								case 'efectivo':
									_iconAppTarjeta = '<span class="badge badge-secondary">Efectivo</span>'
									break;		
								case 'yape':
									_iconAppTarjeta = '<span class="badge badge-warning">Yape</span>'
									break;							
								default:
									_iconAppTarjeta = '<span class="badge badge-danger">'+ _desTipoPagoAPP +'</span>';
									break;
							}
						}
					}

					if ( _isDeliveryPedido  ) {
						_iconTopTpc = '<i class="fa fa-motorcycle ml-2 text-secondary" aria-hidden="true"></i>';
					}

					if (parseInt(itemList.reserva) === 1) {
						_iconTopTpc = '<i class="fa fa-clock-o ml-2 text-secondary" aria-hidden="true"></i>';
					}

					

					xtxt_subtota_total = itemList.des_tipo_consumo.toUpperCase() === 'DELIVERY' ? '-'  :  'S/. ' + xMoneda(xArmarSubtotalesFromTotal(itemList));

					if ( xtxt_subtota_total === '-'  ) {
						xtxt_subtota_total = 'S/. ' + xMoneda(itemList?.json_datos_delivery?.p_subtotales.pop().importe);
					}
					
					

					// si ya se imprimio comanda
					var xShowFlagPrinterComanda = 'xInvisible';
					if ( itemList.is_printer.toString() === '1' ) {
						xShowFlagPrinterComanda = '';						
					}

					if ( itemList.confirmar_pago.toString() === "1" && itemList.nummesa.toString() !== '0') {
						_isOtroCardClass = '';
						_labelNumIdFecha = '';
						_iconTopTpc = '<i class="iconPedido fa fa-credit-card fa-2x"></i>';
						_stylePedido = 'xInfo ';
						_labelIdpedido = '';// _tituloMesa.trim() === 'Mesa' ? '<p class="fs-15 pb-8">'+ _tituloMesa + '</p>' : _labelIdpedido;						
						_tituloMesa = '';
						
						// xIconPedido = '<i class="iconPedido fa fa-credit-card fa-2x"></i>';
						 _referencia =  `<p class="refTitulo fs-28 pb-2 pt-2">${ xCeroIzq(itemList.nummesa, 2) }</p>`; 
						 _nomMozo = '';
						xEstadoMiPedido = 't';
						xref_reserva = 'Mesa Pago App';

						_iconApp = '';
						_iconAppTarjeta = '';
						// _nomMozo = 'Cliente pago por la app';
					}
					

					

					xCadenaNewItem=String(xCadenaNewItem+'<div class="xMiCardPedido xOcupado '+ _isOtroCardClass +_stylePedido+xidtipo_c+' xCursor" id="'+ itemList.idpedido +'"'
						+' data-estado="'+ xEstadoMiPedido +'" data-tpc="'+xidtipo_c+'" data-hora="'+itemList.hora+'" data-p="'+itemList.idpedido+'"'
						+' data-nummesa="'+itemList.nummesa+'" data-correlativo="'+itemList.correlativo_dia+'"'
						+' data-isconfirmarpago="'+itemList.confirmar_pago +'"'
						+' data-numpedido="'+itemList.numpedido+'"  data-abrir-detalle="1" onclick="xLoadDetallesPedido(this)">'+ // onclick="xLoadDetallesPedido(this)"
						'<div class="content-a">'+
							xIconPedido + 
							'<div class="show-led-print '+ xShowFlagPrinterComanda +'" title="Impreso"> <i class="fa fa-print"></i> </div>' +
							'<p class="tipo fw-600">'+ _tituloMesa +' '+ numBold + _iconTopTpc+'</p>'+
							_labelNumIdFecha +
							// '<h3 class="numero">'+ _referencia + '</h3>'+
							// _labelIdpedido +						
							_referencia +
							'<p class="tiempo xfont11"></p>'+xref_reserva +	
							'<p class="fs-11">'+  _nomMozo +'</p>'+
						'</div>'+
						'<div class="content-b">'+
							'<div class="d-flexx justify-content-center">'+
							_iconApp + _iconAppTarjeta +
							'</div>'+
							'<div class="content-importe">' +
							'<p class="importe xBold fs-15">'+ xtxt_subtota_total +'</p>'+
							'</div>' +
						'</div>'+
					'</div>');

					itemList.dibujado = true;
					itemList.actualizado = true;
					// itemList.actualizado = x.confirmar_pago ? x.confirmar_pago == "0" ? true : false : true;
				// }
			});

			if ( xdtPe.length > 0 ) {
				xdtPe[xdtPe.length - 1].actualizado = true;
			}

			if(xCadenaNewItem!=''){

				var $itemsNew=$(xCadenaNewItem);		
				$('.grid').append($itemsNew).isotope( 'appended', $itemsNew );				
			}

			// $('.grid').isotope('updateSortData');			
			

			iIniIsotope = true;
			pasoRedibujado = true;

			// para que vuela a dibujar o no dibuje 2 veces
			setTimeout(() => {
				pasoRedibujado = false;
			}, 500);

			xCadenaNewItem='';

			// no reservas
			const _valsReset = []
			xdtPe.map(x => {
				const _val = x.nummesa == 0 ? '|'+xCeroIzq(x.correlativo_dia,4)+'|' : '|'+xCeroIzq(x.nummesa,2)+'|';
				_valsReset.push(_val);
			}); 


			// si actualiza todo
			if ( _objPedido === 0 ) {
				xResetMesaDefault(_valsReset.join(','));
			}

			// xResetMesaDefault(xdtPe.filter(x => x.reserva.toString() === "0").map(x => {
			// 	const _val = x.nummesa == 0 ? '|'+xCeroIzq(x.correlativo_dia,4)+'|' : '|'+xCeroIzq(x.nummesa,2)+'|';
			// 	return _val;
			// }).join(','));
			
			$('.grid').isotope('updateSortData'); //.isotope('layout');
						
			setTimeout(() => {
				$('.grid').isotope('layout');			
				// $('.grid').isotope('updateSortData'); //.isotope('layout');
				// $('.grid').isotope({ sortBy : ['tpc', 'numero', 'estado'] })
				
			}, 1000);		
			
		});

}

function _cpSocketPintarPedido(pedido) {	

	pNotificaNuevoPedido(pedido); // notifica el pedido nuevo desde la app


	// console.log('nuevo pedido socket' , pedido);
	var _objPedido = 0;
	var dt_pedido = pedido;

	if ( pedido ) {
		if ( pedido.idpedido ) { // desde el cliente
						
			if ( pedido.isFromVR ) {
				_objPedido = {
					idpedido: dt_pedido.idpedido,
					nummesa: dt_pedido.m === '' ? 0 : dt_pedido.m
				}		
			} else {
				_objPedido = {
					idpedido: dt_pedido.idpedido,
					nummesa: dt_pedido.p_header.m === '' ? 0 : dt_pedido.p_header.m
				}
			}			
		 
		} else {
			dt_pedido = JSON.parse(pedido.detalle_json);
			_objPedido = {
				idpedido: dt_pedido.Array_enca.idpedido,
				nummesa: dt_pedido.Array_enca.m === '' ? 0 : dt_pedido.Array_enca.m
			}
		}
	
	}

	// para no volver a cargar la misma mesa se pone 0 en 600ms
	if ( lastIdPedidoPrint === _objPedido.idpedido ) { return; }
	lastIdPedidoPrint = _objPedido.idpedido;

	setTimeout(() => {
		lastIdPedidoPrint = 0;
	}, 600);

	pasoRedibujado = false;
	xPintarEstadoPedido(_objPedido)
}

function _cpSocketPintarFlagPedidoImpreso(listPedidos) {
	// buscar mesa o pedido
	listPedidos = JSON.parse(listPedidos);
	listPedidos.map(x => {
		pedidoEnca = x.item.data.Array_enca;
		var elementFind = xBuscarPedidoDom(pedidoEnca.m, pedidoEnca.num_pedido)
		// elementFind.find('.show-led-print').removeClass('xInvisible');
		if ( elementFind ) {
			if ($(elementFind).find('.importe').val() !== '') {
				$(elementFind).find('.show-led-print').removeClass('xInvisible')
			}
		}
	});

	
}

function xBuscarPedidoDom(mesa = '0', numpedido = '0') {
	var elementRpt;
	mesa = parseInt(mesa);	
	numpedido = parseInt(numpedido);	
	if (mesa !== 0) {
		$('.xMiCardPedido').each((i, e) => {
			if ( parseInt(e.dataset.nummesa) === mesa ) {				
				elementRpt = e;
				return;
			}
		});
	} else {
		$('.xMiCardPedido').each((i, e) => {
			if ( parseInt(e.dataset.numpedido) === numpedido ) {				
				elementRpt = e;
				return;
			}
		});
	}
	return elementRpt;

}



// cuenta los numero de pagos desde la app notificados 
function _cpSocketPintarNumerosPagosNotificados() {
	var divLabelFromApp = $('#labelPagoFromApp');
	var cantPagosNotificados = parseInt(divLabelFromApp.find('.xIndicadorCant-no-remove').text());
	cantPagosNotificados = isNaN(cantPagosNotificados) ? 0 : cantPagosNotificados; 
	cantPagosNotificados ++;

	divLabelFromApp.find('.xIndicadorCant-no-remove').remove();
	divLabelFromApp.append('<span class="xIndicadorCant-no-remove">'+cantPagosNotificados+'</span>').trigger('create');	
}

// xdtPe -> pedido
// function pintarChildPedido(isInit, pedido) {
// 	$(".xMiCardPedido .numero").each(function(index,element){
// 	xindex=-1;
// 	xtxtEstado='';
// 	xtxtEstadoDespachado = ''
// 	xtxtHora='', xdtPe = [];

// 	const _eparent = $(element).parent();
// 	xcont_mesa = element.textContent; //numero mesa

// 	// itemList = xdtPe.filter(x => parseInt(x.nummesa) === parseInt(xcont_mesa))[0];
// 	// isInit -> si esta iniciando el item viene del loadmesas, de
// 	if (!isInit) {
// 		if ( isSocket ) {
// 			xdtPe.push(pedido);
// 		} else {
// 			xdtPe = pedido;
// 		}
// 	} else { xdtPe = pedido; }
	
// 	itemList = xdtPe.filter(x => xCeroIzq(x.nummesa, 2) === element.textContent || xCeroIzq(x.correlativo_dia, 4) === element.textContent)[0]
// 	if ( itemList ) {
// 	xindex = 0;
// 	xtxtEstado = 'xOcupado';
// 	xtxtEstadoDespachado = parseInt(itemList.despachado) === 0 ? '' : 'xDespachado';
// 	xtxtHora = itemList.hora;

// 	// retorna el total + subtotales
// 	xtxt_subtota_total = xArmarSubtotalesFromTotal(itemList);

// 	// xCadenaNumMesa = String(xCadenaNumMesa + '<div class="xMiCardPedido xOcupado ' + xtxtEstadoDespachado + ' ' + selector_tpc_local + ' xCursor'
// 					// 	+' data-estado=" a" data-tpc="' + selector_tpc_local + '" data-hora="' + itemList.hora + '"' 
// 					// 	+' data-p="' + itemList.idpedido + '" data-nummesa="' + itemList.nummesa + '"'
// 					// 	+' data-correlativo="' + itemList.correlativo_dia + '" data-numpedido="' + itemList.numpedido + '"'
// 					// 	+' data-idcat="' + itemList.idcategoria + '" onclick="xLoadDetallesPedido(this)" data-abrir-detalle="1">' +
// 		// '<p class="tipo">Mesa</p>' +
// 		// '<h3 class="numero xBold">' + xCeroIzq(xcont_mesa, 2) + '</h3>' +
// 		// '<p class="tiempo xfont11">-</p>' +
// 		// '<p class="importe xBold">S/. ' + xMoneda(xtxt_subtota_total) + '</p>' +
// 		// '</div>');

// 	_eparent.removeClass('xNeutro');
// 	_eparent.addClass('xOcupado');
// 	_eparent.addClass('xCursor');
// 	_eparent.addClass(xtxtEstadoDespachado);
// 	// _eparent.addClass(xidtpc_item_up);
// 	_eparent.find(".importe").text('S/. '+xMoneda(xtxt_subtota_total))
// 	_eparent.attr('data-hora',itemList.hora);
// 	_eparent.attr('data-p',itemList.idpedido);
// 	_eparent.attr('data-nummesa',itemList.nummesa);
// 	_eparent.attr('data-numpedido',itemList.numpedido);
// 	_eparent.attr('data-correlativo',itemList.correlativo_dia);
// 	_eparent.attr('data-estado','a');
// 	// _eparent.attr('data-tpc', xidtpc_item_up);
// 	_eparent.attr('data-abrir-detalle','1');
// 	_eparent.click(function(e){
// 	xLoadDetallesPedido(_eparent)
// 	e.stopPropagation();
// 	e.stopImmediatePropagation()
// 	});

// 	itemList.actualizado=true;
// 	// xactualiza = true;
// 	// } else {
// 	// xtxtEstado = 'xNeutro';
// 	// xCadenaNumMesa = String(xCadenaNumMesa + '<div class="xMiCardPedido xNeutro ' + selector_tpc_local + '"
// 		// data-estado="b" data-tpc="' + selector_tpc_local + '" data-abrir-detalle=0>' +
// 		// '<p class="tipo">Mesa</p>' +
// 		// '<h3 class="numero xBold">' + xCeroIzq(xcont_mesa, 2) + '</h3>' +
// 		// '<p class="tiempo xfont11">disponible</p>' +
// 		// '<p class="importe xBold">-</p>' +
// 		// '</div>'
// 	// );
// 	}

// 	// xcont_mesa++;
// 	});

// 	// para llevar / delivery / reserva / otros
// 	var xref_reserva='';
// 	// xdtPe.filter(x => parseInt(x.nummesa) === 0 || parseInt(x.reserva) === 1).map(itemList => {
// 	xdtPe.filter(x => !x.actualizado).map(itemList => {
// 	// if (itemList) {
// 	xref_reserva = '';
// 	xidtipo_c = itemList.idtipo_consumo;
// 	if (parseInt(itemList.reserva) === 1) {
// 	xidtipo_c = '99';
// 	xref_reserva = '<p class="ref_reserva xfont12">' + itemList.referencia + '</p>';
// 	}

// 	xidtipo_c='tpc'+xidtipo_c;

// 	xtxt_subtota_total = xArmarSubtotalesFromTotal(itemList);
// 	xCadenaNewItem=String(xCadenaNewItem+'<div class="xMiCardPedido xOcupado '+xidtipo_c+' xCursor"'
// 						+' data-estado="a" data-tpc="'+xidtipo_c+'" data-hora="'+itemList.hora+'" data-p="'+itemList.idpedido+'"'
// 						+' data-nummesa="'+itemList.nummesa+'" data-correlativo="'+itemList.correlativo_dia+'"'
// 						+' data-numpedido="'+itemList.numpedido+'" onclick="xLoadDetallesPedido(this)" data-abrir-detalle="1">'+
// 		'<p class="tipo">Pedido</p>'+
// 		'<h3 class="numero xBold">'+xCeroIzq(itemList.correlativo_dia,4)+'</h3>'+
// 		'<p class="tiempo xfont11">-</p>'+xref_reserva+
// 		'<p class="importe xBold">S/. '+xMoneda(xtxt_subtota_total)+'</p>'+
// 		'</div>');
// 	// }
// 	});

// 	if(xCadenaNewItem!=''){
// 	var $items=$(xCadenaNewItem);
// 	$('.grid').append($items).isotope( 'appended', $items );
// 	}

// 	$('.grid').isotope('updateSortData');

// 	iIniIsotope = true;

// 	xCadenaNewItem='';

// 	xResetMesaDefault(xdtPe.map(x => {
// 	const _val = x.nummesa == 0 ? '|'+xCeroIzq(x.correlativo_dia,4)+'|' : '|'+xCeroIzq(x.nummesa,2)+'|';
// 	return _val;
// 	}).join(','));
// }

function xLogRun_CuentaNumeroPedidos(){
	if ( isSocket) { return; }	

	if(typeof(EventSource) !== "undefined") {
	    xsourceEvent = new EventSource("../../bdphp/log_run.php?op=1");
	    xsourceEvent.onmessage = function(event) {
	        if(event.data!==xValCountPedidos){
				xValCountPedidos=event.data;
				if (firstLoad_mesas){ // si es la primera carga no actualiza
					firstLoad_mesas = false;
					return;
				}
				xActualizarItems();
			}
	    };
	}
}



function xVerificarSiActualizaItems(){
	if (isSocket) {return; }

	_fetchApi.axiosExecute({ type: 'POST', url: '../../bdphp/log.php?op=50101' })
	.then((dtRptI) => {
		// $.ajax({ type: 'POST', url: '../../bdphp/log.php?op=50101'})
		// .done( function (dtRptI) {
		dtRptI=parseInt(dtRptI);
		if(dtRptI!=xCountTotalPedidos){
			xCountTotalPedidos=dtRptI;
			xActualizarItems();
		}
	})
}
function xActualizarItems(){
	if (!isSocket)  {

		xPintarEstadoPedido();
	}

}

function xResetMesaDefault(_num) {
	// if (_num === '') {return; }
	$(".xMiCardPedido.xOcupado .numero").each(function(index,element){
		const _eparent = $(element).parent();
		const _t_find = '|'+element.textContent+'|';
		if (_t_find.length === 6) {return;} // no es mesa
		if ( _num.indexOf(_t_find) === -1 ) {
			_eparent.removeClass('xOcupado');
			_eparent.removeClass('xDespachado');
			_eparent.removeClass('xCursor');
			_eparent.addClass('xNeutro');
			_eparent.find('.show-led-precuenta').addClass('xInvisible');
			_eparent.find('.show-led-reserva').addClass('xInvisible');
			// _eparent.addClass('tpc1');
			_eparent.find(".importe").text('-');
			_eparent.find(".tiempo").text('disponible')
			
			_eparent.attr('data-abrir-detalle','0');
			_eparent.attr('data-estado','b');
			
			_eparent.removeAttr('data-p');
			_eparent.removeAttr('data-hora');
			_eparent.removeAttr('data-numpedido');
			_eparent.removeAttr('data-correlativo');
		}
	});

	$('.grid').isotope('updateSortData');
}


function xRefreshPedidoPaySocket(pedido) {
	// if (_num === '') {return; }
	const element = xBuscarPedidoDom(pedido.num_mesa, pedido.num_pedido);
	if ( !element ) {return;}
	const _eparent = $(element);

	
	if (pedido.importe_restante === 0) {
		if ( pedido.num_mesa === 0 ) { // si es llevar o delivery
			_eparent.remove();
			$('.grid').isotope('updateSortData');
			return;
		}

		// $(".xMiCardPedido.xOcupado .numero").each(function(index,element){
			// const _t_find = '|'+element.textContent+'|';
			// if (_t_find.length === 6) {return;} // no es mesa
			// if ( _num.indexOf(_t_find) === -1 ) {
				_eparent.removeClass('xOcupado');
				_eparent.removeClass('xDespachado');
				_eparent.removeClass('xCursor');
				_eparent.addClass('xNeutro');
				_eparent.find('.show-led-precuenta').addClass('xInvisible');
				_eparent.find('.show-led-reserva').addClass('xInvisible');
				_eparent.find('.show-led-print').addClass('xInvisible');
				_eparent.find('.show-ico-mozo').addClass('xInvisible');
				_eparent.find('.referencia-pedido').addClass('xInvisible');
				_eparent.find('.show-mozo-pedido').removeClass('pintar');
				_eparent.find("#nommozo").text('.');
				// _eparent.addClass('tpc1');
				_eparent.find(".importe").text('-');
				_eparent.find(".tiempo").text('disponible')
				
				_eparent.attr('data-abrir-detalle','0');
				_eparent.attr('data-estado','b');
				
				_eparent.removeAttr('data-p');
				_eparent.removeAttr('data-hora');
				_eparent.removeAttr('data-numpedido');
				_eparent.removeAttr('data-correlativo');
			// }
		// });
	} else {
		const _importeUpdate = parseFloat(_eparent.find(".importe").text().replace('S/. ', '')) - pedido.importe_restante;
		_eparent.find(".importe").text('S/. ' + _importeUpdate.toFixed(2));
	}

	$('.grid').isotope('updateSortData');
}

function xCalcularTiempoPedido(){
	// console.log('pintar cantidad tpc');
	var xhora_item;
	var xContador_cant=new Array();
	$(".xMiCardPedido.xOcupado").each(function(index,element){
		xhora_item=$(element).attr('data-hora');
		xidtpc_item=$(element).attr('data-tpc');
		xidtpc_item=xidtpc_item.replace('tpc','');
		if(isNaN(parseInt(xContador_cant[xidtpc_item]))){xContador_cant[xidtpc_item]=0}
		xContador_cant[xidtpc_item]=parseInt(xContador_cant[xidtpc_item])+1;
		xTiempoTranscurridos_2(xhora_item,function(h,m,s,dif){
			xhora_item=xTiempoDe_MS_Hora(dif);
			$(element).find('.tiempo').text(xhora_item);
		})
	})

	$("#list_menu_lateral .xIndicadorCant").each(function(index,element){$(element).remove();})

	for(a in xContador_cant){
		var xid_element="#DesTPC"+a;
		$(xid_element).find("div .xIndicadorCant").remove();
		$(xid_element).find('div').append('<span class="xIndicadorCant">'+xContador_cant[a]+'</span>').trigger('create');
	}
	/*if(xContador_cant.length==0){
		$("#list_menu_lateral .li_row div .xIndicadorCant").each(function(index,element){$(element).remove();})
	}*/
}

function xLoadItems_add(){
	_fetchApi.axiosExecute({ type: 'POST', url: '../../bdphp/log.php?op=901' })
	.then((dtConsumo) => {
	// $.ajax({ type: 'POST', url: '../../bdphp/log.php?op=901'})
	// .done( function (dtConsumo) {
		var xcadenaConsumo='';
		var xdtConsumo=$.parseJSON(dtConsumo);
		var xdtPro=eval((JSON.stringify(xdtConsumo.datos).replace(/descripcion/g,'label')).replace(/idt/g,'value'));

		const _objListProductoVenta = $("#ListProductoVenta");

		_objListProductoVenta.autocomplete({
			autoFocus:true,
			source:xdtPro,
			select: function( event, ui ) {
				_objListProductoVenta.val(ui.item.label);
		        _objListProductoVenta.attr('data-value',ui.item.value);
		        _objListProductoVenta.attr('data-tipo',ui.item.tipo);
		        _objListProductoVenta.attr('data-idproductodetalle',ui.item.idproducto_detalle);
		        $( "#pventa").val(ui.item.precio);
		        return false;
		    },
		    focus:function(event, ui){return false;},
		    change:function( event, ui ) {
		    	if(ui.item===null){_objListProductoVenta.attr('data-value',"")}
		    	return false;
		    }
		});
	});
}

function getAllRepartidor() {
		_fetchApi.axiosExecute({ type: 'POST', url: '../../bdphp/log_005.php?op=13' })
		.then((dtValues) => {
            // $.ajax({ type: 'POST', url: '../../bdphp/log_005.php?op=13'})
	        // .done( function (dtValues) {				
                dtValues=$.parseJSON(dtValues);	
				xThisCM.listRepartidor=dtValues.datos;				
            });
        }


function selectRepartidor() {
	const index = xThisCM.$.selectRepartidor.value;            
    const _repartidor = xThisCM.listRepartidor[index];

	_fetchApi.axiosExecute({ type: 'POST', url: '../../bdphp/log_005.php?op=1301', data: { idrepartidor: _repartidor.idrepartidor, idpedido: xid_pedido_selected } })
	.then((res) => {
		// $.ajax({ type: 'POST', url: '../../bdphp/log_005.php?op=1301', data:{idrepartidor: _repartidor.idrepartidor, idpedido: xid_pedido_selected }})
	    //     .done( function (res) {	

				xdtDpedido[0].idrepartidor = _repartidor.idrepartidor;
				_cpSocketNoiticaRepartidorFromComercio(xdtDpedido[0]);

				try {
					
					const payloadRepartidor =  [{
						nombre: xdtDpedido[0].json_datos_delivery.p_header.arrDatosDelivery.nombres,
						telefono: xdtDpedido[0].json_datos_delivery.p_header.arrDatosDelivery.telefono,
						establecimiento: xdtDpedido[0].json_datos_delivery.p_header.arrDatosDelivery.establecimiento.nombre,
						idpedido: xdtDpedido[0].idpedido,
						repartidor_nom: _repartidor.nombre,
						repartidor_telefono: _repartidor.telefono
					}];
	
					_cpSocketNoiticaClienteRepartidorAsignado(payloadRepartidor);

				} catch (error) {
					console.log(error);
				}

			});
}


function xCallRepartidorPapaya() {
	var costoEntrega = optionDeliveryCliente.p_header.arrDatosDelivery.costoTotalDelivery;
	var _impDelivery = parseFloat(costoEntrega).toFixed(2);
	if (isNaN(_impDelivery)){
		$('#dialog_info_call_repartidor #msj_dialo_call').text(`No es posible llamar repartidor ya que la direccion que indico no esta georeferenciada, solicite a soporte tecnico habilitar esta opcin.`);
		$('#btnConfirmaCallReparto').addClass('xInvisible');
	} else {
		
		$('#dialog_info_call_repartidor #msj_dialo_call').text(`Deseo Solicitar un repartidor de Papaya Express para este pedido. Al confirmar no podra asignar este pedido a ningn otro repartidor.
					Ademas el comercio asume el costo del servicio de entrega (S/. ${ parseFloat(costoEntrega).toFixed(2) }). Desea confirmar su solicitud?`);

		$('#btnConfirmaCallReparto').removeClass('xInvisible');
	}
	
					
	dialog_info_call_repartidor.open();	
}

function xCallRepartidorPapayaExec() {
	_fetchApi.axiosExecute({ type: 'POST', url: '../../bdphp/log_005.php?op=1302', data: { idpedido: xid_pedido_selected } })
	.then((res) => {
	// $.ajax({ type: 'POST', url: '../../bdphp/log_005.php?op=1302', data:{idpedido: xid_pedido_selected }})
	// .done( function (res) {
		// lanzar notificacion de comision del repartdior
		isDeliverySolicitoReparto = true;
		arrTotalesDeliveryCliente = darFormatoSubTotalesComisionRepartidor(xDtSede_cm[0], optionDeliveryCliente.p_subtotales, optionDeliveryCliente.p_header.arrDatosDelivery.costoTotalDelivery, true);
		// xLocal_xDtSubTotales = darFormatoSubTotalesComisionRepartidor(xDtSede_cm[0], xLocal_xDtSubTotales, optionDeliveryCliente.p_header.arrDatosDelivery.costoTotalDelivery, true);
		xSumarTotalPedidos();
		_cpSocketComercioLLamaRepartidorPapaya();
		$('#showLoadingReparto').removeClass('xInvisible');
		$('#btnLlamarRepartidorP').addClass('xInvisible');
	});
}

// pintar pedido sin cargar desde la bd
// despues de agregar un  item adicional o restar
function xRefreshListaPedidosItems(obj) {	

	
	
	
	if ( isPassAddRowItemList ) { return;} // para evitar que se agregue 2 veces // caso carlin
	isPassAddRowItemList = true;

		const totalPedido = xarr_subtotales[xarr_subtotales.length - 1].importe;
		const _rowItemPedido = {
			idpedido: lastDataPedidoInsert.idpedido,
			idcliente: 0,
			total: totalPedido,
			nummesa: xarr_header.mesa,
			idtipo_consumo: xarr_header.tipo_consumo,
			numpedido: lastDataPedidoInsert.numpedido,
			correlativo_dia: lastDataPedidoInsert.correlativo_dia,
			referencia: '',
			subtotales_tachados: '',
			des_pedido: 'P'+xCeroIzq(lastDataPedidoInsert.correlativo_dia, 3),
			min_transcurridos: 0,
			tiempo_atencion: 0
		}

		xdtDpedido.push(_rowItemPedido);

		xAddRowInsertListItems(obj);
		xPintarListPedido();		

	setTimeout(() => {
		isPassAddRowItemList = false;
	}, 1000);
}


// agregar solo el pedido agregado por control de pedidos
function xAddRowInsertListItems(obj) {
	var xp_sel_nummesa=$(obj).attr('data-nummesa');
	var xp_sel_numpedido=$(obj).attr('data-numpedido');
	var xp_sel_correlativo_dia=$(obj).attr('data-correlativo');
	// xp_sel_idcategoria=$(obj).attr('data-idcat');
	var xp_sel_is_confirmar_pago=$(obj).attr('data-isconfirmarpago');

	const idPedidoAdd = lastDataPedidoInsert ? lastDataPedidoInsert.idpedido : 0;
		const _numMesa = lastDataPedidoInsert ? 0 : xp_sel_nummesa;

		_fetchApi.axiosExecute({ type: 'POST', url: '../../bdphp/log.php?op=3051', data: { m: _numMesa, p: xp_sel_numpedido, confirmar_pago: xp_sel_is_confirmar_pago, lastIdPedido: lastIdPedidoCobrado, idpedido: idPedidoAdd } })
		.then((dtPbdet) => {
		// $.ajax({ type: 'POST', url: '../../bdphp/log.php?op=3051', data:{m:_numMesa, p:xp_sel_numpedido, confirmar_pago: xp_sel_is_confirmar_pago, lastIdPedido: lastIdPedidoCobrado, idpedido: idPedidoAdd}})
		// .done( function (dtPbdet) {
			// console.log('xAddRowInsertListItems');
			var xdtPbdet=$.parseJSON(dtPbdet);

			// si se agrego un nuevo pedido solo trae ese pedido
			if (lastDataPedidoInsert) {
				xdtPbdet.datos.map(i => {
					// xArrayDtOrdenFiltro.push(i);
					if ( !xArrayDtOrdenFiltro.length ) { // si esta agrupado
						// buscamos el item idtipo_consumo + _seccionIndex[0] + idseccion + idcarta_lista
						const _seccionIndex = i.idseccion_index.split('.')
						const _codFindItem = i.idtipo_consumo + '' + _seccionIndex[0] + '.'+ _seccionIndex[1] +''+ i.idcarta_lista;
						const _itemMod = Object.values(xArrayDtOrdenFiltro).find(x => x.grupo === _codFindItem);
						_itemMod.cantidad = parseFloat(_itemMod.cantidad) + parseFloat(i.cantidad);
						_itemMod.cantidad_r = _itemMod.cantidad;
						_itemMod.ptotal =  (parseFloat(_itemMod.ptotal) + parseFloat(i.ptotal)).toFixed(2);
					} else {
						xArrayDtOrdenFiltro.push(i);
					}
				})
			} else {
				xArrayDtOrdenFiltro=xdtPbdet.datos;
			}


			xThisCM.xdtPedDet=xArrayDtOrdenFiltro;
			// console.log('xThisCM.xdtPedDet', xThisCM.xdtPedDet);
			xLoadMipedidoBD(xArrayDtOrdenFiltro)

			xSumarTotalPedidos();
			xCheckPedidos();
		})
		xPopupLoad.xclose();
		xCPopenDialogDetalle();

		xThisCM.isAddItemRow = false;
		xNuevoPedidoCM();
		
				

		
}


function xPintarListPedido() {
	var xcadena_pedido='';
		var xcount_p=1;
		for (var i = 0; i < xdtDpedido.length; i++) {
			let xcolor_tiempo_despacho='';

			switch (xdtDpedido[i].val_color_despachado) {
				case '1':xcolor_tiempo_despacho='xColorRow_verde'; break;
				case '2':xcolor_tiempo_despacho='xColorRow_Ambar'; break;
				case '3':xcolor_tiempo_despacho='xColorRow_Rojo'; break;
			}
			
			const xClassColorMin = xcolor_tiempo_despacho === '' ? 'xColorRow_Plomo' : xcolor_tiempo_despacho;
			const td_tiempo_atencion = xdtDpedido[i].tiempo_atencion.length > 0 ? '<td class="'+ xcolor_tiempo_despacho +'">' + xdtDpedido[i].tiempo_atencion + ' <span class="xfont11 '+ xClassColorMin +'">min</span></td>' : '<td></td>';
			

			xcadena_pedido=String(xcadena_pedido+'<tr class="row selected1 xCursor check_item_p" data-idcategoria="'+xidCategoriaPD+
								'" data-idpedido="'+xdtDpedido[i].idpedido+
								'" data-idcliente="'+xdtDpedido[i].idcliente+
								'" data-idcat="'+xp_sel_idcategoria+
								'" data-punitario="'+xdtDpedido[i].punitario+
								'" data-total="'+xdtDpedido[i].total+
								'" data-m="'+xdtDpedido[0].nummesa+
								'" data-idtipoconsumo="'+xdtDpedido[0].idtipo_consumo+
								'" data-nump="'+xdtDpedido[0].numpedido+
								'" data-correlativo="'+xdtDpedido[0].correlativo_dia+
								'" data-pedido_permiso_borrar="'+xdtDpedido[0].pedido_permiso_borrar+
								'" data-ref="'+xdtDpedido[0].referencia+'">'+
								'" data-subtotales_tachados="'+xdtDpedido[0].subtotales_tachados+'">'+
									'<td><paper-checkbox checked class="check_item"></paper-checkbox>'+xcount_p+'</td>'+
									'<td>'+xdtDpedido[i].des_pedido+' <span class="xfont10 xColorRow_Plomo">'+xdtDpedido[i].referencia+'</span></td>'+
									'<td>'+xdtDpedido[i].min_transcurridos+' <span class="xfont11 xColorRow_Plomo">min</span></td>'+
									td_tiempo_atencion +
									'<td align="right" class="td_importe" id="td_importe">'+xMoneda(xdtDpedido[i].total)+'</td>'+
								'</tr>');
			xcount_p++;
		};
		$('#tb_pedidos .row').remove();
		$('#tb_pedidos').append(xcadena_pedido).trigger('create');

		// xSumarTotalPedidos();
}

function xVerificarCajaAbiertaOtroUsuario() {
	_fetchApi.axiosExecute({ type: 'POST', url: '../../bdphp/log_005.php?op=23' })
	.then((res) => {
		// $.ajax({ type: 'POST', url: '../../bdphp/log_005.php?op=23'})
		// .done( res => {
			res = JSON.parse(res);
			if (res.success) {
				const _dataCajAbierta = res.datos;				
				if ( _dataCajAbierta.length === 0 ) { return }
				if ( parseInt(_dataCajAbierta[0].importe) > 0 ) {
					const _isInfoCajaOpen = isNaN(parseInt(localStorage.getItem('::app3_info_caja_open'))) ? 0 : parseInt(localStorage.getItem('::app3_info_caja_open'));
					if ( _isInfoCajaOpen == 1 ) { return; }


					let _usCajasAbiertas = '';
					_dataCajAbierta.map(x => {
						_usCajasAbiertas +=  '<p class="text-warning fs-14">'+x.nombres + ' con S/' + x.importe + ' </p>'
					})

					const _swalAlertValues = paramsSwalAlert;        					
					_swalAlertValues.html = `<div class="p-1">                    
												<img src="../../images/swal-cash-register.png">												
												<p class="fw-600 fs-20">Caja Abierta</p>
												<p class="fw-100 fs-14">
													Usuarios:
													${_usCajasAbiertas}
												</p>
											</div>`;															
					showAlertSwalHtml(_swalAlertValues);

					localStorage.setItem('::app3_info_caja_open', '1');
				}
			}
		});
}

function xShowCantidadPedidosBorrados() {
	_fetchApi.axiosExecute({ type: 'POST', url: '../../bdphp/log_009.php?op=901' })
	.then((res) => {
	// $.ajax({ type: 'POST', url: '../../bdphp/log_009.php?op=901'})
	// .done( res => {
		res = JSON.parse(res);
		if (res.success) {
			const _cant = res.datos[0].cant;
			$('#DesTPC-borrados').find("div .xIndicadorCant3").remove();
			if ( _cant != '0' ) {
				$('#DesTPC-borrados').find('div').append('<span class="xIndicadorCant3">'+res.datos[0].cant+'</span>').trigger('create');
			}
		}
	});
	
}

// function addContadorLoad() {
// 	var contadoLoad = parseInt(localStorage.getItem('::app3_sys_count_load_m'));
// 	contadoLoad = isNaN(contadoLoad) ? 1 : contadoLoad + 1;
// 	localStorage.setItem('::app3_sys_count_load_m', contadoLoad);
// }

// function isContadorLoad() {
// 	var contadoLoad = parseInt(localStorage.getItem('::app3_sys_count_load_m'));
// 	contadoLoad = isNaN(contadoLoad) ? 1 : contadoLoad;

// 	if ( contadoLoad > 1 ) {
// 		localStorage.setItem('::app3_sys_count_load_m', 0);
// 	}

// 	return contadoLoad > 1 ? false : true;
// }


Polymer({
	is:'x-control-mesas',
	properties:{
		xt_org:Number,
		xt_idsede:Number,
		xt_idus:Number,
		dt_item:Object,
		xdtPedDet: Object,
		isLoadMesasIsotope: Boolean,
		isAddItemRow: Boolean,
		listRepartidor: [],
		importeTotalPedido: Number,
		// hidden_container_registro_pago: boolean = false,
		// valid_form_cliente_pago: boolean = false,
		// valid_monto_pago: boolean = false
	},
	attached:function(){				
		xThisCM = this;
		xThisCM.select_page = 0;	
		
		iIniIsotope = false;
		countIntiCP++;
		cuentaEventoLoadIniPrincipal = cuentaEventoLoadIniPrincipal = 1 ? 0 : cuentaEventoLoadIniPrincipal;
		
		// xIniControlMesa();
		
		// iIniIsotope = false;
		// addContadorLoad();
		// if ( isContadorLoad() ) {
		// 	xIniControlMesa();
		// }
		xbuscar_mesa = false;

		
		// _cpSocketIsConnect();
		setTimeout(() => {				
			xIniControlMesa();
			
			_cpSocketOpen();
			// console.log('entra socket');
		}, 500);
		// if ( xThisCM ) {return}
    	
	},
	ready: () => {
		// _cpSocketOpen();
		console.log('entra ready');
	},
    detached:function(){
		// console.log('sale', countIntiCP);
    	//clearInterval(xRefreshPedidos);
    	clearInterval(xRefreshHora);
    	clearInterval(xRefreshPermiso);
		xbuscar_mesa=true;		

		// xsourceEvent.close();			
		
		_cpSocketClose();
	}

});
</script>
