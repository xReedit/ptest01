<!--link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html" !-->

<dom-module id="x-caja">
	<!-- <script rel="preload" type="text/javascript" src="../../../js/socket.io.js"></script> -->
	<link rel="import" href="../../x-componentes/x-comp-printer-local-select/x-comp-printer-local-select.html">
	<link rel="preload" href="../../../images/_msj_envio_sunat.gif" as="image" media="(max-width: 600px)">
	<template>

		<paper-dialog class="dialog_redondo" id="dialog_info_supervisor" style="max-width: 500px;" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation">
			<div>								
				<p class="fs-18">Cunato tengo?.</p>
				<p class="fw-100 text-secondary">El importe que debe tener en caja es la suma de sus ventas en efectivo <span class="fw-600 text-primary">mas</span> sus ingresos de efectivo a caja y <span class="fw-600 text-danger">menos</span> sus salidas de efectivo de caja.</p>
				<br>
				<p class="fw-100 text-secondary">Puede ver sus ventas en efectivo en la opción de "Registro de Pagos". Si no encuentra su diferencia, llame al supervisor.</p>
				<br>
									
				<button dialog-dismiss class="btn btn-dark mb-2" onclick="xPSupervisor.xopen()">Ingresar clave supervisor</button><br>
				<button dialog-dismiss class="btn btn-primary mb-2" onclick="xOpenDialogPermisoRemotoUs()">Solicitar Permiso Remoto</button><br>
				<button dialog-dismiss class="btn btn-secondary">Cancelar</button>
			</div>
		</paper-dialog>

		<!-- permiso remoto -->
		<paper-dialog class="dialog_redondo" id="dialog_permiso_remoto" style="max-width: 500px;" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation">
			<div>				
				<img src="../../../images/_solicitud_remoto.png" alt="solicita">
				<p class="fs-18">Solicitar permiso remoto.</p>
				<p class="fw-100 text-secondary">Solicitar permiso al administrador para saber su diferencia y poder cerrar su caja.</p>
				<br>
				<p>Quien dará el permiso?</p>
				<select class="selected-template-1" id="selAdmin" onchange="selectedUsAdmin(this)">
					<template is="dom-repeat" items="{{listUsAdmin}}" as="item">
						<option value="{{item.idusario}}">{{ item.nombres }}</option>
					</template>
				</select>
				<br><br>
				<p>En efectivo tengo:</p>
				<input type="text" class="xMiInput xPasarEnter2 fs-15 fw-600 w-50" placeholder="0.00" id="txt_total_tengo">

				<br><br>				
				<button class="xBoton2 xVerde" onclick="xEnviarPermisoRemoto()">Enviar</button>
				<button dialog-dismiss class="xBoton2 xPlomo">Cancelar</button>
			</div>
		</paper-dialog>

		<paper-dialog class="dialog_redondo" id="dialog_enviando_sunat" style="width: 245px;" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation">
			<div style="text-align: center">
				<img id="dgl_sunat_img" src="../../../images/_msj_envio_sunat.gif" alt="">
				<p id="dgl_sunat_msj">Enviando comprobantes electronicos.</p>
				<p id="dgl_sunat_msj2" class="dgl_sunat_msj2 xInvisible xColorRow_Azul">Proceso concluido con exito.</p>
				<p id="dgl_sunat_msj3 xfont11" class="dgl_sunat_msj3 center xColorRow_Plomo">...</p>
				<paper-progress id="dgl_sunat_progress" indeterminate style="width: 100%;"></paper-progress>
				<button dialog-dismiss id="dlg_sunat_btn" class="xBoton2 xVerde xInvisible">Listo</button>
			</div>
		</paper-dialog>
		<paper-dialog id="dialog_erro_print" modal style="min-width: 330px;" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation">
			<h4>Error en impresora</h4>
			<p id="print_error"></p>
			<br>
			<div class="xBoton2 xVerde" style="margin-left:23px;" onclick="xReImprimirCierre();">Intentar Nuevamente</div>
			<div class="xBoton2 xPlomo" style="margin-left:23px;" dialog-dismiss onclick="dialog_detalle.close();">No imprimir</div>
			<br><br><br>
		</paper-dialog>
		<paper-dialog id="dialog_cierre" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
			<div class="xContent">
				<p class="xfont14" id="msj">OK cuadre conforme. Recuerde imprimir las operaciones detalladas, luego cierre su terminal.</p>
				<br>
				<paper-button tabindex="0" raised class="xverde" onclick=""><iron-icon icon="save"></iron-icon>Imprimir cierre</paper-button>
            	<paper-button tabindex="0" raised class="xnegro" onclick=""><iron-icon icon="save"></iron-icon>Cerrar sistema</paper-button>
			</div>
		</paper-dialog>
		<x-pass id="xPSupervisor" titulo="Permiso del administrador" val="Rol1"></x-pass>
		<br>
		<div class="xContent">
			<paper-tabs selected="{{selected}}" id="tab_caja">
				<paper-tab>INGRESO / SALIDA DE CAJA</paper-tab>
      			<paper-tab>CIERRE DE CAJA</paper-tab>
      		</paper-tabs>
			<div class="xLinea2"></div>
      		<br><br>
      		<iron-pages selected="{{selected}}">
	      		<div id="ingreso_caja">
					<div class="xDivImpresora">
						<x-comp-printer-local-select></x-comp-printer-local-select>
					</div>
					<div>
						<br>
						<form id="form_ingreso" onsubmit="return false">
							<select class="xTextRow2 xfont18 xCursor" id="selecie" style="width:200px">
								<option value="1">INGRESO A CAJA</option>
								<option value="2">SALIDA DE CAJA</option>
							</select><br><br>
							<p>Detalle el motivo del movimiento de efectivo.</p>
							<input type="text" class="xMiInput xPasarEnter2" onChange="conMayusculas(this)" placeholder="Motivo" id="motivo" name="motivo" required>
							<br><br>
							<input type="number" class="xMiInput" placeholder="Monto" style="width:200px" pattern="[0-9]+([\.,][0-9]+)?" step="any" id="monto" name="monto" required>
							<div class="xInvisible">
								<input type="text" id="idsede" name="idsede" value="[[xt_idsede]]">
								<input type="text" id="idorg" name="idorg" value="[[xt_org]]">
								<input type="text" id="idusuario" name="idusuario" value="[[xt_idus]]">
								<input type="text" id="fecha" name="fecha">
								<input type="text" id="tipo" name="tipo">
							</div>
						</form><br><br>
						<paper-button tabindex="0" raised class="xverde" onclick="xGuardarIngreso();"><iron-icon icon="save"></iron-icon>Listo Guardar</paper-button>
						<br><br><br>
						<h4>Resumen de movimientos que aun no tienen cierre</h4>
						<div class="xLinea2"></div>
						<table id="tb_resumen_ie" width="65%" class="xtable">
							<thead>
								<th width="20px">#</th>
								<th align="left">Fecha</th>
								<th align="left">Tipo</th>
								<th align="left">Motivo</th>
								<th align="right">Importe</th>
							</thead>
						</table>

						<!-- ingresos varios -->
						<div hidden$="[[ !isShowIngresoVarios ]]">
							<br><br>
							<div class="xLinea2"></div>
							<br>
							<h3>Ingresos Varios</h3>
							<br>
							<table>
								<thead>
									<th align="left">Fecha</th>
									<th align="left">Metodo</th>
									<th align="left">Cliente</th>
									<th align="left">Concepto</th>
									<th align="right">Importe</th>									
								</thead>
								<tbody>
									<template is="dom-repeat" items="{{listIngresosVarios}}" as="item">
										<tr>
											<td>{{ item.fecha }}</td>
											<td>{{ item.tipo_pago }}</td>
											<td>{{ item.nom_cliente }}</td>
											<td>{{ item.concepto }}</td>									
											<td align="right">{{ item.importe }}</td>											
										</tr>
									</template>
								</tbody>
							</table>
						</div>

						<div hidden$="[[ !isShowListaAdelantoOrden ]]">
							<br><br>
							<div class="xLinea2"></div>
							<br>
							<h3>Adelantos de ordernes de pedido</h3>
							<br>
							<table>
								<thead>
									<th>Fecha</th>
									<th>Usuario</th>
									<th># Orden</th>
									<th>Cliente</th>
									<th>Detalle</th>
									<th>Importe</th>
									<th>.</th>
								</thead>
								<tbody>
									<template is="dom-repeat" items="{{listAdelantoOrden}}" as="item">
										<tr>
											<td>{{ item.fecha_hora }}</td>
											<td>{{ item.usuario }}</td>
											<td>{{ item.numero }}</td>
											<td>{{ item.cliente_nom }}</td>
											<td>{{ item.concepto }}</td>
											<td>{{ item.importe }}</td>
											<td>
												<button class="btn btn-sm btn-success" data-id="[[index]]" onclick="recibirAdelanto(this)">Recibir</button>
											</td>
										</tr>
									</template>
								</tbody>
							</table>
						</div>

						<!-- entradas -->
						<div hidden$="[[ !isShowListaTicketEntrada ]]">
							<br><br>
							<div class="xLinea2"></div>
							<br>
							<h3>Tickets de Entrada</h3>
							<span>Recibe este ingreso en tu caja</span>
							<br><br>
							<table>
								<thead>
									<th>Fecha</th>
									<th>Usuario</th>
									<th>Detalle</th>
									<th align="right">Total</th>
									<th></th>									
								</thead>
								<tbody>
									<template is="dom-repeat" items="{{listTicketEntrada}}" as="item">
										<tr>
											<td>{{ item.fecha }}</td>
											<td>{{ item.usuario }}</td>
											<td>
												<table class="w-100 border-0">
													<template is="dom-repeat" items="{{item.lista}}" as="row">
														<tr class="border-0">
															<td class="border-0">{{ row.cantidad }}</td>
															<td class="border-0">{{ row.descripcion }}</td>
															<td align="right" class="fw-600 border-0">{{ row.total }}</td>
														</tr>
													</template>
												</table>
											</td>
											<td align="right" class="fw-600 fs-18">S/. {{ item.total }}</td>
											<td>
												<button class="btn btn-sm btn-success" data-id="[[index]]" onclick="recibirTicketEntrada(this)">Recibir</button>
											</td>
										</tr>
									</template>
								</tbody>
							</table>
						</div>

					</div>
				</div>

				<!--Cierre de caja-->
				<div id="cierre_caja">
					<div class="xTxtCierreCajaContenedor">
						 <b><h3 id="xTituloCierre">CIERRE DE CAJA</h3></b>
						 <p class="fs-15">indique el importe en efectivo que tiene en caja, que es igual a todas las ventas en efectivo más ingresos y menos salidas de caja.</p>
						 <br><br>
						 <p class="fs-16 fw-600">Total de efectivo en caja:</p>
						 <input type="text" class="xMiInput xPasarEnter2 fs-28 fw-600 w-50" data-valor="0.10" placeholder="0.00" id="txt_total_caja">
						 <br><br>

			            <form id="formCierre">
			            <!-- <div class="xAlinearce xm_at_cont xEpaciarInputCierre">
			                 <input type="text" class="xMiInput xPasarEnter2" data-valor="200" placeholder="De 200">
			                 <input type="text" class="xMiInput xPasarEnter2" data-valor="100" placeholder="De 100">
			                 <input type="text" class="xMiInput xPasarEnter2" data-valor="50" placeholder="De 50">
			                 <input type="text" class="xMiInput xPasarEnter2" data-valor="20" placeholder="De 20">
			                 <input type="text" class="xMiInput xPasarEnter2" data-valor="10" placeholder="De 10">
			                 <input type="text" class="xMiInput xPasarEnter2" data-valor="5" placeholder="De 5">
			            </div>
			            <div class="xAlinearce xm_at_cont xEpaciarInputCierre">
			                 <input type="text" class="xMiInput xPasarEnter2" data-valor="2" placeholder="De 2">
			                 <input type="text" class="xMiInput xPasarEnter2" data-valor="1" placeholder="De 1">
			                 <input type="text" class="xMiInput xPasarEnter2" data-valor="0.50" placeholder="De 0.50">
			                 <input type="text" class="xMiInput xPasarEnter2" data-valor="0.20" placeholder="De 0.20">
			                 <input type="text" class="xMiInput xPasarEnter2" data-valor="0.10" placeholder="De 0.10" id="txt_fin">
			                 <input type="text" class="xMiInput" data-valor="total" placeholder="Total" id="TxtTotal" disabled encendido>
			            </div> -->
			            <div id="xTituloRpt">
						</div>
						<div id="xTituloRpt2"></div>

			            </form><br>
						<!-- respuesta solicitud cierre -->
						<div id="div_espera_rpt" class="xInvisible">
							<p class="fw-600 fs-15">Por favor espere la respuesta a la solicitud por parte del administrador... <i class="fa fa-circle-o-notch fa-spin"></i></p>
							<br>
						</div>						
						<div id="div_rpt_solicitud" class="xInvisible">
							<p class="fw-600 fs-15">Respuesta Solicitud</p>
							<p class="fw-600">Efectivo Sistema: {{rowRptSolicitud.importe_sistema}}</p>
							<p class$="[[rowRptSolicitud.diferecia_color]]">{{ rowRptSolicitud.diferecia_estado }}: {{  rowRptSolicitud.diferencia}}</p>
							<br>
						</div>
			            <div id="btns_cierre">
				            <!-- <paper-button tabindex="0" raised class="xverde" onclick="xVerificar();"><iron-icon icon="save"></iron-icon>Verificar</paper-button>
				            <paper-button tabindex="0" raised class="xnegro" onclick="xPSupervisor.xopen()"><iron-icon icon="save"></iron-icon>Supervisor</paper-button> -->
							<button class="btn btn-success" onclick="xVerificar();"><i class="fa fa-check pr-1"></i>Verificar</button>
							<button class="btn btn-dark" onclick="dialog_info_supervisor.open()"><i class="fa fa-money pr-1"></i>Cuanto Tengo?</button>
							<!-- <button class="btn btn-info" onclick="xOpenDialogPermisoRemotoUs()"><i class="fa fa-volume-control-phone pr-1"></i>Permiso Remoto</button> -->
			            </div>
			            <!-- <button onclick="xCocinarResumenBoletas();">Enviar Resumen</button> -->
					</div>

					<br><br>
					<div class="xTxtCierreCajaContenedor mt-2" hidden$="[[ !isShowLastCierres ]]">
						<hr>
						<p class="fw-600 fs-18">Ultimos cierres de caja</p>
						<br>
						<table width="100%">
							<thead>
								<th align="left">Fecha</th>
								<th align="left">Usuario</th>
								<th></th>
							</thead>
							<tbody>
								<template is="dom-repeat" items="{{listCierres}}" as="item">
									<tr>
										<td>{{ item.fecha }}  {{ item.hora }}</td>									
										<td>{{ item.usuario }}</td>
										<td>
											<button class="btn btn-sm btn-info" data-id="[[item.idprint_server_detalle]]" onclick="reImprimirCierreHistory(this)" >Re-imprimir</button>
										</td>
									</tr>
								</template>
							</tbody>
						</table>
					</div>
					<br><br>
				</div>
      		</iron-pages>
			  <br><br><br>

		</div>
		<!--Cierre de caja-->
		<div id="ImprimeCierre" class="xInvisible">
			<p id="xImpTitulo" style="font-size:18px; line-height:1px;">CIERRE DE CAJA</p>
		    <!-- <p id="xImpUsuario" style="font-size:14px; line-height:2px;">aaaaaa</p>
		    <p id="xImpFecha" style="font-size:14px; line-height:1px;">aaaaaa</p> -->

			<table width="290" border="0" id="xTableList" style="font-size:12px;">
			  <tr id="Seccion_total"></tr>
			  <tr id="Seccion_caja"></tr>
			  <tr id="Seccion_salida"></tr>
			  <tr id="Seccion_venta_credito"></tr>
			  <tr id="Seccion_tipo_consumo"></tr>
			  <tr id="Seccion_estado_pedido"></tr>
			  <tr id="Seccion_resumen_vendido"></tr>
			</table>
		</div>


		<div id="content_pdf" class="xInvisible" style="margin-top: 700px;">			
			<div id="pdf_cierre" class="xInvisible border-0" style="max-width: 300px; background: white;">
				<div id="div_datos_cierre_caja"></div>
			</div>
		</div>
	</template>
</dom-module>
<style>
	/*paper-button.colorful {color: #4285f4;}*/
	paper-button[raised].colorful {	background: #4285f4;color: #fff;}
	paper-button[raised].xverde {	background: #43a047;color: #fff;}
	paper-button[raised].xnegro {	background: #424242;color: #fff;}
	.xEpaciarInputCierre input{margin-bottom: 20px; font-size: 18px;}
	.xTxtRojo{color:#F00;}

	.xDivImpresora {
		float: right;
	}

</style>

<script type="text/javascript" src="./cocinar.resumen.boletas.js"></script>
<script type="text/javascript" src="../../view/config.const.js"></script>
<script type="text/javascript" src="../../view/xm_all.js"></script>
<script type="text/javascript" src="./../x-caja/cocinar.resumen.boletas.js"></script>
<script type="text/javascript" src="../../view/item_pedido_print_comprobante.js"></script>
<script type="text/javascript" src="../../view/cpe_interno.js"></script>
<script type="text/javascript" src="../../view/xSOAPSunat.js"></script>

<!-- <script type="text/javascript" src="../../view/socket.master.service.js"></script> -->
<script type="text/javascript" src="../../view/socket.service.p.js"></script>
<script>
var xThisCaja
, xMontoTotalCaja
, xSumData
, xtbReport
, xPermisoSupervisor=0
, xArrayCierrePrint = []
, xArrayEncabezadoCierre
, xEfectivoCaja=0
, nom_supervisor=''
, id_supervisor = 0
, xlo_idorg
, xlo_idsede, isPrintCierreCaja = false
, xlo_us, isSocket, xArraySumT=[], numImtentosUs = 0, guadandoIngresoSalida = false, idUsAdminPermiso = 0, titleFilePDFCierre;
function xIniCaja(){

	xPopupLoad=document.getElementById('xLoad');
	/*if(xIdOrg=='' || xIdOrg==undefined){xIdOrg=window.localStorage.getItem('::app3_wo');}
	if(xIdUsuario=='' || xIdUsuario==undefined){xIdUsuario=window.localStorage.getItem('::app3_woU');}
	if(xIdSede=='' || xIdSede==undefined){	xIdSede=window.localStorage.getItem('::app3_woS');}*/
	xm_LogChequea(function(){
		xm_log_get('ini_us');
		// console.log('xUsAc_Ini', xUsAc_Ini);
		$('body').addClass('loaded');


		xThisCaja.xt_org=xIdOrg;
		xThisCaja.xt_idsede=xIdSede;
		xThisCaja.xt_idus=xIdUsuario;
		//xlo_idorg=xIdOrg;
		//xlo_idsede=xIdSede;
		//xlo_us=xIdUsuario;
		$("#Titulo_page").text("Movimientos de Caja");
		//xScrolUp(0);

		//xIniArraysPrint();
		xtbReport=$("#xTableList");
		
		isSocket = parseInt(xm_log_get('datos_org_sede')[0].pwa) === 0 ? false : true;
	});

	/*xThis.xt_org=xIdOrg;
	xThis.xt_idsede=xIdSede;
	xThis.xt_idus=xIdUsuario;*/

	xPSupervisor=document.getElementById('xPSupervisor');
	xPSupervisor.valor = 'Rol1'; // solo administrador
	xPSupervisor.addEventListener('xSend', function (e) {
		var p=e.detail.xRpts[0].p;
		if(p==1){
			nom_supervisor = e.detail.xRpts[0].nomus;
			id_supervisor = e.detail.xRpts[0].us;
			xPermisoSupervisor=1;
			xVerificar()
			//xPreparaReport();
		}
	});

	//$("#xTituloCierre").text('CIERRE DE CAJA: '+xNomU.toUpperCase());
	$('.xPasarEnter2').on('keyup',function(e){

		var xvalText=$(this).val();
		var xValDeno=$(this).attr('data-valor');
		if(xValDeno=='total'){return;}
		var xDeno=parseFloat(parseFloat(xvalText)/parseFloat(xValDeno));
		if(xDeno % 1==0){
			$(this).removeClass('xTxtRojo');
			xSumarTotal();
		}else{
			$(this).addClass('xTxtRojo');
			}

		var code=e.which;
		if ( code==13||code==186 ) {
			var inputs = $('input'); // storage a array of Inputs
		    var a = inputs.index(document.activeElement);
		    if (inputs[a + 1] !== null)
		    {
		      var nextBox = inputs[a + 1];
		      if(nextBox===undefined){return}
		      if(nextBox.disabled){nextBox = inputs[a + 2]}

		      if(nextBox==undefined){return;}
		  	  nextBox.focus();
		      //event.preventDefault();
		    }
		    return false;
  		}
	});

	$("#form_ingreso #monto").on('keyup',function(e){
		var code=e.which;
		if ( code==13||code==186 ) {xGuardarIngreso();}
	})
	$("#form_egreso #monto").on('keyup',function(e){
		var code=e.which;
		if ( code==13||code==186 ) {xGuardarEgreso();}
	})

	$("#txt_fin").on('keyup',function(e){
		var code=e.which;
		if ( code==13||code==186 ) {
			xVerificar();}
	})

	$("#tab_caja").on('iron-select',function(){
		switch(xThisCaja.selected){
			case 0:xLoadResumenIS();break;
			case 1: xloadLastCierres();break;
		}
	});


	xLoadUsAdminPermiso();

}
function xGuardarIngreso(){
	if ( guadandoIngresoSalida ) { return; }
	//$("#form_ingreso #idorg").val(xIdOrg);
	//$("#form_ingreso #idsede").val(xIdSede);
	//$("#form_ingreso #idusuario").val(xIdUsuario);
	guadandoIngresoSalida = true;
	xvalidateFormInput('form_ingreso',function(a){
		if(a===false){guadandoIngresoSalida = false; return;}
		var xvalIE=$("#form_ingreso #selecie").val();
		xPopupLoad.xopen();
		$("#form_ingreso #fecha").val(xDevolverFecha()+' '+xDevolverHora());
		$("#form_ingreso #monto").val(xMoneda($("#form_ingreso #monto").val()))
		$("#form_ingreso #tipo").val(xvalIE);

		//var xx=$("#form_ingreso").serialize();

		$.post("../../bdphp/ManejoBD_IUD.php?tb=ie_caja",$("#form_ingreso").serialize(),function(aa){
			// console.log(aa);
			xPopupLoad.xclose();
			//$("#form_ingreso").reset();
			$("#form_ingreso #motivo").val('');
			$("#form_ingreso #monto").val('');
			xLoadResumenIS();
			guadandoIngresoSalida = false;
		})
	})
}

function xGetDataCierre(idBitacora) {
	xThisCaja.isErrorCierre = false;
	$.ajax({ type: 'POST', url: '../../bdphp/log.php?op=7000', data:{id: idBitacora}})
	.done(function (resCierre) {
		resCierre = JSON.parse(resCierre);
		if( !resCierre.success ) {
			//msj
			const _msjErr = '<h3>Ups! hubo un problema al cerrar. Intente nuevamente</h3>'
			$('#xTituloRpt').html(_msjErr);
			$('#xTituloRpt').css('color','red');
			xThisCaja.isErrorCierre = true;
			console.log(resCierre); xPopupLoad.xclose(); 

			$("#btns_cierre").html(`<button class="btn btn-primary" onclick="xVerificar();"><i class="fa-light fa-repeat"></i> Volver a Verificar</button> <button class="btn btn-warning" onclick="xDownloadPdfCierre(1);"><i class="fa fa-file-pdf-o"></i> V</button>`);
			
			return;
		}

		const arrData = JSON.parse(resCierre.datos[0]['data']);
		const arrTitulo = JSON.parse(resCierre.datos[0]['titulo']);
		
		// const _objRunCierre = {
		// 	data: arrData,
		// 	titulo: arrTitulo
		// }

		// ok run cierre registros
		// $.ajax({ type: 'POST', url: '../../bdphp/log.php?op=70001', data:{id: idBitacora, objdata: _objRunCierre }})
		$.ajax({ type: 'POST', url: '../../bdphp/log.php?op=70001', data:{id: idBitacora }})
		.done(_res => {
			console.log('run cierre registro ',_res)
		})

		// const arrData = JSON.parse(resCierre.datos[0]['data']);
		// const arrTitulo = JSON.parse(resCierre.datos[0]['titulo']);

		var keyTitulo='', cIndex=0, arrX = [], arrRpt=[];
		arrData.map((x, i) => {
			keyTitulo = Object.keys(x)[0];			
			arrX = JSON.parse(x[keyTitulo]);
			if ( arrX ) {
				arrRpt.push({
					des:arrTitulo[i].des,
					t1:arrTitulo[i].t1,
					t2:arrTitulo[i].t2,
					t3:arrTitulo[i].t3,
					visible:0,
					// items:arrX
					});
				
				arrX.map((z,q) => {
					arrRpt[cIndex][q] = z;
				});
		
				cIndex++;
			}
		});

		xArrayCierrePrint = arrRpt;
		
		// xLoadDataCierrePrintHtml();

		// console.log('arrPrint', arrRpt);

		xPopupLoad.xclose();		
		// $("#btns_cierre").html('<paper-button tabindex="0" raised class="xverde" onclick="xCerrarSessionAll();"><iron-icon icon="close"></iron-icon>Cerrar terminal</paper-button>');		
		$("#btns_cierre").html(`<button class="btn btn-success" onclick="xCerrarSessionAll();"><i class="fa fa-close"></i> Cerrar Terminal</button> <button class="btn btn-warning" onclick="xDownloadPdfCierre(1);"><i class="fa fa-file-pdf-o"></i> Descargar cierre en PDF</button>`);		
		// xUpdateCerrarCession(function () {
			xPermisoSupervisor = 0;
			xIniArraysPrint();
			
			// xOpenPage(22)
			if ( !isPrintCierreCaja ) { xVerificaSiFacturacionE();}


			xImprimirCierre(xArrayEncabezadoCierre, xArrayCierrePrint);
			xEscribirDatosHtml();
		// });
	});
}

function xLoadResumenIS(){
	$("#tb_resumen_ie .row").remove();
	$("#tb_resumen_ie").append('<tr class="row"><td colspan="5"><paper-spinner active></paper-spinner></td></tr>').trigger('create');
	$.ajax({ type: 'POST', url: '../../bdphp/log.php?op=70011'})
	.done( function (dtIE) {
		var xdtIE=$.parseJSON(dtIE);
		var xcadena_resumen_ie='';
		var xCuentaRow=0;
		var xClassTipo='';
		xdtIE=xdtIE.datos;
		for (var i = 0; i < xdtIE.length; i++) {
			xCuentaRow++;
			xClassTipo='';
			if(xdtIE[i].tipo!=1){xClassTipo='xColorRow_Rojo';}
			xcadena_resumen_ie=String(xcadena_resumen_ie+'<tr class="row '+xClassTipo+'"><td>'+xCeroIzq(xCuentaRow,2)+'</td><td>'+xdtIE[i].fecha+'</td><td>'+xdtIE[i].des_tipo+'</td><td>'+xdtIE[i].motivo+'</td><td align="right">'+xdtIE[i].monto+'</td></tr>');
		};
		$("#tb_resumen_ie .row").remove();
		$("#tb_resumen_ie").append(xcadena_resumen_ie).trigger('create');
	});

	xLoadAdelantoOrdenPedido();
	xLoadTicketsEntradaCaja();
	xLoadIngresosVariosCaja();
}

function xLoadAdelantoOrdenPedido() {
	$.ajax({ type: 'POST', url: '../../bdphp/log_004.php?op=15'})
	.done( function (resAdelanto) {
		const _resAdelanto = JSON.parse(resAdelanto).datos;
		xThisCaja.listAdelantoOrden = _resAdelanto;
		// console.log('xThisCaja.listAdelantoOrden', xThisCaja.listAdelantoOrden);
		xThisCaja.isShowListaAdelantoOrden = xThisCaja.listAdelantoOrden.length > 0;
	});
}

function xSumarTotal(){
	xMontoTotalCaja=0;
	$('.xTxtCierreCajaContenedor').find('input:text').each(function(index, element) {
		var xValElement=$(element).val();
		if(xValElement!="" && $(element).attr('data-valor')!="total"){
        	xMontoTotalCaja+=parseFloat(xValElement);
			}

    	});
		$('#TxtTotal').val(xMoneda(xMontoTotalCaja));
	}

function xVerificar(){

	xMontoTotalCaja = txt_total_caja.value;
	//$.post('x../../bdphp/log.php?op=16',{xid:xDataEmp.Data[0].xu,xtb:xDevolverFecha()},function(xData){
	$('#xTituloRpt').html('<paper-spinner active></paper-spinner>').trigger('create');
	//$('#xTituloRpt').text('');	
	const datos = {
		totalcaja: parseFloat(xMontoTotalCaja),
		idusuario_supervisor: id_supervisor || 0,			
	}
	$.ajax({ type: 'POST', url: '../../bdphp/log.php?op=70111', data: {item: datos} })
	.done( res => {
		res = JSON.parse(res);		
		if (!res.success) { // aca pare estar el problema que no imprime
			console.log(res); 
			return;
		}
		res = res.datos[0];		

		var xRpt, xColor='', labelItentos = '', xsub_falta = '', xsub_sobra = '', xRpt_monto_supervicion = '';
		const isConforme = res.isConforme === '1' ? true : false;
		const isNumIntentosAgotado = res.isNumIntentosAgotado === '1' ? true : false;
		const calTotal = parseInt(res.calcTotal);

		if(isConforme){
			xRpt='<h3>OK cuadre conforme.</h3>';xColor='#060'; 
			xArmarArrayPrint(res.idbitacora);
			xloadLastCierres()
		} else {
			if(xPermisoSupervisor==1){//supervisor
				if(!isNaN(calTotal)){
					if(calTotal>1) {
						xRpt_monto_supervicion='(falta '+xMoneda(calTotal)+'). ';xsub_falta='xSubrayar xBold2';
					}
					else {
						xRpt_monto_supervicion='(sobra '+xMoneda(calTotal)+'). ';xsub_sobra='xSubrayar xBold2';
					}
				}
				xRpt='<p class="xfont16"><strong>Efectivo: '+ xMoneda(res.efectivoCaja) +' </strong> '+xRpt_monto_supervicion+' Resultado de caja con supervision. Si <span class='+xsub_sobra+'>tiene sobrante</span>, haga un ingreso en caja como sobrante de efectivo. Si por el contrario <span class='+xsub_falta+'>tiene faltante</span>, haga una salida de caja como faltante en caja. Luego vuela a realizar el cuadre de caja, imprima los resultados y cierre su terminal. </p><a class="xCursor xfont16" onClick="xOpenPage(22);"><strong>Ver Resumen.</strong></a>';xColor="#8e24aa"; //<a onclick="xArmarArrayPrint();">Imprimir cierre</a>
				//xPermisoSupervisor=0;
			}else{
				xColor='#F00';				
				if ( isNumIntentosAgotado ) {
					xRpt='<h3>NUMERO DE INTENTOS DE CIERRE AGOTADO, POR FAVOR LLAME AL SUPERVISOR.</h3>';
				} else {
					numImtentosUs = xCeroIzq(res.numintentos,2);
					labelItentos = '<br><span class="xBold xfont14">Intentos de cierre '+ xCeroIzq(res.numintentos,2) + ' de '+ xCeroIzq(res.numintentos_permitidos,2)+'</span> ';
					if(calTotal<-1){xRpt='<h3>Existe sobrante en caja.'+ labelItentos +'</h3>';}
					if(calTotal>1){xRpt='<h3>Existe faltante en caja.'+ labelItentos +'</h3>';}
				}

			}
		}
		
		$('#xTituloRpt').html(xRpt);
		$('#xTituloRpt').css('color',xColor);
	});
	// $.ajax({ type: 'POST', url: '../../bdphp/log.php?op=7001'})
	// .done( function (dtC) {
	// 	xSumData=parseFloat(dtC);
	// 	xEfectivoCaja=xSumData;
	// 	var xRpt_monto_supervicion='';
	// 	var xsub_falta='', xsub_sobra='';
	// 	var xRpt;
	// 	var xColor="";
	// 	xSumData=xMontoTotalCaja-xSumData;

	// 	if(xSumData>=-1 && xSumData<=1){xRpt='<h3>OK cuadre conforme.</h3>';xColor="#060"; xArmarArrayPrint();}
	// 	else{
	// 		if(xPermisoSupervisor==1){//supervisor
	// 			if(!isNaN(xSumData)){
	// 				if(xSumData>1){xRpt_monto_supervicion='(sobra '+xMoneda(xSumData)+'). ';xsub_sobra='xSubrayar xBold2';}else{xRpt_monto_supervicion='(falta '+xMoneda(xSumData)+'). ';xsub_falta='xSubrayar xBold2';}
	// 			}
	// 			xRpt='<p class="xfont16"><strong>Efectivo: '+xEfectivoCaja+' </strong> '+xRpt_monto_supervicion+' Resultado de caja con supervision. Si <span class='+xsub_sobra+'>tiene sobrante</span>, haga un ingreso en caja como sobrante de efectivo. Si por el contrario <span class='+xsub_falta+'>tiene faltante</span>, haga una salida de caja como faltante en caja. Luego vuela a realizar el cuadre de caja, imprima los resultados y cierre su terminal. </p><a class="xCursor xfont16" onClick="xOpenPage(22);"><strong>Ver Resumen.</strong></a>';xColor="#8e24aa"; //<a onclick="xArmarArrayPrint();">Imprimir cierre</a>
	// 			//xPermisoSupervisor=0;
	// 		}else{
	// 			if(xSumData>1){xRpt='<h3>Existe sobrante en caja</h3>';xColor="#F00";}
	// 			if(xSumData<-1){xRpt='<h3>Existe faltante en caja</h3>';xColor="#F00";}
	// 		}
	// 	}
	// 	//$('.xTxtMontoPagar').find('#xBtns').remove();
	// 	$('#xTituloRpt').html(xRpt);
	// 	$('#xTituloRpt').css('color',xColor);

	// 	if(xColor=="#060"){
	// 		////dialog_cierre.open();
	// 		//$('.xTxtMontoPagar').append('<div id="xBtns"><button data-theme="a" onClick="xImprimir();")>Listo, Imprimir operaciones.</button><button data-theme="a" onClick="xCerrarSession();">Cerrar Terminal</button></div>');
	// 		//$('.xTxtMontoPagar').trigger('create');
	// 		}
	// });
		//});
}

function xArmarSubItems(xx,numBD,reponde){
	var indexAr;
	//efectivo en caja
	if(numBD==7021){
		//efectivo en caja
		indexAr=xArrayCierrePrint.length-1;
		xArrayCierrePrint[indexAr][0]={'des':'EFECTIVO EN CAJA', 't1':'','t2':'', 't3':xMoneda(xEfectivoCaja)}
		reponde(true);
		return;
	}

	$.ajax({ type: 'POST', url: '../../bdphp/log.php?op='+numBD})
	.done( function (dtT) {
		var xDtImpr=$.parseJSON(dtT);
		xDtImpr=xDtImpr.datos;
		indexAr=xArrayCierrePrint.length-1;
		for (var i = 0; i < xDtImpr.length; i++) {
			xArrayCierrePrint[indexAr][i]={'des':xDtImpr[i].descripcion, 't1':xDtImpr[i].t1, 't2':xDtImpr[i].t2, 't3':xDtImpr[i].t3}
		};
		//si no hay registro borra seccion
		if(xDtImpr.length==0){xArrayCierrePrint[indexAr].visible=1;}else{xArrayCierrePrint[indexAr].visible=0;}
		reponde(true);
	})
}

function xIniArraysPrint(){
	xArrayEncabezadoCierre=[];

	var xIpPrintDoc='';
	var xdetall_cierre='';
	var xidPrint;
	if(xPermisoSupervisor==1){xdetall_cierre='Cierre con permiso de supervisor. '+nom_supervisor}
	xDtPrint=xm_log_get('sede_generales');// $.parseJSON(window.localStorage.getItem("::app3_sys_dta_prt"));
	xDtTipoDoc=xm_log_get('app3_woIpPrintO');//JSON.parse(window.localStorage.getItem("::app3_woIpPrintO"));
	xArrayImpresoras=xm_log_get('app3_woIpPrint');// $.parseJSON(window.localStorage.getItem("::app3_woIpPrint"));

	//obtener impresora para cierre
	// for (a in xDtTipoDoc) {
	// 	if(xDtTipoDoc[a].idtipo_otro==-3){xIpPrintDoc=xDtTipoDoc[a].idimpresora; break;}
	// };
	// for (b in xArrayImpresoras) {
	// 	if(xIpPrintDoc==xArrayImpresoras[b].idimpresora){xIpPrintDoc=xArrayImpresoras[b].ip;xidPrint=b;}
	// };

	const impresora = xgetImpresora(-3);
	if (impresora == null ) {
		xRpt = '<p class="xColorRow_Rojo">No se selecciono ninguna impresora para este documento</p><a class="xCursor xfont16" onClick="xOpenPage(22);"><strong>Ver Resumen.</strong></a>';
		$('#xTituloRpt2').html(xRpt);
		// alert('No se selecciono ninguna impresora para este documento');
		isPrintCierreCaja = false;
		return false;
	}
	// xArrayEncabezadoCierre.push({'ip_print':xIpPrintDoc, 'logo':xDtPrint[0].logo,'detalle_cierre':xdetall_cierre,'titulo':'CIERRE DE CAJA','var_margen_iz':xArrayImpresoras[xidPrint].var_margen_iz, 'var_size_font':xArrayImpresoras[xidPrint].var_size_font})
	xArrayEncabezadoCierre.push({ 
		'ip_print': impresora[0].ip_print,
		'logo': xDtPrint[0].logo,
		'detalle_cierre': xdetall_cierre,
		'titulo': 'CIERRE DE CAJA',
		'var_margen_iz': impresora[0].var_margen_iz,
		'var_size_font': impresora[0].var_size_font,
		'papel_size': impresora[0].papel_size });

	isPrintCierreCaja = true;
	return true;
}

function xArmarArrayPrint(idBitacora){
	xPopupLoad.xopen();
	xPopupLoad.titulo="Obteniendo Datos...";

	xGetDataCierre(idBitacora);
	// if (!xIniArraysPrint()) { xPopupLoad.xclose(); return;}
}


function xUpdateCerrarCession(responde){
	$.ajax({ type: 'POST', url: '../../bdphp/log.php?op=70012',data:{i:xIdUsuario}})
	.done( function (dtT) {
		xPopupLoad.xclose();
		$("#btns_cierre").html('<paper-button tabindex="0" raised class="xverde" onclick="xCerrarSessionAll();"><iron-icon icon="close"></iron-icon>Cerrar terminal</paper-button>');
		responde(true)
	})
}




function xImprimirCierre(xArrayEncabezadoCierre,xArrayCierrePrint){

	//si existe impresora local // imprime todos los otros documentos en esta impresora local.
	if ( !isPrintCierreCaja ) { return; }
	var xPrintLocal=window.localStorage.getItem("::app3_woIpPrintLo");
	if(xPrintLocal!=undefined && xPrintLocal!=''){
		xPrintLocal=$.parseJSON(xPrintLocal);
		xArrayEncabezadoCierre[0].ip_print=xPrintLocal.ip;
		xArrayEncabezadoCierre[0].var_margen_iz=xPrintLocal.var_margen_iz;
		xArrayEncabezadoCierre[0].var_size_font=xPrintLocal.var_size_font;
		xArrayEncabezadoCierre[0].papel_size=xPrintLocal.papel_size;
	}

	const _sys_local = parseInt(xm_log_get('datos_org_sede')[0].sys_local);
	xArrayEncabezadoCierre[0].nom_us = xm_log_get('app3_us').nomus;
	xArrayEncabezadoCierre[0].nom_sede = xm_log_get('datos_org_sede')[0].sedenombre;
	
	const _data = {Array_enca:xArrayEncabezadoCierre, ArrayItem:xArrayCierrePrint};

	if (_sys_local === 1) {
		xPopupLoad.xopen();
		xSendDataPrintServer(_data, 4, 'cuadre-caja');
		setTimeout(() => {
			xPopupLoad.xclose();
			xVerificaSiFacturacionE();			
		}, 1000);
		return;
	}


	$.ajax({type: 'POST', url: '../../print/print4.php', data:{Array_enca:xArrayEncabezadoCierre, ArrayItem:xArrayCierrePrint}})
						.done( function (dtPbd) {
							//xPopupLoad.xclose();
							if(dtPbd.indexOf('Error')!=-1){
								xPopupLoad.xclose();
								$("#xTituloRpt").text(dtPbd);
								xErrorPrint=true;
								dialog_erro_print.open();
							}else{
								//xPopupLoad.titulo='Exito!';
								xErrorPrint=false;
								xPopupLoad.titulo="Imprimiendo...";
								xPopupLoad.xopen();								
								//setTimeout( function(){ xNuevoPedido(); }, 600);
								//xNuevoPedido()
								//setTimeout( function(){ xNuevoPedido(); }, 1500);
								xVerificaSiFacturacionE();
							}
						});
}

function xVerificaSiFacturacionE() {
	const _arrSedes = xm_log_get('datos_org_sede');
	const isFacturacionElectronica = _arrSedes[0].facturacion_e_activo === "0" ? false : true; // si se emiten comprobantes electronicos

	if (!isFacturacionElectronica) {
		xPopupLoad.xclose();
		return;
	}

	setTimeout(function(){
		xPopupLoad.xclose();
		dialog_enviando_sunat.open();
		setTimeout(() => {
			xCocinarResumenBoletas(); // envia los comprobantes
			}, 1000);
		}, 1500);
}

function xPreparaReport(){
	var xCadenaAdd='';
	var xTituloEncabezado=new Array()
	$.ajax({ type: 'POST', url: '../../bdphp/log.php?op=7'})
	.done( function (dtT) {
		var xDtt=$.parseJSON(dtT);
		var xDtt=xDtt.datos;
		var xsum_venta_tt=0;
		var xsum_efc_tt=0;
		xCadenaRG='';
		//seccion 1 /resumen general
		//xtotal_seccion1=(parseFloat(xDtt.datos[0].efectivo)+parseFloat(xDtt.datos[1].ingreso))-parseFloat(xDtt.datos[1].salida);
		xTitulo='<tr><td colspan="2" style="border-bottom:1px solid;">RESUMEN GENERAL</td></tr>';
		for (var i = 0; i < xDtt.length; i++) {
			if(xDtt[i].operacion1=='+'){xsum_venta_tt=parseFloat(xDtt[i].importe)+parseFloat(xsum_venta_tt)}
			if(xDtt[i].operacion2=='+'){xsum_efc_tt=parseFloat(xDtt[i].importe)+parseFloat(xsum_efc_tt)}
			if(xDtt[i].operacion2=='-'){xsum_efc_tt=parseFloat(xsum_efc_tt)-parseFloat(xDtt[i].importe)}
			xCadenaRG=String(xCadenaRG+'<tr><td>'+xDtt[i].descripcion+'</td><td align="right">'+xMoneda(xDtt[i].importe)+'</td></tr>');
		};
		xpie_secc1='<tr><td style="border-top:1px solid;">VENTA TOTAL</td><td align="right" style="border-top:1px solid;">'+xMoneda(xsum_venta_tt)+'</td></tr><tr class="xBold" ><td style="border-top:1px solid;border-bottom:1px solid;">EFECTIVO EN CAJA</td><td style="border-top:1px solid;border-bottom:1px solid;" align="right">'+xMoneda(xsum_efc_tt)+'</td></tr>';

		xtbReport.find('#Seccion_total').html(xTitulo+xCadenaRG+xpie_secc1).trigger('create');

		//seccion 2 detalle de caja
		xTituloEncabezado='';
		xTituloEncabezado=["Descripcion", "Importe"];
		xAddReport("INGRESO DE CAJA",701,'Seccion_caja','si',xTituloEncabezado,function(){
			//xTituloEncabezado=["Producto", "Stock"];
			xAddReport("SALIDA DE CAJA",7002,'Seccion_salida','si',xTituloEncabezado,function(){
				xImprimir();
				return
				//xTituloEncabezado=["Habitacion | Servicio", "Cantidad"];
				xAddReport("CONSUMO SERVICIOS",135,'Seccion_servicios','',xTituloEncabezado,function(){
					//xTituloEncabezado=["Motivo", "Importe"];
					xAddReport("MOVIMIENTOS DE CAJA",132,'Seccion_move_caja','',xTituloEncabezado,function(){
						//xTituloEncabezado=["Empresa | Cliente", "Importe"];
						xAddReport("DETALLE DE CREDITO",137,'Seccion_credito','si',xTituloEncabezado,function(){
							//xTituloEncabezado=["Habitacion | Cliente", "Hora"];
							xAddReport("EQUIPAJE CONSIGNADO",138,'Seccion_consigna','',xTituloEncabezado,function(){
								//xTituloEncabezado=["Descripcion", "Importe"];
								xAddReport("ADELANTOS",139,'Seccion_adelanto','si',xTituloEncabezado,function(){
									xPopupLoad.xclose();
									xImprimir();
									if(xSumData>0){
										if(xPermisoSupervisor==0){$.ajax({ type: 'POST', url: '../../bdphp/log.php?op=136', data:{e:xSumData}})}else{xPermisoSupervisor==0;}
									}
								})
							})
						})
					})
				});
			});
		});

	});
}
function xAddReport(xtitulo,oplog,seccion,sacar_total,titulo_encabezado,responde){
	var xCadenaAdd='';
	var xTitulo=''
	var xtotal=0;
	var xTituloEncabezadoTB='';
	var xAligTitulo='';

	for (var i = 0; i < titulo_encabezado.length; i++) {
		if(i==1){xAligTitulo='align="right"';}else{xAligTitulo='';}
		xTituloEncabezadoTB=xTituloEncabezadoTB+'<td '+xAligTitulo+' style="border-bottom:1px solid;">'+titulo_encabezado[i]+'</td>';
	};
	if(titulo_encabezado!=''){xTituloEncabezadoTB='<tr>'+xTituloEncabezadoTB+'</tr>';}

	xTitulo='<tr><td colspan="2" style="border-bottom:1px solid;">'+xtitulo+'</td></tr>';
	$.ajax({ type: 'POST', url: '../../bdphp/log.php?op='+oplog})
	.done( function (dtT) {
		var xDtt=$.parseJSON(dtT);
		for (var i = 0; i < xDtt.datos.length; i++) {
			//<td style="font-size:9px" align="right">'+xDtt.datos[i].t2+'</td>
			xCadenaAdd=String(xCadenaAdd+'<tr><td style="font-size:9px">'+xDtt.datos[i].descripcion+'</td><td align="right">'+xDtt.datos[i].t2+'</td></tr>');
			xtotal=parseFloat(xtotal)+parseFloat(xDtt.datos[i].t2)
		};
		if(sacar_total=='si'){
			xtotal='<tr><td colspan="2" align="right" style="border-top:1px dashed;">'+xMoneda(xtotal)+'</td></tr>';
		}
		else{xtotal='';}
		if(xCadenaAdd==''){xCadenaAdd='<tr><td colspan="2">-</td></tr>';}
		xtbReport.find('#'+seccion).html(xTitulo+xTituloEncabezadoTB+xCadenaAdd+xtotal+'<br>').trigger('create');
		responde(true);
	});
}
function xImprimir(){
	var xCtrCierre=$("#ImprimeCierre");
	//xCtrCierre.find('#xImpUsuario').text(xNomU.toUpperCase());
	xCtrCierre.find('#xImpFecha').text(xDevolverFecha()+' '+xDevolverHora());
	xImprSelec('ImprimeCierre');
}
function xCerrarTerminal(){
	xCerrarSession();
}

function xReImprimirCierre(obj){
	dialog_erro_print.close();
	xPopupLoad.titulo="Enviando...";
	xPopupLoad.xopen();
	xImprimirCierre(xArrayEncabezadoCierre,xArrayCierrePrint);
}

function xEscribirDatosHtml(){

	xArrayCierrePrint.map((i, index) => {
		var sum_t1=0,sum_t2=0,sum_t3=0;
		for (const key in i) {
			if (typeof i[key] === 'object') {				
				sum_t1+=isNaN(parseFloat(removeComas(i[key].t1))) ? 0 : parseFloat(removeComas(i[key].t1));
				sum_t2+=isNaN(parseFloat(removeComas(i[key].t2))) ? 0 : parseFloat(removeComas(i[key].t2));
				sum_t3+=isNaN(parseFloat(removeComas(i[key].t3))) ? 0 : parseFloat(removeComas(i[key].t3));
			}
		}
		// i.map(e => {
		// 	if (typeof e === 'object') {				
		// 		sum_t1+=isNaN(parseFloat(e.t1)) ? 0 : parseFloat(e.t1.replace(',', ''));
		// 		sum_t2+=isNaN(parseFloat(e.t2)) ? 0 : parseFloat(e.t2.replace(',', ''));
		// 		sum_t3+=isNaN(parseFloat(e.t3)) ? 0 : parseFloat(e.t3.replace(',', ''));
		// 	}
		// });
		// i.t1 = sum_t1;
		// i.t2 = sum_t2;
		// i.t3 = sum_t3;

		xArraySumT[index]={'t1': sum_t1 == 0 ? '': sum_t1 ,'t2': sum_t2 == 0 ? '': sum_t2,'t3':sum_t3.toFixed(2)}

	});


	var xtabla_datos='',xtabla_encabezados='', xbody_datos='', count_row=0, xtabla_sum='';
	const sedeDatos = xm_log_get('datos_org_sede')[0];
	for (a in xArrayCierrePrint) {
		xtabla_datos='';xtabla_encabezados='';count_row=0;xtabla_sum='';

		xtabla_encabezados='<thead><th align="left">'+xArrayCierrePrint[a].des+'</th><th align="right">'+xArrayCierrePrint[a].t1+'</th><th align="right">'+xArrayCierrePrint[a].t2+'</th><th align="right">'+xArrayCierrePrint[a].t3+'</th></thead>';

		$.map(xArrayCierrePrint[a], function(xn_p, z) {
			if (typeof xn_p==="object"){
				count_row++;
				xtabla_datos=String(xtabla_datos+'<tr><td>'+xn_p.des+'</td><td align="right" class="t1">'+xn_p.t1+'</td><td class="t2" align="right">'+xn_p.t2+'</td><td class="t3" align="right">'+xn_p.t3+'</td><tr>');
			}
		})
		xtabla_sum=String('<tr><td></td><td align="right"><strong>'+xArraySumT[a].t1+'</strong></td><td align="right"><strong>'+xArraySumT[a].t2+'</strong></td><td align="right"><strong>'+xArraySumT[a].t3+'</strong></td></tr>');

		if(count_row===0){continue;}
		xbody_datos=String(xbody_datos+'<table class="xMarginTop fs-11" width="100%">'+xtabla_encabezados+xtabla_datos+xtabla_sum+'</table><br><br>');

	};

	const _fechaNow = xDevolverFecha() + ' | ' + xDevolverHora();

	xbody_datos = `<div style = "line-height: 1;">
				<h4>CIERRE DE CAJA - ${_fechaNow}</h4>				
				<h4>Local: ${sedeDatos.sedenombre}</h4>				
				<h4>Ciudad: ${sedeDatos.sedeciudad} </h4>
				<p>Usuario: ${xNomUsario}</p>
				<p>Intentos: <strong>${numImtentosUs}</strong></p>
				<p>Supervisor: <trong>${nom_supervisor}</strong></p>
				<br><br>
				</div>${xbody_datos}
				<br><br>
				<p>papaya.com.pe</p>`;

	$("#div_datos_cierre_caja").append(xbody_datos).trigger('create');
	// xPopupLoad.xclose();

	// descargar pdf
	setTimeout(() => {		
		titleFilePDFCierre = "Cierre de caja - "+xNomUsario+ " " + _fechaNow;
		xDownloadPdfCierre();
	}, 1500);

	// enviar a correo electronico;
	if (!sedeDatos.email_cierre) { return; }
	const _msjSend = {
            to: sedeDatos.email_cierre,
            asunto: 'CIERRE DE CAJA | '+ sedeDatos.sedenombre + ' | ' + xDevolverFecha(),
            titulo: 'Cierre de caja',
            htmlContent: pdf_cierre.outerHTML
        }

	xSendEmailClienteSES(_msjSend);
}

// op = 0 // show new tab  1=only save
function xDownloadPdfCierre(op = 0) {
	$('#content_pdf').removeClass('xInvisible');
	$('#pdf_cierre').removeClass('xInvisible');	
	var nodeImgCierre = document.getElementById('pdf_cierre');
	const _heightMM = nodeImgCierre.scrollHeight / 3.77;
	domtoimage.toPng(nodeImgCierre)
    .then(function (dataUrl) {
        var img = new Image();
        img.src = dataUrl;
        
		var doc = new jsPDF('p', 'mm', [90, _heightMM]);
		doc.addImage(img, 'JPEG', 5, 5);
		doc.setProperties({title: titleFilePDFCierre});
		if ( op === 0 ) {
			window.open(doc.output('bloburl'));
		}else {
			doc.save(titleFilePDFCierre);
		}

		$('#pdf_cierre').addClass('xInvisible');
		$('#content_pdf').addClass('xInvisible');
    })
    .catch(function (error) {
        console.error('ocurrio un error', error);
    });
}

function xloadLastCierres() {
	$.ajax({ type: 'POST', url: '../../bdphp/log_004.php?op=12'})
	.done(function (res) {		
		res = JSON.parse(res).datos;
		xThisCaja.listCierres = res;
		xThisCaja.isShowLastCierres = res.length > 0;
		// console.log('xThisCaja.listCierres', xThisCaja.listCierres);
	});
}

function reImprimirCierreHistory(obj) {	
	const _cpe = obj.dataId;
	xPopupLoad.xopen()	
	$.ajax({ type: 'POST', 
		url: '../../bdphp/log_005.php?op=1703',
		data:{idprint: _cpe}})
	.done( function (res) {
		var _detalle_json = JSON.parse(res).datos;
		_detalle_json = _detalle_json.length > 0 ? _detalle_json[0] : _detalle_json;

		// const rowItem = xThisHistVenta.listRegistro[index_historial];
		const _dataPrint = {
			detalle_json: _detalle_json.detalle_json,
			idprint_server_detalle: _detalle_json.idprint_server_detalle + new Date().getMilliseconds(), // para que en print server
			hora: xDevolverHora(),
			nomUs: 'Caja',
			nom_documento: "cuadre-caja"
		}

		_cpSocketprinterOnly(_dataPrint);

		setTimeout(() => {
			xPopupLoad.xclose()
		}, 1500);
	});
}

function recibirAdelanto(obj) {
	const indexList = obj.dataId;
	const item = xThisCaja.listAdelantoOrden[indexList];
	item.fecha_guardar = xDevolverFecha()+' '+xDevolverHora();

	$.ajax({ type: 'POST', 
		url: '../../bdphp/log_004.php?op=1501',
		data:{data: item}})
	.done( function (res) {
		// console.log(res);
		xLoadResumenIS();
	});

}

function recibirTicketEntrada(obj) {
	const indexList = obj.dataId;
	const item = xThisCaja.listTicketEntrada[indexList];	
	item.fecha_guardar = xDevolverFecha()+' '+xDevolverHora();
	// item.total = parseFloat(item.total).toFixed(2)

	$.ajax({ type: 'POST', 
		url: '../../bdphp/log_004.php?op=1701',
		data:{data: item}})
	.done( function (res) {
		// console.log(res);
		xLoadResumenIS();
		// xLoadTicketsEntradaCaja();
	});

}

function xOpenDialogPermisoRemotoUs() {
	txt_total_tengo.value = txt_total_caja.value;
	dialog_permiso_remoto.open();
}

function xLoadTicketsEntradaCaja() {
	$.ajax({ type: 'POST', 
		url: '../../bdphp/log_004.php?op=17'})		
	.done( function (res) {
		// console.log('JSON.parse(res)', JSON.parse(res));
		const _resListTickes = JSON.parse(res).datos;
		xThisCaja.isShowListaTicketEntrada = _resListTickes ? _resListTickes.length > 0 : false;
		xThisCaja.listTicketEntrada = _resListTickes.map( x => {
			x.lista = JSON.parse(x.lista);
			x.total = parseFloat(x.total).toFixed(2)
			return x;
		});
	});
	
}

function xLoadUsAdminPermiso() {
	$.ajax({ type: 'POST', 
		url: '../../bdphp/log.php?op=70112'})
	.done( function (res) {
		// console.log('xLoadUsAdminPermiso', JSON.parse(res));
		xThisCaja.listUsAdmin = JSON.parse(res).datos;
		selectedUsAdmin(null, 0);
		// console.log('listUsAdmin', xThisCaja.listUsAdmin);
	});

}

function xLoadIngresosVariosCaja() {
	$.ajax({ type: 'POST', 
	url: '../../bdphp/log_004.php?op=1702'})
	.done( (res) => {
		xThisCaja.listIngresosVarios = JSON.parse(res).datos;
		xThisCaja.isShowIngresoVarios = xThisCaja.listIngresosVarios.length > 0;
		// console.log('xThisCaja.listIngresosVarios', xThisCaja.listIngresosVarios);
		// selectedUsAdmin(null, 0);
		// console.log('listUsAdmin', xThisCaja.listUsAdmin);
	});
}

function selectedUsAdmin(obj, index = null) {
	if (index !== null) {
		idUsAdminPermiso = xThisCaja.listUsAdmin[index].idusuario;
		return;
	}

	idUsAdminPermiso = xThisCaja.listUsAdmin[obj.selectedIndex].idusuario;
}

function xEnviarPermisoRemoto() {
	$.ajax({ type: 'POST', 
		url: '../../bdphp/log.php?op=70113', data:{idus: idUsAdminPermiso, importe: txt_total_tengo.value}})
	.done( function (res) {
		// console.log('res', res);
		// _cpSocketPermisoCierreRemoto()
		// xThisCaja.isShowEsperaRptSolicitudCierre = true;
		$('#div_espera_rpt').removeClass('xInvisible');
		dialog_permiso_remoto.close();
	});
}

function xCajaResPermisoRemoto(res) {
	// console.log('permiso remoto', res);
	if (res.idusuario_solicita !== xIdUsuario) {return;}

	xThisCaja.rowRptSolicitud = res;

	// xThisCaja.isShowEsperaRptSolicitudCierre = false;
	// xThisCaja.isShowRptSolicitudCierre = true;
	$('#div_espera_rpt').addClass('xInvisible');
	$('#div_rpt_solicitud').removeClass('xInvisible');

}


Polymer({
	is:'x-caja',
	properties:{
		//xpage_selected:String,
		xt_org:Number,
		xt_idsede:Number,
		xt_idus:Number,
		winchaCierre: [],
		listCierres: [],
		listUsAdmin: [],
		isShowLastCierres: Boolean,
		listAdelantoOrden: [],
		listTicketEntrada: [],
		isShowListaAdelantoOrden: Boolean,
		isShowEsperaRptSolicitudCierre: Boolean,
		isShowRptSolicitudCierre: Boolean,
		isShowListaTicketEntrada: Boolean,
		isShowIngresoVarios: Boolean,
		isErrorCierre:Boolean,
		rowRptSolicitud: [],
		listIngresosVarios: []
	},
	attached:function(){
		this.selected=0;
		this.isErrorCierre = false;
		this.isShowLastCierres = false;
		this.isShowListaAdelantoOrden = false;
		this.isShowEsperaRptSolicitudCierre = false;
		this.isShowRptSolicitudCierre = false;
		this.isShowListaTicketEntrada = false;
		this.isShowIngresoVarios = false;
    	xThisCaja=this;
		xIniCaja();
		// _cpSocketIsConnect();

		setTimeout(() => {				
			// xIniControlMesa();
			
			_cpSocketOpen();
		}, 1000);
	},
	detached:function(){
		_cpSocketClose();
	}
})
</script>
