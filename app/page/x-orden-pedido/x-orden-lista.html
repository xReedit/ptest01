<!-- Zabuto Calendar -->
<script src="../../../js/zabuto_calendar.min.js"></script>
<script src="../../view/export.excel.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js"></script>
<link rel="import" href="./x-orden-pedido.html">

<dom-module id="x-orden-lista">
    <template is="dom">

        <br><br>
        <div hidden$="[[showOrden]]" class="xMiCard xradius" style="width:85%; max-width: 1100px;">
			<div class="xEncanezadoCard" style="background: lavenderblush; color: #424242;">
                <div class="d-flexx justify-content-between align-items-center">
                    <h3>Ordenes de pedido</h3>                    
                </div>                
            </div>	
            <div class="xLinea2"></div>
            <div class="xContentCard" style="padding: 20px;">            
                <div class="rowx">
                    <div class="col-sm-4 mb-3">
                        <div id="my-calendar"></div>
                        <br><br>
                    </div>
                    <div class="col-sm-7 w-100" id="table-ordenes-mes">
                        <div class="d-flexx justify-content-between align-items-center">
                            <h3>Ordenes {{ titleFilter }}</h3>
                            <div id="div-btn-orden-lista">
                                <button class="btn btn-sm btn-danger" title="Exportar PDF" onclick="exportPDFOrdenesMes()"><i class="fa fa-file-pdf-o"></i></button>
                                <button class="btn btn-sm btn-success" title="Exportar Excel" onclick="exportExcelOrdenesMes()"><i class="fa fa-file-excel-o"></i></button>
                                <button class="btn btn-sm btn-primary xCursor" onclick="showOrdenGo()">+ Agregar</button>
                            </div>
                        </div>
                        <hr>
                        <div class="w-100">
                            <div hidden$="{{!loadingData}}">
                                <paper-spinner active class="xCentradoVerticalHorizontal"></paper-spinner>
                            </div>
                            <table width="100%">
                                <thead>
                                    <th class="xSinBorde" width="15px">#</th>
                                    <th class="xSinBorde" width="15px">Orden</th>
                                    <th class="xSinBorde" width="20%" >Entrega</th>
                                    <th class="xSinBorde" width="60%">Cliente</th>
                                    <th class="xSinBorde xInvisible" width="60%">Producto</th>
                                    <th class="xSinBorde" width="30px" align="right">Importe</th>
                                    <th class="xSinBorde" width="30px" align="right">Adelanto</th>
                                </thead>
                                <tbody>
                                    <template is="dom-repeat" items="{{listOrdenes}}" as="item">
                                        <tr class="fs-11 xCursor" onclick="openOrden(this)" data-idorden={{item.idorden_pedido}}>
                                            <td data-id="{{index}}"><span>{{displayIndex(index)}}</span></td>
                                            <td> {{ item.num }} </td>
                                            <td>        
                                                <p> {{ item.desFecha }} </p>                                        
                                                <span>Hora: {{ item.hora }} </span>  
                                            </td>
                                            <td> 
                                                <p>{{ item.cliente_nom }}</p> 
                                                <span>{{ item.nota }} </span> 
                                            </td>
                                            <td class="xInvisible">
                                                <table>
                                                    <template is="dom-repeat" items="{{ item.detalle_json }}" as="producto">
                                                        <tr class="xSinBorde">
                                                            <td>{{ producto.cantidad }} </td>
                                                            <td>{{ producto.descripcion }} </td>                                                            
                                                            <!-- <td>{{ producto.ptotal }} </td> -->
                                                        </tr>
                                                    </template>
                                                </table>                                                                                                    
                                            </td>
                                            <td align="right"><p class="fw-600"> {{ item.total }}</p> </td>
                                            <td class$="{{ item.color_importe }}" align="right"> {{ item.total_adelanto }} </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div hidden$="[[!showOrden]]">
            <x-orden-pedido id="compOrden"></x-orden-pedido>
        </div>

    </template>
</dom-module>

<script>
    var xThisOrdenLista, xPopupLoad, listMasterMonth, compOrden, fechaSelectLista, idOrdenSelect;

    function xIniOrdenPedidoLista() {
        $('body').addClass('loaded');
        $("#Titulo_page").text("Ordenes de Pedido");

        compOrden = document.getElementById('compOrden');
        compOrden.addEventListener('goBackOrden', function (e) {
            // console.log('atras');
            xThisOrdenLista.showOrden = false;
            xloadOrdenesMMYY(dateNow.getMonth() + 1, dateNow.getFullYear());
        });

        xThisOrdenLista.loadingData = true;

        // var eventData = [
        //     {"date":"2020-10-23","badge":true,"title":"Example for 2020-10-23","body":"<p class=\"lead\">Information for this date<\/p><p>You can add <strong>html<\/strong> in this block<\/p>","footer":"Extra information"},
        //     {"date":"2020-10-09","badge":true,"title":"Example for 2020-10-09","body":"<p class=\"lead\">Information for this date<\/p><p>You can add <strong>html<\/strong> in this block<\/p>","footer":"Extra information"},
        //     {"date":"2020-10-21","badge":true,"title":"Example for 2020-10-21","body":"<p class=\"lead\">Information for this date<\/p><p>You can add <strong>html<\/strong> in this block<\/p>","footer":"Extra information"},
        //     {"date":"2020-10-16","badge":true,"title":"Example for 2020-10-16","body":"<p class=\"lead\">Information for this date<\/p><p>You can add <strong>html<\/strong> in this block<\/p>","footer":"Extra information"},
        //     {"date":"2020-10-24","badge":false,"title":"Example for 2020-10-24","body":"<p class=\"lead\">Information for this date<\/p><p>You can add <strong>html<\/strong> in this block<\/p>","footer":"Extra information"},
        //     {"date":"2020-10-11","badge":true,"title":"Example for 2020-10-11","body":"<p class=\"lead\">Information for this date<\/p><p>You can add <strong>html<\/strong> in this block<\/p>","footer":"Extra information"}];
            
        

        const dateNow = new Date();
        xloadOrdenesMMYY(dateNow.getMonth() + 1, dateNow.getFullYear());
    }


    function xloadOrdenesMMYY(mes, yy) {  
        xThisOrdenLista.nommes = xMayusculaPrimera(xDesMes(mes - 1)) + '-' + yy;      
        xThisOrdenLista.titleFilter = 'de ' + xMayusculaPrimera(xDesMes(mes - 1)) + ' ' + yy;
        xThisOrdenLista.loadingData = true;
        $.ajax({ type: 'POST', url: '../../bdphp/log_005.php?op=30', data: {m: mes, y: yy} })
        .done(function (res) {
            // console.log(res);
            // xThisOrdenLista.listOrdenes = JSON.parse(res).datos;
            dataInCalendar(JSON.parse(res).datos, mes, yy);
        });
    }

    function dataInCalendar(data, mes, yy) {
        // var eventData = [
        //     {"date":"2020-10-23","badge":true,"title":"Example for 2020-10-23","body":"<p class=\"lead\">Information for this date<\/p><p>You can add <strong>html<\/strong> in this block<\/p>","footer":"Extra information"},
        //     {"date":"2020-10-09","badge":true,"title":"Example for 2020-10-09","body":"<p class=\"lead\">Information for this date<\/p><p>You can add <strong>html<\/strong> in this block<\/p>","footer":"Extra information"},
        //     {"date":"2020-10-21","badge":true,"title":"Example for 2020-10-21","body":"<p class=\"lead\">Information for this date<\/p><p>You can add <strong>html<\/strong> in this block<\/p>","footer":"Extra information"},
        //     {"date":"2020-10-16","badge":true,"title":"Example for 2020-10-16","body":"<p class=\"lead\">Information for this date<\/p><p>You can add <strong>html<\/strong> in this block<\/p>","footer":"Extra information"},
        //     {"date":"2020-10-24","badge":false,"title":"Example for 2020-10-24","body":"<p class=\"lead\">Information for this date<\/p><p>You can add <strong>html<\/strong> in this block<\/p>","footer":"Extra information"},
        //     {"date":"2020-10-11","badge":true,"title":"Example for 2020-10-11","body":"<p class=\"lead\">Information for this date<\/p><p>You can add <strong>html<\/strong> in this block<\/p>","footer":"Extra information"}];
        // console.log('data', data);
        data.map((x, i) => {
            x.num = xCeroIzq(x.idorden_pedido, 3);
            x.visible = true;
            x.desFecha = xDesDiaSemana(x.dia_semana) + ' ' + x.dia; 
            x.color_importe = parseFloat(x.total) > parseFloat(x.total_adelanto) ? 'text-warning fw-600' : 'text-success fw-600';            
            x.detalle_json = JSON.parse(x.detalle_json);
        });

        listMasterMonth = data;
        xThisOrdenLista.listOrdenes = data;

        console.log('xThisOrdenLista.listOrdenes', xThisOrdenLista.listOrdenes);
        // console.log('eventDataCalendarMonth', xThisOrdenLista.eventDataCalendarMonth);

        xThisOrdenLista.loadingData = false;

        xRefreshCalendar(mes, yy);
        

    }

    function xFilterDataCalendarbyDay(ddFilter) {
        xThisOrdenLista.loadingData = true;
        fechaSelectLista = ddFilter;
        setTimeout(() => {            
            xThisOrdenLista.listOrdenes = listMasterMonth.filter(d => d.fentrega === ddFilter);
            xThisOrdenLista.titleFilter =  "del dia " + xDesDiaSemana(ddFilter, true) + ' ' + ddFilter;
            xThisOrdenLista.loadingData = false;
        }, 600);
    }
    
    function xRefreshCalendar(mm, yy) {
        // count ++;

        // fecha1 = 10 + count;
        // fecha2 = 12 + count;

        // _fecha1 = '2020-10-'+fecha1;
        // _fecha2 = '2020-10-'+fecha2;

        // var eventData = [
        // {"date":_fecha1,"badge":true,"title":"Example 1"},
        // {"date":_fecha2,"badge":true,"title":"Example 2"}
        // ];

        // console.log('eventData', eventData);

        $("#my-calendar").zabuto_calendar({
            // year: 2020,            
            // month: 10,
            show_next: true,
            show_previous: true,
            // data: eventData,
            language: "es",
            nav_icon: {
                prev: '<span class="xBoton2"><</span>',
                next: '<span class="xBoton2">></span>'
            },
            ajax: {
                url: '../../bdphp/log_005.php?op=3001',
                modal: true
            },
            action: function () {
                // return myDateFunction(this.id, false);
                // console.log('click ', $(this).data('date'));
                const _dateFilter = $(this).data('date');
                xFilterDataCalendarbyDay(_dateFilter);
            },
            action_nav: function () {
                // console.log('click ', this.id);
                // console.log('click nav', $(this).data('navigation'));
                // console.log('click to', $(this).data('to'));
                const date_to = $(this).data('to');
                xloadOrdenesMMYY(date_to.month, date_to.year);
            },
        });
        


        xThisOrdenLista.loadingData = false;
    }


    function showOrdenGo() {
        compOrden.setValuesShowOrden(idOrdenSelect, fechaSelectLista);
        idOrdenSelect = null

        const _compOrden = document.getElementById('compOrden');
        _compOrden.newOrden();

        xThisOrdenLista.showOrden = true;
    }

    function openOrden(item) {
        // console.log('item', item);
        idOrdenSelect = xThisOrdenLista.listOrdenes.filter(i=> i.idorden_pedido === item.dataIdorden)[0];

        compOrden.setValuesShowOrden(idOrdenSelect, fechaSelectLista);
        idOrdenSelect = null
        xThisOrdenLista.showOrden = true;
    }

    // exportar a pdf formato A4
    function exportPDFOrdenesMes() {
        // var doc = new jsPDF('p', 'pt', 'a4');
        // var elem = document.getElementById('table-ordenes-mes');
        // // var res = doc.autoTableHtmlToJson(elem);
        // doc.fromHTML(elem.innerHTML);
        // const _nomFile = xThisOrdenLista.nommes + '.pdf';
        // doc.save(_nomFile);

        // colocar en invisible al div div-btn-orden-lista
        let _divBtn = document.getElementById('div-btn-orden-lista');
        _divBtn.style.display = 'none';
        
        var pdf = new jsPDF('p', 'pt', 'a4');
        var div = document.getElementById('table-ordenes-mes');

        html2canvas(div, {
            onrendered: function (canvas) {
                var imgData = canvas.toDataURL('image/png');
                var pdfWidth = pdf.internal.pageSize.getWidth();
                var pdfHeight = pdf.internal.pageSize.getHeight();

                // Calculate the height of the image based on its original aspect ratio and the width of the page
                var imgHeight = canvas.height * pdfWidth / canvas.width;

                // Calculate the vertical position to center the image on the page
                var imgTop = (pdfHeight - imgHeight) / 2;

                pdf.addImage(imgData, 'PNG', 0, imgTop, pdfWidth, imgHeight);
                const _nomFile = xThisOrdenLista.nommes + '.pdf';
                pdf.save(_nomFile);
            }
        });

        setTimeout(() => {
            _divBtn.style.display = 'block';
        }, 1000);
        
    }

    // exportar a excel
    function exportExcelOrdenesMes() {
        let _divBtn = document.getElementById('div-btn-orden-lista');
        _divBtn.style.display = 'none';

        // var table = document.getElementById('table-ordenes-mes');
        // var html = table.outerHTML;
        // var url = 'data:application/vnd.ms-excel,' + escape(html); // Set your html table into url 
        // var a = document.createElement('a');
        // a.href = url;
        // a.download = _nomFile; // Your file name
        // a.click();
        
        const _nomFile = xThisOrdenLista.nommes;
        tableToExcel('table-ordenes-mes', _nomFile);

        setTimeout(() => {
            _divBtn.style.display = 'block';
        }, 2000);
    }

    Polymer({
			is: 'x-orden-lista',
			properties: {
                listOrdenes: [],
                loadingData: Boolean,
                titleFilter: String,
                showOrden: Boolean,
                nommes: String,
			},
			attached: function () {
                this.showOrden = false;
                xThisOrdenLista = this;                
				xIniOrdenPedidoLista();
			},
			displayIndex: function (index) {
				return xCeroIzq(index + 1, 1);
			},
		});
</script>