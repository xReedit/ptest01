CREATE TRIGGER `despacho` AFTER UPDATE ON `pedido_detalle`
 FOR EACH ROW IF(new.despachado=1)then
UPDATE pedido as p
	SET estado=1
WHERE p.idpedido=new.idpedido and NOT exists(
	SELECT pd.despachado
	FROM pedido_detalle AS pd 
		INNER JOIN seccion AS s using(idseccion)
	WHERE pd.idpedido=new.idpedido AND pd.despachado=0);
end if

------------------------------------------------

CREATE TRIGGER `kardex_ingreso` AFTER INSERT ON `compra`
 FOR EACH ROW insert into kardex (idoperacion,idorg,idsede,idalmacen,tipo_operacion,fecha,documento)
values (concat('C',new.idcompra), new.idorg,new.idsede,new.idalmacen,1,new.f_compra,new.nota_de_compra)

-------------------------

CREATE TRIGGER `kardex_ingreso_almacen` AFTER INSERT ON `almacen_ie`
 FOR EACH ROW insert into kardex (idoperacion,idorg,idsede,idalmacen,tipo_operacion,fecha,documento)
values (concat('A',new.idalmacen_ie), new.idorg,new.idsede,new.idalmacen,new.tipo,new.fecha,new.motivo)

---------------------------------------

CREATE TRIGGER `restar_pedido_pd` AFTER INSERT ON `registro_pago_pedido`
 FOR EACH ROW begin
update pedido_detalle set cantidad=(cantidad-new.cantidad), ptotal=format(ptotal-new.total,2),pagado=if(ptotal=0,1,0), idregistro_pago=new.idregistro_pago where idpedido_detalle=new.idpedido_detalle;
update pedido set total=total-new.total, estado=if(total=0,2,estado),idregistro_pago=if(total=0,new.idregistro_pago,idregistro_pago) where idpedido=new.idpedido;
end

---------------------------------------

CREATE TRIGGER `stock_en_insert_pedido` AFTER INSERT ON `pedido_detalle`
 FOR EACH ROW if(new.procede_tabla=0)then 
 update producto_stock set stock=stock-new.cantidad where idproducto_stock=new.idcarta_lista;
elseif (new.procede_tabla=1) then
 update carta_lista set cantidad=if(cantidad!='ND',cantidad-new.cantidad,'ND') where idcarta_lista=new.idcarta_lista;
elseif (new.procede_tabla=2) then 
 UPDATE porcion AS p
	LEFT JOIN item_ingrediente AS ii using (idporcion)
 SET p.stock=p.stock - (new.cantidad*(ii.cantidad))
 WHERE ii.iditem=new.iditem;
end if

--------------------------------------

CREATE TRIGGER `stock_en_update_pedido` BEFORE UPDATE ON `pedido_detalle`
 FOR EACH ROW begin
if(new.procede_tabla=0 and new.modificado=1)then 
 update producto_stock set stock=stock+1 where idproducto_stock=new.idcarta_lista;
elseif (new.procede_tabla=1 and new.modificado=1) then 
 update carta_lista set cantidad=if(cantidad!='ND',cantidad+1,'ND') where idcarta_lista=new.idcarta_lista; 
elseif (new.procede_tabla=2 and new.modificado=1) then 
 UPDATE porcion AS p
	LEFT JOIN item_ingrediente AS ii using (idporcion)
 SET p.stock=p.stock + ((1)*(ii.cantidad))
 WHERE ii.iditem=new.iditem;  
end if;
set new.modificado=0;
end

---------------------------------

CREATE TRIGGER `stock_insert_add_compra` AFTER INSERT ON `compra_items`
 FOR EACH ROW IF NOT EXISTS (SELECT idproducto FROM producto_stock WHERE idproducto = new.idproducto AND idalmacen = ( SELECT idalmacen FROM compra WHERE idcompra = new.idcompra ))THEN 
	INSERT INTO producto_stock( idproducto, idalmacen, stock ) VALUES (new.idproducto, (SELECT idalmacen FROM compra WHERE idcompra = new.idcompra), new.cantidad);
ELSE 
	UPDATE producto_stock SET stock = stock + new.cantidad WHERE idproducto = new.idproducto AND idalmacen = ( SELECT idalmacen FROM compra WHERE idcompra = new.idcompra ) ;
END IF

--------------------------------

CREATE TRIGGER `stock_insert_almacen_i` BEFORE INSERT ON `almacen_ie_detalle`
 FOR EACH ROW IF new.procede=0 THEN
UPDATE producto_stock SET stock = stock + new.cantidad WHERE idproducto=new.idp and idalmacen=(select idalmacen from almacen_ie where idalmacen_ie=new.idalmacen_ie);
else
update porcion set stock=stock+new.cantidad where idporcion=new.idp;
END IF

------------------------------------